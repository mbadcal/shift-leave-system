<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shift & Leave Management System</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* ============== PROFESSIONAL LOGIN STYLES ============== */
        .auth-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

            .auth-header h2 {
                color: #2c3e50;
                font-size: 28px;
                margin-bottom: 10px;
                font-weight: 700;
            }

            .auth-header p {
                color: #7f8c8d;
                font-size: 16px;
            }

        .auth-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            color: #95a5a6;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

            .auth-tab.active {
                color: #3498db;
                border-bottom-color: #3498db;
            }

            .auth-tab:hover {
                color: #3498db;
                background: #f8f9fa;
            }

        .auth-form {
            display: none;
        }

            .auth-form.active {
                display: block;
            }

        .form-group {
            margin-bottom: 25px;
            position: relative;
        }

            .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 600;
                color: #2c3e50;
                font-size: 14px;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 14px 16px;
                border: 2px solid #e0e0e0;
                border-radius: 10px;
                font-size: 16px;
                transition: all 0.3s;
                background: white;
            }

                .form-group input:focus,
                .form-group select:focus {
                    border-color: #3498db;
                    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
                    outline: none;
                }

                .form-group input.error,
                .form-group select.error {
                    border-color: #e74c3c;
                }

        .error-message {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .auth-button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

            .auth-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 7px 14px rgba(52, 152, 219, 0.3);
            }

            .auth-button:active {
                transform: translateY(0);
            }

            .auth-button:disabled {
                background: #95a5a6;
                cursor: not-allowed;
                transform: none;
                box-shadow: none;
            }

        .auth-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #ecf0f1;
            color: #7f8c8d;
            font-size: 14px;
        }

            .auth-footer a {
                color: #3498db;
                text-decoration: none;
                font-weight: 600;
            }

                .auth-footer a:hover {
                    text-decoration: underline;
                }

        .auth-loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

            .auth-loading .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 15px;
            }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .auth-success {
            display: none;
            text-align: center;
            padding: 30px;
        }

            .auth-success .checkmark {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: #27ae60;
                margin: 0 auto 20px;
                position: relative;
            }

                .auth-success .checkmark:after {
                    content: '';
                    position: absolute;
                    left: 18px;
                    top: 10px;
                    width: 20px;
                    height: 30px;
                    border: solid white;
                    border-width: 0 4px 4px 0;
                    transform: rotate(45deg);
                }

        /* ============== USER PROFILE MODAL ============== */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .profile-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }

            .profile-header .avatar {
                width: 80px;
                height: 80px;
                border-radius: 50%;
                background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
                margin: 0 auto 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 32px;
                color: white;
                font-weight: bold;
            }

        .profile-info {
            margin-bottom: 25px;
        }

        .profile-info-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

            .profile-info-item label {
                display: block;
                font-size: 12px;
                color: #7f8c8d;
                margin-bottom: 5px;
            }

            .profile-info-item .value {
                font-size: 16px;
                font-weight: 600;
                color: #2c3e50;
            }

        /* ============== ADMIN MANAGEMENT MODAL ============== */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .admin-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .admin-section {
            margin-bottom: 30px;
        }

            .admin-section h3 {
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #ecf0f1;
                color: #2c3e50;
            }

        .admin-user-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .admin-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .admin-user-info {
            flex: 1;
        }

            .admin-user-info .name {
                font-weight: 600;
                color: #2c3e50;
            }

            .admin-user-info .email {
                font-size: 13px;
                color: #7f8c8d;
            }

            .admin-user-info .role {
                display: inline-block;
                padding: 3px 8px;
                background: #3498db;
                color: white;
                border-radius: 4px;
                font-size: 12px;
                margin-top: 5px;
            }

                .admin-user-info .role.admin {
                    background: #e74c3c;
                }

        .admin-user-actions {
            display: flex;
            gap: 8px;
        }

        /* ============== VIEWER MESSAGE ============== */
        .viewer-message {
            display: none;
            padding: 15px;
            background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #f39c12;
            font-size: 14px;
            color: #2c3e50;
        }

            .viewer-message h3 {
                margin-bottom: 8px;
                color: #d68910;
                font-size: 16px;
            }

            .viewer-message p {
                margin-bottom: 8px;
            }

        /* ============== ENHANCED UI ELEMENTS ============== */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border-left: 5px solid #3498db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s;
        }

            .stat-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            }

            .stat-card.pending {
                border-left-color: #f39c12;
                background: linear-gradient(135deg, #fff9e6 0%, #ffeaa7 100%);
            }

            .stat-card.approved {
                border-left-color: #27ae60;
                background: linear-gradient(135deg, #eafaf1 0%, #d5f4e6 100%);
            }

            .stat-card.today-highlight {
                border-left-color: #9b59b6;
                background: linear-gradient(135deg, #f4ecf7 0%, #e8daef 100%);
            }

            .stat-card > div:first-child {
                color: #7f8c8d;
                font-size: 14px;
                margin-bottom: 10px;
                font-weight: 500;
            }

            .stat-card > div:last-child {
                font-size: 24px;
                font-weight: 700;
                color: #2c3e50;
            }

        /* ============== ENHANCED BUTTONS ============== */
        .controls button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
            min-height: 44px;
            flex: 1;
            min-width: 160px;
        }

            .controls button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(52, 152, 219, 0.3);
            }

            .controls button:active {
                transform: translateY(0);
            }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%) !important;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%) !important;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%) !important;
        }

        /* ============== RESPONSIVE DESIGN ============== */
        @media (max-width: 768px) {
            .auth-container {
                padding: 30px 20px;
                margin: 20px;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .controls button {
                min-width: 140px;
                padding: 10px 15px;
                font-size: 13px;
            }

            .controls {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .stats-bar {
                grid-template-columns: 1fr;
            }

            .controls button {
                min-width: 100%;
                margin: 3px 0;
            }

            .auth-tabs {
                flex-direction: column;
            }

            .auth-tab {
                padding: 12px;
            }
        }

        /* ============== NOTIFICATION BADGE ============== */
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 3px 7px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Add this to existing styles */
        .notification-container {
            position: relative;
            display: inline-block;
        }

        /* ============== ENHANCED MODAL STYLES ============== */
        .modal-content {
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============== REAL-TIME UPDATE INDICATOR ============== */
        .update-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27ae60;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
            animation: slideInRight 0.3s ease;
            display: none;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Add to existing modal styles */
        .modal {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* ============== ALL EXISTING STYLES FROM ORIGINAL ============== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f5f5;
            padding: 10px;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-size: 1.4em;
        }

        h2 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 1.2em;
        }

        h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
        }

        h4 {
            font-size: 1em;
            margin-bottom: 10px;
        }

        .view-toggle {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            gap: 8px;
        }

            .view-toggle button {
                padding: 8px 12px;
                border: none;
                border-radius: 5px;
                background: #ecf0f1;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.9em;
                flex: 1;
                min-width: 100px;
            }

                .view-toggle button.active {
                    background: #3498db;
                    color: white;
                }

        .calendar-view, .month-view, .day-view {
            display: none;
        }

            .calendar-view.active, .month-view.active, .day-view.active {
                display: block;
            }

        .week-navigation, .month-navigation, .day-navigation {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

            .nav-buttons button {
                padding: 6px 12px;
                border: none;
                border-radius: 5px;
                background: #3498db;
                color: white;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.9em;
                flex: 1;
                min-width: 80px;
            }

                .nav-buttons button:hover {
                    background: #2980b9;
                }

        .nav-title {
            font-size: 1em;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            flex: 1;
            min-width: 100%;
            order: -1;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .day-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid #ecf0f1;
            transition: all 0.3s;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

            .day-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

            .day-card.today {
                border-color: #3498db;
                background-color: #e8f4fc;
            }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .day-name {
            font-weight: bold;
            font-size: 1em;
            color: #2c3e50;
        }

        .date {
            color: #7f8c8d;
            font-size: 0.85em;
        }

        .shift-list {
            margin-top: 8px;
        }

        .shift-item {
            padding: 6px 8px;
            margin-bottom: 6px;
            border-radius: 5px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .operator-name {
            font-weight: 500;
            font-size: 0.9em;
        }

        .shift-time {
            color: #666;
            font-size: 0.8em;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }

        .obituary-duty {
            background-color: #e3f2fd !important;
            border-left: 3px solid #2196f3;
            color: #1976d2;
        }

        .leave {
            background-color: #ffeaa7 !important;
            border-left: 3px solid #fdcb6e;
        }

        .leave-pending {
            background-color: #fff9e6 !important;
            border-left: 3px solid #f39c12;
            border-style: dashed;
        }

        .leave-approved {
            background-color: #d5f4e6 !important;
            border-left: 3px solid #2ecc71;
        }

        .leave-rejected {
            background-color: #ffebee !important;
            border-left: 3px solid #e74c3c;
        }

        .off-duty {
            background-color: #dfe6e9 !important;
            color: #636e72;
        }

        .off-duty-working {
            background-color: #e8f4fc !important;
            border-left: 3px solid #3498db;
        }

        .extra-hours {
            background-color: #fff3e0 !important;
            border-left: 3px solid #ff9800;
        }

        .holiday {
            background-color: #ffebee !important;
            border-left: 3px solid #e74c3c;
            color: #c0392b;
        }

        .skeleton-shift {
            background-color: #e8f6f3 !important;
            border-left: 3px solid #26a69a;
            color: #00897b;
        }

        .warning {
            background-color: #ffeaa7 !important;
            border: 1px solid #fdcb6e;
            padding: 8px;
            border-radius: 5px;
            margin-top: 8px;
            font-size: 0.85em;
        }

        .critical {
            background-color: #ff7675 !important;
            color: white;
            border: 1px solid #d63031;
        }

        .operator-count-display {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.85em;
        }

        .operator-count-item {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 80px;
        }

        .operator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

            .operator-dot.available {
                background-color: #2ecc71;
            }

            .operator-dot.leave {
                background-color: #fdcb6e;
            }

            .operator-dot.off-duty {
                background-color: #95a5a6;
            }

            .operator-dot.off-duty-working {
                background-color: #3498db;
            }

            .operator-dot.late-entry {
                background-color: #ff6b6b;
            }

            .operator-dot.on-duty {
                background-color: #6c5ce7;
            }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.9em;
        }

        select, input, button, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            -webkit-appearance: none;
            appearance: none;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 8px;
            padding: 10px 15px;
            font-size: 0.95em;
            min-height: 44px;
        }

            button:hover {
                background-color: #2980b9;
            }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

            .button-group button {
                flex: 1;
                min-width: 120px;
            }

        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 4px;
            white-space: nowrap;
        }

        .leave-badge {
            background: #fdcb6e;
            color: #333;
        }

        .leave-pending-badge {
            background: #f39c12;
            color: white;
        }

        .leave-approved-badge {
            background: #2ecc71;
            color: white;
        }

        .leave-rejected-badge {
            background: #e74c3c;
            color: white;
        }

        .obituary-badge {
            background: #2196f3;
            color: white;
        }

        .off-duty-badge {
            background: #95a5a6;
            color: white;
        }

        .off-duty-working-badge {
            background: #3498db;
            color: white;
        }

        .extra-hours-badge {
            background: #ff9800;
            color: white;
        }

        .holiday-badge {
            background: #e74c3c;
            color: white;
        }

        .skeleton-badge {
            background: #26a69a;
            color: white;
        }

        .staff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .staff-item {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 5px;
            flex: 1;
            min-width: 100px;
            text-align: center;
            font-size: 0.9em;
        }

        .ctp-operator {
            background: #d5f4e6;
            border-left: 3px solid #2ecc71;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }

        .day-header-cell {
            text-align: center;
            padding: 8px 5px;
            background: #ecf0f1;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85em;
        }

        .day-cell {
            min-height: 100px;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }

            .day-cell:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                border-color: #3498db;
            }

            .day-cell.empty {
                background: #fafafa;
                cursor: default;
            }

                .day-cell.empty:hover {
                    transform: none;
                    box-shadow: none;
                    border-color: #eee;
                }

            .day-cell.today {
                border-color: #3498db;
                background-color: #e8f4fc;
                border-width: 2px;
            }

            .day-cell .date-num {
                font-weight: bold;
                margin-bottom: 4px;
                color: #2c3e50;
                font-size: 1em;
            }

            .day-cell .day-name {
                font-size: 0.75em;
                color: #7f8c8d;
                margin-bottom: 6px;
            }

            .day-cell .operator-status {
                margin-top: 4px;
                font-size: 0.7em;
            }

            .day-cell .operator-status-item {
                margin-bottom: 2px;
                padding: 2px 4px;
                border-radius: 3px;
                display: flex;
                align-items: center;
                gap: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

                .day-cell .operator-status-item.available {
                    background: #e8f6ef;
                    color: #27ae60;
                }

                .day-cell .operator-status-item.leave {
                    background: #fff9e6;
                    color: #e17055;
                }

                .day-cell .operator-status-item.off-duty {
                    background: #f1f2f6;
                    color: #636e72;
                }

                .day-cell .operator-status-item.off-duty-working {
                    background: #e8f4fc;
                    color: #2980b9;
                }

                .day-cell .operator-status-item.obituary {
                    background: #e3f2fd;
                    color: #1976d2;
                }

                .day-cell .operator-status-item.holiday {
                    background: #ffebee;
                    color: #c0392b;
                }

                .day-cell .operator-status-item.skeleton {
                    background: #e8f6f3;
                    color: #00897b;
                }

                .day-cell .operator-status-item.late-entry {
                    background: #ffeaea;
                    color: #d63031;
                }

                .day-cell .operator-status-item.on-duty {
                    background: #e6e6fa;
                    color: #483d8b;
                }

        .day-details-modal .detail-item {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }

            .day-details-modal .detail-item.leave {
                border-left-color: #fdcb6e;
            }

            .day-details-modal .detail-item.off-duty {
                border-left-color: #95a5a6;
            }

            .day-details-modal .detail-item.off-duty-working {
                border-left-color: #3498db;
            }

            .day-details-modal .detail-item.obituary {
                border-left-color: #2196f3;
            }

            .day-details-modal .detail-item.extra-hours {
                border-left-color: #ff9800;
            }

            .day-details-modal .detail-item.holiday {
                border-left-color: #e74c3c;
            }

            .day-details-modal .detail-item.skeleton {
                border-left-color: #26a69a;
            }

            .day-details-modal .detail-item.late-entry {
                border-left-color: #ff6b6b;
            }

            .day-details-modal .detail-item.on-duty {
                border-left-color: #6c5ce7;
            }

        .day-details-modal .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .day-details-modal .staff-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .day-details-modal .shift-time {
            color: #666;
            font-size: 0.85em;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 15px;
        }

        .tab {
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
            font-size: 0.9em;
        }

            .tab.active {
                border-bottom-color: #3498db;
                color: #3498db;
            }

        .tab-content {
            display: none;
        }

            .tab-content.active {
                display: block;
            }

        .approval-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .approval-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .approval-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

            .approval-item.approved {
                border-left-color: #2ecc71;
            }

            .approval-item.rejected {
                border-left-color: #e74c3c;
            }

        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .approval-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

            .approval-actions button {
                margin-top: 0;
                padding: 6px 12px;
                font-size: 0.85em;
            }

        .coff-summary {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }

        .coff-details {
            margin-top: 8px;
            font-size: 0.85em;
            color: #555;
        }

            .coff-details ul {
                margin-left: 15px;
                margin-top: 4px;
            }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-available {
            background-color: #2ecc71;
        }

        .status-leave {
            background-color: #fdcb6e;
        }

        .status-leave-pending {
            background-color: #f39c12;
        }

        .status-leave-approved {
            background-color: #2ecc71;
        }

        .status-leave-rejected {
            background-color: #e74c3c;
        }

        .status-off {
            background-color: #95a5a6;
        }

        .status-off-duty-working {
            background-color: #3498db;
        }

        .status-obituary {
            background-color: #2196f3;
        }

        .status-extra-hours {
            background-color: #ff9800;
        }

        .status-holiday {
            background-color: #e74c3c;
        }

        .status-skeleton {
            background-color: #26a69a;
        }

        .status-late-entry {
            background-color: #ff6b6b;
        }

        .status-on-duty {
            background-color: #6c5ce7;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8em;
        }

        .day-details-container {
            margin: 15px 0;
        }

            .day-details-container h4 {
                margin-bottom: 10px;
                color: #2c3e50;
                font-size: 1em;
            }

        .day-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .day-stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

            .day-stat-item .stat-value {
                font-size: 1.2em;
                font-weight: bold;
                color: #2c3e50;
            }

            .day-stat-item .stat-label {
                font-size: 0.85em;
                color: #666;
                margin-top: 4px;
            }

        .error-message {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: 4px;
            display: none;
        }

        .date-range-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

            .date-range-group .form-group {
                flex: 1;
                margin-bottom: 0;
                min-width: 120px;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.85em;
        }

            table th {
                background: #ecf0f1;
                padding: 8px;
                text-align: left;
                border: 1px solid #ddd;
                font-size: 0.9em;
            }

            table td {
                padding: 6px 8px;
                border: 1px solid #ddd;
            }

            table tr:hover {
                background: #f8f9fa;
            }

        .holiday-marker {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #e74c3c;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6em;
            font-weight: bold;
        }

        .skeleton-marker {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #26a69a;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6em;
            font-weight: bold;
        }

        .day-cell.holiday-cell {
            background: #ffebee;
            border-color: #e74c3c;
        }

        .day-cell.skeleton-cell {
            background: #e8f6f3;
            border-color: #26a69a;
        }

        .day-view-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .staff-exclusion-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .staff-exclusion-item {
            background: #ecf0f1;
            padding: 6px 8px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }

            .staff-exclusion-item input[type="checkbox"] {
                width: auto;
                margin: 0;
            }

        .edit-shift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 350px;
            overflow-y: auto;
            padding: 8px;
        }

        .edit-shift-day {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

            .edit-shift-day h4 {
                margin-bottom: 8px;
                color: #2c3e50;
                border-bottom: 2px solid #3498db;
                padding-bottom: 4px;
                font-size: 0.9em;
            }

        .edit-staff-shift {
            margin-bottom: 8px;
        }

            .edit-staff-shift label {
                font-size: 0.8em;
                color: #555;
                margin-bottom: 2px;
            }

        .late-entry-badge {
            background: #ff6b6b;
            color: white;
        }

        .late-entry {
            background-color: #ffeaea !important;
            border-left: 3px solid #ff6b6b;
            color: #d63031;
        }

        .on-duty-badge {
            background: #6c5ce7;
            color: white;
        }

        .on-duty {
            background-color: #e6e6fa !important;
            border-left: 3px solid #6c5ce7;
            color: #483d8b;
        }

        /* Attendance report navigation */
        #attendance-nav {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

            #attendance-nav .nav-buttons {
                margin-bottom: 8px;
            }

        #attendance-period-title {
            color: #2c3e50;
            font-size: 1em;
            padding: 5px 0;
            text-align: center;
            font-weight: bold;
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 12px;
            }

            h1 {
                font-size: 1.2em;
                margin-bottom: 12px;
            }

            .calendar {
                grid-template-columns: 1fr;
            }

            .month-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .day-cell {
                min-height: 80px;
            }

            .controls {
                flex-direction: column;
            }

                .controls button {
                    width: 100%;
                    min-width: auto;
                    padding: 10px;
                }

            .nav-buttons {
                width: 100%;
                justify-content: center;
            }

            .date-range-group {
                flex-direction: column;
            }

                .date-range-group .form-group {
                    width: 100%;
                }

            .edit-shift-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
                text-align: left;
            }

            .stats-bar {
                gap: 8px;
            }

            .stat-card {
                min-width: 100px;
                padding: 8px;
                font-size: 0.85em;
            }

            .modal-content {
                padding: 15px;
                max-height: 85vh;
            }

            .button-group button {
                min-width: 100px;
            }

            table {
                font-size: 0.8em;
            }

                table th, table td {
                    padding: 4px 6px;
                }

            .shift-time {
                max-width: 80px;
                font-size: 0.75em;
            }

            .legend-item {
                flex: 1 0 calc(50% - 10px);
                min-width: 120px;
            }

            .operator-name {
                font-size: 0.85em;
            }

            .badge {
                font-size: 0.7em;
                padding: 1px 4px;
            }

            .day-cell .operator-status-item {
                font-size: 0.65em;
            }

            #attendance-nav .nav-buttons {
                flex-direction: column;
            }

                #attendance-nav .nav-buttons button {
                    width: 100%;
                }
        }

        @media (max-width: 480px) {
            .month-grid {
                grid-template-columns: 1fr;
            }

            .day-cell {
                min-height: 70px;
            }

            .view-toggle button {
                min-width: 80px;
                font-size: 0.85em;
                padding: 6px 10px;
            }

            .staff-item {
                min-width: 80px;
                font-size: 0.85em;
                padding: 6px 8px;
            }

            .legend {
                gap: 8px;
                padding: 10px;
            }

            .legend-item {
                flex: 1 0 100%;
                font-size: 0.75em;
            }

            .stat-card {
                flex: 1 0 calc(50% - 8px);
                min-width: auto;
            }
        }

        /* Touch-friendly improvements */
        button, .tab, .day-cell, .shift-item {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        select, input, textarea {
            font-size: 16px; /* Prevents iOS zoom on focus */
        }

        /* Ensure proper scrolling on mobile */
        .modal-content, .edit-shift-grid {
            -webkit-overflow-scrolling: touch;
        }

        /* Custom Radio Buttons */
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

            .radio-option:hover {
                background: #e9ecef;
                border-color: #3498db;
            }

            .radio-option input[type="radio"] {
                display: none;
            }

        .radio-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #95a5a6;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            transition: all 0.3s ease;
        }

            .radio-custom:after {
                content: '';
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #3498db;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                transition: all 0.3s ease;
            }

        .radio-option input[type="radio"]:checked + .radio-custom {
            border-color: #3498db;
            background-color: #e8f4fc;
        }

            .radio-option input[type="radio"]:checked + .radio-custom:after {
                transform: translate(-50%, -50%) scale(1);
            }

        .radio-label {
            font-weight: 500;
            color: #2c3e50;
        }

        .radio-option input[type="radio"]:checked ~ .radio-label {
            color: #3498db;
            font-weight: 600;
        }

        /* Custom Checkboxes */
        .checkbox-item {
            flex: 1 0 45%;
            margin-bottom: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

            .checkbox-option:hover {
                background: #e9ecef;
                border-color: #3498db;
            }

            .checkbox-option input[type="checkbox"] {
                display: none;
            }

        .checkbox-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #95a5a6;
            border-radius: 4px;
            display: inline-block;
            position: relative;
            transition: all 0.3s ease;
            background-color: white;
        }

            .checkbox-custom:after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                color: white;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s ease;
            }

        .checkbox-option input[type="checkbox"]:checked + .checkbox-custom {
            background-color: #3498db;
            border-color: #3498db;
        }

            .checkbox-option input[type="checkbox"]:checked + .checkbox-custom:after {
                transform: translate(-50%, -50%) scale(1);
            }

        .checkbox-label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.85em;
        }

        .checkbox-option input[type="checkbox"]:checked ~ .checkbox-label {
            color: #3498db;
            font-weight: 600;
        }

        /* Container for radio/checkbox groups */
        #onDutyTypeSelector, #regularizeTypeSelector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        /* Staff exclusion list improvements */
        .staff-exclusion-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .radio-option, .checkbox-option {
                flex: 1 0 100%;
                min-width: auto;
            }

            .checkbox-item {
                flex: 1 0 100%;
            }

            .staff-exclusion-list {
                flex-direction: column;
                gap: 8px;
            }
        }

        .leave-cancel-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .leave-cancel-checkbox {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border: 2px solid #95a5a6;
            border-radius: 4px;
            background-color: white;
            position: relative;
            cursor: pointer;
            margin: 0;
            flex-shrink: 0;
        }

            .leave-cancel-checkbox:checked {
                background-color: #e74c3c;
                border-color: #e74c3c;
            }

                .leave-cancel-checkbox:checked::after {
                    content: '';
                    position: absolute;
                    color: white;
                    font-size: 14px;
                    font-weight: bold;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                }

            .leave-cancel-checkbox:focus {
                outline: 2px solid #3498db;
                outline-offset: 2px;
            }

        /* Role-based visibility */
        .admin-only {
            display: flex !important;
        }

        /* When body has viewer class, hide admin-only elements */
        body.viewer .admin-only {
            display: none !important;
        }

        /* Update the tabs styling */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
            padding: 5px 5px 0 5px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
            font-size: 0.9em;
            color: #555;
            background-color: #e9ecef;
            margin: 0 3px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }

            .tab.active {
                border-bottom-color: #3498db;
                color: #3498db;
                background-color: white;
                border-color: #dee2e6 #dee2e6 white #dee2e6;
                box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            }

            .tab:hover:not(.active) {
                background-color: #f1f3f4;
                color: #2c3e50;
            }

        /* Improve day view contrast */
        .day-view-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }

        .day-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .day-header .date {
            color: #555;
            font-size: 0.9em;
            font-weight: 500;
        }

        /* Improve month view contrast */
        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .day-header-cell {
            text-align: center;
            padding: 10px 5px;
            background: #f8f9fa;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            color: #2c3e50;
            border: 1px solid #dee2e6;
        }

        .day-cell {
            min-height: 100px;
            background: #fefefe;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }

            .day-cell:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                border-color: #3498db;
                background-color: #f8f9fa;
            }

            .day-cell.today {
                border-color: #3498db;
                background-color: #e8f4fc;
                border-width: 2px;
            }

            .day-cell .date-num {
                font-weight: bold;
                margin-bottom: 4px;
                color: #2c3e50;
                font-size: 1em;
            }

            .day-cell .day-name {
                font-size: 0.8em;
                color: #666;
                margin-bottom: 6px;
            }

            .day-cell .operator-status-item {
                margin-bottom: 2px;
                padding: 3px 5px;
                border-radius: 3px;
                display: flex;
                align-items: center;
                gap: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-size: 0.75em;
                font-weight: 500;
            }

        /* Improve week view contrast */
        .calendar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .day-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

            .day-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border-color: #3498db;
            }

            .day-card.today {
                border-color: #3498db;
                background-color: #e8f4fc;
                border-width: 2px;
            }

        /* Improve operator names visibility */
        .operator-name {
            font-weight: 600;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .shift-time {
            color: #444;
            font-size: 0.8em;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            font-weight: 500;
        }

        /* Improve badges visibility */
        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 4px;
            white-space: nowrap;
            font-weight: 600;
            color: white !important;
        }

        /* Improve stats bar visibility */
        .stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-width: 120px;
            flex: 1;
            text-align: center;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e8e8e8;
        }

            .stat-card > div:first-child {
                color: #666;
                font-size: 0.85em;
                margin-bottom: 8px;
                font-weight: 500;
            }

            .stat-card > div:last-child {
                font-size: 1.2em;
                font-weight: bold;
                color: #2c3e50;
            }

        /* Improve controls visibility */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
        }

            .controls button {
                margin-top: 0;
                width: auto;
                min-width: 140px;
                flex: 1;
                padding: 10px 15px;
                font-size: 0.9em;
                font-weight: 600;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s;
            }

                .controls button:hover {
                    background-color: #2980b9;
                    transform: translateY(-1px);
                    box-shadow: 0 3px 5px rgba(0,0,0,0.1);
                }

        /* Improve view toggle buttons */
        .view-toggle {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

            .view-toggle button {
                padding: 10px 15px;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                background: #f8f9fa;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.9em;
                flex: 1;
                min-width: 100px;
                color: #555;
                transition: all 0.3s;
            }

                .view-toggle button.active {
                    background: #3498db;
                    color: white;
                    border-color: #3498db;
                }

                .view-toggle button:hover:not(.active) {
                    background: #e9ecef;
                    border-color: #3498db;
                }

        /* Improve tab content background */
        .tab-content {
            display: none;
            background-color: white;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            border: 1px solid #dee2e6;
            border-top: none;
        }

            .tab-content.active {
                display: block;
            }

        /* Improve shift items contrast */
        .shift-item {
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            border: 1px solid #e8e8e8;
        }

        /* Improve operator count display */
        .operator-count-display {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #e8e8e8;
        }

        .operator-count-item {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 100px;
            color: #555;
            font-weight: 500;
        }

        /* Improve navigation bars */
        .week-navigation, .month-navigation, .day-navigation {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            gap: 10px;
            border: 1px solid #e8e8e8;
        }

        .nav-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            flex: 1;
            min-width: 100%;
            order: -1;
        }

        .nav-buttons button {
            padding: 8px 15px;
            border: 1px solid #3498db;
            border-radius: 5px;
            background: white;
            color: #3498db;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            flex: 1;
            min-width: 100px;
            transition: all 0.3s;
        }

            .nav-buttons button:hover {
                background: #3498db;
                color: white;
            }

        /* Improve container contrast */
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        /* Mobile responsiveness improvements */
        @media (max-width: 768px) {
            .tab {
                padding: 8px 10px;
                font-size: 0.85em;
                margin: 0 2px;
            }

            .container {
                padding: 12px;
            }

            .controls button {
                min-width: 120px;
                padding: 8px 12px;
                font-size: 0.85em;
            }

            .view-toggle button {
                min-width: 80px;
                padding: 8px 10px;
                font-size: 0.85em;
            }

            .stat-card {
                padding: 10px;
                min-width: 90px;
            }
        }

        @media (max-width: 480px) {
            .tab {
                flex: 1 0 100%;
                margin-bottom: 5px;
                border-radius: 5px;
            }

            .tabs {
                padding: 5px;
            }

            .tab.active {
                border-radius: 5px;
                border: 1px solid #3498db;
            }

            .view-toggle button {
                flex: 1 0 100%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-container">
            <div class="auth-header">
                <h2> Shift & Leave Management</h2>
                <p>Sign in to access your dashboard</p>
            </div>

            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showLoginTab()">Login</div>
                <div class="auth-tab" onclick="showRegisterTab()">Register</div>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form active">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" placeholder="you@example.com">
                    <div class="error-message" id="loginEmailError"></div>
                </div>

                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" placeholder="">
                    <div class="error-message" id="loginPasswordError"></div>
                </div>

                <button class="auth-button" onclick="loginUser()" id="loginButton">Sign In</button>

                <div class="auth-footer">
                    <p>Don't have an account? <a href="#" onclick="showRegisterTab()">Register here</a></p>
                </div>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" placeholder="John Doe">
                    <div class="error-message" id="registerNameError"></div>
                </div>

                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" placeholder="you@example.com">
                    <div class="error-message" id="registerEmailError"></div>
                </div>

                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" placeholder="">
                    <div class="error-message" id="registerPasswordError"></div>
                </div>

                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" placeholder="">
                    <div class="error-message" id="registerConfirmPasswordError"></div>
                </div>

                <button class="auth-button" onclick="registerUser()" id="registerButton">Create Account</button>

                <div class="auth-footer">
                    <p>Already have an account? <a href="#" onclick="showLoginTab()">Sign in here</a></p>
                </div>
            </div>

            <!-- Loading State -->
            <div id="authLoading" class="auth-loading">
                <div class="spinner"></div>
                <p>Processing...</p>
            </div>

            <!-- Success State -->
            <div id="authSuccess" class="auth-success">
                <div class="checkmark"></div>
                <h3>Success!</h3>
                <p>Redirecting to dashboard...</p>
            </div>
        </div>
    </div>

    <!-- Main Container (Initially Hidden) -->
    <div class="container" style="display: none;">
        <h1> Shift & Leave Management System</h1>

        <div class="viewer-message" id="viewerMessage">
            <h3> Viewer Mode</h3>

        </div>

        <div class="stats-bar">
            <div class="stat-card today-highlight">
                <div>Today's Date</div>
                <div id="current-date" style="font-size: 1.1em; font-weight: bold;"></div>
            </div>
            <div class="stat-card">
                <div>Total Staff</div>
                <div style="font-size: 1.1em; font-weight: bold;">5</div>
            </div>
            <div class="stat-card pending">
                <div>Pending Approvals</div>
                <div id="pending-count" style="font-size: 1.1em; font-weight: bold;">0</div>
            </div>
            <div class="stat-card approved">
                <div>Comp-off Balance</div>
                <div id="coff-balance" style="font-size: 1.1em; font-weight: bold;">0 days</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('approvals')">
                <span class="notification-container">
                    Approvals
                    <span id="approvalBadge" class="notification-badge" style="display: none;">0</span>
                </span>
            </div>
            <div class="tab" onclick="switchTab('coff')">Comp-off</div>
            <div class="tab" onclick="switchTab('reports')">Reports</div>
            <div class="tab" onclick="showProfile()" id="profileTab" style="display: none;"> Profile</div>
            <div class="tab" onclick="showAdminManagement()" id="adminManagementTab" style="display: none;"> Admin</div>
            <div class="tab" onclick="logoutUser()" style="color: #e74c3c;"> Logout</div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="view-toggle">
                <button id="viewTodayBtn" onclick="switchView('today')"> Today</button>
                <button id="viewWeekBtn" class="active" onclick="switchView('week')"> Week View (7 Days)</button>
                <button id="viewMonthBtn" onclick="switchView('month')"> Month View</button>
            </div>

            <div class="controls admin-only" style="display: none;">
                <button onclick="openAddLeaveModal()"> Apply Leave</button>
                <button onclick="openCancelLeaveModal()"> Cancel Leave</button>
                <button onclick="openEditShiftModal()"> Edit Shift</button>
                <button onclick="openEditObituaryModal()"> Edit Obituary Duty</button>
                <button onclick="openOffDutyModal()"> Off-Duty Working</button>
                <button onclick="openOnDutyModal()"> On Duty (OD)</button>
                <button onclick="openLateEntryModal()"> Late Entry</button>
                <button onclick="openExtraHoursModal()"> Add Extra Hours</button>
                <button onclick="openCancelOffDutyModal()"> Cancel Off-Duty</button>
                <button onclick="openApplyCOFFModal()"> Apply COFF</button>
                <button onclick="openHolidayModal()"> Add/Remove Holiday</button>
                <button onclick="openSkeletonModal()"> Add/Remove Skeleton Shift</button>
            </div>

            <div class="staff-list" id="staff-list">
                <!-- Staff list will be populated by JavaScript -->
            </div>

            <!-- Today View -->
            <div id="todayView" class="day-view">
                <div class="day-navigation">
                    <div class="nav-title" id="dayTitle"></div>
                    <div class="nav-buttons">
                        <button onclick="previousDay()"> Previous Day</button>
                        <button onclick="goToToday()">Today</button>
                        <button onclick="nextDay()">Next Day </button>
                    </div>
                </div>
                <div class="day-view-container" id="todayViewContainer">
                    <!-- Today view will be populated by JavaScript -->
                </div>
            </div>

            <!-- Week View (7 Days) -->
            <div id="calendarView" class="calendar-view active">
                <div class="week-navigation">
                    <div class="nav-title" id="weekTitle"></div>
                    <div class="nav-buttons">
                        <button onclick="previousWeek()"> Previous Week</button>
                        <button onclick="goToTodayWeek()">Today</button>
                        <button onclick="nextWeek()">Next Week </button>
                    </div>
                </div>

                <div class="calendar" id="calendar">
                    <!-- Calendar will be populated by JavaScript -->
                </div>
            </div>

            <!-- Month View -->
            <div id="monthView" class="month-view">
                <div class="month-navigation">
                    <div class="nav-title" id="monthTitle"></div>
                    <div class="nav-buttons">
                        <button onclick="previousMonth()"> Previous Month</button>
                        <button onclick="goToTodayMonth()">Today</button>
                        <button onclick="nextMonth()">Next Month </button>
                    </div>
                </div>

                <div class="month-grid" id="monthGrid">
                    <!-- Month grid will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Approvals Tab -->
        <div id="approvals-tab" class="tab-content">
            <h2> Pending Approvals</h2>
            <div id="pending-approvals-container">
                <!-- Pending approvals will be populated by JavaScript -->
            </div>

            <h2> Approved Leaves</h2>
            <div id="approved-leaves-container">
                <!-- Approved leaves will be populated by JavaScript -->
            </div>

            <h2> Rejected Leaves</h2>
            <div id="rejected-leaves-container">
                <!-- Rejected leaves will be populated by JavaScript -->
            </div>
        </div>

        <!-- Comp-off Tab -->
<div id="coff-tab" class="tab-content">
    <h2> Comp-off Management</h2>
    <div class="controls">
        <button onclick="openApplyCOFFModal()"> Apply for Comp-off</button>
        <button onclick="viewCOFFSummary()"> View COFF Summary</button>
        <!-- Add these fix buttons -->
        <button onclick="fixCOFFData()" class="btn-warning"> Fix All COFF Data</button>
        <button onclick="fixODCOFFData()" class="btn-warning"> Fix OD COFF Only</button>
        <button onclick="refreshCOFFData()" class="btn-secondary"> Refresh COFF Data</button>
    </div>
    <div id="coff-summary-container">
        <!-- COFF summary will be populated by JavaScript -->
    </div>
    <div id="coff-history-container">
        <!-- COFF history will be populated by JavaScript -->
    </div>
</div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <h2> Reports</h2>
            <div class="controls">
                <button onclick="generateAttendancePeriodReport()"> Attendance (21st-20th)</button>
                <button onclick="generateOnDutyReport()"> On Duty/Extra Hours</button>
                <button onclick="generateLeaveReport()"> Leave Report</button>
                <button onclick="generateCOFFReport()"> COFF Report</button>
                <button onclick="generateOTReport()"> OT Report</button>
                <button onclick="exportAllData()"> Export All Data</button>
            </div>

            <!-- Navigation for attendance report -->
            <div id="attendance-nav">
                <div class="nav-buttons" style="justify-content: center;">
                    <button onclick="previousAttendancePeriod()"> Previous Period</button>
                    <button onclick="goToCurrentAttendancePeriod()">Current Period</button>
                    <button onclick="nextAttendancePeriod()">Next Period </button>
                </div>
                <div id="attendance-period-title"></div>
            </div>

            <div id="report-container">
                <!-- Reports will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Real-time Update Indicator -->
    <div id="updateIndicator" class="update-indicator">
         Data Updated
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="profile-modal">
        <div class="profile-content">
            <div class="profile-header">
                <div class="avatar" id="profileAvatar">U</div>
                <h2 id="profileName">User Profile</h2>
            </div>

            <div class="profile-info">
                <div class="profile-info-item">
                    <label>Email Address</label>
                    <div class="value" id="profileEmail">Loading...</div>
                </div>

                <div class="profile-info-item">
                    <label>Account Role</label>
                    <div class="value" id="profileRole">Loading...</div>
                </div>

                <div class="profile-info-item">
                    <label>Account Created</label>
                    <div class="value" id="profileCreated">Loading...</div>
                </div>

                <div class="profile-info-item">
                    <label>Last Login</label>
                    <div class="value" id="profileLastLogin">Loading...</div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('profileModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Admin Management Modal -->
    <div id="adminManagementModal" class="admin-modal">
        <div class="admin-content">
            <h2> Admin Management</h2>

            <div class="admin-section">
                <h3>User Management</h3>
                <div id="adminUserList" class="admin-user-list">
                    <!-- Users will be populated here -->
                </div>
            </div>

            <div class="admin-section">
                <h3>Add New User</h3>
                <div class="form-group">
                    <label for="adminNewUserEmail">Email Address</label>
                    <input type="email" id="adminNewUserEmail" placeholder="newuser@example.com">
                </div>

                <div class="form-group">
                    <label for="adminNewUserRole">Role</label>
                    <select id="adminNewUserRole">
                        <option value="viewer">Viewer</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>

                <button onclick="adminAddUser()" class="btn-success">Add User</button>
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('adminManagementModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- All existing modals -->
    <!-- Modal for Day Details -->
    <div id="dayDetailsModal" class="modal day-details-modal">
        <div class="modal-content">
            <h3 id="dayDetailsTitle"></h3>
            <div class="day-stats" id="dayStats">
                <!-- Day statistics will be populated by JavaScript -->
            </div>
            <div class="day-details-container">
                <h4>Shift Details</h4>
                <div id="dayShiftDetails">
                    <!-- Shift details will be populated by JavaScript -->
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('dayDetailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding leave with date range -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <h3>Apply for Leave</h3>
            <div class="form-group">
                <label for="leaveStaff">Staff Member:</label>
                <select id="leaveStaff" onchange="checkLeaveEligibility()">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Leave Period:</label>
                <div class="date-range-group">
                    <div class="form-group">
                        <label for="leaveFromDate">From Date:</label>
                        <input type="date" id="leaveFromDate" onchange="updateLeaveToDate(); checkLeaveEligibility()">
                    </div>
                    <div style="align-self: center;">to</div>
                    <div class="form-group">
                        <label for="leaveToDate">To Date:</label>
                        <input type="date" id="leaveToDate" onchange="checkLeaveEligibility()">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="leaveType">Leave Type:</label>
                <select id="leaveType">
                    <option value="full">Full Day</option>
                    <option value="half">Half Day</option>
                </select>
            </div>
            <div id="leaveEligibilityError" class="error-message">
                <!-- Error message will be populated by JavaScript -->
            </div>
            <div class="button-group">
                <button onclick="submitLeave()">Submit for Approval</button>
                <button class="btn-secondary" onclick="closeModal('leaveModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for editing obituary duty -->
    <div id="editObituaryModal" class="modal">
        <div class="modal-content">
            <h3>Edit Obituary Duty (Transfer)</h3>
            <div class="form-group">
                <label for="obituaryDate">Select Date:</label>
                <input type="date" id="obituaryDate" onchange="loadCurrentObituaryDuty()">
            </div>
            <div class="form-group">
                <label>Current Assignment:</label>
                <div id="currentObituaryInfo" style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                    Loading...
                </div>
            </div>
            <div class="form-group">
                <label>Transfer From:</label>
                <select id="transferFromStaff" onchange="updateAvailableStaff()">
                    <option value="">Select current obituary duty holder</option>
                </select>
            </div>
            <div class="form-group">
                <label>Transfer To:</label>
                <select id="transferToStaff">
                    <option value="">Select new staff for obituary duty</option>
                </select>
            </div>
            <div class="form-group">
                <label for="obituaryReason">Reason for Transfer (Optional):</label>
                <textarea id="obituaryReason" rows="2" placeholder="Reason for transferring obituary duty"></textarea>
            </div>
            <div class="button-group">
                <button onclick="transferObituaryDuty()">Transfer Obituary Duty</button>
                <button class="btn-secondary" onclick="closeModal('editObituaryModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for cancelling leave -->
    <div id="cancelLeaveModal" class="modal">
        <div class="modal-content">
            <h3>Cancel Leave</h3>
            <div class="form-group">
                <label for="cancelLeaveStaff">Select Staff Member:</label>
                <select id="cancelLeaveStaff" onchange="loadLeaveForStaff()">
                    <option value="">All Staff</option>
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Leave Period:</label>
                <div class="date-range-group">
                    <div class="form-group">
                        <label for="cancelFromDate">From Date:</label>
                        <input type="date" id="cancelFromDate" onchange="loadLeaveForStaff()">
                    </div>
                    <div style="align-self: center;">to</div>
                    <div class="form-group">
                        <label for="cancelToDate">To Date:</label>
                        <input type="date" id="cancelToDate" onchange="loadLeaveForStaff()">
                    </div>
                </div>
            </div>

            <!-- Container for leave list -->
            <div id="leaveListContainer" style="max-height: 400px; overflow-y: auto; padding: 10px;">
                <!-- Leave list will be populated here -->
            </div>

            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('cancelLeaveModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for editing shift -->
    <div id="editShiftModal" class="modal">
        <div class="modal-content">
            <h3>Edit Shift Schedule</h3>
            <div class="form-group">
                <label for="effectiveDate">Effective From Date:</label>
                <input type="date" id="effectiveDate">
            </div>

            <div class="edit-shift-grid" id="editShiftGrid">
                <!-- Shift grid will be populated by JavaScript -->
            </div>

            <div class="button-group">
                <button onclick="saveShiftEdit()">Save Changes</button>
                <button class="btn-secondary" onclick="closeModal('editShiftModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for off-duty working entry -->
    <div id="offDutyModal" class="modal">
        <div class="modal-content">
            <h3>Off-Duty Working Entry</h3>
            <div class="form-group">
                <label for="offDutyStaff">Staff Member (Off-duty):</label>
                <select id="offDutyStaff" onchange="updateOffDutyStaffOptions()">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            <div class="form-group">
                <label for="offDutyDate">Date:</label>
                <input type="date" id="offDutyDate" onchange="updateOffDutyStaffOptions()">
            </div>
            <div class="form-group">
                <label for="offDutyShift">Actual Shift Worked:</label>
                <select id="offDutyShift">
                    <option value="5pm-1:30am">5pm-1:30am</option>
                    <option value="4pm-12:30pm">4pm-12:30pm</option>
                    <option value="7pm-3:30pm">7pm-3:30pm</option>
                    <option value="7:00pm-3:30am">7:00pm-3:30am</option>
                </select>
            </div>
            <div class="form-group">
                <label for="offDutyReason">Reason (Optional):</label>
                <input type="text" id="offDutyReason" placeholder="e.g., Staff shortage , Extra work">
            </div>
            <div class="button-group">
                <button onclick="saveOffDutyEntry()">Save Entry</button>
                <button class="btn-secondary" onclick="closeModal('offDutyModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for On Duty -->
    <div id="onDutyModal" class="modal">
        <div class="modal-content">
            <h3>On Duty (Outside Office Work)</h3>
            <div class="form-group">
                <label for="onDutyStaff">Staff Member:</label>
                <select id="onDutyStaff">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="onDutyDate">Date:</label>
                <input type="date" id="onDutyDate">
            </div>
            <div class="form-group">
                <label>On Duty Type:</label>
                <div id="onDutyTypeSelector">
                    <label class="radio-option">
                        <input type="radio" name="onDutyType" value="regular" checked onclick="toggleExtraHours()">
                        <span class="radio-custom"></span>
                        <span class="radio-label">Regular Shift Time</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="onDutyType" value="extra" onclick="toggleExtraHours()">
                        <span class="radio-custom"></span>
                        <span class="radio-label">Extra Hours</span>
                    </label>
                </div>
            </div>
            <div class="form-group" id="extraHoursSection" style="display: none;">
                <label for="onDutyExtraHours">Extra Hours:</label>
                <select id="onDutyExtraHours">
                    <option value="0.5">0.5 hour</option>
                    <option value="1">1 hour</option>
                    <option value="1.5">1.5 hours</option>
                    <option value="2">2 hours</option>
                    <option value="2.5">2.5 hours</option>
                    <option value="3">3 hours</option>
                    <option value="3.5">3.5 hours</option>
                    <option value="4">4 hours</option>
                    <option value="4.5">4.5 hours</option>
                    <option value="5">5 hours</option>
                    <option value="5.5">5.5 hours</option>
                    <option value="6">6 hours</option>
                    <option value="6.5">6.5 hours</option>
                    <option value="7">7 hours</option>
                    <option value="7.5">7.5 hours</option>
                    <option value="8">8 hours (Full day)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="onDutyReason">Reason/Location:</label>
                <textarea id="onDutyReason" rows="3" placeholder="e.g., Client site visit, Field work"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveOnDuty()">Save On Duty</button>
                <button class="btn-secondary" onclick="closeModal('onDutyModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for Late Entry -->
    <div id="lateEntryModal" class="modal">
        <div class="modal-content">
            <h3>Late Entry Registration</h3>
            <div class="form-group">
                <label for="lateEntryStaff">Staff Member:</label>
                <select id="lateEntryStaff" onchange="updateRegularShiftTime()">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lateEntryDate">Date:</label>
                <input type="date" id="lateEntryDate" onchange="updateRegularShiftTime()">
            </div>
            <div class="form-group">
                <label for="regularShiftTime">Regular Shift Time:</label>
                <input type="text" id="regularShiftTime" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label for="actualTime">Actual Entry Time:</label>
                <input type="time" id="actualTime" onchange="calculateDelay()" required>
            </div>
            <div class="form-group">
                <label for="delayMinutes">Calculated Delay:</label>
                <input type="text" id="delayMinutes" readonly style="background: #f5f5f5;">
                <div id="delayMessage" style="font-size: 0.9em; margin-top: 5px; color: #666;"></div>
            </div>
            <div class="form-group">
                <label>Regularization:</label>
                <div id="regularizeTypeSelector">
                    <label class="radio-option">
                        <input type="radio" name="regularizeType" value="coff" checked onclick="toggleCOFFRequirement()">
                        <span class="radio-custom"></span>
                        <span class="radio-label">Regularize from COFF</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="regularizeType" value="skip" onclick="toggleCOFFRequirement()">
                        <span class="radio-custom"></span>
                        <span class="radio-label">Skip Regularization</span>
                    </label>
                </div>
                <div id="coffRequirement" style="padding: 10px; background: #e8f4fc; border-radius: 5px; margin-top: 10px; display: block;">
                    <strong>COFF Required:</strong> <span id="coffHoursRequired">0</span> hours<br>
                    <small>Based on delay calculation</small>
                </div>
            </div>
            <div class="form-group">
                <label for="lateEntryReason">Reason for Late Entry:</label>
                <textarea id="lateEntryReason" rows="2" placeholder="e.g., Traffic, Personal emergency"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveLateEntry()">Save Late Entry</button>
                <button class="btn-secondary" onclick="closeModal('lateEntryModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for extra hours -->
    <div id="extraHoursModal" class="modal">
        <div class="modal-content">
            <h3>Add Extra Working Hours</h3>
            <div class="form-group">
                <label for="extraHoursStaff">Staff Member:</label>
                <select id="extraHoursStaff">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="extraHoursDate">Date:</label>
                <input type="date" id="extraHoursDate">
            </div>
            <div class="form-group">
                <label for="extraHours">Extra Hours:</label>
                <select id="extraHours">
                    <option value="0.5">0.5 hour</option>
                    <option value="1">1 hour</option>
                    <option value="1.5">1.5 hours</option>
                    <option value="2">2 hours</option>
                    <option value="2.5">2.5 hours</option>
                    <option value="3">3 hours</option>
                    <option value="3.5">3.5 hours</option>
                    <option value="4">4 hours</option>
                    <option value="4.5">4.5 hours</option>
                    <option value="5">5 hours</option>
                    <option value="5.5">5.5 hours</option>
                    <option value="6">6 hours</option>
                    <option value="6.5">6.5 hours</option>
                    <option value="7">7 hours</option>
                    <option value="7.5">7.5 hours</option>
                    <option value="8">8 hours (Full day)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="extraHoursReason">Reason:</label>
                <textarea id="extraHoursReason" rows="3" placeholder="Reason for extra hours"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveExtraHours()">Save Extra Hours</button>
                <button class="btn-secondary" onclick="closeModal('extraHoursModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for cancel off-duty working -->
    <div id="cancelOffDutyModal" class="modal">
        <div class="modal-content">
            <h3>Cancel Off-Duty Working Entry</h3>
            <div class="form-group">
                <label for="cancelOffDutyDate">Select Date:</label>
                <input type="date" id="cancelOffDutyDate" onchange="loadOffDutyForDate()">
            </div>
            <div id="offDutyListContainer">
                <!-- Off-duty list will be populated by JavaScript -->
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('cancelOffDutyModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Modal for COFF application -->
    <div id="applyCOFFModal" class="modal">
        <div class="modal-content">
            <h3>Apply for Compensatory Off (COFF)</h3>
            <div class="form-group">
                <label for="coffStaff">Staff Member:</label>
                <select id="coffStaff" onchange="updateCOFFBalanceDisplay()">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label>COFF Period:</label>
                <div class="date-range-group">
                    <div class="form-group">
                        <label for="coffFromDate">From Date:</label>
                        <input type="date" id="coffFromDate" onchange="updateCoffToDate()">
                    </div>
                    <div style="align-self: center;">to</div>
                    <div class="form-group">
                        <label for="coffToDate">To Date:</label>
                        <input type="date" id="coffToDate">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="coffReason">Reason:</label>
                <textarea id="coffReason" rows="3" placeholder="Reason for compensatory off"></textarea>
            </div>
            <div class="coff-summary">
                <h4>Your COFF Balance</h4>
                <div id="coffBalanceDisplay">Calculating...</div>
            </div>
            <div class="button-group">
                <button onclick="submitCOFF()">Submit COFF Request</button>
                <button class="btn-secondary" onclick="closeModal('applyCOFFModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding/removing holiday -->
    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <h3>Add/Remove Holiday</h3>
            <div class="form-group">
                <label for="holidayName">Holiday Name:</label>
                <input type="text" id="holidayName" placeholder="e.g., New Year, Diwali, Christmas">
            </div>
            <div class="form-group">
                <label for="holidayDate">Date:</label>
                <input type="date" id="holidayDate" onchange="checkExistingHoliday()">
            </div>
            <div id="existingHolidayInfo" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                <!-- Existing holiday info will be shown here -->
            </div>
            <div class="button-group">
                <button id="holidayActionBtn" onclick="saveHoliday()">Add Holiday</button>
                <button class="btn-secondary" onclick="closeModal('holidayModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for adding/removing skeleton shift -->
    <div id="skeletonModal" class="modal">
        <div class="modal-content">
            <h3>Add/Remove Skeleton Shift</h3>
            <div class="form-group">
                <label for="skeletonDate">Date:</label>
                <input type="date" id="skeletonDate" onchange="checkExistingSkeleton()">
            </div>
            <div class="form-group">
                <label for="skeletonHours">Skeleton Hours:</label>
                <select id="skeletonHours">
                    <option value="4">4 hours (Half day)</option>
                    <option value="8">8 hours (Full day)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Exclude Employees from OT:</label>
                <div class="staff-exclusion-list" id="skeletonExcludeList">
                    <!-- Staff exclusion checkboxes will be populated here -->
                </div>
            </div>
            <div class="form-group">
                <label for="skeletonReason">Reason:</label>
                <textarea id="skeletonReason" rows="3" placeholder="Reason for skeleton shift"></textarea>
            </div>
            <div id="existingSkeletonInfo" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                <!-- Existing skeleton info will be shown here -->
            </div>
            <div class="button-group">
                <button id="skeletonActionBtn" onclick="saveSkeletonShift()">Add Skeleton Shift</button>
                <button class="btn-secondary" onclick="closeModal('skeletonModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for approval with reason -->
    <div id="approvalReasonModal" class="modal">
        <div class="modal-content">
            <h3>Approve/Reject Leave</h3>
            <div class="form-group">
                <label for="approvalReason">Reason (Optional):</label>
                <textarea id="approvalReason" rows="3" placeholder="Enter reason for approval/rejection"></textarea>
            </div>
            <div class="button-group">
                <button id="approveWithReasonBtn" class="btn-success" onclick="approveLeaveWithReason()">Approve</button>
                <button id="rejectWithReasonBtn" class="btn-danger" onclick="rejectLeaveWithReason()">Reject</button>
                <button class="btn-secondary" onclick="closeModal('approvalReasonModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ============== FIRESTORE CONFIGURATION ==============
        const firebaseConfig = {
            apiKey: "AIzaSyBsZb_05bhHF7Mu5qPlZMgl3Ekpi2Citiw",
            authDomain: "phc-shift.firebaseapp.com",
            projectId: "phc-shift",
            storageBucket: "phc-shift.firebasestorage.app",
            messagingSenderId: "426348959034",
            appId: "1:426348959034:web:2936bf71ff1aae92caac03",
            measurementId: "G-W2GSMLFT9J"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize services
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============== GLOBAL VARIABLES ==============
        // Replace the initial shiftData object with the updated one:
        let shiftData = {
            days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
            shifts: {
                "Sunday": {
                    "Sreejith": "Obituary duty 5pm-1:30am",
                    "Sajeev": "5pm-1:30am",
                    "Umesh": "5pm-1:30am",
                    "Rajesh": "7pm-3:30pm",
                    "ANEESH": "7:00pm-3:30am"
                },
                "Monday": {
                    "Sreejith": "Obituary duty 5pm-1:30am",
                    "Sajeev": "Off-operator",
                    "Umesh": "5pm-1:30am",
                    "Rajesh": "7pm-3:30pm",
                    "ANEESH": "7:00pm-3:30am"
                },
                "Tuesday": {
                    "Sreejith": "5pm-1:30am",
                    "Sajeev": "Obituary duty 5pm-1:30am",
                    "Umesh": "Off-operator",
                    "Rajesh": "7pm-3:30pm",
                    "ANEESH": "7:00pm-3:30am"
                },
                "Wednesday": {
                    "Sreejith": "Off-operator",
                    "Sajeev": "5pm-1:30am",
                    "Umesh": "Obituary duty 5pm-1:30am",
                    "Rajesh": "7pm-3:30pm",
                    "ANEESH": "Off-operator"
                },
                "Thursday": {
                    "Sreejith": "Obituary duty 5pm-1:30am",
                    "Sajeev": "4pm-12:30pm",
                    "Umesh": "5pm-1:30am",
                    "Rajesh": "7pm-3:30pm",
                    "ANEESH": "7:00pm-3:30am"
                },
                "Friday": {
                    "Sreejith": "5pm-1:30am",
                    "Sajeev": "Obituary duty 5pm-1:30am",
                    "Umesh": "7pm-3:30pm",
                    "Rajesh": "Off-operator",
                    "ANEESH": "7:00pm-3:30am"
                },
                "Saturday": {
                    "Sreejith": "4pm-12:30pm",
                    "Sajeev": "5pm-1:30am",
                    "Umesh": "Obituary duty 5pm-1:30am",
                    "Rajesh": "7pm-3:30pm",
                    "ANEESH": "7:00pm-3:30am"
                }
            }
        };
        let leaveData = {};
        let leaveRequests = [];
        let offDutyEntries = {};
        let onDutyEntries = {};
        let extraHoursData = {};
        let coffData = { balances: {}, pending: [], history: [] };
        let holidays = {};
        let skeletonShifts = {};
        let otData = { monthly: {} };
        let lateEntries = { entries: [] };

        let currentUser = null;
        let currentUserRole = 'viewer';
        let currentUserData = null;
        let allUsers = [];

        // Unsubscribe functions for real-time listeners
        let unsubscribeListeners = {
            shiftData: null,
            leaveRequests: null,
            offDutyEntries: null,
            onDutyEntries: null,
            extraHoursData: null,
            coffData: null,
            holidays: null,
            skeletonShifts: null,
            lateEntries: null,
            users: null
        };

        // Staff name abbreviations
        const staffAbbreviations = {
            "Sreejith": "SKS",
            "Sajeev": "SJV",
            "Umesh": "UMU",
            "Rajesh": "MR",
            "ANEESH": "AMR"
        };

        // View state
        let currentWeekStart = new Date();
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentDayView = new Date();

        // Attendance report navigation state
        let currentAttendancePeriod = 0;
        let currentAttendanceStartDate = null;
        let currentAttendanceEndDate = null;

        // For approval modal
        let currentApprovalRequestId = null;
        let currentApprovalAction = null;

        // Get current date
        const today = new Date();
        const currentDateStr = today.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // ============== AUTHENTICATION FUNCTIONS ==============
        function showLoginTab() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));

            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        }

        function showRegisterTab() {
            document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));

            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('registerForm').classList.add('active');
        }

        function showAuthLoading(show) {
            document.getElementById('authLoading').style.display = show ? 'block' : 'none';
            document.getElementById('loginButton').disabled = show;
            document.getElementById('registerButton').disabled = show;
        }

        function showAuthSuccess(show) {
            document.getElementById('authSuccess').style.display = show ? 'block' : 'none';
        }

        function clearAuthErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
                el.textContent = '';
            });

            document.querySelectorAll('.form-group input, .form-group select').forEach(el => {
                el.classList.remove('error');
            });
        }

        function showAuthError(field, message) {
            const errorElement = document.getElementById(field + 'Error');
            const inputElement = document.getElementById(field);

            if (errorElement && inputElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                inputElement.classList.add('error');
            }
        }

        async function loginUser() {
            clearAuthErrors();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            // Validation
            if (!email) {
                showAuthError('loginEmail', 'Email is required');
                return;
            }

            if (!password) {
                showAuthError('loginPassword', 'Password is required');
                return;
            }

            if (!validateEmail(email)) {
                showAuthError('loginEmail', 'Please enter a valid email address');
                return;
            }

            showAuthLoading(true);

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                console.log('User logged in:', userCredential.user.email);

                // Show success state
                showAuthSuccess(true);

                // Authentication state change will handle the rest
            } catch (error) {
                showAuthLoading(false);
                showAuthSuccess(false);

                switch (error.code) {
                    case 'auth/user-not-found':
                        showAuthError('loginEmail', 'No account found with this email');
                        break;
                    case 'auth/wrong-password':
                        showAuthError('loginPassword', 'Incorrect password');
                        break;
                    case 'auth/invalid-email':
                        showAuthError('loginEmail', 'Invalid email format');
                        break;
                    case 'auth/user-disabled':
                        showAuthError('loginEmail', 'This account has been disabled');
                        break;
                    default:
                        showAuthError('loginEmail', 'Login failed. Please try again.');
                        console.error('Login error:', error);
                }
            }
        }

        async function registerUser() {
            clearAuthErrors();

            const name = document.getElementById('registerName').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;

            // Validation
            if (!name) {
                showAuthError('registerName', 'Name is required');
                return;
            }

            if (!email) {
                showAuthError('registerEmail', 'Email is required');
                return;
            }

            if (!password) {
                showAuthError('registerPassword', 'Password is required');
                return;
            }

            if (!confirmPassword) {
                showAuthError('registerConfirmPassword', 'Please confirm your password');
                return;
            }

            if (!validateEmail(email)) {
                showAuthError('registerEmail', 'Please enter a valid email address');
                return;
            }

            if (password.length < 6) {
                showAuthError('registerPassword', 'Password must be at least 6 characters');
                return;
            }

            if (password !== confirmPassword) {
                showAuthError('registerConfirmPassword', 'Passwords do not match');
                return;
            }

            showAuthLoading(true);

            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    email: email,
                    name: name,
                    role: 'viewer', // Default role
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    isActive: true
                });

                console.log('User registered successfully:', email);

                // Show success state
                showAuthSuccess(true);

            } catch (error) {
                showAuthLoading(false);
                showAuthSuccess(false);

                switch (error.code) {
                    case 'auth/email-already-in-use':
                        showAuthError('registerEmail', 'Email is already registered');
                        break;
                    case 'auth/invalid-email':
                        showAuthError('registerEmail', 'Invalid email format');
                        break;
                    case 'auth/weak-password':
                        showAuthError('registerPassword', 'Password is too weak');
                        break;
                    default:
                        showAuthError('registerEmail', 'Registration failed. Please try again.');
                        console.error('Registration error:', error);
                }
            }
        }

        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        async function logoutUser() {
            try {
                await auth.signOut();
                console.log('User logged out');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        async function loadUserData(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    currentUserData = userDoc.data();
                    currentUserRole = currentUserData.role || 'viewer';

                    console.log('User data loaded:', currentUserData.email, 'Role:', currentUserRole);

                    // Update UI based on role
                    updateUIForRole();

                    // Load all users if admin
                    if (currentUserRole === 'admin') {
                        loadAllUsers();
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateUIForRole() {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            const viewerMessage = document.getElementById('viewerMessage');
            const adminManagementTab = document.getElementById('adminManagementTab');
            const approvalTab = document.querySelector('.tab[onclick*="approvals"]');

            if (currentUserRole === 'admin') {
                adminOnlyElements.forEach(el => el.style.display = 'flex');
                if (viewerMessage) viewerMessage.style.display = 'none';
                if (adminManagementTab) adminManagementTab.style.display = 'block';
                if (approvalTab) approvalTab.style.display = 'block';
                document.body.classList.remove('viewer');
            } else {
                adminOnlyElements.forEach(el => el.style.display = 'none');
                if (viewerMessage) viewerMessage.style.display = 'block';
                if (adminManagementTab) adminManagementTab.style.display = 'none';
                if (approvalTab) approvalTab.style.display = 'none';
                document.body.classList.add('viewer');
            }
        }

        // ============== REAL-TIME LISTENERS ==============
        function setupRealtimeListeners() {
            console.log('Setting up real-time listeners...');

            // Listen for shift data changes
            unsubscribeListeners.shiftData = db.collection('shiftData').doc('current')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        console.log('Shift data updated from Firestore:', data);

                        // Validate the data structure
                        if (data.days && data.shifts) {
                            shiftData = data;
                            console.log('Shift data updated locally');
                        } else {
                            console.error('Invalid shift data structure received:', data);
                            // Try to fix it
                            fixShiftDataStructure();
                        }

                        showUpdateIndicator();
                        updateAllViews();
                    } else {
                        console.warn('Shift data document does not exist in Firestore');
                        // Document was deleted or doesn't exist
                        showMissingDocumentWarning();
                    }
                }, (error) => {
                    console.error('Error listening to shift data:', error);
                    alert('Error connecting to shift data. Please refresh the page.');
                });
            // Listen for leave requests
            unsubscribeListeners.leaveRequests = db.collection('leaveRequests')
                .where('status', '!=', 'cancelled')
                .onSnapshot((snapshot) => {
                    leaveRequests = [];
                    snapshot.forEach((doc) => {
                        leaveRequests.push({ id: doc.id, ...doc.data() });
                    });

                    // Update pending count and badge
                    updatePendingApprovals();
                    showUpdateIndicator();

                    // Update leaveData structure
                    leaveData = {};
                    leaveRequests.forEach(req => {
                        if (req.status === 'approved' && !req.isCOFF) {
                            if (!leaveData[req.date]) {
                                leaveData[req.date] = [];
                            }
                            leaveData[req.date].push(req.staff);
                        }
                    });

                    if (document.getElementById('approvals-tab').classList.contains('active')) {
                        renderApprovals();
                    }
                    updateAllViews();
                }, (error) => {
                    console.error('Error listening to leave requests:', error);
                });

            // Listen for off-duty entries
            unsubscribeListeners.offDutyEntries = db.collection('offDutyEntries')
                .onSnapshot((snapshot) => {
                    offDutyEntries = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        offDutyEntries[data.date] = data;
                    });
                    console.log('Off-duty entries updated');
                    showUpdateIndicator();
                    updateAllViews();
                }, (error) => {
                    console.error('Error listening to off-duty entries:', error);
                });

            // Listen for on-duty entries
            unsubscribeListeners.onDutyEntries = db.collection('onDutyEntries')
                .onSnapshot((snapshot) => {
                    onDutyEntries = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        onDutyEntries[data.date] = data;
                    });
                    console.log('On-duty entries updated');
                    showUpdateIndicator();
                    updateAllViews();
                }, (error) => {
                    console.error('Error listening to on-duty entries:', error);
                });

            // Listen for extra hours data
            unsubscribeListeners.extraHoursData = db.collection('extraHoursData')
                .onSnapshot((snapshot) => {
                    extraHoursData = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const key = data.date + '_' + data.staff;
                        extraHoursData[key] = data;
                    });

                    console.log('Extra hours data updated:', Object.values(extraHoursData).length, 'entries');

                    // Recalculate COFF balances
                    calculateCOFFBalances();

                    showUpdateIndicator();
                    updateAllViews();

                }, (error) => {
                    console.error('Error listening to extra hours data:', error);
                });

            // Listen for COFF data
            unsubscribeListeners.coffData = db.collection('coffData')
                .onSnapshot((snapshot) => {
                    coffData = { balances: {}, pending: [], history: [] };
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.type === 'balance') {
                            coffData.balances[data.staff] = data.balance || 0;
                        } else if (data.type === 'pending') {
                            coffData.pending.push(data);
                        } else if (data.type === 'history') {
                            coffData.history.push(data);
                        }
                    });
                    console.log('COFF data updated');
                    showUpdateIndicator();
                    updateStats();

                    if (document.getElementById('coff-tab').classList.contains('active')) {
                        renderCOFFSummary();
                        renderCOFFHistory();
                    }
                }, (error) => {
                    console.error('Error listening to COFF data:', error);
                });

            // Listen for holidays
            unsubscribeListeners.holidays = db.collection('holidays')
                .onSnapshot((snapshot) => {
                    holidays = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        holidays[data.date] = data;
                    });
                    console.log('Holidays updated');
                    showUpdateIndicator();
                    updateAllViews();
                }, (error) => {
                    console.error('Error listening to holidays:', error);
                });

            // Listen for skeleton shifts
            unsubscribeListeners.skeletonShifts = db.collection('skeletonShifts')
                .onSnapshot((snapshot) => {
                    skeletonShifts = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        skeletonShifts[data.date] = data;
                    });
                    console.log('Skeleton shifts updated');
                    showUpdateIndicator();
                    calculateSkeletonOT();
                    updateAllViews();
                }, (error) => {
                    console.error('Error listening to skeleton shifts:', error);
                });

            // Listen for late entries
            unsubscribeListeners.lateEntries = db.collection('lateEntries')
                .onSnapshot((snapshot) => {
                    lateEntries = { entries: [] };
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        lateEntries.entries.push(data);
                    });
                    console.log('Late entries updated');
                    showUpdateIndicator();
                    updateAllViews();
                }, (error) => {
                    console.error('Error listening to late entries:', error);
                });

            // Listen for users (admin only)
            if (currentUserRole === 'admin') {
                unsubscribeListeners.users = db.collection('users')
                    .onSnapshot((snapshot) => {
                        allUsers = [];
                        snapshot.forEach((doc) => {
                            allUsers.push({ id: doc.id, ...doc.data() });
                        });
                        console.log('Users updated:', allUsers.length);

                        if (document.getElementById('adminManagementModal').style.display === 'flex') {
                            renderAdminUserList();
                        }
                    }, (error) => {
                        console.error('Error listening to users:', error);
                    });
            }
        }

        function showUpdateIndicator() {
            const indicator = document.getElementById('updateIndicator');
            indicator.style.display = 'block';

            setTimeout(() => {
                indicator.style.display = 'none';
            }, 2000);
        }

        // ============== HELPER FUNCTIONS ==============
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDateForDisplay(date) {
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                weekday: 'short'
            });
        }

        function checkIfOnLeave(staff, date) {
            const dateKey = formatDateForInput(date);
            return leaveRequests.some(req =>
                req.staff === staff &&
                req.date === dateKey &&
                req.status === 'approved'
            );
        }

        function getLeaveStatus(staff, date) {
            const dateKey = formatDateForInput(date);
            const request = leaveRequests.find(req =>
                req.staff === staff && req.date === dateKey
            );
            return request ? request.status : null;
        }

        function checkOffDutyWorking(staff, date) {
            const dateKey = formatDateForInput(date);
            return offDutyEntries[dateKey] && offDutyEntries[dateKey].staff === staff;
        }

        function checkOnDuty(staff, date) {
            const dateKey = formatDateForInput(date);
            return onDutyEntries[dateKey] && onDutyEntries[dateKey].staff === staff;
        }

        function checkExtraHours(staff, date) {
            const dateKey = formatDateForInput(date);
            return extraHoursData[dateKey] && extraHoursData[dateKey].staff === staff;
        }

        function checkLateEntry(staff, date) {
            const dateKey = formatDateForInput(date);
            return lateEntries.entries.some(entry =>
                entry.staff === staff && entry.date === dateKey
            );
        }

        function getLateEntry(staff, date) {
            const dateKey = formatDateForInput(date);
            return lateEntries.entries.find(entry =>
                entry.staff === staff && entry.date === dateKey
            );
        }

        function getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry) {
            if (hasLateEntry) return 'status-late-entry';
            if (leaveStatus === 'pending') return 'status-leave-pending';
            if (leaveStatus === 'approved') return 'status-leave-approved';
            if (leaveStatus === 'rejected') return 'status-leave-rejected';
            if (isOffDutyWorking) return 'status-off-duty-working';
            if (isOnDuty) return 'status-on-duty';
            if (hasExtraHours) return 'status-extra-hours';
            if (shift && shift.includes('Obituary')) return 'status-obituary';
            if (shift && shift.includes('Off')) return 'status-off';
            return 'status-available';
        }

        function getDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                dates.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            return dates;
        }

        // ============== PENDING APPROVALS ==============
        function updatePendingApprovals() {
            const pendingCount = leaveRequests.filter(req => req.status === 'pending').length;
            document.getElementById('pending-count').textContent = pendingCount;

            const badge = document.getElementById('approvalBadge');
            if (pendingCount > 0) {
                badge.textContent = pendingCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // ============== ADMIN FUNCTIONS ==============
        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users').get();
                allUsers = [];
                snapshot.forEach(doc => {
                    allUsers.push({ id: doc.id, ...doc.data() });
                });
                console.log('Loaded', allUsers.length, 'users');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function renderAdminUserList() {
            const container = document.getElementById('adminUserList');
            if (!container) return;

            container.innerHTML = '';

            allUsers.forEach(user => {
                if (!user.name) return; // Skip invalid users

                const item = document.createElement('div');
                item.className = 'admin-user-item';

                item.innerHTML = `
                            <div class="admin-user-info">
                                <div class="name">${user.name}</div>
                                <div class="email">${user.email}</div>
                                <div class="role ${user.role}">${user.role.toUpperCase()}</div>
                            </div>
                            <div class="admin-user-actions">
                                ${user.role === 'viewer' ?
                        `<button onclick="adminUpdateRole('${user.id}', 'admin')" class="btn-success" style="padding: 8px 12px; font-size: 12px;">Make Admin</button>` :
                        `<button onclick="adminUpdateRole('${user.id}', 'viewer')" class="btn-warning" style="padding: 8px 12px; font-size: 12px;">Make Viewer</button>`
                    }
                                ${user.id !== currentUser.uid ?
                        `<button onclick="adminDeleteUser('${user.id}')" class="btn-danger" style="padding: 8px 12px; font-size: 12px;">Delete</button>` : ''
                    }
                            </div>
                        `;

                container.appendChild(item);
            });
        }

        async function adminUpdateRole(userId, newRole) {
            if (!confirm(`Are you sure you want to change this user's role to ${newRole}?`)) {
                return;
            }

            try {
                await db.collection('users').doc(userId).update({
                    role: newRole,
                    updatedAt: new Date().toISOString()
                });

                alert('User role updated successfully');
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('Failed to update user role');
            }
        }

        async function adminDeleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                // Delete from Firestore
                await db.collection('users').doc(userId).delete();

                // Note: We're not deleting from Firebase Auth for security reasons
                // Admins should handle Auth deletion through Firebase Console if needed

                alert('User deleted successfully');
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            }
        }

        async function adminAddUser() {
            const email = document.getElementById('adminNewUserEmail').value.trim();
            const role = document.getElementById('adminNewUserRole').value;

            if (!email || !validateEmail(email)) {
                alert('Please enter a valid email address');
                return;
            }

            // Check if user already exists
            const existingUser = allUsers.find(u => u.email === email);
            if (existingUser) {
                alert('A user with this email already exists');
                return;
            }

            try {
                // Create user in Firebase Auth
                const password = Math.random().toString(36).slice(-8); // Generate random password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    email: email,
                    name: email.split('@')[0], // Use email prefix as name
                    role: role,
                    createdAt: new Date().toISOString(),
                    lastLogin: null,
                    isActive: true
                });

                // Send password reset email so user can set their own password
                await auth.sendPasswordResetEmail(email);

                alert(`User created successfully! An email has been sent to ${email} to set their password.`);

                // Clear form
                document.getElementById('adminNewUserEmail').value = '';

            } catch (error) {
                console.error('Error adding user:', error);

                switch (error.code) {
                    case 'auth/email-already-in-use':
                        alert('Email is already registered');
                        break;
                    case 'auth/invalid-email':
                        alert('Invalid email format');
                        break;
                    default:
                        alert('Failed to create user. Please try again.');
                }
            }
        }

        // ============== PROFILE FUNCTIONS ==============
        function showProfile() {
            if (!currentUserData) return;

            document.getElementById('profileName').textContent = currentUserData.name || currentUser.email;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileRole').textContent = currentUserData.role || 'viewer';

            // Set avatar initial
            const avatar = document.getElementById('profileAvatar');
            const name = currentUserData.name || currentUser.email;
            avatar.textContent = name.charAt(0).toUpperCase();

            // Format dates
            if (currentUserData.createdAt) {
                const created = new Date(currentUserData.createdAt);
                document.getElementById('profileCreated').textContent = created.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            if (currentUserData.lastLogin) {
                const lastLogin = new Date(currentUserData.lastLogin);
                document.getElementById('profileLastLogin').textContent = lastLogin.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            openModal('profileModal');
        }

        function showAdminManagement() {
            if (currentUserRole !== 'admin') {
                alert('Access denied. Admin privileges required.');
                return;
            }

            renderAdminUserList();
            openModal('adminManagementModal');
        }

        // ============== INITIALIZATION ==============
         async function initializeFirestoreData() {
            console.log('Initializing Firestore data structure...');

            try {
                // Check if shift data exists
                const shiftDoc = await db.collection('shiftData').doc('current').get();

                if (!shiftDoc.exists) {
                    console.log('Creating shift data document...');

                    // Create the document with our initial shift data
                    await db.collection('shiftData').doc('current').set({
                        days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                        shifts: {
                            "Sunday": {
                                "Sreejith": "Obituary duty 5pm-1:30am",
                                "Sajeev": "5pm-1:30am",
                                "Umesh": "5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Monday": {
                                "Sreejith": "Obituary duty 5pm-1:30am",
                                "Sajeev": "Off-operator",
                                "Umesh": "5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Tuesday": {
                                "Sreejith": "5pm-1:30am",
                                "Sajeev": "Obituary duty 5pm-1:30am",
                                "Umesh": "Off-operator",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Wednesday": {
                                "Sreejith": "Off-operator",
                                "Sajeev": "5pm-1:30am",
                                "Umesh": "Obituary duty 5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "Off-operator"
                            },
                            "Thursday": {
                                "Sreejith": "Obituary duty 5pm-1:30am",
                                "Sajeev": "4pm-12:30pm",
                                "Umesh": "5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Friday": {
                                "Sreejith": "5pm-1:30am",
                                "Sajeev": "Obituary duty 5pm-1:30am",
                                "Umesh": "7pm-3:30pm",
                                "Rajesh": "Off-operator",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Saturday": {
                                "Sreejith": "4pm-12:30pm",
                                "Sajeev": "5pm-1:30am",
                                "Umesh": "Obituary duty 5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            }
                        },
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        lastUpdatedBy: 'system'
                    });

                    console.log('Shift data document created successfully');

                    // Also create the global shiftData object
                    shiftData = {
                        days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                        shifts: {
                            "Sunday": {
                                "Sreejith": "Obituary duty 5pm-1:30am",
                                "Sajeev": "5pm-1:30am",
                                "Umesh": "5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Monday": {
                                "Sreejith": "Obituary duty 5pm-1:30am",
                                "Sajeev": "Off-operator",
                                "Umesh": "5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Tuesday": {
                                "Sreejith": "5pm-1:30am",
                                "Sajeev": "Obituary duty 5pm-1:30am",
                                "Umesh": "Off-operator",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Wednesday": {
                                "Sreejith": "Off-operator",
                                "Sajeev": "5pm-1:30am",
                                "Umesh": "Obituary duty 5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "Off-operator"
                            },
                            "Thursday": {
                                "Sreejith": "Obituary duty 5pm-1:30am",
                                "Sajeev": "4pm-12:30pm",
                                "Umesh": "5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Friday": {
                                "Sreejith": "5pm-1:30am",
                                "Sajeev": "Obituary duty 5pm-1:30am",
                                "Umesh": "7pm-3:30pm",
                                "Rajesh": "Off-operator",
                                "ANEESH": "7:00pm-3:30am"
                            },
                            "Saturday": {
                                "Sreejith": "4pm-12:30pm",
                                "Sajeev": "5pm-1:30am",
                                "Umesh": "Obituary duty 5pm-1:30am",
                                "Rajesh": "7pm-3:30pm",
                                "ANEESH": "7:00pm-3:30am"
                            }
                        }
                    };

                } else {
                    // Document exists, load the data
                    const data = shiftDoc.data();
                    console.log('Loaded shift data from Firestore:', data);

                    // Update the global shiftData object
                    if (data.days && data.shifts) {
                        shiftData = data;
                    } else {
                        console.warn('Firestore data has unexpected structure, using defaults');
                    }
                }

                console.log('Firestore data initialization complete');

            } catch (error) {
                console.error('Error initializing Firestore data:', error);
                console.error('Error details:', error.message, error.stack);

                // Show user-friendly error
                alert('Error initializing data. Please refresh the page or contact administrator.\n\nError: ' + error.message);
            }
        }
        async function initApp() {
            // Check authentication state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;

                    // Update user's last login
                    await db.collection('users').doc(user.uid).update({
                        lastLogin: new Date().toISOString()
                    });

                    // Load user data
                    await loadUserData(user.uid);

                    // Show main interface
                    document.getElementById('authModal').style.display = 'none';
                    document.querySelector('.container').style.display = 'block';
                    document.getElementById('profileTab').style.display = 'block';

                    // Show admin tab if user is admin
                    if (currentUserRole === 'admin') {
                        document.getElementById('adminManagementTab').style.display = 'block';
                    }

                    // Initialize Firestore data structure
                    await initializeFirestoreData();

                    // Set up real-time listeners
                    setupRealtimeListeners();

                    // Initialize UI
                    document.getElementById('current-date').textContent = currentDateStr;
                    updateStats();
                    renderStaffList();
                    renderWeekView();
                    renderMonthView();
                    renderTodayView();
                    updateWeekTitle();
                    updateMonthTitle();
                    updateDayTitle();

                    // Set default dates for modals
                    setDefaultDates();

                    // Initialize COFF tab
                    renderCOFFSummary();
                    renderCOFFHistory();

                    // Initialize approvals tab
                    renderApprovals();

                    // Calculate OT for skeleton shifts
                    calculateSkeletonOT();

                    // Calculate COFF balances on init
                    calculateCOFFBalances();

                    // Add touch event listeners
                    initTouchEvents();

                } else {
                    // No user is signed in, show auth modal
                    document.getElementById('authModal').style.display = 'flex';
                    document.querySelector('.container').style.display = 'none';
                    showLoginTab();

                    // Clean up listeners
                    cleanupListeners();
                }
            });
        }

        // Clean up listeners
        function cleanupListeners() {
            Object.values(unsubscribeListeners).forEach(unsubscribe => {
                if (unsubscribe && typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            unsubscribeListeners = {
                shiftData: null,
                leaveRequests: null,
                offDutyEntries: null,
                onDutyEntries: null,
                extraHoursData: null,
                coffData: null,
                holidays: null,
                skeletonShifts: null,
                lateEntries: null,
                users: null
            };
        }

        // ============== CORE FUNCTIONS ==============
        function updateAllViews() {
            renderWeekView();
            renderMonthView();
            renderTodayView();
            renderStaffList();
            if (document.getElementById('coff-tab').classList.contains('active')) {
                renderCOFFSummary();
                renderCOFFHistory();
            }
        }

        function updateStats() {
            const pendingCount = leaveRequests.filter(req => req.status === 'pending').length;
            document.getElementById('pending-count').textContent = pendingCount;

            let totalCoffBalance = 0;
            Object.values(coffData.balances).forEach(balance => {
                totalCoffBalance += balance;
            });
            document.getElementById('coff-balance').textContent = totalCoffBalance.toFixed(1) + ' days';
        }

        function renderStaffList() {
            const staffList = document.getElementById('staff-list');
            const staff = [
                { name: "Sreejith", type: "Operator", abbrev: "SKS" },
                { name: "Sajeev", type: "Operator", abbrev: "SJV" },
                { name: "Umesh", type: "Operator", abbrev: "UMU" },
                { name: "Rajesh", type: "Operator", abbrev: "MR" },
                { name: "ANEESH", type: "CTP Operator", abbrev: "AMR" }
            ];

            staffList.innerHTML = '';
            staff.forEach(person => {
                const div = document.createElement('div');
                div.className = `staff-item ${person.type === 'CTP Operator' ? 'ctp-operator' : ''}`;
                div.innerHTML = `
                            <div style="font-weight: bold; font-size: 0.9em;">${person.name}</div>
                            <div style="font-size: 0.75em; color: #666;">${person.type} (${person.abbrev})</div>
                        `;
                staffList.appendChild(div);
            });
        }

        function renderTodayView() {
            const container = document.getElementById('todayViewContainer');
            const date = currentDayView;
            const dayIndex = date.getDay();
            const dayName = shiftData.days[dayIndex];
            const dateStr = formatDateForDisplay(date);

            const isToday = date.toDateString() === today.toDateString();
            const dateKey = formatDateForInput(date);
            const isHoliday = holidays[dateKey];
            const isSkeleton = skeletonShifts[dateKey];

            let html = `
                        <div class="day-header" style="margin-bottom: 15px;">
                            <div class="day-name">${dayName}</div>
                            <div class="date">${dateStr}</div>
                        </div>
                    `;

            // Add holiday/skeleton marker
            if (isHoliday) {
                html += `<div class="holiday-marker" style="position: static; margin-bottom: 10px; padding: 5px 8px; font-size: 0.8em;">HOLIDAY: ${holidays[dateKey].name}</div>`;
            } else if (isSkeleton) {
                html += `<div class="skeleton-marker" style="position: static; margin-bottom: 10px; padding: 5px 8px; font-size: 0.8em;">SKELETON SHIFT: ${skeletonShifts[dateKey].hours} hours</div>`;
            }

            // Get all staff for today
            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            let availableOperators = 0;

            staffList.forEach(staff => {
                const shift = shiftData.shifts[dayName][staff];
                const isOnLeave = checkIfOnLeave(staff, date);
                const isOffDutyWorking = checkOffDutyWorking(staff, date);
                const isOnDuty = checkOnDuty(staff, date);
                const hasExtraHours = checkExtraHours(staff, date);
                const leaveStatus = getLeaveStatus(staff, date);
                const hasLateEntry = checkLateEntry(staff, date);
                const abbrev = staffAbbreviations[staff];

                let statusClass = '';
                let statusText = '';
                let badge = '';
                let shiftDisplay = shift || 'Not Scheduled';

                if (hasLateEntry) {
                    statusClass = 'late-entry';
                    const lateEntry = getLateEntry(staff, date);
                    statusText = `Late Entry: ${lateEntry.delayMinutes} min delay`;
                    badge = '<span class="badge late-entry-badge">LATE</span>';
                    shiftDisplay = lateEntry.actualTime || shiftDisplay;
                    availableOperators++;
                } else if (leaveStatus === 'pending') {
                    statusClass = 'leave-pending';
                    statusText = 'Pending Leave';
                    badge = '<span class="badge leave-pending-badge">PENDING</span>';
                } else if (leaveStatus === 'approved') {
                    statusClass = 'leave-approved';
                    statusText = 'On Leave';
                    badge = '<span class="badge leave-approved-badge">LEAVE</span>';
                } else if (leaveStatus === 'rejected') {
                    statusClass = 'leave-rejected';
                    statusText = 'Leave Rejected';
                    badge = '<span class="badge leave-rejected-badge">REJECTED</span>';
                } else if (isOffDutyWorking) {
                    statusClass = 'off-duty-working';
                    statusText = 'Off-duty Working';
                    const entry = offDutyEntries[dateKey];
                    shiftDisplay = entry ? entry.shift : shiftDisplay;
                    badge = '<span class="badge off-duty-working-badge">OFF-DUTY</span>';
                    availableOperators++;
                } else if (isOnDuty) {
                    statusClass = 'on-duty';
                    const entry = onDutyEntries[dateKey];
                    statusText = entry && entry.type === 'extra' ? `On Duty (+${entry.hours}h extra)` : 'On Duty (OD)';
                    badge = '<span class="badge on-duty-badge">OD</span>';
                    availableOperators++;
                } else if (hasExtraHours) {
                    statusClass = 'extra-hours';
                    const extra = extraHoursData[dateKey];
                    statusText = `+${extra.hours} extra hours`;
                    badge = '<span class="badge extra-hours-badge">EXTRA</span>';
                    availableOperators++;
                } else if (shift && shift.includes('Obituary')) {
                    statusClass = 'obituary-duty';
                    statusText = 'Obituary Duty';
                    availableOperators++;
                    badge = '<span class="badge obituary-badge">OBITUARY</span>';
                } else if (shift && shift.includes('Off')) {
                    statusClass = 'off-duty';
                    statusText = 'Off Duty';
                } else if (shift && !isOnLeave) {
                    availableOperators++;
                }

                if (isHoliday) {
                    badge += '<span class="badge holiday-badge">HOLIDAY</span>';
                    statusText = 'Holiday';
                }

                if (isSkeleton) {
                    badge += '<span class="badge skeleton-badge">SKELETON</span>';
                    statusText = 'Skeleton Shift';
                }

                html += `
                            <div class="shift-item ${statusClass}">
                                <div class="operator-name">
                                    <span class="status-indicator ${getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry)}"></span>
                                    ${abbrev} (${staff})
                                    ${badge}
                                </div>
                                <div class="shift-time">${shiftDisplay}</div>
                            </div>
                            ${statusText ? `<div style="font-size: 0.75em; color: #666; margin-left: 20px; margin-bottom: 5px;">${statusText}</div>` : ''}
                        `;
            });

            // Add operator count
            html += `
                        <div class="operator-count-display" style="margin-top: 15px;">
                            <div class="operator-count-item">
                                <span class="operator-dot available"></span>
                                <span>Available Operators: ${availableOperators}/5</span>
                            </div>
                        </div>
                    `;

            // Add warnings
            if (availableOperators <= 2) {
                html += `<div class="warning" style="margin-top: 12px;"> Minimum operators only (${availableOperators} available)</div>`;
            } else if (availableOperators < 2) {
                html += `<div class="warning critical" style="margin-top: 12px;"> CRITICAL: Less than 2 operators available!</div>`;
            }

            container.innerHTML = html;
        }

        function renderWeekView() {
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';

            for (let i = 0; i < 7; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(currentWeekStart.getDate() + i);
                const dayIndex = date.getDay();
                const dayName = shiftData.days[dayIndex];
                const dateStr = formatDateForDisplay(date);

                const isToday = date.toDateString() === today.toDateString();

                // Check for holiday or skeleton shift
                const dateKey = formatDateForInput(date);
                const isHoliday = holidays[dateKey];
                const isSkeleton = skeletonShifts[dateKey];

                // Count operators by status
                const operators = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                let availableOperators = 0;
                let leaveOperators = 0;
                let offDutyOperators = 0;
                let offDutyWorkingOperators = 0;
                let onDutyOperators = 0;
                let obituaryOperators = 0;
                let extraHoursOperators = 0;
                let lateEntryOperators = 0;

                operators.forEach(op => {
                    const shift = shiftData.shifts[dayName][op];
                    const isOnLeave = checkIfOnLeave(op, date);
                    const isOffDutyWorking = checkOffDutyWorking(op, date);
                    const isOnDuty = checkOnDuty(op, date);
                    const hasExtraHours = checkExtraHours(op, date);
                    const hasLateEntry = checkLateEntry(op, date);

                    if (hasLateEntry) {
                        availableOperators++;
                        lateEntryOperators++;
                    } else if (isOffDutyWorking || isOnDuty) {
                        availableOperators++;
                        if (isOffDutyWorking) offDutyWorkingOperators++;
                        if (isOnDuty) onDutyOperators++;
                    } else if (shift && !shift.includes('Off') && !isOnLeave) {
                        availableOperators++;
                        if (shift.includes('Obituary')) {
                            obituaryOperators++;
                        }
                    }

                    if (isOnLeave) leaveOperators++;
                    if (shift && shift.includes('Off') && !isOffDutyWorking) offDutyOperators++;
                    if (hasExtraHours) extraHoursOperators++;
                });

                // Create day card
                const dayCard = document.createElement('div');
                let additionalClass = '';
                if (isHoliday) additionalClass = 'holiday-cell';
                if (isSkeleton) additionalClass = 'skeleton-cell';
                dayCard.className = `day-card ${isToday ? 'today' : ''} ${additionalClass}`;
                dayCard.onclick = () => showDayDetails(date);

                // Add holiday/skeleton marker
                if (isHoliday) {
                    const marker = document.createElement('div');
                    marker.className = 'holiday-marker';
                    marker.textContent = 'HOLIDAY';
                    dayCard.appendChild(marker);
                } else if (isSkeleton) {
                    const marker = document.createElement('div');
                    marker.className = 'skeleton-marker';
                    marker.textContent = 'SKELETON';
                    dayCard.appendChild(marker);
                }

                // Create header
                const header = document.createElement('div');
                header.className = 'day-header';
                header.innerHTML = `
                            <div class="day-name">${dayName}</div>
                            <div class="date">${dateStr}</div>
                        `;

                // Create shift list
                const shiftList = document.createElement('div');
                shiftList.className = 'shift-list';

                // Add all staff shifts
                const allStaff = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                allStaff.forEach(staff => {
                    const shift = shiftData.shifts[dayName][staff];
                    if (shift || checkOffDutyWorking(staff, date) || checkOnDuty(staff, date) || checkExtraHours(staff, date) || checkIfOnLeave(staff, date) || checkLateEntry(staff, date)) {
                        const leaveStatus = getLeaveStatus(staff, date);
                        const isOffDutyWorking = checkOffDutyWorking(staff, date);
                        const isOnDuty = checkOnDuty(staff, date);
                        const hasExtraHours = checkExtraHours(staff, date);
                        const hasLateEntry = checkLateEntry(staff, date);
                        const abbrev = staffAbbreviations[staff];

                        const shiftItem = document.createElement('div');
                        let statusClass = '';

                        if (hasLateEntry) {
                            statusClass = 'late-entry';
                        } else if (leaveStatus === 'pending') {
                            statusClass = 'leave-pending';
                        } else if (leaveStatus === 'approved') {
                            statusClass = 'leave-approved';
                        } else if (leaveStatus === 'rejected') {
                            statusClass = 'leave-rejected';
                        } else if (isOffDutyWorking) {
                            statusClass = 'off-duty-working';
                        } else if (isOnDuty) {
                            statusClass = 'on-duty';
                        } else if (hasExtraHours) {
                            statusClass = 'extra-hours';
                        } else if (shift && shift.includes('Obituary')) {
                            statusClass = 'obituary-duty';
                        } else if (shift && shift.includes('Off')) {
                            statusClass = 'off-duty';
                        }

                        shiftItem.className = `shift-item ${statusClass}`;

                        let shiftDisplay = shift || '';
                        let badge = '';

                        if (hasLateEntry) {
                            const lateEntry = getLateEntry(staff, date);
                            shiftDisplay = lateEntry.actualTime || shiftDisplay;
                            badge = '<span class="badge late-entry-badge">LATE</span>';
                        } else if (isOffDutyWorking) {
                            const entry = offDutyEntries[dateKey];
                            if (entry && entry.staff === staff) {
                                shiftDisplay = entry.shift;
                                badge = '<span class="badge off-duty-working-badge">OFF-DUTY</span>';
                            }
                        }

                        if (isOnDuty) {
                            const entry = onDutyEntries[dateKey];
                            if (entry && entry.staff === staff) {
                                badge = '<span class="badge on-duty-badge">OD</span>';
                                if (entry.type === 'extra') {
                                    shiftDisplay = (shiftDisplay || 'Shift') + ` +${entry.hours}h extra`;
                                }
                            }
                        }

                        if (hasExtraHours) {
                            const extra = extraHoursData[dateKey];
                            if (extra && extra.staff === staff) {
                                shiftDisplay = (shiftDisplay || 'Shift') + ` +${extra.hours}h extra`;
                                badge += '<span class="badge extra-hours-badge">+EXTRA</span>';
                            }
                        }

                        if (leaveStatus === 'pending') {
                            badge += '<span class="badge leave-pending-badge">PENDING</span>';
                        } else if (leaveStatus === 'approved') {
                            badge += '<span class="badge leave-approved-badge">LEAVE</span>';
                        } else if (leaveStatus === 'rejected') {
                            badge += '<span class="badge leave-rejected-badge">REJECTED</span>';
                        }

                        if (shift && shift.includes('Obituary')) {
                            badge += '<span class="badge obituary-badge">OBITUARY</span>';
                        }

                        if (isHoliday) {
                            badge += '<span class="badge holiday-badge">HOLIDAY</span>';
                        }

                        if (isSkeleton) {
                            badge += '<span class="badge skeleton-badge">SKELETON</span>';
                        }

                        shiftItem.innerHTML = `
                                    <div class="operator-name">
                                        <span class="status-indicator ${getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry)}"></span>
                                        ${abbrev} (${staff}${staff === 'ANEESH' ? ' CTP' : ''})
                                        ${badge}
                                    </div>
                                    <div class="shift-time">${shiftDisplay}</div>
                                `;
                        shiftList.appendChild(shiftItem);
                    }
                });

                // Add operator count with color indicators
                const operatorCount = document.createElement('div');
                operatorCount.className = 'operator-count-display';
                operatorCount.innerHTML = `
                            <div class="operator-count-item">
                                <span class="operator-dot available"></span>
                                <span>Available: ${availableOperators}</span>
                            </div>
                            <div class="operator-count-item">
                                <span class="operator-dot leave"></span>
                                <span>Leave: ${leaveOperators}</span>
                            </div>
                            <div class="operator-count-item">
                                <span class="operator-dot off-duty"></span>
                                <span>Off: ${offDutyOperators}</span>
                            </div>
                            <div class="operator-count-item">
                                <span class="operator-dot on-duty"></span>
                                <span>OD: ${onDutyOperators}</span>
                            </div>
                            <div class="operator-count-item">
                                <span class="operator-dot late-entry"></span>
                                <span>Late: ${lateEntryOperators}</span>
                            </div>
                        `;
                shiftList.appendChild(operatorCount);

                // Add warnings
                if (availableOperators <= 2) {
                    const warning = document.createElement('div');
                    warning.className = 'warning';
                    warning.textContent = ` Minimum operators only (${availableOperators} available)`;
                    shiftList.appendChild(warning);
                } else if (availableOperators < 2) {
                    const warning = document.createElement('div');
                    warning.className = 'warning critical';
                    warning.textContent = ' CRITICAL: Less than 2 operators available!';
                    shiftList.appendChild(warning);
                }

                // Assemble day card
                dayCard.appendChild(header);
                dayCard.appendChild(shiftList);
                calendar.appendChild(dayCard);
            }
        }

        function renderMonthView() {
            const monthGrid = document.getElementById('monthGrid');
            monthGrid.innerHTML = '';

            // Add day headers
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'day-header-cell';
                header.textContent = day;
                monthGrid.appendChild(header);
            });

            // Get first day of month and total days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const totalDays = lastDay.getDate();
            const firstDayIndex = firstDay.getDay();

            // Add empty cells for days before month start
            for (let i = 0; i < firstDayIndex; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell empty';
                monthGrid.appendChild(emptyCell);
            }

            // Add cells for each day of month
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayIndex = date.getDay();
                const dayName = shiftData.days[dayIndex];
                const isToday = date.toDateString() === today.toDateString();
                const dateKey = formatDateForInput(date);
                const isHoliday = holidays[dateKey];
                const isSkeleton = skeletonShifts[dateKey];

                const cell = document.createElement('div');
                let additionalClass = '';
                if (isHoliday) additionalClass = 'holiday-cell';
                if (isSkeleton) additionalClass = 'skeleton-cell';
                cell.className = `day-cell ${isToday ? 'today' : ''} ${additionalClass}`;
                cell.onclick = () => showDayDetails(date);

                // Add holiday/skeleton marker
                if (isHoliday) {
                    const marker = document.createElement('div');
                    marker.className = 'holiday-marker';
                    marker.textContent = 'H';
                    cell.appendChild(marker);
                } else if (isSkeleton) {
                    const marker = document.createElement('div');
                    marker.className = 'skeleton-marker';
                    marker.textContent = 'S';
                    cell.appendChild(marker);
                }

                // Get all staff data for this day
                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                let availableOperators = 0;
                let leaveList = [];
                let offDutyList = [];
                let offDutyWorkingList = [];
                let onDutyList = [];
                let obituaryList = [];
                let extraHoursList = [];
                let pendingLeaveList = [];
                let approvedLeaveList = [];
                let rejectedLeaveList = [];
                let lateEntryList = [];

                staffList.forEach(staff => {
                    const shift = shiftData.shifts[dayName][staff];
                    const isOnLeave = checkIfOnLeave(staff, date);
                    const isOffDutyWorking = checkOffDutyWorking(staff, date);
                    const isOnDuty = checkOnDuty(staff, date);
                    const hasExtraHours = checkExtraHours(staff, date);
                    const leaveStatus = getLeaveStatus(staff, date);
                    const hasLateEntry = checkLateEntry(staff, date);

                    // Count off-duty working and on-duty as available
                    if (hasLateEntry) {
                        availableOperators++;
                        lateEntryList.push(staff);
                    } else if (isOffDutyWorking || isOnDuty) {
                        availableOperators++;
                        if (isOffDutyWorking) offDutyWorkingList.push(staff);
                        if (isOnDuty) onDutyList.push(staff);
                    } else if (shift && !shift.includes('Off') && !isOnLeave) {
                        availableOperators++;
                        if (shift && shift.includes('Obituary')) {
                            obituaryList.push(staff);
                        }
                    }

                    // Track leave status
                    if (isOnLeave) {
                        leaveList.push(staff);
                        if (leaveStatus === 'pending') {
                            pendingLeaveList.push(staff);
                        } else if (leaveStatus === 'approved') {
                            approvedLeaveList.push(staff);
                        } else if (leaveStatus === 'rejected') {
                            rejectedLeaveList.push(staff);
                        }
                    }

                    if (shift && shift.includes('Off') && !isOffDutyWorking) {
                        offDutyList.push(staff);
                    }

                    if (hasExtraHours) {
                        extraHoursList.push(staff);
                    }
                });

                // Format date for display
                const dayStr = date.getDate();

                let cellContent = `
                            <div class="date-num">${dayStr}</div>
                            <div class="day-name">${dayName.substring(0, 3)}</div>
                        `;

                // Show available operators count
                if (availableOperators > 0) {
                    cellContent += `<div class="operator-status-item available">${availableOperators}/5</div>`;
                }

                // Show staff names with full status text
                const allStaffToday = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                allStaffToday.forEach(staff => {
                    const shift = shiftData.shifts[dayName][staff];
                    const isOnLeave = checkIfOnLeave(staff, date);
                    const isOffDutyWorking = checkOffDutyWorking(staff, date);
                    const isOnDuty = checkOnDuty(staff, date);
                    const hasExtraHours = checkExtraHours(staff, date);
                    const leaveStatus = getLeaveStatus(staff, date);
                    const hasLateEntry = checkLateEntry(staff, date);
                    const abbrev = staffAbbreviations[staff];

                    let statusClass = '';
                    let statusText = abbrev;

                    if (hasLateEntry) {
                        statusClass = 'late-entry';
                        const lateEntry = getLateEntry(staff, date);
                        statusText += ` - Late: ${lateEntry.delayMinutes} min`;
                    } else if (leaveStatus === 'pending') {
                        statusClass = 'leave';
                        statusText += ' - Pending Leave';
                    } else if (leaveStatus === 'approved') {
                        statusClass = 'leave';
                        statusText += ' - Leave';
                    } else if (isOffDutyWorking) {
                        statusClass = 'off-duty-working';
                        statusText += ' - Off-duty Working';
                    } else if (isOnDuty) {
                        statusClass = 'on-duty';
                        const entry = onDutyEntries[dateKey];
                        if (entry && entry.staff === staff) {
                            statusText += entry.type === 'extra' ? ` - OD (+${entry.hours}h)` : ' - OD';
                        }
                    } else if (hasExtraHours) {
                        statusClass = 'extra-hours';
                        const extra = extraHoursData[dateKey];
                        if (extra && extra.staff === staff) {
                            statusText += ` - +${extra.hours}h extra`;
                        }
                    } else if (shift && shift.includes('Obituary')) {
                        statusClass = 'obituary';
                        statusText += ' - Obituary Duty';
                    } else if (shift && shift.includes('Off')) {
                        statusClass = 'off-duty';
                        statusText += ' - OFF';
                    } else if (shift) {
                        statusText += ' - Duty';
                    }

                    if (isHoliday) {
                        statusClass = 'holiday';
                        statusText = abbrev + ' - Holiday';
                    }

                    if (isSkeleton) {
                        statusClass = 'skeleton';
                        statusText = abbrev + ' - Skeleton Shift';
                    }

                    cellContent += `<div class="operator-status-item ${statusClass}" title="${staff}">${statusText}</div>`;
                });

                // Show holiday
                if (isHoliday) {
                    cellContent += `<div class="operator-status-item holiday" title="${holidays[dateKey].name}"> ${holidays[dateKey].name.substring(0, 10)}</div>`;
                }

                // Show skeleton shift
                if (isSkeleton) {
                    const skeleton = skeletonShifts[dateKey];
                    cellContent += `<div class="operator-status-item skeleton" title="Skeleton Shift"> ${skeleton.hours}h</div>`;
                }

                // Add critical warning if less than 2 operators
                if (availableOperators < 2) {
                    cellContent += `<div style="font-size: 0.65em; color: #e74c3c; background: #ffebee; padding: 2px; border-radius: 2px; margin-top: 3px; text-align: center;">CRITICAL</div>`;
                } else if (availableOperators <= 2) {
                    cellContent += `<div style="font-size: 0.65em; color: #f39c12; background: #fff9e6; padding: 2px; border-radius: 2px; margin-top: 3px; text-align: center;">MIN</div>`;
                }

                cell.innerHTML = cellContent;
                monthGrid.appendChild(cell);
            }
        }

        function showDayDetails(date) {
            const dateKey = formatDateForInput(date);
            const dayIndex = date.getDay();
            const dayName = shiftData.days[dayIndex];
            const dateStr = formatDateForDisplay(date);
            const isHoliday = holidays[dateKey];
            const isSkeleton = skeletonShifts[dateKey];

            document.getElementById('dayDetailsTitle').textContent = `${dayName}, ${dateStr}`;

            // Calculate statistics
            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            let availableOperators = 0;
            let leaveOperators = 0;
            let offDutyOperators = 0;
            let offDutyWorkingOperators = 0;
            let onDutyOperators = 0;
            let obituaryOperators = 0;
            let extraHoursOperators = 0;
            let pendingLeaveOperators = 0;
            let lateEntryOperators = 0;

            staffList.forEach(staff => {
                const shift = shiftData.shifts[dayName][staff];
                const isOnLeave = checkIfOnLeave(staff, date);
                const isOffDutyWorking = checkOffDutyWorking(staff, date);
                const isOnDuty = checkOnDuty(staff, date);
                const hasExtraHours = checkExtraHours(staff, date);
                const leaveStatus = getLeaveStatus(staff, date);
                const hasLateEntry = checkLateEntry(staff, date);

                if (hasLateEntry) {
                    availableOperators++;
                    lateEntryOperators++;
                } else if (isOffDutyWorking || isOnDuty) {
                    availableOperators++;
                    if (isOffDutyWorking) offDutyWorkingOperators++;
                    if (isOnDuty) onDutyOperators++;
                } else if (shift && !shift.includes('Off') && !isOnLeave) {
                    availableOperators++;
                    if (shift.includes('Obituary')) {
                        obituaryOperators++;
                    }
                }

                if (leaveStatus === 'pending') {
                    pendingLeaveOperators++;
                    leaveOperators++;
                } else if (leaveStatus === 'approved') {
                    leaveOperators++;
                }

                if (shift && shift.includes('Off') && !isOffDutyWorking) {
                    offDutyOperators++;
                }

                if (hasExtraHours) {
                    extraHoursOperators++;
                }
            });

            // Update day stats
            const dayStats = document.getElementById('dayStats');
            dayStats.innerHTML = `
                        <div class="day-stat-item">
                            <div class="stat-value">${availableOperators}/5</div>
                            <div class="stat-label">Available</div>
                        </div>
                        <div class="day-stat-item">
                            <div class="stat-value">${leaveOperators}</div>
                            <div class="stat-label">On Leave</div>
                        </div>
                        <div class="day-stat-item">
                            <div class="stat-value">${offDutyOperators}</div>
                            <div class="stat-label">Off Duty</div>
                        </div>
                        <div class="day-stat-item">
                            <div class="stat-value">${onDutyOperators}</div>
                            <div class="stat-label">On Duty (OD)</div>
                        </div>
                        <div class="day-stat-item">
                            <div class="stat-value">${lateEntryOperators}</div>
                            <div class="stat-label">Late Entry</div>
                        </div>
                    `;

            // Update shift details
            const shiftDetails = document.getElementById('dayShiftDetails');
            let detailsHTML = '';

            const allStaff = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            allStaff.forEach(staff => {
                const shift = shiftData.shifts[dayName][staff];
                const isOnLeave = checkIfOnLeave(staff, date);
                const isOffDutyWorking = checkOffDutyWorking(staff, date);
                const isOnDuty = checkOnDuty(staff, date);
                const hasExtraHours = checkExtraHours(staff, date);
                const leaveStatus = getLeaveStatus(staff, date);
                const hasLateEntry = checkLateEntry(staff, date);
                const abbrev = staffAbbreviations[staff];

                let detailClass = '';
                let statusText = '';
                let shiftDisplay = shift || 'Not Scheduled';

                if (hasLateEntry) {
                    detailClass = 'late-entry';
                    const lateEntry = getLateEntry(staff, date);
                    statusText = `Late Entry: ${lateEntry.delayMinutes} minutes delay`;
                    if (lateEntry.regularizedFromCOFF) {
                        statusText += ' (Regularized from COFF)';
                    }
                    shiftDisplay = lateEntry.actualTime || shiftDisplay;
                } else if (leaveStatus === 'pending') {
                    detailClass = 'leave';
                    statusText = 'Pending Leave';
                } else if (leaveStatus === 'approved') {
                    detailClass = 'leave';
                    statusText = 'On Leave';
                } else if (leaveStatus === 'rejected') {
                    detailClass = 'leave';
                    statusText = 'Leave Rejected';
                } else if (isOffDutyWorking) {
                    detailClass = 'off-duty-working';
                    statusText = 'Off-duty Working';
                    const entry = offDutyEntries[dateKey];
                    shiftDisplay = entry ? entry.shift : shiftDisplay;
                } else if (isOnDuty) {
                    detailClass = 'on-duty';
                    const entry = onDutyEntries[dateKey];
                    statusText = entry.type === 'extra' ? `On Duty (+${entry.hours}h extra)` : 'On Duty (OD)';
                } else if (hasExtraHours) {
                    detailClass = 'extra-hours';
                    const extra = extraHoursData[dateKey];
                    statusText = `+${extra.hours} extra hours`;
                } else if (shift && shift.includes('Obituary')) {
                    detailClass = 'obituary';
                    statusText = 'Obituary Duty';
                } else if (shift && shift.includes('Off')) {
                    detailClass = 'off-duty';
                    statusText = 'Off Duty';
                }

                if (isHoliday) {
                    detailClass = 'holiday';
                    statusText = 'Holiday';
                }

                if (isSkeleton) {
                    detailClass = 'skeleton';
                    statusText = 'Skeleton Shift';
                }

                detailsHTML += `
                            <div class="detail-item ${detailClass}">
                                <div class="detail-header">
                                    <div class="staff-name">
                                        ${abbrev} (${staff}${staff === 'ANEESH' ? ' CTP' : ''})
                                    </div>
                                    <div class="shift-time">${shiftDisplay}</div>
                                </div>
                                ${statusText ? `<div style="font-size: 0.85em; margin-top: 5px;">${statusText}</div>` : ''}
                            </div>
                        `;
            });

            shiftDetails.innerHTML = detailsHTML;
            document.getElementById('dayDetailsModal').style.display = 'flex';
        }

        function switchTab(tabName) {
            // Update tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Activate selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');

            // Refresh content if needed
            if (tabName === 'approvals') {
                renderApprovals();
            } else if (tabName === 'coff') {
                renderCOFFSummary();
                renderCOFFHistory();
            } else if (tabName === 'reports') {
                // Clear reports container and hide attendance navigation
                document.getElementById('report-container').innerHTML = '<p>Select a report to generate</p>';
                document.getElementById('attendance-nav').style.display = 'none';
            }
        }

        function switchView(viewType) {
            // Update buttons
            document.getElementById('viewTodayBtn').classList.remove('active');
            document.getElementById('viewWeekBtn').classList.remove('active');
            document.getElementById('viewMonthBtn').classList.remove('active');

            // Hide all views
            document.getElementById('todayView').classList.remove('active');
            document.getElementById('calendarView').classList.remove('active');
            document.getElementById('monthView').classList.remove('active');

            // Show selected view and activate button
            if (viewType === 'today') {
                document.getElementById('todayView').classList.add('active');
                document.getElementById('viewTodayBtn').classList.add('active');
            } else if (viewType === 'week') {
                document.getElementById('calendarView').classList.add('active');
                document.getElementById('viewWeekBtn').classList.add('active');
            } else if (viewType === 'month') {
                document.getElementById('monthView').classList.add('active');
                document.getElementById('viewMonthBtn').classList.add('active');
            }
        }

        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderWeekView();
            updateWeekTitle();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderWeekView();
            updateWeekTitle();
        }

        function goToTodayWeek() {
            currentWeekStart = new Date();
            currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
            renderWeekView();
            updateWeekTitle();
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderMonthView();
            updateMonthTitle();
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderMonthView();
            updateMonthTitle();
        }

        function goToTodayMonth() {
            currentMonth = today.getMonth();
            currentYear = today.getFullYear();
            renderMonthView();
            updateMonthTitle();
        }

        function previousDay() {
            currentDayView.setDate(currentDayView.getDate() - 1);
            renderTodayView();
            updateDayTitle();
        }

        function nextDay() {
            currentDayView.setDate(currentDayView.getDate() + 1);
            renderTodayView();
            updateDayTitle();
        }

        function goToToday() {
            currentDayView = new Date();
            renderTodayView();
            updateDayTitle();
        }

        function updateWeekTitle() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(currentWeekStart.getDate() + 6);
            const startStr = currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('weekTitle').textContent = `Week: ${startStr} - ${endStr}`;
        }

        function updateMonthTitle() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('monthTitle').textContent = `${monthNames[currentMonth]} ${currentYear}`;
        }

        function updateDayTitle() {
            const dateStr = currentDayView.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('dayTitle').textContent = dateStr;
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            // Prevent body scrolling when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Restore body scrolling
            document.body.style.overflow = 'auto';
        }

        // Specific modal open functions
        function openAddLeaveModal() {
            openModal('leaveModal');
        }

        function openEditShiftModal() {
            openModal('editShiftModal');
            loadShiftEditGrid();
        }

        function openEditObituaryModal() {
            openModal('editObituaryModal');
            loadCurrentObituaryDuty();
        }

        function openOffDutyModal() {
            openModal('offDutyModal');
            updateOffDutyStaffOptions();
        }

        function openOnDutyModal() {
            openModal('onDutyModal');
            // Set default values
            document.getElementById('onDutyDate').value = formatDateForInput(new Date());
            document.getElementById('onDutyExtraHours').value = '0.5';
            document.getElementById('onDutyReason').value = '';
            document.querySelector('input[name="onDutyType"][value="regular"]').checked = true;
            document.getElementById('extraHoursSection').style.display = 'none';
        }

        function openLateEntryModal() {
            openModal('lateEntryModal');
            const todayStr = formatDateForInput(new Date());
            document.getElementById('lateEntryDate').value = todayStr;
            document.getElementById('actualTime').value = '';
            document.getElementById('lateEntryReason').value = '';
            document.querySelector('input[name="regularizeType"][value="coff"]').checked = true;
            document.getElementById('coffRequirement').style.display = 'block';

            // Set default actual time to current time
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('actualTime').value = currentTime;

            updateRegularShiftTime();
        }

        function openCancelOffDutyModal() {
            openModal('cancelOffDutyModal');
            loadOffDutyForDate();
        }

        function openApplyCOFFModal() {
            openModal('applyCOFFModal');
            updateCOFFBalanceDisplay();
        }

        function openHolidayModal() {
            openModal('holidayModal');
            checkExistingHoliday();
        }

        function openSkeletonModal() {
            openModal('skeletonModal');
            const todayStr = formatDateForInput(new Date());
            document.getElementById('skeletonDate').value = todayStr;
            document.getElementById('skeletonHours').value = '8';
            document.getElementById('skeletonReason').value = '';
            document.getElementById('existingSkeletonInfo').style.display = 'none';
            document.getElementById('skeletonActionBtn').textContent = 'Add Skeleton Shift';
            document.getElementById('skeletonActionBtn').className = '';

            // Populate staff exclusion list
            const excludeList = document.getElementById('skeletonExcludeList');
            excludeList.innerHTML = '';

            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            staffList.forEach(staff => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                item.innerHTML = `
                            <label class="checkbox-option">
                                <input type="checkbox" id="exclude_${staff}" value="${staff}">
                                <span class="checkbox-custom"></span>
                                <span class="checkbox-label">${staffAbbreviations[staff]} (${staff})</span>
                            </label>
                        `;
                excludeList.appendChild(item);
            });

            checkExistingSkeleton();
        }

        function openCancelLeaveModal() {
            openModal('cancelLeaveModal');
            loadLeaveForStaff();
        }

        function openExtraHoursModal() {
            openModal('extraHoursModal');
            const todayStr = formatDateForInput(new Date());
            document.getElementById('extraHoursDate').value = todayStr;
            document.getElementById('extraHours').value = '1';
            document.getElementById('extraHoursReason').value = '';
        }

        // ============== ATTENDANCE REPORT FUNCTIONS ==============
        function generateAttendancePeriodReport() {
            // Show navigation
            document.getElementById('attendance-nav').style.display = 'block';

            // Generate report for current period (offset = 0)
            generateAttendanceReportForPeriod(0);
        }

        function generateAttendanceReportForPeriod(periodOffset) {
            const container = document.getElementById('report-container');
            const periodTitle = document.getElementById('attendance-period-title');

            // Calculate period based on offset
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            const currentDay = today.getDate();

            // Determine base period (0 = current/next period based on today's date)
            let baseStartDate, baseEndDate;

            if (currentDay <= 20) {
                // If today is before the 21st, current period is previous month 21st to current month 20th
                baseStartDate = new Date(currentYear, currentMonth - 1, 21);
                baseEndDate = new Date(currentYear, currentMonth, 20);
            } else {
                // If today is after the 20th, current period is current month 21st to next month 20th
                baseStartDate = new Date(currentYear, currentMonth, 21);
                baseEndDate = new Date(currentYear, currentMonth + 1, 20);
            }

            // Apply offset (each offset is one month forward or backward)
            const monthsToAdjust = periodOffset;
            const reportStartDate = new Date(baseStartDate.getFullYear(), baseStartDate.getMonth() + monthsToAdjust, 21);
            const reportEndDate = new Date(reportStartDate.getFullYear(), reportStartDate.getMonth() + 1, 20);

            // Adjust year if crossing year boundary
            if (reportStartDate.getMonth() === 11 && reportStartDate.getDate() === 21) {
                reportEndDate.setFullYear(reportStartDate.getFullYear() + 1);
            }

            // Store current period for navigation
            currentAttendancePeriod = periodOffset;
            currentAttendanceStartDate = reportStartDate;
            currentAttendanceEndDate = reportEndDate;

            const reportPeriod = `${reportStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} to ${reportEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

            // Update period title
            let periodLabel = "Current Period";
            if (periodOffset < 0) {
                periodLabel = `${Math.abs(periodOffset)} Period${Math.abs(periodOffset) > 1 ? 's' : ''} Ago`;
            } else if (periodOffset > 0) {
                periodLabel = `${periodOffset} Period${periodOffset > 1 ? 's' : ''} Ahead`;
            }
            periodTitle.textContent = `${periodLabel}: ${reportPeriod}`;

            let html = `<h3>Attendance Report</h3>`;

            // Create table
            html += `<div style="overflow-x: auto;">
                        <table style="min-width: 1000px;">
                            <thead>
                                <tr>
                                    <th style="min-width: 100px;">Operator</th>`;

            // Generate date headers
            const tempDate = new Date(reportStartDate);
            while (tempDate <= reportEndDate) {
                const dateStr = tempDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayName = tempDate.toLocaleDateString('en-US', { weekday: 'short' }).substring(0, 2);
                html += `<th style="min-width: 30px; text-align: center;" title="${tempDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}">
                                    ${dateStr}<br>${dayName}
                                 </th>`;
                tempDate.setDate(tempDate.getDate() + 1);
            }

            html += `<th>Total Days</th><th>Present</th><th>Leave</th><th>Off</th><th>% Present</th></tr></thead><tbody>`;

            // Get all staff members
            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];

            staffList.forEach(staff => {
                const abbrev = staffAbbreviations[staff];
                html += `<tr>
                                    <td style="font-weight: bold;">${abbrev}<br>(${staff}${staff === 'ANEESH' ? ' CTP' : ''})</td>`;

                let totalDays = 0;
                let presentDays = 0;
                let leaveDays = 0;
                let offDays = 0;

                // Reset tempDate for this staff member
                tempDate.setTime(reportStartDate.getTime());

                while (tempDate <= reportEndDate) {
                    const dateKey = formatDateForInput(tempDate);
                    const dayIndex = tempDate.getDay();
                    const dayName = shiftData.days[dayIndex];

                    // Check various statuses
                    const isHoliday = holidays[dateKey];
                    const isSkeleton = skeletonShifts[dateKey];
                    const shift = shiftData.shifts[dayName][staff];
                    const isOnLeave = checkIfOnLeave(staff, tempDate);
                    const isOffDutyWorking = checkOffDutyWorking(staff, tempDate);
                    const isOnDuty = checkOnDuty(staff, tempDate);
                    const hasLateEntry = checkLateEntry(staff, tempDate);
                    const leaveStatus = getLeaveStatus(staff, tempDate);
                    const isOffDuty = shift && (shift.includes('Off') || shift.includes('Off-operator'));

                    let attendanceMark = '';
                    let cellStyle = '';
                    let cellTitle = '';

                    if (isHoliday) {
                        attendanceMark = '<span style="color: #e74c3c; font-weight: bold;" title="Holiday">H</span>';
                        cellStyle = 'background-color: #ffebee;';
                        cellTitle = `Holiday: ${holidays[dateKey].name}`;
                        // Don't count holidays in totals
                    } else if (isSkeleton) {
                        attendanceMark = '<span style="color: #26a69a; font-weight: bold;" title="Skeleton Shift">S</span>';
                        cellStyle = 'background-color: #e8f6f3;';
                        cellTitle = `Skeleton Shift: ${skeletonShifts[dateKey].hours} hours`;
                        // Don't count skeleton shifts in totals
                    } else if (isOnLeave) {
                        attendanceMark = leaveStatus === 'pending' ?
                            '<span style="color: #f39c12; font-weight: bold; border: 1px dashed #f39c12; padding: 0 2px;" title="Pending Leave">L?</span>' :
                            '<span style="color: #e74c3c; font-weight: bold;" title="Leave">L</span>';
                        cellStyle = leaveStatus === 'pending' ? 'background-color: #fff9e6;' : 'background-color: #ffebee;';
                        leaveDays++;
                        totalDays++;
                        cellTitle = leaveStatus === 'pending' ? 'Pending Leave' : 'On Leave';
                    } else if (isOffDuty && !isOffDutyWorking) {
                        attendanceMark = '<span style="color: #95a5a6; font-weight: bold;" title="Off Duty">O</span>';
                        cellStyle = 'background-color: #f1f2f6;';
                        offDays++;
                        totalDays++;
                        cellTitle = 'Off Duty';
                    } else if (isOffDutyWorking || isOnDuty || hasLateEntry) {
                        attendanceMark = '<span style="color: #27ae60; font-weight: bold;" title="Present">X</span>';
                        cellStyle = 'background-color: #e8f6ef;';
                        presentDays++;
                        totalDays++;
                        cellTitle = isOffDutyWorking ? 'Off-duty Working' :
                            isOnDuty ? 'On Duty (OD)' :
                                hasLateEntry ? 'Present (Late Entry)' : 'Present';
                    } else if (shift && !shift.includes('Off')) {
                        attendanceMark = '<span style="color: #27ae60; font-weight: bold;" title="Present"></span>';
                        cellStyle = 'background-color: #e8f6ef;';
                        presentDays++;
                        totalDays++;
                        cellTitle = `Present: ${shift}`;
                    } else {
                        attendanceMark = '<span style="color: #95a5a6;">-</span>';
                        cellTitle = 'No Shift';
                        // Don't count "no shift" days in totals
                    }

                    html += `<td style="text-align: center; ${cellStyle}" title="${cellTitle}">${attendanceMark}</td>`;

                    tempDate.setDate(tempDate.getDate() + 1);
                }

                // Calculate attendance percentage
                const attendancePercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                let percentageColor = '#27ae60'; // Green for good attendance
                if (attendancePercentage < 80) percentageColor = '#f39c12'; // Orange for moderate
                if (attendancePercentage < 60) percentageColor = '#e74c3c'; // Red for poor

                // Add totals for this staff member
                html += `<td style="text-align: center; font-weight: bold;">${totalDays}</td>
                                 <td style="text-align: center; color: #27ae60; font-weight: bold;">${presentDays}</td>
                                 <td style="text-align: center; color: #e74c3c; font-weight: bold;">${leaveDays}</td>
                                 <td style="text-align: center; color: #95a5a6; font-weight: bold;">${offDays}</td>
                                 <td style="text-align: center; color: ${percentageColor}; font-weight: bold;">${attendancePercentage}%</td>
                               </tr>`;
            });

            // Add summary row
            html += `<tr style="background-color: #f8f9fa; font-weight: bold;">
                                <td>TOTAL</td>`;

            // Empty cells for each date
            tempDate.setTime(reportStartDate.getTime());
            let dateCount = 0;
            while (tempDate <= reportEndDate) {
                dateCount++;
                html += `<td style="text-align: center;">${dateCount}</td>`;
                tempDate.setDate(tempDate.getDate() + 1);
            }

            // Calculate overall totals
            const totalStaff = staffList.length;
            const totalDaysInPeriod = Math.floor((reportEndDate - reportStartDate) / (1000 * 60 * 60 * 24)) + 1;

            html += `<td style="text-align: center;">${totalDaysInPeriod * totalStaff}</td>
                             <td style="text-align: center;">-</td>
                             <td style="text-align: center;">-</td>
                             <td style="text-align: center;">-</td>
                             <td style="text-align: center;">-</td>
                           </tr>`;

            html += `</tbody></table></div>`;

            // Add legend
            html += `
                        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h4>Legend:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #27ae60; font-weight: bold;"></span> Present
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #e74c3c; font-weight: bold;">L</span> Leave
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #95a5a6; font-weight: bold;">O</span> Off Duty
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #f39c12; font-weight: bold; border: 1px dashed #f39c12; padding: 0 2px;">L?</span> Pending Leave
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #e74c3c; font-weight: bold;">H</span> Holiday
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #26a69a; font-weight: bold;">S</span> Skeleton Shift
                                </div>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                <strong>Note:</strong> Holiday and Skeleton Shift days are not counted in Present/Leave/Off totals.
                            </div>
                        </div>
                    `;

            container.innerHTML = html;
        }

        // Navigation functions for attendance report
        function previousAttendancePeriod() {
            generateAttendanceReportForPeriod(currentAttendancePeriod - 1);
        }

        function nextAttendancePeriod() {
            generateAttendanceReportForPeriod(currentAttendancePeriod + 1);
        }

        function goToCurrentAttendancePeriod() {
            generateAttendanceReportForPeriod(0);
        }

        // Other report functions
        function generateLeaveReport() {
            // Hide attendance navigation for leave report
            document.getElementById('attendance-nav').style.display = 'none';

            const container = document.getElementById('report-container');
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 3); // Last 3 months

            const filteredLeaves = leaveRequests.filter(req => {
                const reqDate = new Date(req.date);
                return reqDate >= startDate && req.status === 'approved';
            });

            if (filteredLeaves.length === 0) {
                container.innerHTML = '<h3>Leave Report</h3><p>No approved leaves in the last 3 months.</p>';
                return;
            }

            let html = '<h3>Leave Report (Last 3 Months)</h3>';
            html += '<table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Reason</th></tr></thead><tbody>';

            filteredLeaves.forEach(leave => {
                const abbrev = staffAbbreviations[leave.staff];
                html += `
                            <tr>
                                <td>${leave.date}</td>
                                <td>${abbrev} (${leave.staff})</td>
                                <td>${leave.type}</td>
                                <td>${leave.reason || ''}</td>
                            </tr>
                        `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function generateOnDutyReport() {
            // Hide attendance navigation for On Duty report
            document.getElementById('attendance-nav').style.display = 'none';

            const container = document.getElementById('report-container');
            let html = '<h3>On Duty & Extra Hours Report</h3>';

            // Get all On Duty entries (including extra hours)
            const allOnDutyEntries = Object.values(onDutyEntries);
            const allExtraHours = Object.values(extraHoursData);

            // Combine and sort by date
            const combinedEntries = [];

            // Add On Duty entries
            allOnDutyEntries.forEach(entry => {
                combinedEntries.push({
                    type: 'On Duty',
                    date: entry.date,
                    staff: entry.staff,
                    hours: entry.type === 'extra' ? entry.hours : 0,
                    totalHours: entry.type === 'extra' ? (8 + entry.hours) : 8,
                    reason: entry.reason,
                    entryDate: entry.entryDate,
                    shiftType: entry.type === 'extra' ? 'Extra Hours' : 'Regular Shift',
                    originalShift: entry.regularShift
                });
            });

            // Add standalone Extra Hours entries (not linked to On Duty)
            allExtraHours.forEach(entry => {
                // Check if this entry is already included as On Duty
                const isInOnDuty = allOnDutyEntries.some(od =>
                    od.staff === entry.staff && od.date === entry.date && od.type === 'extra'
                );

                if (!isInOnDuty && entry.type !== 'Off-Duty Working') {
                    combinedEntries.push({
                        type: 'Extra Hours',
                        date: entry.date,
                        staff: entry.staff,
                        hours: entry.hours,
                        totalHours: entry.hours,
                        reason: entry.reason,
                        entryDate: entry.entryDate,
                        shiftType: 'Standalone Extra',
                        originalShift: 'Not specified'
                    });
                }
            });

            // Sort by date (newest first)
            combinedEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (combinedEntries.length === 0) {
                html += '<p>No On Duty or Extra Hours entries found.</p>';
                container.innerHTML = html;
                return;
            }

            // Group by month for summary
            const monthlySummary = {};
            const staffSummary = {};

            // Initialize staff summary
            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            staffList.forEach(staff => {
                staffSummary[staff] = {
                    totalHours: 0,
                    onDutyDays: 0,
                    extraHours: 0,
                    entries: []
                };
            });

            // Process all entries
            combinedEntries.forEach(entry => {
                const date = new Date(entry.date);
                const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                // Initialize month in summary
                if (!monthlySummary[monthKey]) {
                    monthlySummary[monthKey] = {
                        month: monthName,
                        totalHours: 0,
                        totalDays: 0,
                        entries: []
                    };
                }

                // Update monthly summary
                monthlySummary[monthKey].totalHours += entry.totalHours;
                monthlySummary[monthKey].totalDays += (entry.type === 'On Duty' ? 1 : 0);
                monthlySummary[monthKey].entries.push(entry);

                // Update staff summary
                if (staffSummary[entry.staff]) {
                    staffSummary[entry.staff].totalHours += entry.totalHours;
                    if (entry.type === 'On Duty') {
                        staffSummary[entry.staff].onDutyDays++;
                    }
                    staffSummary[entry.staff].extraHours += entry.hours;
                    staffSummary[entry.staff].entries.push(entry);
                }
            });

            // Display Monthly Summary
            html += '<h4>Monthly Summary</h4>';
            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 800px;">';
            html += '<thead><tr><th>Month</th><th>On Duty Days</th><th>Total Hours</th><th>Details</th></tr></thead><tbody>';

            // Sort months chronologically
            const sortedMonths = Object.keys(monthlySummary).sort().reverse();

            sortedMonths.forEach(monthKey => {
                const monthData = monthlySummary[monthKey];
                html += `
                            <tr>
                                <td><strong>${monthData.month}</strong></td>
                                <td>${monthData.totalDays} days</td>
                                <td>${monthData.totalHours.toFixed(1)} hours</td>
                                <td>
                                    <button onclick="showMonthDetails('${monthKey}')"
                                            style="padding: 4px 8px; font-size: 0.8em;">
                                        View Details
                                    </button>
                                </td>
                            </tr>
                        `;
            });

            html += '</tbody></table></div>';

            // Display Staff Summary
            html += '<h4 style="margin-top: 30px;">Staff Summary</h4>';
            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 800px;">';
            html += '<thead><tr><th>Staff</th><th>On Duty Days</th><th>Total Hours</th><th>Extra Hours</th><th>Average Hours/Day</th><th>Details</th></tr></thead><tbody>';

            staffList.forEach(staff => {
                const summary = staffSummary[staff];
                const abbrev = staffAbbreviations[staff];
                const avgHours = summary.onDutyDays > 0 ? (summary.totalHours / summary.onDutyDays).toFixed(1) : '0';

                html += `
                            <tr>
                                <td><strong>${abbrev} (${staff})</strong></td>
                                <td>${summary.onDutyDays} days</td>
                                <td>${summary.totalHours.toFixed(1)} hours</td>
                                <td>${summary.extraHours.toFixed(1)} hours</td>
                                <td>${avgHours} hours</td>
                                <td>
                                    <button onclick="showStaffOnDutyDetails('${staff}')"
                                            style="padding: 4px 8px; font-size: 0.8em;">
                                        View Details
                                    </button>
                                </td>
                            </tr>
                        `;
            });

            html += '</tbody></table></div>';

            // Display Recent Entries (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const recentEntries = combinedEntries.filter(entry =>
                new Date(entry.date) >= thirtyDaysAgo
            );

            if (recentEntries.length > 0) {
                html += '<h4 style="margin-top: 30px;">Recent Entries (Last 30 Days)</h4>';
                html += '<div style="overflow-x: auto;">';
                html += '<table style="min-width: 1000px;">';
                html += '<thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Regular Shift</th><th>Extra Hours</th><th>Total Hours</th><th>Reason</th></tr></thead><tbody>';

                recentEntries.forEach(entry => {
                    const abbrev = staffAbbreviations[entry.staff];
                    const extraHoursDisplay = entry.hours > 0 ? `${entry.hours}h` : '-';
                    const totalHoursDisplay = entry.totalHours > 8 ? `<strong>${entry.totalHours}h</strong>` : `${entry.totalHours}h`;

                    html += `
                                <tr>
                                    <td>${entry.date}</td>
                                    <td>${abbrev} (${entry.staff})</td>
                                    <td>${entry.shiftType}</td>
                                    <td>${entry.originalShift}</td>
                                    <td>${extraHoursDisplay}</td>
                                    <td>${totalHoursDisplay}</td>
                                    <td>${entry.reason || '-'}</td>
                                </tr>
                            `;
                });

                html += '</tbody></table></div>';
            }

            // Add legend
            html += `
                        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                            <h4>Legend:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #3498db; font-weight: bold;">On Duty</span>: Regular shift work outside office
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #e74c3c; font-weight: bold;">Extra Hours</span>: Additional hours beyond regular shift
                                </div>
                                <div style="display: flex; align-items: center; gap: 5px;">
                                    <span style="color: #27ae60; font-weight: bold;">Standalone Extra</span>: Extra hours not linked to On Duty
                                </div>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                <strong>Note:</strong> Regular shift is counted as 8 hours. Extra hours are additional to the regular shift.
                            </div>
                        </div>
                    `;

            container.innerHTML = html;
        }

        function generateCOFFReport() {
            // Hide attendance navigation for COFF report
            document.getElementById('attendance-nav').style.display = 'none';

            const container = document.getElementById('report-container');
            let html = '<h3>COFF Report</h3>';

            // Group extra hours by staff
            const extraHoursByStaff = {};
            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];

            staffList.forEach(staff => {
                extraHoursByStaff[staff] = [];
            });

            Object.values(extraHoursData).forEach(entry => {
                if (entry && entry.staff) {
                    extraHoursByStaff[entry.staff].push(entry);
                }
            });

            // Display COFF balances with extra hours breakdown
            html += '<h4>Current COFF Balances</h4>';
            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 800px;">';
            html += '<thead><tr><th>Staff</th><th>Total Extra Hours</th><th>COFF Earned</th><th>Current Balance</th><th>Status</th></tr></thead><tbody>';

            staffList.forEach(staff => {
                const balance = coffData.balances[staff] || 0;
                const extraHoursEntries = extraHoursByStaff[staff] || [];
                const totalExtraHours = extraHoursEntries.reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
                const coffEarned = totalExtraHours / 8;
                const abbrev = staffAbbreviations[staff];

                let status = '<span style="color: #e74c3c;">Not eligible</span>';
                if (balance >= 1) {
                    status = '<span style="color: #27ae60;">Eligible</span>';
                } else if (balance >= 0.5) {
                    status = '<span style="color: #f39c12;">Partial</span>';
                }

                html += `
            <tr>
                <td><strong>${abbrev} (${staff})</strong></td>
                <td>${totalExtraHours.toFixed(1)} hours</td>
                <td>${coffEarned.toFixed(2)} days</td>
                <td><strong>${balance.toFixed(2)} days</strong><br><small>(${(balance * 8).toFixed(1)} hours)</small></td>
                <td>${status}</td>
            </tr>
        `;
            });

            html += '</tbody></table></div>';

            // Show detailed extra hours breakdown
            html += '<h4 style="margin-top: 30px;">Extra Hours Breakdown</h4>';

            staffList.forEach(staff => {
                const extraHoursEntries = extraHoursByStaff[staff] || [];

                if (extraHoursEntries.length > 0) {
                    html += `<h5>${staffAbbreviations[staff]} (${staff}) - ${extraHoursEntries.length} entries</h5>`;
                    html += '<div style="overflow-x: auto;">';
                    html += '<table style="min-width: 800px; margin-bottom: 20px;">';
                    html += '<thead><tr><th>Date</th><th>Hours</th><th>COFF Days</th><th>Reason</th><th>Entry Date</th></tr></thead><tbody>';

                    // Sort by date descending
                    extraHoursEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

                    extraHoursEntries.forEach(entry => {
                        const coffDays = (parseFloat(entry.hours) || 0) / 8;
                        html += `
                    <tr>
                        <td>${entry.date}</td>
                        <td><strong>${entry.hours} hours</strong></td>
                        <td>${coffDays.toFixed(2)} days</td>
                        <td>${entry.reason || 'No reason provided'}</td>
                        <td>${new Date(entry.entryDate).toLocaleDateString()}</td>
                    </tr>
                `;
                    });

                    html += '</tbody></table></div>';
                }
            });

            // Show COFF history
            if (coffData.history && coffData.history.length > 0) {
                html += '<h4 style="margin-top: 30px;">COFF Transaction History</h4>';
                html += '<div style="overflow-x: auto;">';
                html += '<table style="min-width: 800px;">';
                html += '<thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Hours</th><th>COFF Days</th><th>Balance After</th><th>Reason</th></tr></thead><tbody>';

                // Sort by date descending
                const sortedHistory = [...coffData.history].sort((a, b) =>
                    new Date(b.transactionDate || b.date) - new Date(a.transactionDate || a.date)
                );

                // Show only last 50 entries
                sortedHistory.slice(0, 50).forEach(entry => {
                    const abbrev = staffAbbreviations[entry.staff];
                    const hours = entry.hours || 0;
                    const coffDisplay = entry.coffEarned ?
                        `<span style="color: #27ae60;">+${entry.coffEarned.toFixed(2)}</span>` :
                        entry.coffUsed ?
                            `<span style="color: #e74c3c;">-${entry.coffUsed.toFixed(2)}</span>` :
                            'N/A';

                    html += `
                <tr>
                    <td>${entry.date}</td>
                    <td>${abbrev} (${entry.staff})</td>
                    <td>${entry.type}</td>
                    <td>${hours > 0 ? `${hours}h` : '-'}</td>
                    <td>${coffDisplay}</td>
                    <td>${entry.balanceAfter ? entry.balanceAfter.toFixed(2) + ' days' : 'N/A'}</td>
                    <td>${entry.reason || ''}</td>
                </tr>
            `;
                });

                html += '</tbody></table></div>';
            }

            container.innerHTML = html;
        }
async function fixCOFFData() {
    if (!confirm('This will recalculate all COFF balances from extra hours AND OD data. Continue?')) {
        return;
    }
    
    try {
        console.log('Fixing COFF data...');
        
        // Get all extra hours data
        const extraHoursSnapshot = await db.collection('extraHoursData').get();
        const allExtraHours = [];
        extraHoursSnapshot.forEach(doc => {
            allExtraHours.push(doc.data());
        });
        
        // Get all On Duty entries
        const onDutySnapshot = await db.collection('onDutyEntries').get();
        const allOnDuty = [];
        onDutySnapshot.forEach(doc => {
            allOnDuty.push(doc.data());
        });
        
        // Get all off-duty entries
        const offDutySnapshot = await db.collection('offDutyEntries').get();
        const allOffDuty = [];
        offDutySnapshot.forEach(doc => {
            allOffDuty.push(doc.data());
        });
        
        console.log('Found:', {
            extraHours: allExtraHours.length,
            onDuty: allOnDuty.length,
            offDuty: allOffDuty.length
        });
        
        // Calculate balances per staff
        const balances = {};
        const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
        staffList.forEach(staff => {
            balances[staff] = 0;
        });
        
        // Process standalone extra hours
        allExtraHours.forEach(entry => {
            if (entry && entry.staff && entry.hours && entry.type !== 'Off-Duty Working') {
                const hours = parseFloat(entry.hours) || 0;
                const coffDays = hours / 8;
                balances[entry.staff] += coffDays;
                
                console.log(`Extra hours: ${entry.staff} +${hours}h = +${coffDays.toFixed(2)} COFF days`);
            }
        });
        
        // Process On Duty extra hours
        allOnDuty.forEach(entry => {
            if (entry && entry.staff && entry.type === 'extra' && entry.hours) {
                const extraHours = parseFloat(entry.hours) || 0;
                const coffDays = extraHours / 8;
                balances[entry.staff] += coffDays;
                
                console.log(`OD extra: ${entry.staff} +${extraHours}h = +${coffDays.toFixed(2)} COFF days`);
            }
        });
        
        // Process off-duty working
        allOffDuty.forEach(entry => {
            if (entry && entry.staff) {
                // Off-duty working = 1 COFF day (8 hours)
                balances[entry.staff] += 1;
                console.log(`Off-duty: ${entry.staff} +1 COFF day`);
            }
        });
        
        // Update local coffData
        coffData.balances = balances;
        
        // Save balances using direct Firestore calls (not saveCOFFBalances)
        for (const staff of staffList) {
            const balance = balances[staff];
            await db.collection('coffData').doc(`${staff}_balance`).set({
                staff: staff,
                type: 'balance',
                balance: balance,
                updatedAt: new Date().toISOString(),
                lastCalculated: new Date().toISOString(),
                calculatedBy: currentUser?.email || 'system'
            }, { merge: true });
            
            console.log(`Updated ${staff}: ${balance.toFixed(2)} COFF days`);
        }
        
        // Create history entries for missing records
        await createMissingCOFFHistory(allExtraHours, allOnDuty, allOffDuty);
        
        alert(`COFF data fixed successfully!\n\nBalances recalculated from:\n ${allExtraHours.length} extra hours entries\n ${allOnDuty.filter(e => e.type === 'extra').length} OD extra hours entries\n ${allOffDuty.length} off-duty working entries`);
        
        // Refresh display
        updateStats(); // Update the stats display
        renderCOFFSummary();
        
    } catch (error) {
        console.error('Error fixing COFF data:', error);
        alert('Failed to fix COFF data: ' + error.message);
    }
}
async function fixODCOFFData() {
    if (!confirm('This will recalculate COFF balances from On Duty extra hours only. Continue?')) {
        return;
    }
    
    try {
        console.log('Fixing OD COFF data...');
        
        // Get all On Duty entries
        const snapshot = await db.collection('onDutyEntries').get();
        const odEntries = [];
        snapshot.forEach(doc => {
            odEntries.push(doc.data());
        });
        
        // Filter only entries with extra hours
        const odExtraEntries = odEntries.filter(entry => 
            entry && entry.staff && entry.type === 'extra' && entry.hours
        );
        
        console.log(`Found ${odExtraEntries.length} OD entries with extra hours`);
        
        // Create COFF history entries for each
        let createdCount = 0;
        for (const entry of odExtraEntries) {
            const coffEarned = parseFloat(entry.hours) / 8;
            const historyId = `od_extra_${entry.date}_${entry.staff}`;
            const historyDoc = await db.collection('coffData').doc(historyId).get();
            
            if (!historyDoc.exists) {
                await db.collection('coffData').doc(historyId).set({
                    staff: entry.staff,
                    type: 'history',
                    date: entry.date,
                    hours: parseFloat(entry.hours),
                    coffEarned: coffEarned,
                    reason: `On Duty: ${entry.reason || 'No reason provided'}`,
                    transactionDate: entry.entryDate || new Date().toISOString(),
                    source: 'on-duty-extra',
                    fixedAt: new Date().toISOString()
                }, { merge: true });
                createdCount++;
                console.log(`Created COFF history for ${entry.staff}: ${entry.hours} hours on ${entry.date}`);
            }
        }
        
        // Also update the balance for each staff
        const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
        
        // First get current balances
        for (const staff of staffList) {
            const odHours = odExtraEntries
                .filter(e => e.staff === staff)
                .reduce((sum, entry) => sum + (parseFloat(entry.hours) || 0), 0);
            
            const coffToAdd = odHours / 8;
            
            if (coffToAdd > 0) {
                // Get current balance
                const balanceDoc = await db.collection('coffData').doc(`${staff}_balance`).get();
                let currentBalance = 0;
                
                if (balanceDoc.exists) {
                    currentBalance = balanceDoc.data().balance || 0;
                }
                
                const newBalance = currentBalance + coffToAdd;
                
                // Update balance
                await db.collection('coffData').doc(`${staff}_balance`).set({
                    staff: staff,
                    type: 'balance',
                    balance: newBalance,
                    updatedAt: new Date().toISOString(),
                    lastCalculated: new Date().toISOString(),
                    odHoursAdded: odHours,
                    odCoffAdded: coffToAdd
                }, { merge: true });
                
                console.log(`Updated ${staff} balance: ${currentBalance.toFixed(2)} + ${coffToAdd.toFixed(2)} = ${newBalance.toFixed(2)} COFF days`);
            }
        }
        
        alert(`OD COFF data fixed successfully!\n\nProcessed ${odExtraEntries.length} OD extra hours entries\nCreated ${createdCount} new COFF history records\nUpdated COFF balances for all staff`);
        
        // Recalculate and refresh display
        calculateCOFFBalances();
        renderCOFFSummary();
        
    } catch (error) {
        console.error('Error fixing OD COFF data:', error);
        alert('Failed to fix OD COFF data: ' + error.message);
    }
}

async function createMissingCOFFHistory(allExtraHours, allOnDuty, allOffDuty) {
    console.log('Creating missing COFF history entries...');
    
    // Process extra hours
    for (const entry of allExtraHours) {
        if (entry && entry.staff && entry.hours && entry.date && entry.type !== 'Off-Duty Working') {
            const coffEarned = parseFloat(entry.hours) / 8;
            const historyId = `extra_${entry.date}_${entry.staff}`;
            const historyDoc = await db.collection('coffData').doc(historyId).get();
            
            if (!historyDoc.exists) {
                await db.collection('coffData').doc(historyId).set({
                    staff: entry.staff,
                    type: 'history',
                    date: entry.date,
                    hours: parseFloat(entry.hours),
                    coffEarned: coffEarned,
                    reason: entry.reason || 'Extra hours worked',
                    transactionDate: entry.entryDate || new Date().toISOString(),
                    source: 'extra-hours',
                    createdDuringFix: true
                }, { merge: true });
                console.log(`Created history for extra hours: ${entry.staff} on ${entry.date}`);
            }
        }
    }
    
    // Process OD extra hours
    for (const entry of allOnDuty) {
        if (entry && entry.staff && entry.type === 'extra' && entry.hours && entry.date) {
            const coffEarned = parseFloat(entry.hours) / 8;
            const historyId = `od_extra_${entry.date}_${entry.staff}`;
            const historyDoc = await db.collection('coffData').doc(historyId).get();
            
            if (!historyDoc.exists) {
                await db.collection('coffData').doc(historyId).set({
                    staff: entry.staff,
                    type: 'history',
                    date: entry.date,
                    hours: parseFloat(entry.hours),
                    coffEarned: coffEarned,
                    reason: `On Duty: ${entry.reason || 'No reason provided'}`,
                    transactionDate: entry.entryDate || new Date().toISOString(),
                    source: 'on-duty-extra',
                    createdDuringFix: true
                }, { merge: true });
                console.log(`Created history for OD extra: ${entry.staff} on ${entry.date}`);
            }
        }
    }
    
    // Process off-duty working
    for (const entry of allOffDuty) {
        if (entry && entry.staff && entry.date) {
            const historyId = `offduty_${entry.date}_${entry.staff}`;
            const historyDoc = await db.collection('coffData').doc(historyId).get();
            
            if (!historyDoc.exists) {
                await db.collection('coffData').doc(historyId).set({
                    staff: entry.staff,
                    type: 'history',
                    date: entry.date,
                    hours: 8,
                    coffEarned: 1,
                    reason: `Off-duty working: ${entry.reason || 'No reason provided'}`,
                    transactionDate: entry.entryDate || new Date().toISOString(),
                    source: 'off-duty',
                    createdDuringFix: true
                }, { merge: true });
                console.log(`Created history for off-duty: ${entry.staff} on ${entry.date}`);
            }
        }
    }
    
    console.log('Missing COFF history entries created');
}

        function generateOTReport() {
            // Hide attendance navigation for OT report
            document.getElementById('attendance-nav').style.display = 'none';

            const container = document.getElementById('report-container');
            let html = '<h3>Overtime Report</h3>';

            // Get current month
            const currentDate = new Date();
            const currentMonthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
            const currentMonthData = otData.monthly[currentMonthKey] || {};

            html += `<h4>Current Month (${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})</h4>`;
            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 600px;">';
            html += '<thead><tr><th>Staff</th><th>Skeleton OT</th><th>Extra Hours OT</th><th>Total OT Hours</th><th>OT Amount</th></tr></thead><tbody>';

            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            let totalSkeletonOT = 0;
            let totalExtraOT = 0;
            let totalHours = 0;
            let totalAmount = 0;

            staffList.forEach(staff => {
                const abbrev = staffAbbreviations[staff];
                const totalOT = currentMonthData[staff] || 0;

                // Calculate skeleton OT (hours from skeleton shifts)
                let skeletonOT = 0;
                Object.entries(skeletonShifts).forEach(([date, skeleton]) => {
                    const dateObj = new Date(date);
                    const monthKey = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;

                    if (monthKey === currentMonthKey) {
                        if (!skeleton.excludedStaff?.includes(staff)) {
                            const dayIndex = dateObj.getDay();
                            const dayName = shiftData.days[dayIndex];
                            const shift = shiftData.shifts[dayName][staff];

                            if (shift && !shift.includes('Off') && !shift.includes('Off-operator')) {
                                skeletonOT += parseFloat(skeleton.hours) || 0;
                            }
                        }
                    }
                });

                // Calculate extra hours OT
                let extraOT = 0;
                Object.values(extraHoursData).forEach(entry => {
                    if (entry.staff === staff) {
                        const dateObj = new Date(entry.date);
                        const monthKey = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;

                        if (monthKey === currentMonthKey) {
                            extraOT += parseFloat(entry.hours) || 0;
                        }
                    }
                });

                // Calculate OT amount (assuming 200 per hour)
                const otRate = 200;
                const otAmount = totalOT * otRate;

                totalSkeletonOT += skeletonOT;
                totalExtraOT += extraOT;
                totalHours += totalOT;
                totalAmount += otAmount;

                html += `
            <tr>
                <td><strong>${abbrev} (${staff})</strong></td>
                <td>${skeletonOT.toFixed(1)} hours</td>
                <td>${extraOT.toFixed(1)} hours</td>
                <td><strong>${totalOT.toFixed(1)} hours</strong></td>
                <td>${otAmount.toFixed(2)}</td>
            </tr>
        `;
            });

            html += `<tr style="font-weight: bold; background: #f8f9fa;">
                <td>Total</td>
                <td>${totalSkeletonOT.toFixed(1)} hours</td>
                <td>${totalExtraOT.toFixed(1)} hours</td>
                <td>${totalHours.toFixed(1)} hours</td>
                <td>${totalAmount.toFixed(2)}</td>
            </tr>`;
            html += '</tbody></table></div>';

            // Add details breakdown
            html += '<h4 style="margin-top: 30px;">OT Breakdown Details</h4>';

            // Skeleton Shifts
            html += '<h5>Skeleton Shifts:</h5>';
            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 600px;">';
            html += '<thead><tr><th>Date</th><th>Skeleton Hours</th><th>Excluded Staff</th><th>Reason</th></tr></thead><tbody>';

            Object.entries(skeletonShifts).forEach(([date, skeleton]) => {
                const dateObj = new Date(date);
                const monthKey = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;

                if (monthKey === currentMonthKey) {
                    const excludedStaff = skeleton.excludedStaff?.map(staff => staffAbbreviations[staff]).join(', ') || 'None';
                    html += `
                <tr>
                    <td>${date}</td>
                    <td>${skeleton.hours} hours</td>
                    <td>${excludedStaff}</td>
                    <td>${skeleton.reason || 'No reason provided'}</td>
                </tr>
            `;
                }
            });

            html += '</tbody></table></div>';

            // Extra Hours
            html += '<h5 style="margin-top: 20px;">Extra Hours:</h5>';
            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 600px;">';
            html += '<thead><tr><th>Date</th><th>Staff</th><th>Extra Hours</th><th>Reason</th></tr></thead><tbody>';

            Object.values(extraHoursData).forEach(entry => {
                const dateObj = new Date(entry.date);
                const monthKey = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;

                if (monthKey === currentMonthKey) {
                    const abbrev = staffAbbreviations[entry.staff];
                    html += `
                <tr>
                    <td>${entry.date}</td>
                    <td>${abbrev} (${entry.staff})</td>
                    <td>${entry.hours} hours</td>
                    <td>${entry.reason || 'No reason provided'}</td>
                </tr>
            `;
                }
            });

            html += '</tbody></table></div>';

            container.innerHTML = html;
        }

        function exportAllData() {
            // Hide attendance navigation for export
            document.getElementById('attendance-nav').style.display = 'none';

            const allData = {
                shiftData: shiftData,
                leaveData: leaveData,
                leaveRequests: leaveRequests,
                offDutyEntries: offDutyEntries,
                onDutyEntries: onDutyEntries,
                extraHoursData: extraHoursData,
                coffData: coffData,
                holidays: holidays,
                skeletonShifts: skeletonShifts,
                otData: otData,
                lateEntries: lateEntries,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(allData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

            const exportFileDefaultName = `shift-management-export-${new Date().toISOString().split('T')[0]}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();

            const container = document.getElementById('report-container');
            container.innerHTML = '<h3>Data Export</h3><p style="color: #27ae60;"> Export completed! File downloaded: ' + exportFileDefaultName + '</p>';
        }

        // Function to show month details for On Duty report
        function showMonthDetails(monthKey) {
            const container = document.getElementById('report-container');
            const [year, month] = monthKey.split('-').map(Number);
            const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Get all entries for this month
            const allEntries = [
                ...Object.values(onDutyEntries),
                ...Object.values(extraHoursData)
            ].filter(entry => {
                const date = new Date(entry.date);
                return date.getFullYear() === year && (date.getMonth() + 1) === month;
            });

            let html = `<h3>Month Details: ${monthName}</h3>`;
            html += '<button onclick="generateOnDutyReport()" style="margin-bottom: 15px;"> Back to Report</button>';

            if (allEntries.length === 0) {
                html += '<p>No entries found for this month.</p>';
                container.innerHTML = html;
                return;
            }

            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 1000px;">';
            html += '<thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Regular Shift</th><th>Extra Hours</th><th>Total Hours</th><th>Reason</th><th>Entry Date</th></tr></thead><tbody>';

            // Sort by date
            allEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

            allEntries.forEach(entry => {
                const abbrev = staffAbbreviations[entry.staff];
                const isOnDuty = entry.hasOwnProperty('type');
                const type = isOnDuty ? (entry.type === 'extra' ? 'On Duty (Extra)' : 'On Duty') : 'Extra Hours';
                const extraHours = isOnDuty ? (entry.type === 'extra' ? entry.hours : 0) : entry.hours;
                const totalHours = isOnDuty ? (entry.type === 'extra' ? (8 + entry.hours) : 8) : entry.hours;
                const originalShift = entry.regularShift || 'Not specified';

                html += `
                        <tr>
                            <td>${entry.date}</td>
                            <td>${abbrev} (${entry.staff})</td>
                            <td>${type}</td>
                            <td>${originalShift}</td>
                            <td>${extraHours > 0 ? `${extraHours}h` : '-'}</td>
                            <td>${totalHours}h</td>
                            <td>${entry.reason || '-'}</td>
                            <td>${new Date(entry.entryDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                        </tr>
                    `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Function to show staff details for On Duty report
        function showStaffOnDutyDetails(staffName) {
            const container = document.getElementById('report-container');
            const abbrev = staffAbbreviations[staffName];

            // Get all entries for this staff
            const allEntries = [
                ...Object.values(onDutyEntries),
                ...Object.values(extraHoursData)
            ].filter(entry => entry.staff === staffName);

            let html = `<h3>On Duty Details: ${abbrev} (${staffName})</h3>`;
            html += '<button onclick="generateOnDutyReport()" style="margin-bottom: 15px;"> Back to Report</button>';

            if (allEntries.length === 0) {
                html += '<p>No entries found for this staff.</p>';
                container.innerHTML = html;
                return;
            }

            // Sort by date (newest first)
            allEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Calculate totals
            let totalOnDutyDays = 0;
            let totalExtraHours = 0;
            let totalHours = 0;

            allEntries.forEach(entry => {
                const isOnDuty = entry.hasOwnProperty('type');
                if (isOnDuty) {
                    totalOnDutyDays++;
                    if (entry.type === 'extra') {
                        totalExtraHours += entry.hours;
                        totalHours += (8 + entry.hours);
                    } else {
                        totalHours += 8;
                    }
                } else {
                    totalExtraHours += entry.hours;
                    totalHours += entry.hours;
                }
            });

            html += `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4>Summary</h4>
                            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Total On Duty Days</div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${totalOnDutyDays}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Total Extra Hours</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #e74c3c;">${totalExtraHours.toFixed(1)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Total Hours</div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #27ae60;">${totalHours.toFixed(1)}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.9em; color: #666;">Average Hours/Day</div>
                                    <div style="font-size: 1.5em; font-weight: bold;">${totalOnDutyDays > 0 ? (totalHours / totalOnDutyDays).toFixed(1) : '0'}</div>
                                </div>
                            </div>
                        </div>`;

            html += '<div style="overflow-x: auto;">';
            html += '<table style="min-width: 1000px;">';
            html += '<thead><tr><th>Date</th><th>Type</th><th>Regular Shift</th><th>Extra Hours</th><th>Total Hours</th><th>Reason</th><th>Entry Date</th></tr></thead><tbody>';

            allEntries.forEach(entry => {
                const isOnDuty = entry.hasOwnProperty('type');
                const type = isOnDuty ? (entry.type === 'extra' ? 'On Duty (Extra)' : 'On Duty') : 'Extra Hours';
                const extraHours = isOnDuty ? (entry.type === 'extra' ? entry.hours : 0) : entry.hours;
                const totalHoursEntry = isOnDuty ? (entry.type === 'extra' ? (8 + entry.hours) : 8) : entry.hours;
                const originalShift = entry.regularShift || 'Not specified';

                html += `
                        <tr>
                            <td>${entry.date}</td>
                            <td>${type}</td>
                            <td>${originalShift}</td>
                            <td>${extraHours > 0 ? `${extraHours}h` : '-'}</td>
                            <td><strong>${totalHoursEntry}h</strong></td>
                            <td>${entry.reason || '-'}</td>
                            <td>${new Date(entry.entryDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</td>
                        </tr>
                    `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // ============== LEAVE MANAGEMENT FUNCTIONS ==============
        function updateLeaveToDate() {
            const fromDate = document.getElementById('leaveFromDate').value;
            if (fromDate) {
                document.getElementById('leaveToDate').value = fromDate;
                document.getElementById('leaveToDate').min = fromDate;
            }
        }

        function updateCoffToDate() {
            const fromDate = document.getElementById('coffFromDate').value;
            if (fromDate) {
                document.getElementById('coffToDate').value = fromDate;
                document.getElementById('coffToDate').min = fromDate;
            }
        }

        async function checkLeaveEligibility() {
            const staff = document.getElementById('leaveStaff').value;
            const fromDate = document.getElementById('leaveFromDate').value;
            const toDate = document.getElementById('leaveToDate').value;
            const errorDiv = document.getElementById('leaveEligibilityError');

            if (!fromDate || !toDate) {
                errorDiv.style.display = 'none';
                return;
            }

            const startDate = new Date(fromDate);
            const endDate = new Date(toDate);

            if (startDate > endDate) {
                errorDiv.textContent = 'To date cannot be earlier than from date';
                errorDiv.style.display = 'block';
                return;
            }

            // Check for conflicting leaves
            const dates = getDatesInRange(startDate, endDate);
            let conflicts = [];

            dates.forEach(date => {
                const dateKey = formatDateForInput(date);
                const dayIndex = date.getDay();
                const dayName = shiftData.days[dayIndex];
                const shift = shiftData.shifts[dayName][staff];

                // Check if already on leave
                const existingLeave = leaveRequests.find(req =>
                    req.staff === staff &&
                    req.date === dateKey &&
                    req.status === 'approved'
                );

                // Check if it's an off day
                const isOffDay = shift && (shift.includes('Off') || shift.includes('Off-operator'));
                const isOffDutyWorking = checkOffDutyWorking(staff, date);

                // Check if it's a holiday
                const isHoliday = holidays[dateKey];

                // Check if it's a skeleton shift
                const isSkeleton = skeletonShifts[dateKey];

                if (existingLeave) {
                    conflicts.push(`${dateKey}: Already on approved leave`);
                } else if (isHoliday) {
                    conflicts.push(`${dateKey}: Holiday - ${holidays[dateKey].name}`);
                } else if (isSkeleton) {
                    conflicts.push(`${dateKey}: Skeleton shift`);
                } else if (isOffDay && !isOffDutyWorking) {
                    conflicts.push(`${dateKey}: Off day (${shift})`);
                }
            });

            if (conflicts.length > 0) {
                errorDiv.innerHTML = '<strong>Potential Issues:</strong><ul>' +
                    conflicts.map(c => `<li>${c}</li>`).join('') + '</ul>';
                errorDiv.style.display = 'block';
            } else {
                errorDiv.style.display = 'none';
            }
        }

        async function submitLeave() {
            const staff = document.getElementById('leaveStaff').value;
            const fromDate = document.getElementById('leaveFromDate').value;
            const toDate = document.getElementById('leaveToDate').value;
            const leaveType = document.getElementById('leaveType').value;

            if (!staff || !fromDate || !toDate) {
                alert('Please fill in all required fields');
                return;
            }

            const startDate = new Date(fromDate);
            const endDate = new Date(toDate);

            if (startDate > endDate) {
                alert('To date cannot be earlier than from date');
                return;
            }

            const dates = getDatesInRange(startDate, endDate);

            try {
                // Create leave request for each date
                for (const date of dates) {
                    const dateKey = formatDateForInput(date);
                    const dayIndex = date.getDay();
                    const dayName = shiftData.days[dayIndex];
                    const shift = shiftData.shifts[dayName][staff];

                    // Check if already on leave
                    const existingLeave = leaveRequests.find(req =>
                        req.staff === staff &&
                        req.date === dateKey &&
                        req.status === 'approved'
                    );

                    // Check if it's an off day
                    const isOffDay = shift && (shift.includes('Off') || shift.includes('Off-operator'));
                    const isOffDutyWorking = checkOffDutyWorking(staff, date);

                    // Check if it's a holiday
                    const isHoliday = holidays[dateKey];

                    // Check if it's a skeleton shift
                    const isSkeleton = skeletonShifts[dateKey];

                    if (existingLeave) {
                        alert(`Leave for ${dateKey} already exists`);
                        continue;
                    }

                    if (isHoliday) {
                        alert(`${dateKey} is a holiday: ${holidays[dateKey].name}`);
                        continue;
                    }

                    if (isSkeleton) {
                        alert(`${dateKey} has a skeleton shift`);
                        continue;
                    }

                    if (isOffDay && !isOffDutyWorking) {
                        alert(`${dateKey} is an off day (${shift})`);
                        continue;
                    }

                    // Create leave request document
                    await db.collection('leaveRequests').add({
                        staff: staff,
                        date: dateKey,
                        type: leaveType,
                        status: 'pending',
                        requestedBy: currentUser.email,
                        requestedDate: new Date().toISOString(),
                        isCOFF: false
                    });
                }

                alert('Leave request(s) submitted for approval');
                closeModal('leaveModal');

                // Clear form
                document.getElementById('leaveFromDate').value = '';
                document.getElementById('leaveToDate').value = '';
                document.getElementById('leaveEligibilityError').style.display = 'none';

            } catch (error) {
                console.error('Error submitting leave:', error);
                alert('Failed to submit leave request. Please try again.');
            }
        }

        function loadLeaveForStaff() {
            const staff = document.getElementById('cancelLeaveStaff').value;
            const fromDate = document.getElementById('cancelFromDate').value;
            const toDate = document.getElementById('cancelToDate').value;

            const container = document.getElementById('leaveListContainer');

            if (!staff || !fromDate || !toDate) {
                container.innerHTML = '<p>Please select staff and date range</p>';
                return;
            }

            const startDate = new Date(fromDate);
            const endDate = new Date(toDate);

            if (startDate > endDate) {
                container.innerHTML = '<p style="color: #e74c3c;">To date cannot be earlier than from date</p>';
                return;
            }

            const dates = getDatesInRange(startDate, endDate);
            let leavesToCancel = [];

            // Collect all leave requests in the date range
            dates.forEach(date => {
                const dateKey = formatDateForInput(date);
                const dayIndex = date.getDay();
                const dayName = shiftData.days[dayIndex];

                leaveRequests.forEach(request => {
                    if (request.date === dateKey &&
                        (staff === '' || request.staff === staff) &&
                        request.status === 'approved') {

                        const shift = shiftData.shifts[dayName][request.staff];
                        leavesToCancel.push({
                            ...request,
                            dateObj: date,
                            dayName: dayName,
                            shift: shift
                        });
                    }
                });
            });

            if (leavesToCancel.length === 0) {
                container.innerHTML = '<p>No approved leaves found in the selected range</p>';
                return;
            }

            // Sort by date and staff
            leavesToCancel.sort((a, b) => {
                if (a.date === b.date) {
                    return a.staff.localeCompare(b.staff);
                }
                return new Date(a.date) - new Date(b.date);
            });

            let html = '<h4>Select Leaves to Cancel:</h4>';
            html += '<div style="display: flex; flex-direction: column; gap: 10px;">';

            leavesToCancel.forEach(leave => {
                const abbrev = staffAbbreviations[leave.staff];
                const dateStr = leave.dateObj.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });

                html += `
                        <div class="leave-cancel-item" style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <input type="checkbox" class="leave-cancel-checkbox" id="cancel_${leave.id}" data-id="${leave.id}">
                            <div style="flex: 1;">
                                <div style="font-weight: bold;">${abbrev} (${leave.staff})</div>
                                <div style="font-size: 0.9em; color: #666;">${dateStr}  ${leave.dayName}  ${leave.shift || 'No shift'}</div>
                            </div>
                        </div>
                    `;
            });

            html += '</div>';
            html += '<div style="margin-top: 15px;">';
            html += '<button onclick="cancelSelectedLeaves()" style="background: #e74c3c; color: white;">Cancel Selected Leaves</button>';
            html += '</div>';

            container.innerHTML = html;
        }

        async function cancelSelectedLeaves() {
            const checkboxes = document.querySelectorAll('.leave-cancel-checkbox:checked');

            if (checkboxes.length === 0) {
                alert('Please select at least one leave to cancel');
                return;
            }

            if (!confirm(`Are you sure you want to cancel ${checkboxes.length} leave(s)?`)) {
                return;
            }

            try {
                const cancelPromises = [];

                checkboxes.forEach(checkbox => {
                    const leaveId = checkbox.getAttribute('data-id');
                    cancelPromises.push(
                        db.collection('leaveRequests').doc(leaveId).update({
                            status: 'cancelled',
                            cancelledBy: currentUser.email,
                            cancelledDate: new Date().toISOString()
                        })
                    );
                });

                await Promise.all(cancelPromises);
                alert(`${checkboxes.length} leave(s) cancelled successfully`);
                loadLeaveForStaff(); // Refresh the list

            } catch (error) {
                console.error('Error cancelling leaves:', error);
                alert('Failed to cancel leaves. Please try again.');
            }
        }

        // ============== SHIFT EDIT FUNCTIONS ==============
        // In the loadShiftEditGrid function, update the select options:
        // In the loadShiftEditGrid function, update the select options:
        function loadShiftEditGrid() {
            const grid = document.getElementById('editShiftGrid');
            grid.innerHTML = '';

            const effectiveDate = document.getElementById('effectiveDate').value;
            if (!effectiveDate) {
                // Set default to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('effectiveDate').value = formatDateForInput(tomorrow);
                return;
            }

            const startDate = new Date(effectiveDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6); // One week

            const dates = getDatesInRange(startDate, endDate);

            dates.forEach(date => {
                const dateKey = formatDateForInput(date);
                const dayIndex = date.getDay();
                const dayName = shiftData.days[dayIndex];
                const dateStr = formatDateForDisplay(date);

                const dayDiv = document.createElement('div');
                dayDiv.className = 'edit-shift-day';
                dayDiv.innerHTML = `<h4>${dateStr}</h4>`;

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];

                staffList.forEach(staff => {
                    const currentShift = shiftData.shifts[dayName]?.[staff] || '';

                    const staffDiv = document.createElement('div');
                    staffDiv.className = 'edit-staff-shift';
                    staffDiv.innerHTML = `
                <label>${staffAbbreviations[staff]}:</label>
                <select id="shift_${dateKey}_${staff}">
                    <option value="">Select Shift</option>
                    <option value="5pm-1:30am" ${currentShift === '5pm-1:30am' ? 'selected' : ''}>5pm-1:30am</option>
                    <option value="4pm-12:30pm" ${currentShift === '4pm-12:30pm' ? 'selected' : ''}>4pm-12:30pm</option>
                    <option value="7pm-3:30pm" ${currentShift === '7pm-3:30pm' ? 'selected' : ''}>7pm-3:30pm</option>
                    <option value="7:00pm-3:30am" ${currentShift === '7:00pm-3:30am' ? 'selected' : ''}>7:00pm-3:30am</option>
                    <option value="Obituary duty 5pm-1:30am" ${currentShift === 'Obituary duty 5pm-1:30am' || currentShift.includes('Obituary duty') ? 'selected' : ''}>Obituary duty 5pm-1:30am</option>
                    <option value="Off" ${currentShift === 'Off' ? 'selected' : ''}>Off</option>
                    <option value="Off-operator" ${currentShift === 'Off-operator' ? 'selected' : ''}>Off-operator</option>
                </select>
            `;
                    dayDiv.appendChild(staffDiv);
                });

                grid.appendChild(dayDiv);
            });
        }

        async function saveShiftEdit() {
            const effectiveDate = document.getElementById('effectiveDate').value;
            if (!effectiveDate) {
                alert('Please select an effective date');
                return;
            }

            // Check if user has permission (admin only)
            if (currentUserRole !== 'admin') {
                alert('Only administrators can edit shifts.');
                return;
            }

            const startDate = new Date(effectiveDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            const dates = getDatesInRange(startDate, endDate);
            const updates = {};

            // Collect all changes
            dates.forEach(date => {
                const dateKey = formatDateForInput(date);
                const dayIndex = date.getDay();
                const dayName = shiftData.days[dayIndex];

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];

                staffList.forEach(staff => {
                    const select = document.getElementById(`shift_${dateKey}_${staff}`);
                    if (select && select.value) {
                        if (!updates[dayName]) {
                            updates[dayName] = {};
                        }
                        updates[dayName][staff] = select.value;
                    }
                });
            });

            if (Object.keys(updates).length === 0) {
                alert('No changes made to shifts');
                return;
            }

            try {
                console.log('Updating shifts with:', updates);

                // Prepare the update data
                const updateData = {
                    updatedAt: new Date().toISOString(),
                    lastUpdatedBy: currentUser.email
                };

                // Add shift updates
                Object.keys(updates).forEach(dayName => {
                    updateData[`shifts.${dayName}`] = updates[dayName];
                });

                console.log('Update data prepared:', updateData);

                // Update in Firestore using set with merge: true
                await db.collection('shiftData').doc('current').set({
                    shifts: {
                        ...shiftData.shifts,
                        ...updates
                    },
                    updatedAt: new Date().toISOString(),
                    lastUpdatedBy: currentUser.email
                }, { merge: true });

                // Also update local shiftData
                shiftData.shifts = {
                    ...shiftData.shifts,
                    ...updates
                };

                alert('Shift schedule updated successfully');
                closeModal('editShiftModal');

                // Refresh the UI
                updateAllViews();

            } catch (error) {
                console.error('Error updating shifts:', error);
                console.error('Error details:', error.message, error.stack);

                if (error.code === 'permission-denied') {
                    alert('Permission denied. You may not have permission to edit shifts.\n\nPlease ensure:\n1. You are logged in as an administrator\n2. Firestore rules allow write access\n3. Your email is verified');
                } else if (error.code === 'not-found') {
                    // Document doesn't exist, create it
                    try {
                        await createOrUpdateShiftDocument(updates);
                        alert('Shift schedule created and updated successfully');
                        closeModal('editShiftModal');
                        updateAllViews();
                    } catch (createError) {
                        console.error('Error creating shift document:', createError);
                        alert('Failed to create shift document: ' + createError.message);
                    }
                } else {
                    alert('Failed to update shifts: ' + error.message);
                }
            }
        }

        async function createOrUpdateShiftDocument(updates) {
            // First, get current data or initialize
            const shiftDoc = await db.collection('shiftData').doc('current').get();

            if (shiftDoc.exists) {
                // Update existing document
                const currentData = shiftDoc.data();
                const newShifts = {
                    ...currentData.shifts,
                    ...updates
                };

                await db.collection('shiftData').doc('current').update({
                    shifts: newShifts,
                    updatedAt: new Date().toISOString(),
                    lastUpdatedBy: currentUser.email
                });

                // Update local data
                shiftData.shifts = newShifts;
            } else {
                // Create new document with complete shift data
                const newShifts = {
                    "Sunday": {
                        "Sreejith": "Obituary duty 5pm-1:30am",
                        "Sajeev": "5pm-1:30am",
                        "Umesh": "5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Monday": {
                        "Sreejith": "Obituary duty 5pm-1:30am",
                        "Sajeev": "Off-operator",
                        "Umesh": "5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Tuesday": {
                        "Sreejith": "5pm-1:30am",
                        "Sajeev": "Obituary duty 5pm-1:30am",
                        "Umesh": "Off-operator",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Wednesday": {
                        "Sreejith": "Off-operator",
                        "Sajeev": "5pm-1:30am",
                        "Umesh": "Obituary duty 5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "Off-operator"
                    },
                    "Thursday": {
                        "Sreejith": "Obituary duty 5pm-1:30am",
                        "Sajeev": "4pm-12:30pm",
                        "Umesh": "5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Friday": {
                        "Sreejith": "5pm-1:30am",
                        "Sajeev": "Obituary duty 5pm-1:30am",
                        "Umesh": "7pm-3:30pm",
                        "Rajesh": "Off-operator",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Saturday": {
                        "Sreejith": "4pm-12:30pm",
                        "Sajeev": "5pm-1:30am",
                        "Umesh": "Obituary duty 5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    }
                };

                // Apply updates to the base data
                Object.keys(updates).forEach(dayName => {
                    if (newShifts[dayName]) {
                        newShifts[dayName] = {
                            ...newShifts[dayName],
                            ...updates[dayName]
                        };
                    } else {
                        newShifts[dayName] = updates[dayName];
                    }
                });

                await db.collection('shiftData').doc('current').set({
                    days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                    shifts: newShifts,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    lastUpdatedBy: currentUser.email
                });

                // Update local data
                shiftData = {
                    days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                    shifts: newShifts
                };
            }
        }

        // ============== OBITUARY DUTY FUNCTIONS ==============
        async function loadCurrentObituaryDuty() {
            const date = document.getElementById('obituaryDate').value;
            if (!date) {
                // Set default to today
                const today = new Date();
                document.getElementById('obituaryDate').value = formatDateForInput(today);
                return;
            }

            const dateObj = new Date(date);
            const dayIndex = dateObj.getDay();
            const dayName = shiftData.days[dayIndex];

            const infoDiv = document.getElementById('currentObituaryInfo');
            const fromSelect = document.getElementById('transferFromStaff');
            const toSelect = document.getElementById('transferToStaff');

            // Clear selects
            fromSelect.innerHTML = '<option value="">Select current obituary duty holder</option>';
            toSelect.innerHTML = '<option value="">Select new staff for obituary duty</option>';

            // Find staff with obituary duty
            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            let obituaryStaff = null;
            let obituaryShift = '';

            staffList.forEach(staff => {
                const shift = shiftData.shifts[dayName][staff];
                if (shift && shift.includes('Obituary duty')) {
                    obituaryStaff = staff;
                    obituaryShift = shift;
                }
            });

            if (obituaryStaff) {
                infoDiv.innerHTML = `
            <strong>Current Assignment:</strong> ${obituaryStaff}<br>
            <strong>Shift:</strong> ${obituaryShift}<br>
            <small>${dayName}, ${formatDateForDisplay(dateObj)}</small>
        `;

                // Populate transfer from select
                const optionFrom = document.createElement('option');
                optionFrom.value = obituaryStaff;
                optionFrom.textContent = `${obituaryStaff} (Current - ${obituaryShift})`;
                fromSelect.appendChild(optionFrom);

                // Populate transfer to select
                staffList.forEach(staff => {
                    if (staff !== obituaryStaff) {
                        const shift = shiftData.shifts[dayName][staff] || 'No shift';
                        const optionTo = document.createElement('option');
                        optionTo.value = staff;
                        optionTo.textContent = `${staff} (${shift})`;
                        toSelect.appendChild(optionTo);
                    }
                });
            } else {
                infoDiv.innerHTML = `
            <strong>No obituary duty assigned for this date</strong><br>
            <small>${dayName}, ${formatDateForDisplay(dateObj)}</small>
            <div style="margin-top: 10px; color: #e74c3c;">
                <small>Note: You can still transfer by selecting a staff member to assign obituary duty to.</small>
            </div>
        `;

                // Populate transfer from select with all staff
                staffList.forEach(staff => {
                    const shift = shiftData.shifts[dayName][staff] || 'No shift';
                    const optionFrom = document.createElement('option');
                    optionFrom.value = staff;
                    optionFrom.textContent = `${staff} (${shift})`;
                    fromSelect.appendChild(optionFrom);
                });

                // Populate transfer to select with all staff
                staffList.forEach(staff => {
                    const shift = shiftData.shifts[dayName][staff] || 'No shift';
                    const optionTo = document.createElement('option');
                    optionTo.value = staff;
                    optionTo.textContent = `${staff} (${shift})`;
                    toSelect.appendChild(optionTo);
                });
            }
        }
        function updateAvailableStaff() {
            const fromStaff = document.getElementById('transferFromStaff').value;
            const toSelect = document.getElementById('transferToStaff');

            // Clear and repopulate with all staff except the selected from staff
            toSelect.innerHTML = '<option value="">Select new staff for obituary duty</option>';

            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            staffList.forEach(staff => {
                if (staff !== fromStaff) {
                    const option = document.createElement('option');
                    option.value = staff;
                    option.textContent = staff;
                    toSelect.appendChild(option);
                }
            });
        }

        async function transferObituaryDuty() {
            const date = document.getElementById('obituaryDate').value;
            const fromStaff = document.getElementById('transferFromStaff').value;
            const toStaff = document.getElementById('transferToStaff').value;
            const reason = document.getElementById('obituaryReason').value;

            if (!date || !fromStaff || !toStaff) {
                alert('Please fill in all required fields');
                return;
            }

            if (fromStaff === toStaff) {
                alert('Cannot transfer to the same staff member');
                return;
            }

            const dateObj = new Date(date);
            const dayIndex = dateObj.getDay();
            const dayName = shiftData.days[dayIndex];

            try {
                console.log('Transferring obituary duty:', { date, dayName, fromStaff, toStaff });

                // First, verify the document exists
                const shiftDocRef = db.collection('shiftData').doc('current');
                const shiftDoc = await shiftDocRef.get();

                if (!shiftDoc.exists) {
                    console.error('Shift data document not found in Firestore');
                    alert('Shift data not found. The system needs to be initialized. Please contact administrator.');

                    // Try to create the document
                    await initializeFirestoreData();
                    return;
                }

                // Get current data
                const currentData = shiftDoc.data();
                console.log('Current Firestore data:', currentData);

                if (!currentData.shifts || !currentData.shifts[dayName]) {
                    console.error('Invalid shift data structure');
                    alert('Shift data structure is incorrect. Please refresh the page.');
                    return;
                }

                // Update the shifts object
                const updatedShifts = { ...currentData.shifts };

                // Check if fromStaff has obituary duty
                const currentShiftFrom = updatedShifts[dayName][fromStaff];
                let newShiftFrom = currentShiftFrom;

                if (currentShiftFrom && currentShiftFrom.includes('Obituary duty')) {
                    // Remove "Obituary duty " prefix
                    newShiftFrom = currentShiftFrom.replace('Obituary duty ', '');
                    console.log(`Removing obituary duty from ${fromStaff}: ${currentShiftFrom} -> ${newShiftFrom}`);
                } else {
                    console.log(`${fromStaff} does not have obituary duty: ${currentShiftFrom}`);
                }

                // Update toStaff's shift
                const currentShiftTo = updatedShifts[dayName][toStaff];
                let newShiftTo = currentShiftTo;

                if (currentShiftTo && !currentShiftTo.includes('Obituary duty')) {
                    // Add "Obituary duty " prefix
                    newShiftTo = 'Obituary duty ' + currentShiftTo;
                    console.log(`Adding obituary duty to ${toStaff}: ${currentShiftTo} -> ${newShiftTo}`);
                } else if (!currentShiftTo) {
                    // If staff has no shift, assign default
                    newShiftTo = 'Obituary duty 5pm-1:30am';
                    console.log(`${toStaff} has no shift, assigning: ${newShiftTo}`);
                } else {
                    console.log(`${toStaff} already has: ${currentShiftTo}`);
                }

                // Update the shifts object
                updatedShifts[dayName][fromStaff] = newShiftFrom;
                updatedShifts[dayName][toStaff] = newShiftTo;

                // Prepare update
                const updateData = {
                    shifts: updatedShifts,
                    updatedAt: new Date().toISOString(),
                    lastUpdatedBy: currentUser.email
                };

                console.log('Updating Firestore with:', updateData);

                // Update Firestore
                await shiftDocRef.update(updateData);

                // Also update local shiftData object
                shiftData.shifts = updatedShifts;

                // Log the transfer
                await db.collection('obituaryTransfers').add({
                    date: date,
                    dayName: dayName,
                    fromStaff: fromStaff,
                    toStaff: toStaff,
                    fromShift: currentShiftFrom,
                    toShift: newShiftTo,
                    reason: reason,
                    transferredBy: currentUser.email,
                    transferredAt: new Date().toISOString()
                });

                console.log('Transfer successful');
                alert('Obituary duty transferred successfully');

                // Close modal and clear form
                closeModal('editObituaryModal');
                document.getElementById('obituaryReason').value = '';

                // Refresh UI
                loadCurrentObituaryDuty();
                updateAllViews();

            } catch (error) {
                console.error('Error transferring obituary duty:', error);
                console.error('Error details:', error.message, error.stack);

                // More detailed error messages
                if (error.code === 'permission-denied') {
                    alert('Permission denied. You may not have permission to modify shift data.');
                } else if (error.code === 'not-found') {
                    alert('Document not found. Please refresh the page and try again.');
                } else if (error.message.includes('No document to update')) {
                    alert('No shift data document found. Please contact administrator.');
                } else if (error.code === 'failed-precondition') {
                    alert('Document was modified by another user. Please refresh and try again.');
                } else {
                    alert('Failed to transfer obituary duty: ' + error.message);
                }
            }
        }

        // ============== OFF-DUTY WORKING FUNCTIONS ==============
        function updateOffDutyStaffOptions() {
            const date = document.getElementById('offDutyDate').value;
            const staffSelect = document.getElementById('offDutyStaff');

            if (!date) return;

            const dateObj = new Date(date);
            const dayIndex = dateObj.getDay();
            const dayName = shiftData.days[dayIndex];

            staffSelect.innerHTML = '';

            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];

            staffList.forEach(staff => {
                const shift = shiftData.shifts[dayName][staff];
                const isOnLeave = checkIfOnLeave(staff, dateObj);
                const isOffDuty = shift && (shift.includes('Off') || shift.includes('Off-operator'));

                if (isOffDuty && !isOnLeave) {
                    const option = document.createElement('option');
                    option.value = staff;
                    option.textContent = `${staff} (${shift})`;
                    staffSelect.appendChild(option);
                }
            });

            if (staffSelect.options.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No off-duty staff available for this date';
                staffSelect.appendChild(option);
            }
        }

        async function saveOffDutyEntry() {
            const staff = document.getElementById('offDutyStaff').value;
            const date = document.getElementById('offDutyDate').value;
            const shift = document.getElementById('offDutyShift').value;
            const reason = document.getElementById('offDutyReason').value;

            if (!staff || !date || !shift) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                await db.collection('offDutyEntries').doc(date).set({
                    staff: staff,
                    date: date,
                    shift: shift,
                    reason: reason,
                    enteredBy: currentUser.email,
                    entryDate: new Date().toISOString()
                });

                alert('Off-duty working entry saved successfully');
                closeModal('offDutyModal');

                // Clear form
                document.getElementById('offDutyReason').value = '';

            } catch (error) {
                console.error('Error saving off-duty entry:', error);
                alert('Failed to save off-duty entry. Please try again.');
            }
        }

        function loadOffDutyForDate() {
            const date = document.getElementById('cancelOffDutyDate').value;
            const container = document.getElementById('offDutyListContainer');

            if (!date) {
                container.innerHTML = '<p>Please select a date</p>';
                return;
            }

            const dateKey = date;
            const entry = offDutyEntries[dateKey];

            if (!entry) {
                container.innerHTML = '<p>No off-duty working entries found for this date</p>';
                return;
            }

            const abbrev = staffAbbreviations[entry.staff];
            const dateObj = new Date(dateKey);
            const dateStr = dateObj.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            container.innerHTML = `
                    <h4>Off-Duty Working Entry for ${dateStr}</h4>
                    <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                        <div><strong>Staff:</strong> ${abbrev} (${entry.staff})</div>
                        <div><strong>Shift Worked:</strong> ${entry.shift}</div>
                        ${entry.reason ? `<div><strong>Reason:</strong> ${entry.reason}</div>` : ''}
                        <div><strong>Entered By:</strong> ${entry.enteredBy}</div>
                        <div><strong>Entry Date:</strong> ${new Date(entry.entryDate).toLocaleString()}</div>
                    </div>
                    <div style="text-align: center;">
                        <button onclick="cancelOffDutyEntry('${dateKey}')" style="background: #e74c3c; color: white;">Cancel This Entry</button>
                    </div>
                `;
        }

        async function cancelOffDutyEntry(dateKey) {
            if (!confirm('Are you sure you want to cancel this off-duty working entry?')) {
                return;
            }

            try {
                await db.collection('offDutyEntries').doc(dateKey).delete();
                alert('Off-duty working entry cancelled successfully');
                loadOffDutyForDate();
            } catch (error) {
                console.error('Error cancelling off-duty entry:', error);
                alert('Failed to cancel off-duty entry. Please try again.');
            }
        }

        // ============== ON DUTY FUNCTIONS ==============
        function toggleExtraHours() {
            const extraHoursSection = document.getElementById('extraHoursSection');
            const isExtra = document.querySelector('input[name="onDutyType"]:checked').value === 'extra';
            extraHoursSection.style.display = isExtra ? 'block' : 'none';
        }

async function saveOnDuty() {
    const staff = document.getElementById('onDutyStaff').value;
    const date = document.getElementById('onDutyDate').value;
    const onDutyType = document.querySelector('input[name="onDutyType"]:checked').value;
    const extraHours = onDutyType === 'extra' ? document.getElementById('onDutyExtraHours').value : null;
    const reason = document.getElementById('onDutyReason').value;
    
    if (!staff || !date || !reason) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const entry = {
            staff: staff,
            date: date,
            type: onDutyType === 'extra' ? 'extra' : 'regular',
            reason: reason,
            enteredBy: currentUser.email,
            entryDate: new Date().toISOString()
        };
        
        if (onDutyType === 'extra') {
            entry.hours = parseFloat(extraHours);
            
            // Get regular shift for this day
            const dateObj = new Date(date);
            const dayIndex = dateObj.getDay();
            const dayName = shiftData.days[dayIndex];
            const shift = shiftData.shifts[dayName][staff];
            entry.regularShift = shift || 'Not specified';
            
            // Create COFF history entry for the extra hours
            const coffEarned = parseFloat(extraHours) / 8;
            await db.collection('coffData').add({
                staff: staff,
                type: 'history',
                date: date,
                hours: parseFloat(extraHours),
                coffEarned: coffEarned,
                reason: `On Duty extra hours: ${reason}`,
                transactionDate: new Date().toISOString(),
                enteredBy: currentUser.email,
                source: 'on-duty-extra'
            });
            
            console.log(`COFF entry created: ${coffEarned} days for ${extraHours} extra hours`);
        }
        
        await db.collection('onDutyEntries').doc(date + '_' + staff).set(entry);
        
        if (onDutyType === 'extra') {
            alert(`On Duty with extra hours saved successfully!\n\n${extraHours} extra hours = ${(parseFloat(extraHours)/8).toFixed(2)} COFF days earned`);
        } else {
            alert('On Duty entry saved successfully');
        }
        
        closeModal('onDutyModal');
        
        // Trigger COFF recalculation
        calculateCOFFBalances();
        
    } catch (error) {
        console.error('Error saving On Duty entry:', error);
        alert('Failed to save On Duty entry. Please try again.\nError: ' + error.message);
    }
}

        // ============== LATE ENTRY FUNCTIONS ==============
        function updateRegularShiftTime() {
            const staff = document.getElementById('lateEntryStaff').value;
            const date = document.getElementById('lateEntryDate').value;
            const regularTimeInput = document.getElementById('regularShiftTime');

            if (!staff || !date) return;

            const dateObj = new Date(date);
            const dayIndex = dateObj.getDay();
            const dayName = shiftData.days[dayIndex];
            const shift = shiftData.shifts[dayName][staff];

            if (shift && !shift.includes('Off') && !shift.includes('Off-operator')) {
                // Extract start time from shift string
                let startTime = shift;

                // Remove "Obituary duty " prefix if present
                if (startTime.includes('Obituary duty ')) {
                    startTime = startTime.replace('Obituary duty ', '');
                }

                // Get the start time part (before the dash)
                startTime = startTime.split('-')[0].trim();

                // Convert to 24-hour format
                if (startTime.includes('pm') && !startTime.includes('12')) {
                    let hour = parseInt(startTime);
                    if (hour < 12) hour += 12;
                    startTime = hour.toString().padStart(2, '0') + ':00';
                } else if (startTime.includes('am')) {
                    let hour = parseInt(startTime);
                    if (hour === 12) hour = 0; // Midnight
                    startTime = hour.toString().padStart(2, '0') + ':00';
                } else {
                    // Handle times like "7:00pm"
                    if (startTime.includes(':')) {
                        let [hour, minute] = startTime.replace(/[ap]m/i, '').split(':');
                        hour = parseInt(hour);
                        minute = minute || '00';

                        if (startTime.toLowerCase().includes('pm') && hour < 12) {
                            hour += 12;
                        }
                        if (startTime.toLowerCase().includes('am') && hour === 12) {
                            hour = 0;
                        }

                        startTime = hour.toString().padStart(2, '0') + ':' + minute;
                    }
                }

                regularTimeInput.value = startTime;
            } else {
                regularTimeInput.value = 'No regular shift';
            }
        }
        function calculateDelay() {
            const regularTime = document.getElementById('regularShiftTime').value;
            const actualTime = document.getElementById('actualTime').value;
            const delayInput = document.getElementById('delayMinutes');
            const delayMessage = document.getElementById('delayMessage');
            const coffHoursRequired = document.getElementById('coffHoursRequired');

            if (!regularTime || !actualTime || regularTime === 'No regular shift') {
                delayInput.value = 'N/A';
                delayMessage.textContent = '';
                coffHoursRequired.textContent = '0';
                return;
            }

            // Convert times to minutes
            const [regularHour, regularMinute] = regularTime.split(':').map(Number);
            const [actualHour, actualMinute] = actualTime.split(':').map(Number);

            const regularTotalMinutes = regularHour * 60 + regularMinute;
            const actualTotalMinutes = actualHour * 60 + actualMinute;

            let delayMinutes = actualTotalMinutes - regularTotalMinutes;

            if (delayMinutes < 0) {
                delayMinutes = 0; // Early arrival, no delay
            }

            delayInput.value = `${delayMinutes} minutes`;

            // Calculate COFF requirement (1 hour COFF for every 60 minutes delay, rounded up)
            const coffHours = Math.ceil(delayMinutes / 60);
            coffHoursRequired.textContent = coffHours;

            if (delayMinutes === 0) {
                delayMessage.textContent = ' On time or early';
                delayMessage.style.color = '#27ae60';
            } else if (delayMinutes <= 15) {
                delayMessage.textContent = ' Minor delay (15 mins or less)';
                delayMessage.style.color = '#f39c12';
            } else if (delayMinutes <= 60) {
                delayMessage.textContent = ' Moderate delay (1 hour or less)';
                delayMessage.style.color = '#f39c12';
            } else {
                delayMessage.textContent = ' Significant delay (more than 1 hour)';
                delayMessage.style.color = '#e74c3c';
            }
        }

        function toggleCOFFRequirement() {
            const coffRequirementDiv = document.getElementById('coffRequirement');
            const isCOFF = document.querySelector('input[name="regularizeType"]:checked').value === 'coff';
            coffRequirementDiv.style.display = isCOFF ? 'block' : 'none';
        }

        async function saveLateEntry() {
            const staff = document.getElementById('lateEntryStaff').value;
            const date = document.getElementById('lateEntryDate').value;
            const regularTime = document.getElementById('regularShiftTime').value;
            const actualTime = document.getElementById('actualTime').value;
            const regularizeType = document.querySelector('input[name="regularizeType"]:checked').value;
            const reason = document.getElementById('lateEntryReason').value;

            if (!staff || !date || !actualTime) {
                alert('Please fill in all required fields');
                return;
            }

            if (regularTime === 'No regular shift') {
                alert('Cannot register late entry for a day with no regular shift');
                return;
            }

            try {
                const delayMinutes = parseInt(document.getElementById('delayMinutes').value) || 0;
                const coffHoursRequired = regularizeType === 'coff' ? Math.ceil(delayMinutes / 60) : 0;

                const entry = {
                    staff: staff,
                    date: date,
                    regularShiftTime: regularTime,
                    actualTime: actualTime,
                    delayMinutes: delayMinutes,
                    regularizeType: regularizeType,
                    regularizedFromCOFF: regularizeType === 'coff',
                    coffHoursRequired: coffHoursRequired,
                    reason: reason,
                    enteredBy: currentUser.email,
                    entryDate: new Date().toISOString()
                };

                await db.collection('lateEntries').add(entry);

                // If regularization from COFF is selected, update COFF balance
                if (regularizeType === 'coff' && coffHoursRequired > 0) {
                    const currentBalance = coffData.balances[staff] || 0;
                    const newBalance = currentBalance - (coffHoursRequired / 8); // Convert hours to days

                    await db.collection('coffData').add({
                        staff: staff,
                        type: 'history',
                        date: date,
                        coffUsed: coffHoursRequired / 8,
                        balanceAfter: newBalance,
                        reason: `Late entry regularization: ${delayMinutes} min delay`,
                        transactionDate: new Date().toISOString()
                    });

                    // Update COFF balance
                    await db.collection('coffData').doc(`${staff}_balance`).set({
                        staff: staff,
                        type: 'balance',
                        balance: newBalance,
                        updatedAt: new Date().toISOString()
                    }, { merge: true });
                }

                alert('Late entry registered successfully');
                closeModal('lateEntryModal');

            } catch (error) {
                console.error('Error saving late entry:', error);
                alert('Failed to register late entry. Please try again.');
            }
        }

        // ============== EXTRA HOURS FUNCTIONS ==============
        async function saveExtraHours() {
            const staff = document.getElementById('extraHoursStaff').value;
            const date = document.getElementById('extraHoursDate').value;
            const hours = document.getElementById('extraHours').value;
            const reason = document.getElementById('extraHoursReason').value;

            if (!staff || !date || !hours) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const entry = {
                    staff: staff,
                    date: date,
                    hours: parseFloat(hours),
                    reason: reason,
                    enteredBy: currentUser.email,
                    entryDate: new Date().toISOString(),
                    type: 'extra-hours'
                };

                // Save to Firestore
                const docId = `${date}_${staff}`;
                await db.collection('extraHoursData').doc(docId).set(entry);

                console.log('Extra hours saved:', entry);

                // Also add to COFF history
                const coffEarned = parseFloat(hours) / 8;
                await db.collection('coffData').add({
                    staff: staff,
                    type: 'history',
                    date: date,
                    hours: parseFloat(hours),
                    coffEarned: coffEarned,
                    reason: `Extra hours: ${reason || 'No reason provided'}`,
                    transactionDate: new Date().toISOString(),
                    enteredBy: currentUser.email
                });

                alert(`Extra hours saved successfully!\n\n${hours} hours = ${coffEarned.toFixed(2)} COFF days earned`);
                closeModal('extraHoursModal');

                // Clear form
                document.getElementById('extraHoursReason').value = '';

                // Trigger COFF recalculation
                calculateCOFFBalances();

            } catch (error) {
                console.error('Error saving extra hours:', error);
                alert('Failed to save extra hours. Please try again.\nError: ' + error.message);
            }
        }
        // ============== COFF MANAGEMENT FUNCTIONS ==============
        function updateCOFFBalanceDisplay() {
            const staff = document.getElementById('coffStaff').value;
            const balanceDiv = document.getElementById('coffBalanceDisplay');

            const balance = coffData.balances[staff] || 0;
            const hours = balance * 8;

            let status = 'Not eligible for COFF';
            let statusColor = '#e74c3c';

            if (balance >= 1) {
                status = 'Eligible for COFF';
                statusColor = '#27ae60';
            } else if (balance >= 0.5) {
                status = 'Partial COFF available (minimum 0.5 day required)';
                statusColor = '#f39c12';
            }

            balanceDiv.innerHTML = `
                    <div style="font-size: 1.5em; font-weight: bold; color: ${statusColor};">${balance.toFixed(2)} days (${hours.toFixed(1)} hours)</div>
                    <div style="color: ${statusColor}; margin-top: 5px;">${status}</div>
                `;
        }

        async function submitCOFF() {
            const staff = document.getElementById('coffStaff').value;
            const fromDate = document.getElementById('coffFromDate').value;
            const toDate = document.getElementById('coffToDate').value;
            const reason = document.getElementById('coffReason').value;

            if (!staff || !fromDate || !toDate) {
                alert('Please fill in all required fields');
                return;
            }

            const startDate = new Date(fromDate);
            const endDate = new Date(toDate);

            if (startDate > endDate) {
                alert('To date cannot be earlier than from date');
                return;
            }

            const balance = coffData.balances[staff] || 0;

            if (balance < 1) {
                alert(`Insufficient COFF balance: ${balance.toFixed(2)} days. Minimum 1 day required.`);
                return;
            }

            try {
                // Create COFF request
                await db.collection('coffData').add({
                    staff: staff,
                    type: 'pending',
                    fromDate: fromDate,
                    toDate: toDate,
                    daysRequested: Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1,
                    reason: reason,
                    requestedBy: currentUser.email,
                    requestedDate: new Date().toISOString(),
                    status: 'pending'
                });

                alert('COFF request submitted successfully');
                closeModal('applyCOFFModal');

                // Clear form
                document.getElementById('coffFromDate').value = '';
                document.getElementById('coffToDate').value = '';
                document.getElementById('coffReason').value = '';

            } catch (error) {
                console.error('Error submitting COFF request:', error);
                alert('Failed to submit COFF request. Please try again.');
            }
        }

        function viewCOFFSummary() {
            // Switch to COFF tab and show summary
            switchTab('coff');
        }

function renderCOFFSummary() {
    const container = document.getElementById('coff-summary-container');
    
    let html = '<h3>COFF Balances</h3>';
    
    // Calculate hours per staff from different sources
    const extraHoursByStaff = {};
    const odExtraHoursByStaff = {};
    const offDutyByStaff = {};
    
    // Initialize
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    staffList.forEach(staff => {
        extraHoursByStaff[staff] = 0;
        odExtraHoursByStaff[staff] = 0;
        offDutyByStaff[staff] = 0;
    });
    
    // Count standalone extra hours
    Object.values(extraHoursData).forEach(entry => {
        if (entry && entry.staff && entry.hours && entry.type !== 'Off-Duty Working') {
            const hours = parseFloat(entry.hours) || 0;
            extraHoursByStaff[entry.staff] += hours;
        }
    });
    
    // Count OD extra hours
    Object.values(onDutyEntries).forEach(entry => {
        if (entry && entry.staff && entry.type === 'extra' && entry.hours) {
            const hours = parseFloat(entry.hours) || 0;
            odExtraHoursByStaff[entry.staff] += hours;
        }
    });
    
    // Count off-duty working days
    Object.values(offDutyEntries).forEach(entry => {
        if (entry && entry.staff) {
            offDutyByStaff[entry.staff] += 1;
        }
    });
    
    html += '<div style="overflow-x: auto;">';
    html += '<table style="min-width: 1000px;">';
    html += '<thead><tr><th>Staff</th><th>Extra Hours</th><th>OD Extra Hours</th><th>Off-Duty Days</th><th>Total COFF Earned</th><th>Current Balance</th><th>Status</th></tr></thead><tbody>';
    
    staffList.forEach(staff => {
        const balance = coffData.balances[staff] || 0;
        const extraHours = extraHoursByStaff[staff];
        const odExtraHours = odExtraHoursByStaff[staff];
        const offDutyDays = offDutyByStaff[staff];
        const abbrev = staffAbbreviations[staff];
        
        // Calculate COFF earned from different sources
        const extraHoursCoff = extraHours / 8;
        const odExtraCoff = odExtraHours / 8;
        const offDutyCoff = offDutyDays;
        const totalCoffEarned = extraHoursCoff + odExtraCoff + offDutyCoff;
        
        let status = '<span style="color: #e74c3c;">Not eligible</span>';
        let statusText = 'Not eligible';
        if (balance >= 1) {
            status = '<span style="color: #27ae60;">Eligible</span>';
            statusText = 'Eligible';
        } else if (balance >= 0.5) {
            status = '<span style="color: #f39c12;">Partial</span>';
            statusText = 'Partial (needs 0.5 more)';
        }
        
        html += `
            <tr>
                <td><strong>${abbrev} (${staff})</strong></td>
                <td>${extraHours.toFixed(1)} hours<br><small>${extraHoursCoff.toFixed(2)} days</small></td>
                <td>${odExtraHours.toFixed(1)} hours<br><small>${odExtraCoff.toFixed(2)} days</small></td>
                <td>${offDutyDays} days<br><small>${offDutyCoff.toFixed(2)} COFF days</small></td>
                <td><strong>${totalCoffEarned.toFixed(2)} days</strong></td>
                <td><strong>${balance.toFixed(2)} days</strong><br><small>(${(balance * 8).toFixed(1)} hours)</small></td>
                <td>${status}<br><small>${statusText}</small></td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    // Add breakdown of recent OD extra hours
    html += '<h4 style="margin-top: 30px;">Recent On Duty (OD) Extra Hours</h4>';
    
    // Get recent OD extra hours (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const recentODExtra = Object.values(onDutyEntries)
        .filter(entry => {
            if (!entry || !entry.date || entry.type !== 'extra') return false;
            const entryDate = new Date(entry.date);
            return entryDate >= thirtyDaysAgo;
        })
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (recentODExtra.length > 0) {
        html += '<div style="overflow-x: auto;">';
        html += '<table style="min-width: 800px;">';
        html += '<thead><tr><th>Date</th><th>Staff</th><th>Regular Shift</th><th>Extra Hours</th><th>COFF Earned</th><th>Reason</th></tr></thead><tbody>';
        
        recentODExtra.forEach(entry => {
            const abbrev = staffAbbreviations[entry.staff];
            const coffEarned = parseFloat(entry.hours) / 8;
            
            html += `
                <tr>
                    <td>${entry.date}</td>
                    <td>${abbrev} (${entry.staff})</td>
                    <td>${entry.regularShift || 'Not specified'}</td>
                    <td><strong>${entry.hours} hours</strong></td>
                    <td>${coffEarned.toFixed(2)} COFF days</td>
                    <td>${entry.reason || 'No reason provided'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
    } else {
        html += '<p>No On Duty extra hours recorded in the last 30 days.</p>';
    }
    
    container.innerHTML = html;
}

        function renderCOFFHistory() {
            const container = document.getElementById('coff-history-container');

            // Show pending COFF requests (admin only)
            if (currentUserRole === 'admin' && coffData.pending.length > 0) {
                let html = '<h3>Pending COFF Requests</h3>';
                html += '<div style="overflow-x: auto;">';
                html += '<table><thead><tr><th>Staff</th><th>Period</th><th>Days</th><th>Reason</th><th>Requested</th><th>Actions</th></tr></thead><tbody>';

                coffData.pending.forEach(request => {
                    const abbrev = staffAbbreviations[request.staff];
                    html += `
                            <tr>
                                <td>${abbrev} (${request.staff})</td>
                                <td>${request.fromDate} to ${request.toDate}</td>
                                <td>${request.daysRequested} days</td>
                                <td>${request.reason || ''}</td>
                                <td>${new Date(request.requestedDate).toLocaleDateString()}</td>
                                <td>
                                    <button onclick="approveCOFF('${request.id}', '${request.staff}', ${request.daysRequested})"
                                            style="padding: 4px 8px; font-size: 0.8em; background: #27ae60; color: white;">Approve</button>
                                    <button onclick="rejectCOFF('${request.id}')"
                                            style="padding: 4px 8px; font-size: 0.8em; background: #e74c3c; color: white;">Reject</button>
                                </td>
                            </tr>
                        `;
                });

                html += '</tbody></table></div>';
                container.innerHTML += html;
            }

            // Show COFF history
            if (coffData.history.length > 0) {
                let html = '<h3>COFF History</h3>';
                html += '<div style="overflow-x: auto;">';
                html += '<table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Hours</th><th>COFF Days</th><th>Balance After</th><th>Reason</th></tr></thead><tbody>';

                // Sort by date (newest first)
                const sortedHistory = [...coffData.history].sort((a, b) =>
                    new Date(b.transactionDate || b.date) - new Date(a.transactionDate || a.date)
                );

                // Show only last 20 entries
                sortedHistory.slice(0, 20).forEach(entry => {
                    const abbrev = staffAbbreviations[entry.staff];
                    const hours = entry.hours || 0;
                    const coffDays = entry.coffEarned || entry.coffUsed || 0;
                    const coffDisplay = entry.coffEarned ? `+${coffDays.toFixed(2)}` :
                        entry.coffUsed ? `-${coffDays.toFixed(2)}` : 'N/A';

                    html += `
                            <tr>
                                <td>${entry.date}</td>
                                <td>${abbrev} (${entry.staff})</td>
                                <td>${entry.type}</td>
                                <td>${hours > 0 ? `${hours}h` : '-'}</td>
                                <td>${coffDisplay}</td>
                                <td>${entry.balanceAfter ? entry.balanceAfter.toFixed(2) + ' days' : 'N/A'}</td>
                                <td>${entry.reason || ''}</td>
                            </tr>
                        `;
                });

                html += '</tbody></table></div>';
                container.innerHTML += html;
            }
        }

        async function approveCOFF(requestId, staff, daysRequested) {
            if (!confirm(`Approve COFF request for ${staff} (${daysRequested} days)?`)) {
                return;
            }

            try {
                // Update COFF balance
                const currentBalance = coffData.balances[staff] || 0;
                const newBalance = currentBalance - daysRequested;

                if (newBalance < 0) {
                    alert('Insufficient COFF balance. Cannot approve request.');
                    return;
                }

                // Update balance
                await db.collection('coffData').doc(`${staff}_balance`).set({
                    staff: staff,
                    type: 'balance',
                    balance: newBalance,
                    updatedAt: new Date().toISOString()
                }, { merge: true });

                // Move request to history
                const request = coffData.pending.find(req => req.id === requestId);
                if (request) {
                    await db.collection('coffData').doc(requestId).update({
                        type: 'history',
                        status: 'approved',
                        approvedBy: currentUser.email,
                        approvedDate: new Date().toISOString(),
                        balanceAfter: newBalance
                    });
                }

                alert('COFF request approved successfully');
                renderCOFFHistory(); // Refresh display

            } catch (error) {
                console.error('Error approving COFF request:', error);
                alert('Failed to approve COFF request. Please try again.');
            }
        }

        async function rejectCOFF(requestId) {
            if (!confirm('Reject this COFF request?')) {
                return;
            }

            try {
                await db.collection('coffData').doc(requestId).update({
                    status: 'rejected',
                    rejectedBy: currentUser.email,
                    rejectedDate: new Date().toISOString()
                });

                alert('COFF request rejected');
                renderCOFFHistory(); // Refresh display

            } catch (error) {
                console.error('Error rejecting COFF request:', error);
                alert('Failed to reject COFF request. Please try again.');
            }
        }

        // ============== HOLIDAY FUNCTIONS ==============
        async function checkExistingHoliday() {
            const date = document.getElementById('holidayDate').value;
            const infoDiv = document.getElementById('existingHolidayInfo');
            const actionBtn = document.getElementById('holidayActionBtn');

            if (!date) return;

            const holiday = holidays[date];

            if (holiday) {
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                        <strong>Existing Holiday:</strong><br>
                        <div style="margin-top: 5px;">
                            ${holiday.name}<br>
                            <small>Added on: ${new Date(holiday.addedDate).toLocaleDateString()}</small>
                        </div>
                    `;
                actionBtn.textContent = 'Remove Holiday';
                actionBtn.className = 'btn-danger';
            } else {
                infoDiv.style.display = 'none';
                actionBtn.textContent = 'Add Holiday';
                actionBtn.className = '';
            }
        }

        async function saveHoliday() {
            const name = document.getElementById('holidayName').value.trim();
            const date = document.getElementById('holidayDate').value;

            if (!name || !date) {
                alert('Please fill in all required fields');
                return;
            }

            const existingHoliday = holidays[date];

            try {
                if (existingHoliday) {
                    // Remove holiday
                    await db.collection('holidays').doc(date).delete();
                    alert('Holiday removed successfully');
                } else {
                    // Add holiday
                    await db.collection('holidays').doc(date).set({
                        name: name,
                        date: date,
                        addedBy: currentUser.email,
                        addedDate: new Date().toISOString()
                    });
                    alert('Holiday added successfully');
                }

                closeModal('holidayModal');

                // Clear form
                document.getElementById('holidayName').value = '';
                document.getElementById('holidayDate').value = '';

            } catch (error) {
                console.error('Error saving holiday:', error);
                alert('Failed to save holiday. Please try again.');
            }
        }

        // ============== SKELETON SHIFT FUNCTIONS ==============
        async function checkExistingSkeleton() {
            const date = document.getElementById('skeletonDate').value;
            const infoDiv = document.getElementById('existingSkeletonInfo');
            const actionBtn = document.getElementById('skeletonActionBtn');

            if (!date) return;

            const skeleton = skeletonShifts[date];

            if (skeleton) {
                infoDiv.style.display = 'block';
                infoDiv.innerHTML = `
                        <strong>Existing Skeleton Shift:</strong><br>
                        <div style="margin-top: 5px;">
                            ${skeleton.hours} hours<br>
                            ${skeleton.reason ? `Reason: ${skeleton.reason}<br>` : ''}
                            <small>Added on: ${new Date(skeleton.addedDate).toLocaleDateString()}</small>
                        </div>
                    `;
                actionBtn.textContent = 'Remove Skeleton Shift';
                actionBtn.className = 'btn-danger';
            } else {
                infoDiv.style.display = 'none';
                actionBtn.textContent = 'Add Skeleton Shift';
                actionBtn.className = '';
            }
        }

        async function saveSkeletonShift() {
            const date = document.getElementById('skeletonDate').value;
            const hours = document.getElementById('skeletonHours').value;
            const reason = document.getElementById('skeletonReason').value.trim();

            if (!date || !hours) {
                alert('Please fill in all required fields');
                return;
            }

            const existingSkeleton = skeletonShifts[date];

            try {
                if (existingSkeleton) {
                    // Remove skeleton shift
                    await db.collection('skeletonShifts').doc(date).delete();
                    alert('Skeleton shift removed successfully');
                } else {
                    // Get excluded staff
                    const excludedStaff = [];
                    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                    staffList.forEach(staff => {
                        const checkbox = document.getElementById(`exclude_${staff}`);
                        if (checkbox && checkbox.checked) {
                            excludedStaff.push(staff);
                        }
                    });

                    // Add skeleton shift
                    await db.collection('skeletonShifts').doc(date).set({
                        date: date,
                        hours: parseInt(hours),
                        reason: reason,
                        excludedStaff: excludedStaff,
                        addedBy: currentUser.email,
                        addedDate: new Date().toISOString()
                    });
                    alert('Skeleton shift added successfully');
                }

                closeModal('skeletonModal');

                // Clear form
                document.getElementById('skeletonDate').value = '';
                document.getElementById('skeletonHours').value = '8';
                document.getElementById('skeletonReason').value = '';

            } catch (error) {
                console.error('Error saving skeleton shift:', error);
                alert('Failed to save skeleton shift. Please try again.');
            }
        }

        function calculateSkeletonOT() {
            // Reset OT data
            const currentDate = new Date();
            const currentMonthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
            otData.monthly[currentMonthKey] = {};

            // Initialize OT for all staff
            const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
            staffList.forEach(staff => {
                otData.monthly[currentMonthKey][staff] = 0;
            });

            // Calculate OT for skeleton shifts
            Object.entries(skeletonShifts).forEach(([date, skeleton]) => {
                const dateObj = new Date(date);
                const skeletonMonthKey = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;

                // Only calculate for current month
                if (skeletonMonthKey === currentMonthKey) {
                    staffList.forEach(staff => {
                        // Check if staff is not excluded
                        if (!skeleton.excludedStaff?.includes(staff)) {
                            const dayIndex = dateObj.getDay();
                            const dayName = shiftData.days[dayIndex];
                            const shift = shiftData.shifts[dayName][staff];

                            // If staff has a regular shift (not off), add skeleton OT hours
                            if (shift && !shift.includes('Off') && !shift.includes('Off-operator')) {
                                const otHours = parseFloat(skeleton.hours) || 0;

                                // Initialize if not exists
                                if (!otData.monthly[skeletonMonthKey][staff]) {
                                    otData.monthly[skeletonMonthKey][staff] = 0;
                                }

                                otData.monthly[skeletonMonthKey][staff] += otHours;
                            }
                        }
                    });
                }
            });

            // Also calculate OT from extra hours
            Object.values(extraHoursData).forEach(entry => {
                const dateObj = new Date(entry.date);
                const monthKey = `${dateObj.getFullYear()}-${(dateObj.getMonth() + 1).toString().padStart(2, '0')}`;

                if (monthKey === currentMonthKey) {
                    const staff = entry.staff;
                    const hours = parseFloat(entry.hours) || 0;

                    if (!otData.monthly[monthKey][staff]) {
                        otData.monthly[monthKey][staff] = 0;
                    }

                    otData.monthly[monthKey][staff] += hours;
                }
            });
        }

        // ============== APPROVAL FUNCTIONS ==============
        function renderApprovals() {
            const pendingContainer = document.getElementById('pending-approvals-container');
            const approvedContainer = document.getElementById('approved-leaves-container');
            const rejectedContainer = document.getElementById('rejected-leaves-container');

            // Filter leave requests by status
            const pendingRequests = leaveRequests.filter(req => req.status === 'pending');
            const approvedRequests = leaveRequests.filter(req => req.status === 'approved');
            const rejectedRequests = leaveRequests.filter(req => req.status === 'rejected');

            // Render pending approvals
            if (pendingRequests.length === 0) {
                pendingContainer.innerHTML = '<p>No pending approvals.</p>';
            } else {
                let html = '<div class="approval-list">';

                pendingRequests.forEach(request => {
                    const abbrev = staffAbbreviations[request.staff];
                    const date = new Date(request.date);
                    const dateStr = date.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    html += `
                            <div class="approval-item">
                                <div class="approval-header">
                                    <div>
                                        <strong>${abbrev} (${request.staff})</strong><br>
                                        <small>${dateStr}  ${request.type} leave</small>
                                    </div>
                                    <div style="font-size: 0.8em; color: #7f8c8d;">
                                        Requested by: ${request.requestedBy}<br>
                                        ${new Date(request.requestedDate).toLocaleDateString()}
                                    </div>
                                </div>
                                ${request.reason ? `<div style="margin-top: 5px;"><em>Reason: ${request.reason}</em></div>` : ''}
                                <div class="approval-actions">
                                    <button class="btn-success" onclick="showApprovalReasonModal('${request.id}', 'approve')">Approve</button>
                                    <button class="btn-danger" onclick="showApprovalReasonModal('${request.id}', 'reject')">Reject</button>
                                </div>
                            </div>
                        `;
                });

                html += '</div>';
                pendingContainer.innerHTML = html;
            }

            // Render approved leaves (last 30 days)
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

            const recentApproved = approvedRequests.filter(req =>
                new Date(req.date) >= thirtyDaysAgo
            ).slice(0, 10); // Show only recent 10

            if (recentApproved.length === 0) {
                approvedContainer.innerHTML = '<p>No recently approved leaves.</p>';
            } else {
                let html = '<div class="approval-list">';

                recentApproved.forEach(request => {
                    const abbrev = staffAbbreviations[request.staff];
                    const date = new Date(request.date);
                    const dateStr = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });

                    html += `
                            <div class="approval-item approved">
                                <div class="approval-header">
                                    <div>
                                        <strong>${abbrev} (${request.staff})</strong><br>
                                        <small>${dateStr}  ${request.type} leave</small>
                                    </div>
                                    <div style="font-size: 0.8em; color: #27ae60;">
                                        Approved<br>
                                        ${request.approvedBy ? `by ${request.approvedBy}` : ''}
                                    </div>
                                </div>
                                ${request.approvalReason ? `<div style="margin-top: 5px;"><em>Approval note: ${request.approvalReason}</em></div>` : ''}
                            </div>
                        `;
                });

                html += '</div>';
                approvedContainer.innerHTML = html;
            }

            // Render rejected leaves (last 30 days)
            const recentRejected = rejectedRequests.filter(req =>
                new Date(req.date) >= thirtyDaysAgo
            ).slice(0, 10); // Show only recent 10

            if (recentRejected.length === 0) {
                rejectedContainer.innerHTML = '<p>No recently rejected leaves.</p>';
            } else {
                let html = '<div class="approval-list">';

                recentRejected.forEach(request => {
                    const abbrev = staffAbbreviations[request.staff];
                    const date = new Date(request.date);
                    const dateStr = date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });

                    html += `
                            <div class="approval-item rejected">
                                <div class="approval-header">
                                    <div>
                                        <strong>${abbrev} (${request.staff})</strong><br>
                                        <small>${dateStr}  ${request.type} leave</small>
                                    </div>
                                    <div style="font-size: 0.8em; color: #e74c3c;">
                                        Rejected<br>
                                        ${request.rejectedBy ? `by ${request.rejectedBy}` : ''}
                                    </div>
                                </div>
                                ${request.rejectionReason ? `<div style="margin-top: 5px;"><em>Rejection reason: ${request.rejectionReason}</em></div>` : ''}
                            </div>
                        `;
                });

                html += '</div>';
                rejectedContainer.innerHTML = html;
            }
        }

        function showApprovalReasonModal(requestId, action) {
            currentApprovalRequestId = requestId;
            currentApprovalAction = action;

            document.getElementById('approvalReason').value = '';
            openModal('approvalReasonModal');
        }

        async function approveLeaveWithReason() {
            const reason = document.getElementById('approvalReason').value;

            try {
                await db.collection('leaveRequests').doc(currentApprovalRequestId).update({
                    status: 'approved',
                    approvedBy: currentUser.email,
                    approvedDate: new Date().toISOString(),
                    approvalReason: reason
                });

                alert('Leave approved successfully');
                closeModal('approvalReasonModal');
                renderApprovals(); // Refresh approvals list

            } catch (error) {
                console.error('Error approving leave:', error);
                alert('Failed to approve leave. Please try again.');
            }
        }

        async function rejectLeaveWithReason() {
            const reason = document.getElementById('approvalReason').value;

            try {
                await db.collection('leaveRequests').doc(currentApprovalRequestId).update({
                    status: 'rejected',
                    rejectedBy: currentUser.email,
                    rejectedDate: new Date().toISOString(),
                    rejectionReason: reason
                });

                alert('Leave rejected');
                closeModal('approvalReasonModal');
                renderApprovals(); // Refresh approvals list

            } catch (error) {
                console.error('Error rejecting leave:', error);
                alert('Failed to reject leave. Please try again.');
            }
        }

        // ============== COFF BALANCE CALCULATION ==============
// Make sure you have this function defined BEFORE saveCOFFBalances

function calculateCOFFBalances() {
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    
    // Initialize balances
    const newBalances = {};
    staffList.forEach(staff => {
        newBalances[staff] = 0;
    });
    
    // Calculate COFF from extra hours (standalone)
    Object.values(extraHoursData).forEach(entry => {
        if (entry && entry.staff && entry.hours && entry.type !== 'Off-Duty Working') {
            const staff = entry.staff;
            const hours = parseFloat(entry.hours) || 0;
            const coffDays = hours / 8; // 8 hours = 1 COFF day
            
            if (coffDays > 0) {
                newBalances[staff] = (newBalances[staff] || 0) + coffDays;
            }
        }
    });
    
    // Calculate COFF from off-duty working
    Object.values(offDutyEntries).forEach(entry => {
        if (entry && entry.staff) {
            const staff = entry.staff;
            // Off-duty working counts as 8 hours (full day) for COFF
            newBalances[staff] = (newBalances[staff] || 0) + 1;
        }
    });
    
    // Calculate COFF from On Duty (OD) with extra hours
    Object.values(onDutyEntries).forEach(entry => {
        if (entry && entry.staff && entry.type === 'extra' && entry.hours) {
            const staff = entry.staff;
            const extraHours = parseFloat(entry.hours) || 0;
            const coffDays = extraHours / 8;
            
            if (coffDays > 0) {
                newBalances[staff] = (newBalances[staff] || 0) + coffDays;
            }
        }
    });
    
    // Update local COFF balances
    coffData.balances = newBalances;
    
    console.log('COFF Balances calculated:', coffData.balances);
    
    // Update stats
    updateStats();
    
    // Return the balances for immediate use
    return newBalances;
}

// Add this function BEFORE fixCOFFData() and fixODCOFFData() functions

async function saveCOFFBalances() {
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    
    try {
        console.log('Saving COFF balances to Firestore...');
        
        for (const staff of staffList) {
            const balance = coffData.balances[staff] || 0;
            
            await db.collection('coffData').doc(`${staff}_balance`).set({
                staff: staff,
                type: 'balance',
                balance: balance,
                updatedAt: new Date().toISOString(),
                lastCalculated: new Date().toISOString(),
                calculatedBy: currentUser?.email || 'system'
            }, { merge: true });
            
            console.log(`Saved ${staff}: ${balance.toFixed(2)} COFF days`);
        }
        
        console.log('COFF balances saved successfully');
        return true;
        
    } catch (error) {
        console.error('Error saving COFF balances:', error);
        throw error; // Re-throw the error so it can be caught by the calling function
    }
}

        // ============== INITIALIZATION FUNCTIONS ==============
        function setDefaultDates() {
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);

            const dateFormat = formatDateForInput(today);
            const tomorrowFormat = formatDateForInput(tomorrow);

            // Set default dates for all modals
            const dateInputs = [
                'leaveFromDate', 'leaveToDate',
                'cancelFromDate', 'cancelToDate',
                'obituaryDate', 'offDutyDate',
                'onDutyDate', 'lateEntryDate',
                'extraHoursDate', 'cancelOffDutyDate',
                'coffFromDate', 'coffToDate',
                'holidayDate', 'skeletonDate',
                'effectiveDate'
            ];

            dateInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    if (inputId === 'effectiveDate') {
                        input.value = tomorrowFormat;
                    } else {
                        input.value = dateFormat;
                    }

                    // Set min date to today for future dates
                    if (inputId.includes('FromDate') || inputId.includes('ToDate') ||
                        inputId.includes('Date') && !inputId.includes('cancel')) {
                        input.min = dateFormat;
                    }
                }
            });
        }

        function initTouchEvents() {
            // Add touch event listeners for better mobile experience
            const dayCards = document.querySelectorAll('.day-card, .day-cell');
            dayCards.forEach(card => {
                card.addEventListener('touchstart', function () {
                    this.style.transform = 'scale(0.98)';
                });

                card.addEventListener('touchend', function () {
                    this.style.transform = '';
                });
            });

            // Prevent double tap zoom on buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function (e) {
                    if (e.touches.length > 1) {
                        e.preventDefault();
                    }
                });
            });
        }

        // Initialize the application
        initApp();

        // Close modals when clicking outside
        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            });
        };

        // Prevent form submission on Enter key
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Enter' &&
                (event.target.type === 'text' || event.target.type === 'password' ||
                    event.target.type === 'email' || event.target.tagName === 'TEXTAREA')) {
                event.preventDefault();
            }
        });

        // Handle escape key to close modals
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }
        });

    </script>
</body>
</html>
