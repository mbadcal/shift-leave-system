<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shift & Leave Management System</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f5f5;
            padding: 10px;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* Login Modal Styles */
        .login-modal {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 30px;
        }

            .login-header h1 {
                color: #2c3e50;
                font-size: 1.8em;
                margin-bottom: 10px;
            }

            .login-header p {
                color: #7f8c8d;
                font-size: 0.95em;
            }

        .login-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2em;
        }

        .login-form {
            margin-bottom: 20px;
        }

        .login-input {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

            .login-input:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }

            .login-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 7px 14px rgba(102, 126, 234, 0.2);
            }

        .login-links {
            margin-top: 20px;
            font-size: 0.9em;
            color: #7f8c8d;
        }

            .login-links a {
                color: #667eea;
                text-decoration: none;
            }

                .login-links a:hover {
                    text-decoration: underline;
                }

        .login-error {
            background: #ffeaea;
            color: #e74c3c;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9em;
            display: none;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .user-role {
            background: #e8f4fc;
            color: #3498db;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
        }

            .logout-btn:hover {
                background: #c0392b;
            }

        .admin-badge {
            background: #9b59b6;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .viewer-badge {
            background: #27ae60;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Hide controls for viewers */
        body.viewer-mode .controls,
        body.viewer-mode .button-group:not(.viewer-visible),
        body.viewer-mode .approval-actions:not(.viewer-visible),
        body.viewer-mode .btn-success:not(.viewer-visible),
        body.viewer-mode .btn-danger:not(.viewer-visible) {
            display: none !important;
        }

        body.viewer-mode .view-toggle,
        body.viewer-mode .tabs,
        body.viewer-mode .tab,
        body.viewer-mode .calendar,
        body.viewer-mode .month-grid,
        body.viewer-mode .day-view,
        body.viewer-mode .stats-bar,
        body.viewer-mode .staff-list,
        body.viewer-mode .legend {
            pointer-events: all;
            opacity: 1;
        }

        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-size: 1.4em;
        }

        h2 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 1.2em;
        }

        h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
        }

        h4 {
            font-size: 1em;
            margin-bottom: 10px;
        }

        .stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            min-width: 120px;
            flex: 1;
            text-align: center;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #e8e8e8;
        }

            .stat-card.pending {
                border-left-color: #f39c12;
                background: #fff9e6;
            }

            .stat-card.approved {
                border-left-color: #27ae60;
                background: #eafaf1;
            }

        .today-highlight {
            background: #e8f4fc;
            border-left-color: #2980b9 !important;
        }

        .view-toggle {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            gap: 10px;
        }

            .view-toggle button {
                padding: 10px 15px;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                background: #f8f9fa;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.9em;
                flex: 1;
                min-width: 100px;
                color: #555;
                transition: all 0.3s;
            }

                .view-toggle button.active {
                    background: #3498db;
                    color: white;
                    border-color: #3498db;
                }

                .view-toggle button:hover:not(.active) {
                    background: #e9ecef;
                    border-color: #3498db;
                }

        .calendar-view, .month-view, .day-view {
            display: none;
        }

            .calendar-view.active, .month-view.active, .day-view.active {
                display: block;
            }

        .week-navigation, .month-navigation, .day-navigation {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            gap: 10px;
            border: 1px solid #e8e8e8;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

            .nav-buttons button {
                padding: 8px 15px;
                border: 1px solid #3498db;
                border-radius: 5px;
                background: white;
                color: #3498db;
                cursor: pointer;
                font-weight: 600;
                font-size: 0.9em;
                flex: 1;
                min-width: 100px;
                transition: all 0.3s;
            }

                .nav-buttons button:hover {
                    background: #3498db;
                    color: white;
                }

        .nav-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            flex: 1;
            min-width: 100%;
            order: -1;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .day-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

            .day-card:hover {
                transform: translateY(-3px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                border-color: #3498db;
            }

            .day-card.today {
                border-color: #3498db;
                background-color: #e8f4fc;
                border-width: 2px;
            }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }

        .day-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .date {
            color: #555;
            font-size: 0.9em;
            font-weight: 500;
        }

        .shift-list {
            margin-top: 8px;
        }

        .shift-item {
            padding: 8px 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            border: 1px solid #e8e8e8;
        }

        .operator-name {
            font-weight: 600;
            font-size: 0.9em;
            color: #2c3e50;
        }

        .shift-time {
            color: #444;
            font-size: 0.8em;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            font-weight: 500;
        }

        .obituary-duty {
            background-color: #e3f2fd !important;
            border-left: 3px solid #2196f3;
            color: #1976d2;
        }

        .leave {
            background-color: #ffeaa7 !important;
            border-left: 3px solid #fdcb6e;
        }

        .leave-pending {
            background-color: #fff9e6 !important;
            border-left: 3px solid #f39c12;
            border-style: dashed;
        }

        .leave-approved {
            background-color: #d5f4e6 !important;
            border-left: 3px solid #2ecc71;
        }

        .leave-rejected {
            background-color: #ffebee !important;
            border-left: 3px solid #e74c3c;
        }

        .off-duty {
            background-color: #dfe6e9 !important;
            color: #636e72;
        }

        .off-duty-working {
            background-color: #e8f4fc !important;
            border-left: 3px solid #3498db;
        }

        .extra-hours {
            background-color: #fff3e0 !important;
            border-left: 3px solid #ff9800;
        }

        .holiday {
            background-color: #ffebee !important;
            border-left: 3px solid #e74c3c;
            color: #c0392b;
        }

        .skeleton-shift {
            background-color: #e8f6f3 !important;
            border-left: 3px solid #26a69a;
            color: #00897b;
        }

        .warning {
            background-color: #ffeaa7 !important;
            border: 1px solid #fdcb6e;
            padding: 8px;
            border-radius: 5px;
            margin-top: 8px;
            font-size: 0.85em;
        }

        .critical {
            background-color: #ff7675 !important;
            color: white;
            border: 1px solid #d63031;
        }

        .operator-count-display {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #e8e8e8;
        }

        .operator-count-item {
            display: flex;
            align-items: center;
            gap: 6px;
            flex: 1;
            min-width: 100px;
            color: #555;
            font-weight: 500;
        }

        .operator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

            .operator-dot.available {
                background-color: #2ecc71;
            }

            .operator-dot.leave {
                background-color: #fdcb6e;
            }

            .operator-dot.off-duty {
                background-color: #95a5a6;
            }

            .operator-dot.off-duty-working {
                background-color: #3498db;
            }

            .operator-dot.late-entry {
                background-color: #ff6b6b;
            }

            .operator-dot.on-duty {
                background-color: #6c5ce7;
            }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.9em;
        }

        select, input, button, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            -webkit-appearance: none;
            appearance: none;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 8px;
            padding: 10px 15px;
            font-size: 0.95em;
            min-height: 44px;
        }

            button:hover {
                background-color: #2980b9;
            }

        .btn-danger {
            background-color: #e74c3c;
        }

            .btn-danger:hover {
                background-color: #c0392b;
            }

        .btn-secondary {
            background-color: #95a5a6;
        }

            .btn-secondary:hover {
                background-color: #7f8c8d;
            }

        .btn-success {
            background-color: #2ecc71;
        }

            .btn-success:hover {
                background-color: #27ae60;
            }

        .btn-warning {
            background-color: #f39c12;
        }

            .btn-warning:hover {
                background-color: #d68910;
            }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

            .button-group button {
                flex: 1;
                min-width: 120px;
            }

        .badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 4px;
            white-space: nowrap;
            font-weight: 600;
            color: white !important;
        }

        .leave-badge {
            background: #fdcb6e;
            color: white;
        }

        .leave-pending-badge {
            background: #f39c12;
            color: white;
        }

        .leave-approved-badge {
            background: #2ecc71;
            color: white;
        }

        .leave-rejected-badge {
            background: #e74c3c;
            color: white;
        }

        .obituary-badge {
            background: #2196f3;
            color: white;
        }

        .off-duty-badge {
            background: #95a5a6;
            color: white;
        }

        .off-duty-working-badge {
            background: #3498db;
            color: white;
        }

        .extra-hours-badge {
            background: #ff9800;
            color: white;
        }

        .holiday-badge {
            background: #e74c3c;
            color: white;
        }

        .skeleton-badge {
            background: #26a69a;
            color: white;
        }

        .staff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .staff-item {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 5px;
            flex: 1;
            min-width: 100px;
            text-align: center;
            font-size: 0.9em;
        }

        .ctp-operator {
            background: #d5f4e6;
            border-left: 3px solid #2ecc71;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
        }

            .controls button {
                margin-top: 0;
                width: auto;
                min-width: 140px;
                flex: 1;
                padding: 10px 15px;
                font-size: 0.9em;
                font-weight: 600;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.3s;
            }

                .controls button:hover {
                    background-color: #2980b9;
                    transform: translateY(-1px);
                    box-shadow: 0 3px 5px rgba(0,0,0,0.1);
                }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .day-header-cell {
            text-align: center;
            padding: 10px 5px;
            background: #f8f9fa;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            color: #2c3e50;
            border: 1px solid #dee2e6;
        }

        .day-cell {
            min-height: 100px;
            background: #fefefe;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }

            .day-cell:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                border-color: #3498db;
                background-color: #f8f9fa;
            }

            .day-cell.empty {
                background: #fafafa;
                cursor: default;
            }

                .day-cell.empty:hover {
                    transform: none;
                    box-shadow: none;
                    border-color: #eee;
                }

            .day-cell.today {
                border-color: #3498db;
                background-color: #e8f4fc;
                border-width: 2px;
            }

            .day-cell .date-num {
                font-weight: bold;
                margin-bottom: 4px;
                color: #2c3e50;
                font-size: 1em;
            }

            .day-cell .day-name {
                font-size: 0.8em;
                color: #666;
                margin-bottom: 6px;
            }

            .day-cell .operator-status {
                margin-top: 4px;
                font-size: 0.7em;
            }

            .day-cell .operator-status-item {
                margin-bottom: 2px;
                padding: 3px 5px;
                border-radius: 3px;
                display: flex;
                align-items: center;
                gap: 4px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                font-size: 0.75em;
                font-weight: 500;
            }

                .day-cell .operator-status-item.available {
                    background: #e8f6ef;
                    color: #27ae60;
                }

                .day-cell .operator-status-item.leave {
                    background: #fff9e6;
                    color: #e17055;
                }

                .day-cell .operator-status-item.off-duty {
                    background: #f1f2f6;
                    color: #636e72;
                }

                .day-cell .operator-status-item.off-duty-working {
                    background: #e8f4fc;
                    color: #2980b9;
                }

                .day-cell .operator-status-item.obituary {
                    background: #e3f2fd;
                    color: #1976d2;
                }

                .day-cell .operator-status-item.holiday {
                    background: #ffebee;
                    color: #c0392b;
                }

                .day-cell .operator-status-item.skeleton {
                    background: #e8f6f3;
                    color: #00897b;
                }

                .day-cell .operator-status-item.late-entry {
                    background: #ffeaea;
                    color: #d63031;
                }

                .day-cell .operator-status-item.on-duty {
                    background: #e6e6fa;
                    color: #483d8b;
                }

        .day-details-modal .detail-item {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }

            .day-details-modal .detail-item.leave {
                border-left-color: #fdcb6e;
            }

            .day-details-modal .detail-item.off-duty {
                border-left-color: #95a5a6;
            }

            .day-details-modal .detail-item.off-duty-working {
                border-left-color: #3498db;
            }

            .day-details-modal .detail-item.obituary {
                border-left-color: #2196f3;
            }

            .day-details-modal .detail-item.extra-hours {
                border-left-color: #ff9800;
            }

            .day-details-modal .detail-item.holiday {
                border-left-color: #e74c3c;
            }

            .day-details-modal .detail-item.skeleton {
                border-left-color: #26a69a;
            }

            .day-details-modal .detail-item.late-entry {
                border-left-color: #ff6b6b;
            }

            .day-details-modal .detail-item.on-duty {
                border-left-color: #6c5ce7;
            }

        .day-details-modal .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .day-details-modal .staff-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        .day-details-modal .shift-time {
            color: #666;
            font-size: 0.85em;
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
            padding: 5px 5px 0 5px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
            font-size: 0.9em;
            color: #555;
            background-color: #e9ecef;
            margin: 0 3px;
            border-radius: 5px 5px 0 0;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
            border-bottom: none;
        }

            .tab.active {
                border-bottom-color: #3498db;
                color: #3498db;
                background-color: white;
                border-color: #dee2e6 #dee2e6 white #dee2e6;
                box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            }

            .tab:hover:not(.active) {
                background-color: #f1f3f4;
                color: #2c3e50;
            }

        .tab-content {
            display: none;
            background-color: white;
            padding: 15px;
            border-radius: 0 0 8px 8px;
            border: 1px solid #dee2e6;
            border-top: none;
        }

            .tab-content.active {
                display: block;
            }

        .approval-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .approval-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .approval-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

            .approval-item.approved {
                border-left-color: #2ecc71;
            }

            .approval-item.rejected {
                border-left-color: #e74c3c;
            }

        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .approval-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

            .approval-actions button {
                margin-top: 0;
                padding: 6px 12px;
                font-size: 0.85em;
            }

        .coff-summary {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }

        .coff-details {
            margin-top: 8px;
            font-size: 0.85em;
            color: #555;
        }

            .coff-details ul {
                margin-left: 15px;
                margin-top: 4px;
            }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .status-available {
            background-color: #2ecc71;
        }

        .status-leave {
            background-color: #fdcb6e;
        }

        .status-leave-pending {
            background-color: #f39c12;
        }

        .status-leave-approved {
            background-color: #2ecc71;
        }

        .status-leave-rejected {
            background-color: #e74c3c;
        }

        .status-off {
            background-color: #95a5a6;
        }

        .status-off-duty-working {
            background-color: #3498db;
        }

        .status-obituary {
            background-color: #2196f3;
        }

        .status-extra-hours {
            background-color: #ff9800;
        }

        .status-holiday {
            background-color: #e74c3c;
        }

        .status-skeleton {
            background-color: #26a69a;
        }

        .status-late-entry {
            background-color: #ff6b6b;
        }

        .status-on-duty {
            background-color: #6c5ce7;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8em;
        }

        .day-details-container {
            margin: 15px 0;
        }

            .day-details-container h4 {
                margin-bottom: 10px;
                color: #2c3e50;
                font-size: 1em;
            }

        .day-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }

        .day-stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

            .day-stat-item .stat-value {
                font-size: 1.2em;
                font-weight: bold;
                color: #2c3e50;
            }

            .day-stat-item .stat-label {
                font-size: 0.85em;
                color: #666;
                margin-top: 4px;
            }

        .error-message {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: 4px;
            display: none;
        }

        .date-range-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

            .date-range-group .form-group {
                flex: 1;
                margin-bottom: 0;
                min-width: 120px;
            }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.85em;
        }

            table th {
                background: #ecf0f1;
                padding: 8px;
                text-align: left;
                border: 1px solid #ddd;
                font-size: 0.9em;
            }

            table td {
                padding: 6px 8px;
                border: 1px solid #ddd;
            }

            table tr:hover {
                background: #f8f9fa;
            }

        .holiday-marker {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #e74c3c;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6em;
            font-weight: bold;
        }

        .skeleton-marker {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #26a69a;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6em;
            font-weight: bold;
        }

        .day-cell.holiday-cell {
            background: #ffebee;
            border-color: #e74c3c;
        }

        .day-cell.skeleton-cell {
            background: #e8f6f3;
            border-color: #26a69a;
        }

        .day-view-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .staff-exclusion-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .staff-exclusion-item {
            background: #ecf0f1;
            padding: 6px 8px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }

            .staff-exclusion-item input[type="checkbox"] {
                width: auto;
                margin: 0;
            }

        .edit-shift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 350px;
            overflow-y: auto;
            padding: 8px;
        }

        .edit-shift-day {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

            .edit-shift-day h4 {
                margin-bottom: 8px;
                color: #2c3e50;
                border-bottom: 2px solid #3498db;
                padding-bottom: 4px;
                font-size: 0.9em;
            }

        .edit-staff-shift {
            margin-bottom: 8px;
        }

            .edit-staff-shift label {
                font-size: 0.8em;
                color: #555;
                margin-bottom: 2px;
            }

        .late-entry-badge {
            background: #ff6b6b;
            color: white;
        }

        .late-entry {
            background-color: #ffeaea !important;
            border-left: 3px solid #ff6b6b;
            color: #d63031;
        }

        .on-duty-badge {
            background: #6c5ce7;
            color: white;
        }

        .on-duty {
            background-color: #e6e6fa !important;
            border-left: 3px solid #6c5ce7;
            color: #483d8b;
        }

        #attendance-nav {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

            #attendance-nav .nav-buttons {
                margin-bottom: 8px;
            }

        #attendance-period-title {
            color: #2c3e50;
            font-size: 1em;
            padding: 5px 0;
            text-align: center;
            font-weight: bold;
        }

        /* Custom Radio Buttons */
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

            .radio-option:hover {
                background: #e9ecef;
                border-color: #3498db;
            }

            .radio-option input[type="radio"] {
                display: none;
            }

        .radio-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #95a5a6;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            transition: all 0.3s ease;
        }

            .radio-custom:after {
                content: '';
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #3498db;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                transition: all 0.3s ease;
            }

        .radio-option input[type="radio"]:checked + .radio-custom {
            border-color: #3498db;
            background-color: #e8f4fc;
        }

            .radio-option input[type="radio"]:checked + .radio-custom:after {
                transform: translate(-50%, -50%) scale(1);
            }

        .radio-label {
            font-weight: 500;
            color: #2c3e50;
        }

        .radio-option input[type="radio"]:checked ~ .radio-label {
            color: #3498db;
            font-weight: 600;
        }

        /* Custom Checkboxes */
        .checkbox-item {
            flex: 1 0 45%;
            margin-bottom: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

            .checkbox-option:hover {
                background: #e9ecef;
                border-color: #3498db;
            }

            .checkbox-option input[type="checkbox"] {
                display: none;
            }

        .checkbox-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #95a5a6;
            border-radius: 4px;
            display: inline-block;
            position: relative;
            transition: all 0.3s ease;
            background-color: white;
        }

            .checkbox-custom:after {
                content: 'âœ“';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                color: white;
                font-size: 12px;
                font-weight: bold;
                transition: all 0.3s ease;
            }

        .checkbox-option input[type="checkbox"]:checked + .checkbox-custom {
            background-color: #3498db;
            border-color: #3498db;
        }

            .checkbox-option input[type="checkbox"]:checked + .checkbox-custom:after {
                transform: translate(-50%, -50%) scale(1);
            }

        .checkbox-label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.85em;
        }

        .checkbox-option input[type="checkbox"]:checked ~ .checkbox-label {
            color: #3498db;
            font-weight: 600;
        }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .container {
                padding: 12px;
            }

            h1 {
                font-size: 1.2em;
                margin-bottom: 12px;
            }

            .calendar {
                grid-template-columns: 1fr;
            }

            .month-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .day-cell {
                min-height: 80px;
            }

            .controls {
                flex-direction: column;
            }

                .controls button {
                    width: 100%;
                    min-width: auto;
                    padding: 10px;
                }

            .nav-buttons {
                width: 100%;
                justify-content: center;
            }

            .date-range-group {
                flex-direction: column;
            }

                .date-range-group .form-group {
                    width: 100%;
                }

            .edit-shift-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
                text-align: left;
            }

            .stats-bar {
                gap: 8px;
            }

            .stat-card {
                min-width: 100px;
                padding: 8px;
                font-size: 0.85em;
            }

            .modal-content {
                padding: 15px;
                max-height: 85vh;
            }

            .button-group button {
                min-width: 100px;
            }

            table {
                font-size: 0.8em;
            }

                table th, table td {
                    padding: 4px 6px;
                }

            .shift-time {
                max-width: 80px;
                font-size: 0.75em;
            }

            .legend-item {
                flex: 1 0 calc(50% - 10px);
                min-width: 120px;
            }

            .operator-name {
                font-size: 0.85em;
            }

            .badge {
                font-size: 0.7em;
                padding: 1px 4px;
            }

            .day-cell .operator-status-item {
                font-size: 0.65em;
            }

            #attendance-nav .nav-buttons {
                flex-direction: column;
            }

                #attendance-nav .nav-buttons button {
                    width: 100%;
                }

            .user-info {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
                justify-content: center;
            }

            .login-container {
                padding: 30px 20px;
            }
        }

        @media (max-width: 480px) {
            .month-grid {
                grid-template-columns: 1fr;
            }

            .day-cell {
                min-height: 70px;
            }

            .view-toggle button {
                min-width: 80px;
                font-size: 0.85em;
                padding: 6px 10px;
            }

            .staff-item {
                min-width: 80px;
                font-size: 0.85em;
                padding: 6px 8px;
            }

            .legend {
                gap: 8px;
                padding: 10px;
            }

            .legend-item {
                flex: 1 0 100%;
                font-size: 0.75em;
            }

            .stat-card {
                flex: 1 0 calc(50% - 8px);
                min-width: auto;
            }

            .tab {
                padding: 8px 10px;
                font-size: 0.85em;
                margin: 0 2px;
            }

            .controls button {
                min-width: 120px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
        }

        /* Touch-friendly improvements */
        button, .tab, .day-cell, .shift-item {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        select, input, textarea {
            font-size: 16px;
        }

        .modal-content, .edit-shift-grid {
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="login-modal">
        <div class="login-container">
            <div class="login-header">
                <div class="login-avatar">ðŸ‘¥</div>
                <h1>Shift & Leave Management</h1>
                <p>Please login to continue</p>
            </div>
            
            <div id="loginError" class="login-error"></div>
            
            <div class="login-form">
                <input type="email" id="loginEmail" class="login-input" placeholder="Email address" required>
                <input type="password" id="loginPassword" class="login-input" placeholder="Password" required>
                <button onclick="login()" class="login-btn">Login</button>
            </div>
            
            <div class="login-links">
                <p>Default admin: admin@shift.com / password123</p>
                <p>Default viewer: viewer@shift.com / password123</p>
                <p id="registerLink" style="margin-top: 10px;"><a href="#" onclick="showRegister()">Register new account</a></p>
            </div>
        </div>
    </div>

    <!-- Main Application (Initially Hidden) -->
    <div id="appContent" style="display: none;">
        <!-- User Info Bar -->
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">U</div>
            <div>
                <div class="user-name" id="userName">User</div>
                <div class="user-role" id="userRole">Admin</div>
            </div>
            <button onclick="logout()" class="logout-btn">Logout</button>
        </div>
        
        <div class="container">
            <h1>ðŸ“… Shift & Leave Management System</h1>
            
            <div class="stats-bar">
                <div class="stat-card today-highlight">
                    <div>Today's Date</div>
                    <div id="current-date" style="font-size: 1.1em; font-weight: bold;"></div>
                </div>
                <div class="stat-card">
                    <div>Total Staff</div>
                    <div style="font-size: 1.1em; font-weight: bold;">5</div>
                </div>
                <div class="stat-card pending">
                    <div>Pending Approvals</div>
                    <div id="pending-count" style="font-size: 1.1em; font-weight: bold;">0</div>
                </div>
                <div class="stat-card approved">
                    <div>Comp-off Balance</div>
                    <div id="coff-balance" style="font-size: 1.1em; font-weight: bold;">0 days</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
                <div class="tab" onclick="switchTab('approvals')">Approvals</div>
                <div class="tab" onclick="switchTab('coff')">Comp-off</div>
                <div class="tab" onclick="switchTab('reports')">Reports</div>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="view-toggle">
                    <button id="viewTodayBtn" onclick="switchView('today')">ðŸ“… Today</button>
                    <button id="viewWeekBtn" class="active" onclick="switchView('week')">ðŸ“… Week View (7 Days)</button>
                    <button id="viewMonthBtn" onclick="switchView('month')">ðŸ“† Month View</button>
                </div>
                
                <div class="controls">
                    <button onclick="openAddLeaveModal()">âž• Apply Leave</button>
                    <button onclick="openCancelLeaveModal()">âŒ Cancel Leave</button>
                    <button onclick="openEditShiftModal()">âœï¸ Edit Shift</button>
                    <button onclick="openEditObituaryModal()">ðŸ“‹ Edit Obituary Duty</button>
                    <button onclick="openOffDutyModal()">ðŸ“ Off-Duty Working</button>
                    <button onclick="openOnDutyModal()">ðŸ¢ On Duty (OD)</button>
                    <button onclick="openLateEntryModal()">â° Late Entry</button>
                    <button onclick="openExtraHoursModal()">â° Add Extra Hours</button>
                    <button onclick="openCancelOffDutyModal()">ðŸ—‘ï¸ Cancel Off-Duty</button>
                    <button onclick="openApplyCOFFModal()">ðŸ”„ Apply COFF</button>
                    <button onclick="openHolidayModal()">ðŸŽ‰ Add/Remove Holiday</button>
                    <button onclick="openSkeletonModal()">ðŸ’€ Add/Remove Skeleton Shift</button>
                </div>
                
                <div class="staff-list" id="staff-list">
                    <!-- Staff list will be populated by JavaScript -->
                </div>
                
                <!-- Today View -->
                <div id="todayView" class="day-view">
                    <div class="day-navigation">
                        <div class="nav-title" id="dayTitle"></div>
                        <div class="nav-buttons">
                            <button onclick="previousDay()">â—€ Previous Day</button>
                            <button onclick="goToToday()">Today</button>
                            <button onclick="nextDay()">Next Day â–¶</button>
                        </div>
                    </div>
                    <div class="day-view-container" id="todayViewContainer">
                        <!-- Today view will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Week View (7 Days) -->
                <div id="calendarView" class="calendar-view active">
                    <div class="week-navigation">
                        <div class="nav-title" id="weekTitle"></div>
                        <div class="nav-buttons">
                            <button onclick="previousWeek()">â—€ Previous Week</button>
                            <button onclick="goToTodayWeek()">Today</button>
                            <button onclick="nextWeek()">Next Week â–¶</button>
                        </div>
                    </div>
                    
                    <div class="calendar" id="calendar">
                        <!-- Calendar will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Month View -->
                <div id="monthView" class="month-view">
                    <div class="month-navigation">
                        <div class="nav-title" id="monthTitle"></div>
                        <div class="nav-buttons">
                            <button onclick="previousMonth()">â—€ Previous Month</button>
                            <button onclick="goToTodayMonth()">Today</button>
                            <button onclick="nextMonth()">Next Month â–¶</button>
                        </div>
                    </div>
                    
                    <div class="month-grid" id="monthGrid">
                        <!-- Month grid will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Approvals Tab -->
            <div id="approvals-tab" class="tab-content">
                <h2>ðŸ“‹ Pending Approvals</h2>
                <div id="pending-approvals-container">
                    <!-- Pending approvals will be populated by JavaScript -->
                </div>
                
                <h2>âœ… Approved Leaves</h2>
                <div id="approved-leaves-container">
                    <!-- Approved leaves will be populated by JavaScript -->
                </div>
                
                <h2>âŒ Rejected Leaves</h2>
                <div id="rejected-leaves-container">
                    <!-- Rejected leaves will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Comp-off Tab -->
            <div id="coff-tab" class="tab-content">
                <h2>ðŸ”„ Comp-off Management</h2>
                <div class="controls">
                    <button onclick="openApplyCOFFModal()">ðŸ”„ Apply for Comp-off</button>
                    <button onclick="viewCOFFSummary()">ðŸ“Š View COFF Summary</button>
                </div>
                <div id="coff-summary-container">
                    <!-- COFF summary will be populated by JavaScript -->
                </div>
                <div id="coff-history-container">
                    <!-- COFF history will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content">
                <h2>ðŸ“Š Reports</h2>
                <div class="controls">
                    <button onclick="generateAttendancePeriodReport()">ðŸ“‹ Attendance (21st-20th)</button>
                    <button onclick="generateLeaveReport()">ðŸ–ï¸ Leave Report</button>
                    <button onclick="generateCOFFReport()">ðŸ”„ COFF Report</button>
                    <button onclick="generateOTReport()">ðŸ’° OT Report</button>
                    <button onclick="exportAllData()">ðŸ’¾ Export All Data</button>
                </div>
                
                <!-- Navigation for attendance report -->
                <div id="attendance-nav">
                    <div class="nav-buttons" style="justify-content: center;">
                        <button onclick="previousAttendancePeriod()">â—€ Previous Period</button>
                        <button onclick="goToCurrentAttendancePeriod()">Current Period</button>
                        <button onclick="nextAttendancePeriod()">Next Period â–¶</button>
                    </div>
                    <div id="attendance-period-title"></div>
                </div>
                
                <div id="report-container">
                    <!-- Reports will be displayed here -->
                </div>
            </div>
        </div>
        
        <!-- All existing modals remain here (same as before) -->
        <!-- Modal for Day Details -->
        <div id="dayDetailsModal" class="modal day-details-modal">
            <div class="modal-content">
                <h3 id="dayDetailsTitle"></h3>
                <div class="day-stats" id="dayStats">
                    <!-- Day statistics will be populated by JavaScript -->
                </div>
                <div class="day-details-container">
                    <h4>Shift Details</h4>
                    <div id="dayShiftDetails">
                        <!-- Shift details will be populated by JavaScript -->
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="closeModal('dayDetailsModal')">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for adding leave with date range -->
        <div id="leaveModal" class="modal">
            <div class="modal-content">
                <h3>Apply for Leave</h3>
                <div class="form-group">
                    <label for="leaveStaff">Staff Member:</label>
                    <select id="leaveStaff" onchange="checkLeaveEligibility()">
                        <option value="Sreejith">Sreejith</option>
                        <option value="Sajeev">Sajeev</option>
                        <option value="Umesh">Umesh</option>
                        <option value="Rajesh">Rajesh</option>
                        <option value="ANEESH">ANEESH (CTP)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Leave Period:</label>
                    <div class="date-range-group">
                        <div class="form-group">
                            <label for="leaveFromDate">From Date:</label>
                            <input type="date" id="leaveFromDate" onchange="updateLeaveToDate(); checkLeaveEligibility()">
                        </div>
                        <div style="align-self: center;">to</div>
                        <div class="form-group">
                            <label for="leaveToDate">To Date:</label>
                            <input type="date" id="leaveToDate" onchange="checkLeaveEligibility()">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="leaveType">Leave Type:</label>
                    <select id="leaveType">
                        <option value="full">Full Day</option>
                        <option value="half">Half Day</option>
                    </select>
                </div>
                <div id="leaveEligibilityError" class="error-message">
                    <!-- Error message will be populated by JavaScript -->
                </div>
                <div class="button-group">
                    <button onclick="submitLeave()">Submit for Approval</button>
                    <button class="btn-secondary" onclick="closeModal('leaveModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for editing obituary duty -->
        <div id="editObituaryModal" class="modal">
            <div class="modal-content">
                <h3>Edit Obituary Duty (Transfer)</h3>
                <div class="form-group">
                    <label for="obituaryDate">Select Date:</label>
                    <input type="date" id="obituaryDate" onchange="loadCurrentObituaryDuty()">
                </div>
                <div class="form-group">
                    <label>Current Assignment:</label>
                    <div id="currentObituaryInfo" style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                        Loading...
                    </div>
                </div>
                <div class="form-group">
                    <label>Transfer From:</label>
                    <select id="transferFromStaff" onchange="updateAvailableStaff()">
                        <option value="">Select current obituary duty holder</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Transfer To:</label>
                    <select id="transferToStaff">
                        <option value="">Select new staff for obituary duty</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="obituaryReason">Reason for Transfer (Optional):</label>
                    <textarea id="obituaryReason" rows="2" placeholder="Reason for transferring obituary duty"></textarea>
                </div>
                <div class="button-group">
                    <button onclick="transferObituaryDuty()">Transfer Obituary Duty</button>
                    <button class="btn-secondary" onclick="closeModal('editObituaryModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for cancelling leave -->
        <div id="cancelLeaveModal" class="modal">
            <div class="modal-content">
                <h3>Cancel Leave</h3>
                <div class="form-group">
                    <label for="cancelLeaveStaff">Select Staff Member:</label>
                    <select id="cancelLeaveStaff" onchange="loadLeaveForStaff()">
                        <option value="">All Staff</option>
                        <option value="Sreejith">Sreejith</option>
                        <option value="Sajeev">Sajeev</option>
                        <option value="Umesh">Umesh</option>
                        <option value="Rajesh">Rajesh</option>
                        <option value="ANEESH">ANEESH (CTP)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Leave Period:</label>
                    <div class="date-range-group">
                        <div class="form-group">
                            <label for="cancelFromDate">From Date:</label>
                            <input type="date" id="cancelFromDate" onchange="loadLeaveForStaff()">
                        </div>
                        <div style="align-self: center;">to</div>
                        <div class="form-group">
                            <label for="cancelToDate">To Date:</label>
                            <input type="date" id="cancelToDate" onchange="loadLeaveForStaff()">
                        </div>
                    </div>
                </div>
                <div id="leaveListContainer">
                    <!-- Leave list will be populated by JavaScript -->
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="closeModal('cancelLeaveModal')">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for editing shift -->
        <div id="editShiftModal" class="modal">
            <div class="modal-content">
                <h3>Edit Shift Schedule</h3>
                <div class="form-group">
                    <label for="effectiveDate">Effective From Date:</label>
                    <input type="date" id="effectiveDate">
                </div>
                
                <div class="edit-shift-grid" id="editShiftGrid">
                    <!-- Shift grid will be populated by JavaScript -->
                </div>
                
                <div class="button-group">
                    <button onclick="saveShiftEdit()">Save Changes</button>
                    <button class="btn-secondary" onclick="closeModal('editShiftModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for off-duty working entry -->
        <div id="offDutyModal" class="modal">
            <div class="modal-content">
                <h3>Off-Duty Working Entry</h3>
                <div class="form-group">
                    <label for="offDutyStaff">Staff Member (Off-duty):</label>
                    <select id="offDutyStaff" onchange="updateOffDutyStaffOptions()">
                        <!-- Options will be populated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="offDutyDate">Date:</label>
                    <input type="date" id="offDutyDate" onchange="updateOffDutyStaffOptions()">
                </div>
                <div class="form-group">
                    <label for="offDutyShift">Actual Shift Worked:</label>
                    <select id="offDutyShift">
                        <option value="5pm-1:30am">5pm-1:30am</option>
                        <option value="4pm-12:30pm">4pm-12:30pm</option>
                        <option value="7pm-3:30pm">7pm-3:30pm</option>
                        <option value="7:00pm-3:30am">7:00pm-3:30am</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="offDutyReason">Reason (Optional):</label>
                    <input type="text" id="offDutyReason" placeholder="e.g., Emergency coverage, Project deadline">
                </div>
                <div class="button-group">
                    <button onclick="saveOffDutyEntry()">Save Entry</button>
                    <button class="btn-secondary" onclick="closeModal('offDutyModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for On Duty -->
        <div id="onDutyModal" class="modal">
            <div class="modal-content">
                <h3>On Duty (Outside Office Work)</h3>
                <div class="form-group">
                    <label for="onDutyStaff">Staff Member:</label>
                    <select id="onDutyStaff">
                        <option value="Sreejith">Sreejith</option>
                        <option value="Sajeev">Sajeev</option>
                        <option value="Umesh">Umesh</option>
                        <option value="Rajesh">Rajesh</option>
                        <option value="ANEESH">ANEESH (CTP)</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="onDutyDate">Date:</label>
                    <input type="date" id="onDutyDate">
                </div>
                <div class="form-group">
                    <label>On Duty Type:</label>
                    <div id="onDutyTypeSelector">
                        <label class="radio-option">
                            <input type="radio" name="onDutyType" value="regular" checked onclick="toggleExtraHours()">
                            <span class="radio-custom"></span>
                            <span class="radio-label">Regular Shift Time</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="onDutyType" value="extra" onclick="toggleExtraHours()">
                            <span class="radio-custom"></span>
                            <span class="radio-label">Extra Hours</span>
                        </label>
                    </div>
                </div>
                <div class="form-group" id="extraHoursSection" style="display: none;">
                    <label for="onDutyExtraHours">Extra Hours:</label>
                    <select id="onDutyExtraHours">
                        <option value="0.5">0.5 hour</option>
                        <option value="1">1 hour</option>
                        <option value="1.5">1.5 hours</option>
                        <option value="2">2 hours</option>
                        <option value="2.5">2.5 hours</option>
                        <option value="3">3 hours</option>
                        <option value="3.5">3.5 hours</option>
                        <option value="4">4 hours</option>
                        <option value="4.5">4.5 hours</option>
                        <option value="5">5 hours</option>
                        <option value="5.5">5.5 hours</option>
                        <option value="6">6 hours</option>
                        <option value="6.5">6.5 hours</option>
                        <option value="7">7 hours</option>
                        <option value="7.5">7.5 hours</option>
                        <option value="8">8 hours (Full day)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="onDutyReason">Reason/Location:</label>
                    <textarea id="onDutyReason" rows="3" placeholder="e.g., Client site visit, Field work"></textarea>
                </div>
                <div class="button-group">
                    <button onclick="saveOnDuty()">Save On Duty</button>
                    <button class="btn-secondary" onclick="closeModal('onDutyModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for Late Entry -->
        <div id="lateEntryModal" class="modal">
            <div class="modal-content">
                <h3>Late Entry Registration</h3>
                <div class="form-group">
                    <label for="lateEntryStaff">Staff Member:</label>
                    <select id="lateEntryStaff" onchange="updateRegularShiftTime()">
                        <option value="Sreejith">Sreejith</option>
                        <option value="Sajeev">Sajeev</option>
                        <option value="Umesh">Umesh</option>
                        <option value="Rajesh">Rajesh</option>
                        <option value="ANEESH">ANEESH (CTP)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="lateEntryDate">Date:</label>
                    <input type="date" id="lateEntryDate" onchange="updateRegularShiftTime()">
                </div>
                <div class="form-group">
                    <label for="regularShiftTime">Regular Shift Time:</label>
                    <input type="text" id="regularShiftTime" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label for="actualTime">Actual Entry Time:</label>
                    <input type="time" id="actualTime" onchange="calculateDelay()" required>
                </div>
                <div class="form-group">
                    <label for="delayMinutes">Calculated Delay:</label>
                    <input type="text" id="delayMinutes" readonly style="background: #f5f5f5;">
                    <div id="delayMessage" style="font-size: 0.9em; margin-top: 5px; color: #666;"></div>
                </div>
                <div class="form-group">
                    <label>Regularization:</label>
                    <div id="regularizeTypeSelector">
                        <label class="radio-option">
                            <input type="radio" name="regularizeType" value="coff" checked onclick="toggleCOFFRequirement()">
                            <span class="radio-custom"></span>
                            <span class="radio-label">Regularize from COFF</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="regularizeType" value="skip" onclick="toggleCOFFRequirement()">
                            <span class="radio-custom"></span>
                            <span class="radio-label">Skip Regularization</span>
                        </label>
                    </div>
                    <div id="coffRequirement" style="padding: 10px; background: #e8f4fc; border-radius: 5px; margin-top: 10px; display: block;">
                        <strong>COFF Required:</strong> <span id="coffHoursRequired">0</span> hours<br>
                        <small>Based on delay calculation</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="lateEntryReason">Reason for Late Entry:</label>
                    <textarea id="lateEntryReason" rows="2" placeholder="e.g., Traffic, Personal emergency"></textarea>
                </div>
                <div class="button-group">
                    <button onclick="saveLateEntry()">Save Late Entry</button>
                    <button class="btn-secondary" onclick="closeModal('lateEntryModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for extra hours -->
        <div id="extraHoursModal" class="modal">
            <div class="modal-content">
                <h3>Add Extra Working Hours</h3>
                <div class="form-group">
                    <label for="extraHoursStaff">Staff Member:</label>
                    <select id="extraHoursStaff">
                        <option value="Sreejith">Sreejith</option>
                        <option value="Sajeev">Sajeev</option>
                        <option value="Umesh">Umesh</option>
                        <option value="Rajesh">Rajesh</option>
                        <option value="ANEESH">ANEESH (CTP)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="extraHoursDate">Date:</label>
                    <input type="date" id="extraHoursDate">
                </div>
                <div class="form-group">
                    <label for="extraHours">Extra Hours:</label>
                    <select id="extraHours">
                        <option value="0.5">0.5 hour</option>
                        <option value="1">1 hour</option>
                        <option value="1.5">1.5 hours</option>
                        <option value="2">2 hours</option>
                        <option value="2.5">2.5 hours</option>
                        <option value="3">3 hours</option>
                        <option value="3.5">3.5 hours</option>
                        <option value="4">4 hours</option>
                        <option value="4.5">4.5 hours</option>
                        <option value="5">5 hours</option>
                        <option value="5.5">5.5 hours</option>
                        <option value="6">6 hours</option>
                        <option value="6.5">6.5 hours</option>
                        <option value="7">7 hours</option>
                        <option value="7.5">7.5 hours</option>
                        <option value="8">8 hours (Full day)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="extraHoursReason">Reason:</label>
                    <textarea id="extraHoursReason" rows="3" placeholder="Reason for extra hours"></textarea>
                </div>
                <div class="button-group">
                    <button onclick="saveExtraHours()">Save Extra Hours</button>
                    <button class="btn-secondary" onclick="closeModal('extraHoursModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for cancel off-duty working -->
        <div id="cancelOffDutyModal" class="modal">
            <div class="modal-content">
                <h3>Cancel Off-Duty Working Entry</h3>
                <div class="form-group">
                    <label for="cancelOffDutyDate">Select Date:</label>
                    <input type="date" id="cancelOffDutyDate" onchange="loadOffDutyForDate()">
                </div>
                <div id="offDutyListContainer">
                    <!-- Off-duty list will be populated by JavaScript -->
                </div>
                <div class="button-group">
                    <button class="btn-secondary" onclick="closeModal('cancelOffDutyModal')">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for COFF application -->
        <div id="applyCOFFModal" class="modal">
            <div class="modal-content">
                <h3>Apply for Compensatory Off (COFF)</h3>
                <div class="form-group">
                    <label for="coffStaff">Staff Member:</label>
                    <select id="coffStaff" onchange="updateCOFFBalanceDisplay()">
                        <option value="Sreejith">Sreejith</option>
                        <option value="Sajeev">Sajeev</option>
                        <option value="Umesh">Umesh</option>
                        <option value="Rajesh">Rajesh</option>
                        <option value="ANEESH">ANEESH (CTP)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>COFF Period:</label>
                    <div class="date-range-group">
                        <div class="form-group">
                            <label for="coffFromDate">From Date:</label>
                            <input type="date" id="coffFromDate" onchange="updateCoffToDate()">
                        </div>
                        <div style="align-self: center;">to</div>
                        <div class="form-group">
                            <label for="coffToDate">To Date:</label>
                            <input type="date" id="coffToDate">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="coffReason">Reason:</label>
                    <textarea id="coffReason" rows="3" placeholder="Reason for compensatory off"></textarea>
                </div>
                <div class="coff-summary">
                    <h4>Your COFF Balance</h4>
                    <div id="coffBalanceDisplay">Calculating...</div>
                </div>
                <div class="button-group">
                    <button onclick="submitCOFF()">Submit COFF Request</button>
                    <button class="btn-secondary" onclick="closeModal('applyCOFFModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for adding/removing holiday -->
        <div id="holidayModal" class="modal">
            <div class="modal-content">
                <h3>Add/Remove Holiday</h3>
                <div class="form-group">
                    <label for="holidayName">Holiday Name:</label>
                    <input type="text" id="holidayName" placeholder="e.g., New Year, Diwali, Christmas">
                </div>
                <div class="form-group">
                    <label for="holidayDate">Date:</label>
                    <input type="date" id="holidayDate" onchange="checkExistingHoliday()">
                </div>
                <div id="existingHolidayInfo" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                    <!-- Existing holiday info will be shown here -->
                </div>
                <div class="button-group">
                    <button id="holidayActionBtn" onclick="saveHoliday()">Add Holiday</button>
                    <button class="btn-secondary" onclick="closeModal('holidayModal')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Modal for adding/removing skeleton shift -->
        <div id="skeletonModal" class="modal">
            <div class="modal-content">
                <h3>Add/Remove Skeleton Shift</h3>
                <div class="form-group">
                    <label for="skeletonDate">Date:</label>
                    <input type="date" id="skeletonDate" onchange="checkExistingSkeleton()">
                </div>
                <div class="form-group">
                    <label for="skeletonHours">Skeleton Hours:</label>
                    <select id="skeletonHours">
                        <option value="4">4 hours (Half day)</option>
                        <option value="8">8 hours (Full day)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Exclude Employees from OT:</label>
                    <div class="staff-exclusion-list" id="skeletonExcludeList">
                        <!-- Staff exclusion checkboxes will be populated here -->
                    </div>
                </div>
                <div class="form-group">
                    <label for="skeletonReason">Reason:</label>
                    <textarea id="skeletonReason" rows="3" placeholder="Reason for skeleton shift"></textarea>
                </div>
                <div id="existingSkeletonInfo" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                    <!-- Existing skeleton info will be shown here -->
                </div>
                <div class="button-group">
                    <button id="skeletonActionBtn" onclick="saveSkeletonShift()">Add Skeleton Shift</button>
                    <button class="btn-secondary" onclick="closeModal('skeletonModal')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Modal for approval with reason -->
        <div id="approvalReasonModal" class="modal">
            <div class="modal-content">
                <h3>Approve/Reject Leave</h3>
                <div class="form-group">
                    <label for="approvalReason">Reason (Optional):</label>
                    <textarea id="approvalReason" rows="3" placeholder="Enter reason for approval/rejection"></textarea>
                </div>
                <div class="button-group">
                    <button id="approveWithReasonBtn" class="btn-success" onclick="approveLeaveWithReason()">Approve</button>
                    <button id="rejectWithReasonBtn" class="btn-danger" onclick="rejectLeaveWithReason()">Reject</button>
                    <button class="btn-secondary" onclick="closeModal('approvalReasonModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBsZb_05bhHF7Mu5qPlZMgl3Ekpi2Citiw",
            authDomain: "phc-shift.firebaseapp.com",
            projectId: "phc-shift",
            storageBucket: "phc-shift.firebasestorage.app",
            messagingSenderId: "426348959034",
            appId: "1:426348959034:web:2936bf71ff1aae92caac03"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== AUTHENTICATION STATE MANAGEMENT ====================
        let currentUser = null;
        let userRole = 'viewer'; // Default to viewer

        // Check auth state on page load
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const role = await checkUserRole(user.uid);
                userRole = role;
                showApp();
            } else {
                currentUser = null;
                userRole = 'viewer';
                showLogin();
            }
        });

        // ==================== LOGIN FUNCTION ====================
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            // Basic validation
            if (!email || !password) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Check if user exists in Firestore
                const userDoc = await db.collection('users').doc(user.uid).get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userRole = userData.role || 'viewer';
                    updateUserInfo(userData);
                    showApp();
                } else {
                    // If user doesn't exist in Firestore, create a new user with default viewer role
                    const userData = {
                        email: user.email,
                        name: user.email.split('@')[0],
                        role: 'viewer',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('users').doc(user.uid).set(userData);
                    userRole = 'viewer';
                    updateUserInfo(userData);
                    showApp();
                }
            } catch (error) {
                console.error("Login error:", error);
                errorDiv.textContent = getAuthErrorMessage(error);
                errorDiv.style.display = 'block';
            }
        }

        // ==================== CHECK USER ROLE ====================
        async function checkUserRole(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    return userData.role || 'viewer';
                }
            } catch (error) {
                console.error("Error checking user role:", error);
            }
            return 'viewer';
        }

        // ==================== UPDATE USER INFO IN UI ====================
        function updateUserInfo(userData) {
            const userName = userData.name || userData.email.split('@')[0];
            const role = userData.role || 'viewer';
            const firstLetter = userName.charAt(0).toUpperCase();

            document.getElementById('userName').textContent = userName;
            document.getElementById('userRole').textContent = role.charAt(0).toUpperCase() + role.slice(1);
            document.getElementById('userAvatar').textContent = firstLetter;

            // Update role badge styling
            const roleElement = document.getElementById('userRole');
            roleElement.className = 'user-role';
            if (role === 'admin') {
                roleElement.classList.add('admin-badge');
            } else if (role === 'viewer') {
                roleElement.classList.add('viewer-badge');
            }
        }

        // ==================== SHOW/APP FUNCTIONS ====================
        function showLogin() {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('appContent').style.display = 'none';
            document.body.classList.remove('viewer-mode');
        }

        function showApp() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';

            // Apply viewer mode based on role
            if (userRole === 'viewer') {
                document.body.classList.add('viewer-mode');
            } else {
                document.body.classList.remove('viewer-mode');
            }

            // Initialize the app
            initApp();
        }

        // ==================== LOGOUT FUNCTION ====================
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.signOut();
                currentUser = null;
                userRole = 'viewer';
                showLogin();
            }
        }

        // ==================== CHECK PERMISSION FOR ACTIONS ====================
        function checkPermission(actionName) {
            if (userRole !== 'admin') {
                alert(`You don't have permission to ${actionName}. Please contact an administrator.`);
                return false;
            }
            return true;
        }

        // ==================== MODIFIED MODAL FUNCTIONS WITH PERMISSION CHECK ====================
        function openAddLeaveModal() {
            if (!checkPermission('apply leave')) return;
            openModal('leaveModal');
        }

        function openCancelLeaveModal() {
            if (!checkPermission('cancel leave')) return;
            openModal('cancelLeaveModal');
        }

        function openEditShiftModal() {
            if (!checkPermission('edit shifts')) return;
            openModal('editShiftModal');
            loadShiftEditGrid();
        }

        function openEditObituaryModal() {
            if (!checkPermission('edit obituary duty')) return;
            openModal('editObituaryModal');
            loadCurrentObituaryDuty();
        }

        function openOffDutyModal() {
            if (!checkPermission('record off-duty working')) return;
            openModal('offDutyModal');
            updateOffDutyStaffOptions();
        }

        function openOnDutyModal() {
            if (!checkPermission('record on duty')) return;
            openModal('onDutyModal');
        }

        function openLateEntryModal() {
            if (!checkPermission('record late entry')) return;
            openModal('lateEntryModal');
        }

        function openExtraHoursModal() {
            if (!checkPermission('add extra hours')) return;
            openModal('extraHoursModal');
        }

        function openCancelOffDutyModal() {
            if (!checkPermission('cancel off-duty entries')) return;
            openModal('cancelOffDutyModal');
            loadOffDutyForDate();
        }

        function openApplyCOFFModal() {
            if (!checkPermission('apply COFF')) return;
            openModal('applyCOFFModal');
            updateCOFFBalanceDisplay();
        }

        function openHolidayModal() {
            if (!checkPermission('manage holidays')) return;
            openModal('holidayModal');
            checkExistingHoliday();
        }

        function openSkeletonModal() {
            if (!checkPermission('manage skeleton shifts')) return;
            openModal('skeletonModal');
            checkExistingSkeleton();
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // ==================== MODIFIED REPORT FUNCTIONS ====================
        function generateAttendancePeriodReport() {
            if (!checkPermission('generate attendance reports')) return;
            document.getElementById('attendance-nav').style.display = 'block';
            generateAttendanceReportForPeriod(0);
        }

        function generateLeaveReport() {
            if (!checkPermission('generate leave reports')) return;
            document.getElementById('attendance-nav').style.display = 'none';
            // ... rest of your generateLeaveReport function
        }

        function generateCOFFReport() {
            if (!checkPermission('generate COFF reports')) return;
            document.getElementById('attendance-nav').style.display = 'none';
            // ... rest of your generateCOFFReport function
        }

        function generateOTReport() {
            if (!checkPermission('generate OT reports')) return;
            document.getElementById('attendance-nav').style.display = 'none';
            // ... rest of your generateOTReport function
        }

        function exportAllData() {
            if (!checkPermission('export data')) return;
            document.getElementById('attendance-nav').style.display = 'none';
            // ... rest of your exportAllData function
        }

        // ==================== ERROR MESSAGE HELPER ====================
        function getAuthErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Invalid email address';
                case 'auth/user-disabled':
                    return 'Account disabled';
                case 'auth/user-not-found':
                    return 'User not found';
                case 'auth/wrong-password':
                    return 'Wrong password';
                case 'auth/email-already-in-use':
                    return 'Email already registered';
                case 'auth/operation-not-allowed':
                    return 'Operation not allowed';
                case 'auth/weak-password':
                    return 'Password is too weak';
                default:
                    return error.message || 'Login failed. Please try again.';
            }
        }

        // ==================== SETUP DEFAULT ACCOUNTS ====================
        async function setupDefaultAccounts() {
            try {
                // Admin account
                try {
                    const adminCredential = await auth.createUserWithEmailAndPassword(
                        'admin@shift.com',
                        'password123'
                    );

                    await db.collection('users').doc(adminCredential.user.uid).set({
                        email: 'admin@shift.com',
                        name: 'System Admin',
                        role: 'admin',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('Admin account created');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        console.log('Admin account already exists');
                    } else {
                        console.error('Error creating admin account:', error);
                    }
                }

                // Viewer account
                try {
                    const viewerCredential = await auth.createUserWithEmailAndPassword(
                        'viewer@shift.com',
                        'password123'
                    );

                    await db.collection('users').doc(viewerCredential.user.uid).set({
                        email: 'viewer@shift.com',
                        name: 'Viewer User',
                        role: 'viewer',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('Viewer account created');
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        console.log('Viewer account already exists');
                    } else {
                        console.error('Error creating viewer account:', error);
                    }
                }

                alert('Default accounts setup complete!\n\nAdmin: admin@shift.com / password123\nViewer: viewer@shift.com / password123');
            } catch (error) {
                console.error('Setup error:', error);
                alert('Error setting up accounts: ' + error.message);
            }
        }

        // ==================== INITIALIZE APP ====================
        async function initApp() {
            console.log('Initializing app for:', currentUser?.email, 'Role:', userRole);

            // Update UI based on role
            if (userRole === 'viewer') {
                document.body.classList.add('viewer-mode');
                console.log('Viewer mode enabled');
            } else {
                document.body.classList.remove('viewer-mode');
                console.log('Admin mode enabled');
            }

            // Update current date
            const today = new Date();
            const currentDateStr = today.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('current-date').textContent = currentDateStr;

            // Load other app data if needed
            // loadAllData(); // Uncomment this if you have data loading functions

            console.log('App initialized successfully');
        }

        // ==================== ADD EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', function () {
            // Add click event to login button
            const loginButton = document.querySelector('.login-btn');
            if (loginButton) {
                loginButton.onclick = login;
            }

            // Add enter key support for login
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');

            if (loginEmail && loginPassword) {
                loginEmail.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') login();
                });

                loginPassword.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') login();
                });
            }

            // Optional: Setup default accounts button
            const registerLink = document.getElementById('registerLink');
            if (registerLink) {
                registerLink.onclick = function (e) {
                    e.preventDefault();
                    if (confirm('Create default admin and viewer accounts?\n\nAdmin: admin@shift.com / password123\nViewer: viewer@shift.com / password123')) {
                        setupDefaultAccounts();
                    }
                };
            }
        });

        // ==================== CSS STYLE FOR VIEWER MODE ====================
        // Make sure this CSS is in your stylesheet:
        /*
        body.viewer-mode .controls,
        body.viewer-mode .button-group:not(.viewer-visible),
        body.viewer-mode .approval-actions:not(.viewer-visible),
        body.viewer-mode .btn-success:not(.viewer-visible),
        body.viewer-mode .btn-danger:not(.viewer-visible),
        body.viewer-mode .tab[onclick*="reports"],
        body.viewer-mode .tab[onclick*="coff"],
        body.viewer-mode .tab[onclick*="approvals"] {
            display: none !important;
        }
        
        body.viewer-mode .tab[onclick="switchTab('dashboard')"] {
            width: 100%;
        }
        */
        // ==================== INITIALIZE APP (Placeholder) ====================
        function initApp() {
            // This function should contain all your main app initialization code
            // For now, just update the current date
            const today = new Date();
            const currentDateStr = today.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('current-date').textContent = currentDateStr;

            // Add other initialization code here
            console.log('App initialized for user:', currentUser?.email);
        }

        // ==================== SETUP DEFAULT ACCOUNTS ====================
        // You can call this function once to create default accounts
        async function setupDefaultAccounts() {
            const defaultAccounts = [
                {
                    email: 'admin@shift.com',
                    password: 'password123',
                    name: 'Admin User',
                    role: 'admin'
                },
                {
                    email: 'viewer@shift.com',
                    password: 'password123',
                    name: 'Viewer User',
                    role: 'viewer'
                }
            ];

            for (const account of defaultAccounts) {
                try {
                    // Check if user already exists
                    const userCredential = await auth.createUserWithEmailAndPassword(
                        account.email,
                        account.password
                    ).catch(async (error) => {
                        if (error.code === 'auth/email-already-in-use') {
                            // User already exists, sign in to update Firestore
                            return await auth.signInWithEmailAndPassword(account.email, account.password);
                        }
                        throw error;
                    });

                    // Update Firestore with user data
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email: account.email,
                        name: account.name,
                        role: account.role,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log(`Default ${account.role} account created/setup: ${account.email}`);

                } catch (error) {
                    console.error(`Error setting up ${account.email}:`, error);
                }
            }
        }

        // ==================== RUN SETUP (Only once) ====================
        // Uncomment this line to create default accounts (run once, then comment out again)
        // setupDefaultAccounts();

            // ==================== FIREBASE DATA MANAGEMENT ====================
            const staffAbbreviations = {
                "Sreejith": "SKS",
                "Sajeev": "SJV",
                "Umesh": "UMU",
                "Rajesh": "MR",
                "ANEESH": "AMR"
            };

            // Global data stores
            let shiftData = {
                days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                shifts: {
                    "Sunday": {
                        "Sreejith": "Obituary duty 5pm-1:30am",
                        "Sajeev": "5pm-1:30am",
                        "Umesh": "5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Monday": {
                        "Sreejith": "Obituary duty 5pm-1:30am",
                        "Sajeev": "Off-operator",
                        "Umesh": "5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Tuesday": {
                        "Sreejith": "5pm-1:30am",
                        "Sajeev": "Obituary duty 5pm-1:30am",
                        "Umesh": "Off-operator",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Wednesday": {
                        "Sreejith": "Off-operator",
                        "Sajeev": "5pm-1:30am",
                        "Umesh": "Obituary duty 5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "Off-operator"
                    },
                    "Thursday": {
                        "Sreejith": "Obituary duty 5pm-1:30am",
                        "Sajeev": "4pm-12:30pm",
                        "Umesh": "5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Friday": {
                        "Sreejith": "5pm-1:30am",
                        "Sajeev": "Obituary duty 5pm-1:30am",
                        "Umesh": "7pm-3:30pm",
                        "Rajesh": "Off-operator",
                        "ANEESH": "7:00pm-3:30am"
                    },
                    "Saturday": {
                        "Sreejith": "4pm-12:30pm",
                        "Sajeev": "5pm-1:30am",
                        "Umesh": "Obituary duty 5pm-1:30am",
                        "Rajesh": "7pm-3:30pm",
                        "ANEESH": "7:00pm-3:30am"
                    }
                }
            };

            let leaveRequests = [];
            let offDutyEntries = {};
            let onDutyEntries = {};
            let extraHoursData = {};
            let coffData = { balances: {}, history: [], pending: [] };
            let holidays = {};
            let skeletonShifts = {};
            let otData = { monthly: {} };
            let lateEntries = { entries: [] };

            // Load all data from Firestore
            async function loadAllData() {
                try {
                    if (userRole !== 'admin') {
                        await loadReadOnlyData();
                        return;
                    }

                    const promises = [
                        loadShiftData(),
                        loadLeaveRequests(),
                        loadOffDutyEntries(),
                        loadOnDutyEntries(),
                        loadExtraHoursData(),
                        loadCoffData(),
                        loadHolidays(),
                        loadSkeletonShifts(),
                        loadOtData(),
                        loadLateEntries()
                    ];

                    await Promise.all(promises);
                } catch (error) {
                    console.error("Error loading data:", error);
                    alert("Error loading data. Please refresh the page.");
                }
            }

            async function loadReadOnlyData() {
                try {
                    const promises = [
                        loadShiftData(),
                        loadLeaveRequests(),
                        loadOffDutyEntries(),
                        loadOnDutyEntries(),
                        loadExtraHoursData(),
                        loadCoffData(),
                        loadHolidays(),
                        loadSkeletonShifts(),
                        loadOtData(),
                        loadLateEntries()
                    ];

                    await Promise.all(promises);
                } catch (error) {
                    console.error("Error loading read-only data:", error);
                }
            }

            async function loadShiftData() {
                try {
                    const doc = await db.collection('systemData').doc('shiftData').get();
                    if (doc.exists) shiftData = doc.data();
                    else await db.collection('systemData').doc('shiftData').set(shiftData);
                } catch (error) { console.error("Error loading shift data:", error); }
            }

            async function loadLeaveRequests() {
                try {
                    const snapshot = await db.collection('leaveRequests').orderBy('requestedAt', 'desc').limit(1000).get();
                    leaveRequests = [];
                    snapshot.forEach(doc => leaveRequests.push({ id: doc.id, ...doc.data() }));
                } catch (error) { console.error("Error loading leave requests:", error); }
            }

            async function loadOffDutyEntries() {
                try {
                    const snapshot = await db.collection('offDutyEntries').orderBy('date', 'desc').limit(1000).get();
                    offDutyEntries = {};
                    snapshot.forEach(doc => { const data = doc.data(); offDutyEntries[data.date] = data; });
                } catch (error) { console.error("Error loading off-duty entries:", error); }
            }

            async function loadOnDutyEntries() {
                try {
                    const snapshot = await db.collection('onDutyEntries').orderBy('date', 'desc').limit(1000).get();
                    onDutyEntries = {};
                    snapshot.forEach(doc => { const data = doc.data(); onDutyEntries[data.date] = data; });
                } catch (error) { console.error("Error loading on-duty entries:", error); }
            }

            async function loadExtraHoursData() {
                try {
                    const snapshot = await db.collection('extraHoursData').orderBy('date', 'desc').limit(1000).get();
                    extraHoursData = {};
                    snapshot.forEach(doc => { const data = doc.data(); extraHoursData[data.date] = data; });
                } catch (error) { console.error("Error loading extra hours data:", error); }
            }

            async function loadCoffData() {
                try {
                    const doc = await db.collection('systemData').doc('coffData').get();
                    if (doc.exists) coffData = doc.data();
                    else {
                        coffData.balances = { "Sreejith": 0, "Sajeev": 0, "Umesh": 0, "Rajesh": 0, "ANEESH": 0 };
                        coffData.history = []; coffData.pending = [];
                        await db.collection('systemData').doc('coffData').set(coffData);
                    }
                } catch (error) { console.error("Error loading COFF data:", error); }
            }

            async function loadHolidays() {
                try {
                    const snapshot = await db.collection('holidays').orderBy('date', 'desc').limit(1000).get();
                    holidays = {};
                    snapshot.forEach(doc => { const data = doc.data(); holidays[data.date] = data; });
                } catch (error) { console.error("Error loading holidays:", error); }
            }

            async function loadSkeletonShifts() {
                try {
                    const snapshot = await db.collection('skeletonShifts').orderBy('date', 'desc').limit(1000).get();
                    skeletonShifts = {};
                    snapshot.forEach(doc => { const data = doc.data(); skeletonShifts[data.date] = data; });
                } catch (error) { console.error("Error loading skeleton shifts:", error); }
            }

            async function loadOtData() {
                try {
                    const doc = await db.collection('systemData').doc('otData').get();
                    if (doc.exists) otData = doc.data();
                    else {
                        otData.monthly = {};
                        await db.collection('systemData').doc('otData').set(otData);
                    }
                } catch (error) { console.error("Error loading OT data:", error); }
            }

            async function loadLateEntries() {
                try {
                    const doc = await db.collection('systemData').doc('lateEntries').get();
                    if (doc.exists) lateEntries = doc.data();
                    else {
                        lateEntries.entries = [];
                        await db.collection('systemData').doc('lateEntries').set(lateEntries);
                    }
                } catch (error) { console.error("Error loading late entries:", error); }
            }

            // ==================== FIREBASE SAVE FUNCTIONS ====================
            async function saveAllData() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save data.");
                    return false;
                }

                try {
                    await db.collection('systemData').doc('shiftData').set(shiftData);
                    await db.collection('systemData').doc('coffData').set(coffData);
                    await db.collection('systemData').doc('otData').set(otData);
                    await db.collection('systemData').doc('lateEntries').set(lateEntries);
                    updateStats();
                    return true;
                } catch (error) {
                    console.error("Error saving data:", error);
                    alert("Error saving data. Please try again.");
                    return false;
                }
            }

            async function saveLeaveRequest(request) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to submit leave requests.");
                    return null;
                }

                try {
                    const docRef = await db.collection('leaveRequests').add({
                        ...request,
                        submittedBy: currentUser.uid,
                        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return docRef.id;
                } catch (error) {
                    console.error("Error saving leave request:", error);
                    throw error;
                }
            }

            async function updateLeaveRequest(requestId, updates) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to update leave requests.");
                    return false;
                }

                try {
                    await db.collection('leaveRequests').doc(requestId).update({
                        ...updates,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error("Error updating leave request:", error);
                    throw error;
                }
            }

            async function deleteLeaveRequest(requestId) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete leave requests.");
                    return false;
                }

                try {
                    await db.collection('leaveRequests').doc(requestId).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting leave request:", error);
                    throw error;
                }
            }

            async function saveOffDutyEntry(entry) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save off-duty entries.");
                    return false;
                }

                try {
                    await db.collection('offDutyEntries').doc(entry.date).set({
                        ...entry,
                        savedBy: currentUser.uid,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error("Error saving off-duty entry:", error);
                    throw error;
                }
            }

            async function deleteOffDutyEntry(date) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete off-duty entries.");
                    return false;
                }

                try {
                    await db.collection('offDutyEntries').doc(date).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting off-duty entry:", error);
                    throw error;
                }
            }

            async function saveOnDutyEntry(entry) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save on-duty entries.");
                    return false;
                }

                try {
                    await db.collection('onDutyEntries').doc(entry.date).set({
                        ...entry,
                        savedBy: currentUser.uid,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error("Error saving on-duty entry:", error);
                    throw error;
                }
            }

            async function deleteOnDutyEntry(date) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete on-duty entries.");
                    return false;
                }

                try {
                    await db.collection('onDutyEntries').doc(date).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting on-duty entry:", error);
                    throw error;
                }
            }

            async function saveExtraHoursEntry(entry) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save extra hours.");
                    return false;
                }

                try {
                    await db.collection('extraHoursData').doc(entry.date).set({
                        ...entry,
                        savedBy: currentUser.uid,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error("Error saving extra hours entry:", error);
                    throw error;
                }
            }

            async function deleteExtraHoursEntry(date) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete extra hours.");
                    return false;
                }

                try {
                    await db.collection('extraHoursData').doc(date).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting extra hours entry:", error);
                    throw error;
                }
            }

            async function saveHoliday(holiday) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to manage holidays.");
                    return false;
                }

                try {
                    await db.collection('holidays').doc(holiday.date).set({
                        ...holiday,
                        savedBy: currentUser.uid,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error("Error saving holiday:", error);
                    throw error;
                }
            }

            async function deleteHoliday(date) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete holidays.");
                    return false;
                }

                try {
                    await db.collection('holidays').doc(date).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting holiday:", error);
                    throw error;
                }
            }

            async function saveSkeletonShift(skeleton) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to manage skeleton shifts.");
                    return false;
                }

                try {
                    await db.collection('skeletonShifts').doc(skeleton.date).set({
                        ...skeleton,
                        savedBy: currentUser.uid,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    return true;
                } catch (error) {
                    console.error("Error saving skeleton shift:", error);
                    throw error;
                }
            }

            async function deleteSkeletonShift(date) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete skeleton shifts.");
                    return false;
                }

                try {
                    await db.collection('skeletonShifts').doc(date).delete();
                    return true;
                } catch (error) {
                    console.error("Error deleting skeleton shift:", error);
                    throw error;
                }
            }

            async function saveLateEntry(entry) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save late entries.");
                    return false;
                }

                try {
                    const newEntry = {
                        ...entry,
                        savedBy: currentUser.uid,
                        savedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    lateEntries.entries.push(newEntry);
                    await db.collection('systemData').doc('lateEntries').set(lateEntries);
                    return true;
                } catch (error) {
                    console.error("Error saving late entry:", error);
                    throw error;
                }
            }

            async function deleteLateEntry(entryId) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete late entries.");
                    return false;
                }

                try {
                    const index = lateEntries.entries.findIndex(e => e.id === entryId);
                    if (index !== -1) {
                        lateEntries.entries.splice(index, 1);
                        await db.collection('systemData').doc('lateEntries').set(lateEntries);
                    }
                    return true;
                } catch (error) {
                    console.error("Error deleting late entry:", error);
                    throw error;
                }
            }

            // ==================== HELPER FUNCTIONS ====================
            function formatDateForInput(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            function formatDateForDisplay(date) {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    weekday: 'short'
                });
            }

            function getDatesInRange(startDate, endDate) {
                const dates = [];
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    dates.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                return dates;
            }

            function checkIfOnLeave(staff, date) {
                const dateKey = formatDateForInput(date);
                return leaveRequests.some(req =>
                    req.staff === staff &&
                    req.date === dateKey &&
                    req.status === 'approved'
                );
            }

            function checkOffDutyWorking(staff, date) {
                const dateKey = formatDateForInput(date);
                const entry = offDutyEntries[dateKey];
                return entry && entry.staff === staff;
            }

            function checkOnDuty(staff, date) {
                const dateKey = formatDateForInput(date);
                const entry = onDutyEntries[dateKey];
                return entry && entry.staff === staff;
            }

            function checkExtraHours(staff, date) {
                const dateKey = formatDateForInput(date);
                const entry = extraHoursData[dateKey];
                return entry && entry.staff === staff;
            }

            function getLeaveStatus(staff, date) {
                const dateKey = formatDateForInput(date);
                const request = leaveRequests.find(req => req.staff === staff && req.date === dateKey);
                return request ? request.status : null;
            }

            function checkLateEntry(staff, date) {
                const dateKey = formatDateForInput(date);
                return lateEntries.entries.some(entry => entry.staff === staff && entry.date === dateKey);
            }

            function getLateEntry(staff, date) {
                const dateKey = formatDateForInput(date);
                return lateEntries.entries.find(entry => entry.staff === staff && entry.date === dateKey);
            }

            function getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry) {
                if (hasLateEntry) return 'status-late-entry';
                if (leaveStatus === 'pending') return 'status-leave-pending';
                if (leaveStatus === 'approved') return 'status-leave-approved';
                if (leaveStatus === 'rejected') return 'status-leave-rejected';
                if (isOffDutyWorking) return 'status-off-duty-working';
                if (isOnDuty) return 'status-on-duty';
                if (hasExtraHours) return 'status-extra-hours';
                if (shift && shift.includes('Obituary')) return 'status-obituary';
                if (shift && shift.includes('Off')) return 'status-off';
                return 'status-available';
            }

            // ==================== MAIN APPLICATION FUNCTIONS ====================
            let currentWeekStart = new Date();
            currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            let currentDayView = new Date();
            let currentApprovalRequestId = null;
            let currentApprovalAction = null;
            let currentAttendancePeriod = 0;
            let currentAttendanceStartDate = null;
            let currentAttendanceEndDate = null;

            const today = new Date();
            const currentDateStr = today.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // ==================== ORIGINAL FUNCTIONS WITH FIREBASE UPDATES ====================
            async function initApp() {
                await loadAllData();
                document.getElementById('current-date').textContent = currentDateStr;
                updateStats();
                renderStaffList();
                renderWeekView();
                renderMonthView();
                renderTodayView();
                updateWeekTitle();
                updateMonthTitle();
                updateDayTitle();

                const todayStr = formatDateForInput(today);
                setDefaultModalDates(todayStr);

                updateOffDutyStaffOptions();
                renderCOFFSummary();
                renderCOFFHistory();
                renderApprovals();
                calculateSkeletonOT();
                calculateCOFFBalances();
                initTouchEvents();
            }

            function setDefaultModalDates(todayStr) {
                const dateFields = [
                    'leaveFromDate', 'leaveToDate', 'obituaryDate', 'offDutyDate',
                    'effectiveDate', 'cancelOffDutyDate', 'coffFromDate', 'coffToDate',
                    'holidayDate', 'skeletonDate', 'cancelFromDate', 'cancelToDate',
                    'extraHoursDate', 'onDutyDate', 'lateEntryDate'
                ];
                dateFields.forEach(field => {
                    const element = document.getElementById(field);
                    if (element) element.value = todayStr;
                });
            }

            function initTouchEvents() {
                const buttons = document.querySelectorAll('button, .tab, .day-cell');
                buttons.forEach(button => {
                    button.addEventListener('touchstart', function () { this.style.transform = 'scale(0.98)'; });
                    button.addEventListener('touchend', function () { this.style.transform = ''; });
                });
            }

            function updateStats() {
                const pendingCount = leaveRequests.filter(req => req.status === 'pending').length;
                document.getElementById('pending-count').textContent = pendingCount;
                let totalCoffBalance = 0;
                Object.values(coffData.balances).forEach(balance => totalCoffBalance += balance);
                document.getElementById('coff-balance').textContent = totalCoffBalance.toFixed(1) + ' days';
            }

            function renderStaffList() {
                const staffList = document.getElementById('staff-list');
                const staff = [
                    { name: "Sreejith", type: "Operator", abbrev: "SKS" },
                    { name: "Sajeev", type: "Operator", abbrev: "SJV" },
                    { name: "Umesh", type: "Operator", abbrev: "UMU" },
                    { name: "Rajesh", type: "Operator", abbrev: "MR" },
                    { name: "ANEESH", type: "CTP Operator", abbrev: "AMR" }
                ];

                staffList.innerHTML = '';
                staff.forEach(person => {
                    const div = document.createElement('div');
                    div.className = `staff-item ${person.type === 'CTP Operator' ? 'ctp-operator' : ''}`;
                    div.innerHTML = `
                <div style="font-weight: bold; font-size: 0.9em;">${person.name}</div>
                <div style="font-size: 0.75em; color: #666;">${person.type} (${person.abbrev})</div>
            `;
                    staffList.appendChild(div);
                });
            }

            function renderTodayView() {
                const container = document.getElementById('todayViewContainer');
                const date = currentDayView;
                const dayIndex = date.getDay();
                const dayName = shiftData.days[dayIndex];
                const dateStr = formatDateForDisplay(date);
                const isToday = date.toDateString() === today.toDateString();
                const dateKey = formatDateForInput(date);
                const isHoliday = holidays[dateKey];
                const isSkeleton = skeletonShifts[dateKey];

                let html = `
            <div class="day-header" style="margin-bottom: 15px;">
                <div class="day-name">${dayName}</div>
                <div class="date">${dateStr}</div>
            </div>
        `;

                if (isHoliday) {
                    html += `<div class="holiday-marker" style="position: static; margin-bottom: 10px; padding: 5px 8px; font-size: 0.8em;">HOLIDAY: ${holidays[dateKey].name}</div>`;
                } else if (isSkeleton) {
                    html += `<div class="skeleton-marker" style="position: static; margin-bottom: 10px; padding: 5px 8px; font-size: 0.8em;">SKELETON SHIFT: ${skeletonShifts[dateKey].hours} hours</div>`;
                }

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                let availableOperators = 0;
                let hasCriticalWarning = false;

                staffList.forEach(staff => {
                    const shift = shiftData.shifts[dayName][staff];
                    const isOnLeave = checkIfOnLeave(staff, date);
                    const isOffDutyWorking = checkOffDutyWorking(staff, date);
                    const isOnDuty = checkOnDuty(staff, date);
                    const hasExtraHours = checkExtraHours(staff, date);
                    const leaveStatus = getLeaveStatus(staff, date);
                    const hasLateEntry = checkLateEntry(staff, date);
                    const abbrev = staffAbbreviations[staff];

                    let statusClass = '';
                    let statusText = '';
                    let badge = '';
                    let shiftDisplay = shift || 'Not Scheduled';

                    if (hasLateEntry) {
                        statusClass = 'late-entry';
                        const lateEntry = getLateEntry(staff, date);
                        statusText = `Late Entry: ${lateEntry.delayMinutes} min delay`;
                        badge = '<span class="badge late-entry-badge">LATE</span>';
                        shiftDisplay = lateEntry.actualTime || shiftDisplay;
                        availableOperators++;
                    } else if (leaveStatus === 'pending') {
                        statusClass = 'leave-pending';
                        statusText = 'Pending Leave';
                        badge = '<span class="badge leave-pending-badge">PENDING</span>';
                    } else if (leaveStatus === 'approved') {
                        statusClass = 'leave-approved';
                        statusText = 'On Leave';
                        badge = '<span class="badge leave-approved-badge">LEAVE</span>';
                    } else if (leaveStatus === 'rejected') {
                        statusClass = 'leave-rejected';
                        statusText = 'Leave Rejected';
                        badge = '<span class="badge leave-rejected-badge">REJECTED</span>';
                    } else if (isOffDutyWorking) {
                        statusClass = 'off-duty-working';
                        statusText = 'Off-duty Working';
                        const entry = offDutyEntries[dateKey];
                        shiftDisplay = entry ? entry.shift : shiftDisplay;
                        badge = '<span class="badge off-duty-working-badge">OFF-DUTY</span>';
                        availableOperators++;
                    } else if (isOnDuty) {
                        statusClass = 'on-duty';
                        const entry = onDutyEntries[dateKey];
                        statusText = entry && entry.type === 'extra' ? `On Duty (+${entry.hours}h extra)` : 'On Duty (OD)';
                        badge = '<span class="badge on-duty-badge">OD</span>';
                        availableOperators++;
                    } else if (hasExtraHours) {
                        statusClass = 'extra-hours';
                        const extra = extraHoursData[dateKey];
                        statusText = `+${extra.hours} extra hours`;
                        badge = '<span class="badge extra-hours-badge">EXTRA</span>';
                        availableOperators++;
                    } else if (shift && shift.includes('Obituary')) {
                        statusClass = 'obituary-duty';
                        statusText = 'Obituary Duty';
                        availableOperators++;
                        badge = '<span class="badge obituary-badge">OBITUARY</span>';
                    } else if (shift && shift.includes('Off')) {
                        statusClass = 'off-duty';
                        statusText = 'Off Duty';
                    } else if (shift && !isOnLeave) {
                        availableOperators++;
                    }

                    if (isHoliday) {
                        badge += '<span class="badge holiday-badge">HOLIDAY</span>';
                        statusText = 'Holiday';
                    }

                    if (isSkeleton) {
                        badge += '<span class="badge skeleton-badge">SKELETON</span>';
                        statusText = 'Skeleton Shift';
                    }

                    html += `
                <div class="shift-item ${statusClass}">
                    <div class="operator-name">
                        <span class="status-indicator ${getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry)}"></span>
                        ${abbrev} (${staff})
                        ${badge}
                    </div>
                    <div class="shift-time">${shiftDisplay}</div>
                </div>
                ${statusText ? `<div style="font-size: 0.75em; color: #666; margin-left: 20px; margin-bottom: 5px;">${statusText}</div>` : ''}
            `;
                });

                html += `
            <div class="operator-count-display" style="margin-top: 15px;">
                <div class="operator-count-item">
                    <span class="operator-dot available"></span>
                    <span>Available Operators: ${availableOperators}/5</span>
                </div>
            </div>
        `;

                if (availableOperators <= 2) {
                    html += `<div class="warning" style="margin-top: 12px;">âš ï¸ Minimum operators only (${availableOperators} available)</div>`;
                } else if (availableOperators < 2) {
                    html += `<div class="warning critical" style="margin-top: 12px;">âŒ CRITICAL: Less than 2 operators available!</div>`;
                    hasCriticalWarning = true;
                }

                container.innerHTML = html;
            }

            // ==================== MODAL FUNCTIONS ====================
            function openModal(modalId) {
                if (userRole !== 'admin' && modalId !== 'dayDetailsModal') {
                    const writeModals = [
                        'leaveModal', 'cancelLeaveModal', 'editShiftModal', 'editObituaryModal',
                        'offDutyModal', 'onDutyModal', 'lateEntryModal', 'extraHoursModal',
                        'cancelOffDutyModal', 'applyCOFFModal', 'holidayModal', 'skeletonModal',
                        'approvalReasonModal'
                    ];

                    if (writeModals.includes(modalId)) {
                        alert("You don't have permission to perform this action.");
                        return;
                    }
                }

                document.getElementById(modalId).style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            function openAddLeaveModal() { openModal('leaveModal'); }
            function openEditShiftModal() { openModal('editShiftModal'); loadShiftEditGrid(); }
            function openEditObituaryModal() { openModal('editObituaryModal'); loadCurrentObituaryDuty(); }
            function openOffDutyModal() { openModal('offDutyModal'); updateOffDutyStaffOptions(); }
            function openOnDutyModal() { openModal('onDutyModal'); }
            function openLateEntryModal() { openModal('lateEntryModal'); }
            function openCancelOffDutyModal() { openModal('cancelOffDutyModal'); loadOffDutyForDate(); }
            function openApplyCOFFModal() { openModal('applyCOFFModal'); updateCOFFBalanceDisplay(); }
            function openHolidayModal() { openModal('holidayModal'); checkExistingHoliday(); }
            function openSkeletonModal() { openModal('skeletonModal'); checkExistingSkeleton(); }
            function openCancelLeaveModal() { openModal('cancelLeaveModal'); loadLeaveForStaff(); }
            function openExtraHoursModal() { openModal('extraHoursModal'); }

            // ==================== LEAVE FUNCTIONS WITH FIREBASE ====================
            function checkLeaveEligibility() {
                const staff = document.getElementById('leaveStaff').value;
                const fromDate = new Date(document.getElementById('leaveFromDate').value);
                const toDate = new Date(document.getElementById('leaveToDate').value);
                const errorDiv = document.getElementById('leaveEligibilityError');

                if (fromDate > toDate) {
                    errorDiv.textContent = 'To date must be after From date';
                    errorDiv.style.display = 'block';
                    return false;
                }

                const dateRange = getDatesInRange(fromDate, toDate);
                for (const date of dateRange) {
                    const dateKey = formatDateForInput(date);
                    if (checkIfOnLeave(staff, date)) {
                        errorDiv.textContent = `${staff} already has leave on ${dateKey}`;
                        errorDiv.style.display = 'block';
                        return false;
                    }
                }

                errorDiv.style.display = 'none';
                return true;
            }

            function updateLeaveToDate() {
                const fromDate = document.getElementById('leaveFromDate').value;
                if (fromDate) {
                    document.getElementById('leaveToDate').value = fromDate;
                    document.getElementById('leaveToDate').min = fromDate;
                }
            }

            async function submitLeave() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to submit leave requests.");
                    return;
                }

                if (!checkLeaveEligibility()) return;

                const staff = document.getElementById('leaveStaff').value;
                const fromDate = new Date(document.getElementById('leaveFromDate').value);
                const toDate = new Date(document.getElementById('leaveToDate').value);
                const type = document.getElementById('leaveType').value;
                const leaveTypeText = type === 'full' ? 'Full Day Leave' : 'Half Day Leave';

                const dateRange = getDatesInRange(fromDate, toDate);

                try {
                    for (const date of dateRange) {
                        const dateKey = formatDateForInput(date);
                        const leaveRequest = {
                            id: Date.now() + Math.random(),
                            staff: staff,
                            date: dateKey,
                            type: leaveTypeText,
                            reason: '',
                            status: 'pending',
                            requestedAt: new Date().toISOString(),
                            isCOFF: false
                        };

                        await saveLeaveRequest(leaveRequest);
                        leaveRequests.push(leaveRequest);
                    }

                    updateStats();
                    alert(`Leave request submitted for ${staff} from ${formatDateForInput(fromDate)} to ${formatDateForInput(toDate)}`);
                    closeModal('leaveModal');

                    renderWeekView();
                    renderMonthView();
                    renderTodayView();
                    renderApprovals();
                } catch (error) {
                    console.error("Error submitting leave:", error);
                    alert("Error submitting leave request. Please try again.");
                }
            }

            async function loadLeaveForStaff() {
                const staff = document.getElementById('cancelLeaveStaff').value;
                const fromDate = document.getElementById('cancelFromDate').value;
                const toDate = document.getElementById('cancelToDate').value;
                const container = document.getElementById('leaveListContainer');

                let filteredRequests = leaveRequests.filter(req => {
                    const matchesStaff = staff === '' || req.staff === staff;
                    const matchesDate = (!fromDate || req.date >= fromDate) && (!toDate || req.date <= toDate);
                    return matchesStaff && matchesDate && req.status !== 'cancelled';
                });

                if (filteredRequests.length === 0) {
                    container.innerHTML = '<p>No leaves found for the selected criteria.</p>';
                    return;
                }

                let html = '<h4>Select Leaves to Cancel:</h4>';
                filteredRequests.forEach(request => {
                    const abbrev = staffAbbreviations[request.staff];
                    let badgeClass = '';
                    let badgeText = '';

                    if (request.status === 'pending') {
                        badgeClass = 'leave-pending-badge';
                        badgeText = 'PENDING';
                    } else if (request.status === 'approved') {
                        badgeClass = request.isCOFF ? 'obituary-badge' : 'leave-approved-badge';
                        badgeText = request.isCOFF ? 'COFF' : 'APPROVED';
                    } else if (request.status === 'rejected') {
                        badgeClass = 'leave-rejected-badge';
                        badgeText = 'REJECTED';
                    }

                    html += `
                <div style="margin-bottom: 10px; padding: 12px; background: ${request.status === 'approved' ? '#e8f6ef' : '#f8f9fa'}; border-radius: 5px; border-left: 4px solid ${request.status === 'approved' ? '#27ae60' : request.status === 'pending' ? '#f39c12' : '#e74c3c'}">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" value="${request.id}" style="width: auto;">
                        <div style="flex: 1;">
                            <strong>${abbrev} (${request.staff})</strong> - ${request.date} (${request.type})
                            <span class="badge ${badgeClass}" style="margin-left: 8px;">
                                ${badgeText}${request.isCOFF ? ' (COFF)' : ''}
                            </span>
                            ${request.reason ? `<div style="font-size: 0.85em; color: #666; margin-top: 3px;">Reason: ${request.reason}</div>` : ''}
                        </div>
                    </label>
                </div>
            `;
                });

                html += `
            <div class="button-group">
                <button onclick="cancelSelectedLeaves()" class="btn-danger">Cancel Selected Leaves</button>
            </div>
        `;

                container.innerHTML = html;
            }

            async function cancelSelectedLeaves() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to cancel leaves.");
                    return;
                }

                const checkboxes = document.querySelectorAll('#leaveListContainer input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    alert('Please select at least one leave to cancel.');
                    return;
                }

                if (confirm(`Cancel ${checkboxes.length} selected leave(s)?`)) {
                    let cancelledCOFFLeaves = 0;

                    for (const checkbox of checkboxes) {
                        const requestId = checkbox.value;
                        const requestIndex = leaveRequests.findIndex(req => req.id == requestId);
                        if (requestIndex !== -1) {
                            const request = leaveRequests[requestIndex];
                            const isCOFFLeave = request.isCOFF;
                            const staff = request.staff;
                            const dateKey = request.date;

                            // Update in Firestore
                            await updateLeaveRequest(requestId, {
                                status: 'cancelled',
                                cancelledAt: new Date().toISOString()
                            });

                            leaveRequests[requestIndex].status = 'cancelled';
                            leaveRequests[requestIndex].cancelledAt = new Date().toISOString();

                            if (isCOFFLeave && request.status === 'approved') {
                                coffData.balances[staff] = (coffData.balances[staff] || 0) + 1;
                                cancelledCOFFLeaves++;

                                coffData.history.push({
                                    id: Date.now(),
                                    staff: staff,
                                    date: dateKey,
                                    type: 'COFF Restored (Cancelled Leave)',
                                    hours: 8,
                                    coffEarned: 1,
                                    balanceAfter: coffData.balances[staff],
                                    timestamp: new Date().toISOString(),
                                    reason: `COFF restored due to cancelled leave on ${dateKey}`
                                });
                            }
                        }
                    }

                    await saveAllData();
                    updateStats();
                    calculateCOFFBalances();

                    let successMsg = `${checkboxes.length} leave(s) cancelled successfully.`;
                    if (cancelledCOFFLeaves > 0) {
                        successMsg += `\n${cancelledCOFFLeaves} COFF day(s) restored to respective staff.`;
                    }
                    alert(successMsg);

                    loadLeaveForStaff();
                    renderWeekView();
                    renderMonthView();
                    renderTodayView();
                    renderApprovals();
                    renderCOFFSummary();
                    renderCOFFHistory();
                }
            }

            async function cancelSingleLeave(requestId) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to cancel leaves.");
                    return;
                }

                if (confirm('Cancel this approved leave?')) {
                    const requestIndex = leaveRequests.findIndex(req => req.id == requestId);
                    if (requestIndex !== -1) {
                        await updateLeaveRequest(requestId, {
                            status: 'cancelled',
                            cancelledAt: new Date().toISOString()
                        });

                        leaveRequests[requestIndex].status = 'cancelled';
                        leaveRequests[requestIndex].cancelledAt = new Date().toISOString();

                        await saveAllData();
                        updateStats();
                        renderApprovals();
                        renderWeekView();
                        renderMonthView();
                        renderTodayView();
                        alert('Leave cancelled successfully!');
                    }
                }
            }

            // ==================== OFF-DUTY FUNCTIONS WITH FIREBASE ====================
            function updateOffDutyStaffOptions() {
                const date = document.getElementById('offDutyDate').value;
                const staffSelect = document.getElementById('offDutyStaff');
                const dateObj = new Date(date);
                const dayIndex = dateObj.getDay();
                const dayName = shiftData.days[dayIndex];

                const currentSelected = staffSelect.value;
                staffSelect.innerHTML = '';

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                let availableStaff = [];

                staffList.forEach(staff => {
                    const shift = shiftData.shifts[dayName][staff];
                    const abbrev = staffAbbreviations[staff];
                    const dateKey = formatDateForInput(dateObj);
                    const hasOffDutyWorking = offDutyEntries[dateKey] && offDutyEntries[dateKey].staff === staff;
                    const isOnLeave = checkIfOnLeave(staff, dateObj);

                    if (shift && (shift.includes('Off') || shift.includes('Off-operator')) && !hasOffDutyWorking) {
                        availableStaff.push({
                            name: staff,
                            abbrev: abbrev,
                            shift: shift,
                            isOnLeave: isOnLeave
                        });
                    }
                });

                if (availableStaff.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No off-duty staff available on this date';
                    staffSelect.appendChild(option);
                    staffSelect.disabled = true;
                    return;
                }

                availableStaff.sort((a, b) => a.name.localeCompare(b.name));

                const selectOption = document.createElement('option');
                selectOption.value = '';
                selectOption.textContent = '-- Select Staff --';
                staffSelect.appendChild(selectOption);

                availableStaff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.name;
                    let statusInfo = staff.isOnLeave ? ' (On Leave - covering)' : '';
                    option.textContent = `${staff.abbrev} (${staff.name}) - ${staff.shift}${statusInfo}`;
                    staffSelect.appendChild(option);
                });

                if (currentSelected && availableStaff.some(staff => staff.name === currentSelected)) {
                    staffSelect.value = currentSelected;
                } else {
                    staffSelect.value = '';
                }

                staffSelect.disabled = false;
            }

            async function saveOffDutyEntry() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save off-duty entries.");
                    return;
                }

                const staffSelect = document.getElementById('offDutyStaff');
                const staff = staffSelect.value;
                const date = document.getElementById('offDutyDate').value;
                const shift = document.getElementById('offDutyShift').value;
                const reason = document.getElementById('offDutyReason').value;
                const abbrev = staffAbbreviations[staff];

                if (!staff || staff === '') {
                    alert('Please select a staff member from the dropdown list.');
                    return;
                }

                try {
                    const dateKey = date;
                    const entry = {
                        staff: staff,
                        date: date,
                        shift: shift,
                        reason: reason,
                        entryDate: new Date().toISOString()
                    };

                    await saveOffDutyEntry(entry);
                    offDutyEntries[dateKey] = entry;

                    let hoursWorked = 8;
                    if (shift.includes('5pm-1:30am')) hoursWorked = 8;
                    if (shift.includes('4pm-12:30pm')) hoursWorked = 8;
                    if (shift.includes('7pm-3:30pm')) hoursWorked = 8;
                    if (shift.includes('7:00pm-3:30am')) hoursWorked = 8;

                    extraHoursData[dateKey] = {
                        staff: staff,
                        hours: hoursWorked,
                        reason: `Off-duty working: ${reason || 'Coverage'}`,
                        entryDate: new Date().toISOString(),
                        coffCalculated: false,
                        type: 'Off-Duty Working'
                    };

                    await saveAllData();
                    calculateCOFFBalances();

                    alert(`Off-duty working entry saved for ${abbrev} (${staff}) on ${date}. ${hoursWorked} hours added for COFF calculation.`);
                    closeModal('offDutyModal');

                    renderWeekView();
                    renderMonthView();
                    renderTodayView();
                    updateStats();
                } catch (error) {
                    console.error("Error saving off-duty entry:", error);
                    alert("Error saving off-duty entry. Please try again.");
                }
            }

            async function loadOffDutyForDate() {
                const date = document.getElementById('cancelOffDutyDate').value;
                const container = document.getElementById('offDutyListContainer');
                const dateKey = date;
                const entry = offDutyEntries[dateKey];

                if (!entry) {
                    container.innerHTML = '<p>No off-duty working entries found for this date.</p>';
                    return;
                }

                const abbrev = staffAbbreviations[entry.staff];
                container.innerHTML = `
            <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <strong>Off-duty Working Entry:</strong><br>
                <strong>Staff:</strong> ${abbrev} (${entry.staff})<br>
                <strong>Date:</strong> ${date}<br>
                <strong>Shift Worked:</strong> ${entry.shift}<br>
                <strong>Reason:</strong> ${entry.reason || 'Not specified'}<br>
                <strong>Entry Date:</strong> ${new Date(entry.entryDate).toLocaleDateString()}
            </div>
            <div class="button-group">
                <button onclick="cancelOffDutyEntry('${dateKey}')" class="btn-danger">Cancel This Entry</button>
            </div>
        `;
            }

            async function cancelOffDutyEntry(dateKey) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to delete off-duty entries.");
                    return;
                }

                if (confirm('Cancel this off-duty working entry?')) {
                    try {
                        await deleteOffDutyEntry(dateKey);
                        delete offDutyEntries[dateKey];
                        if (extraHoursData[dateKey]) delete extraHoursData[dateKey];

                        await saveAllData();
                        calculateCOFFBalances();
                        alert('Off-duty working entry cancelled.');
                        closeModal('cancelOffDutyModal');

                        renderWeekView();
                        renderMonthView();
                        renderTodayView();
                    } catch (error) {
                        console.error("Error cancelling off-duty entry:", error);
                        alert("Error cancelling off-duty entry. Please try again.");
                    }
                }
            }

            // ==================== ON DUTY FUNCTIONS WITH FIREBASE ====================
            function toggleExtraHours() {
                const extraHoursSection = document.getElementById('extraHoursSection');
                const onDutyType = document.querySelector('input[name="onDutyType"]:checked').value;
                extraHoursSection.style.display = onDutyType === 'extra' ? 'block' : 'none';
            }

            async function saveOnDuty() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save on-duty entries.");
                    return;
                }

                const staff = document.getElementById('onDutyStaff').value;
                const date = document.getElementById('onDutyDate').value;
                const onDutyType = document.querySelector('input[name="onDutyType"]:checked').value;
                const extraHours = onDutyType === 'extra' ? parseFloat(document.getElementById('onDutyExtraHours').value) : 0;
                const reason = document.getElementById('onDutyReason').value;
                const abbrev = staffAbbreviations[staff];

                if (!staff || !date || !reason) {
                    alert('Please fill all required fields');
                    return;
                }

                try {
                    const dateKey = date;
                    const dateObj = new Date(date);
                    const dayIndex = dateObj.getDay();
                    const dayName = shiftData.days[dayIndex];
                    const regularShift = shiftData.shifts[dayName][staff] || 'Not Scheduled';

                    const entry = {
                        staff: staff,
                        date: date,
                        type: onDutyType,
                        hours: extraHours,
                        reason: reason,
                        regularShift: regularShift,
                        entryDate: new Date().toISOString()
                    };

                    await saveOnDutyEntry(entry);
                    onDutyEntries[dateKey] = entry;

                    if (onDutyType === 'extra' && extraHours > 0) {
                        extraHoursData[dateKey] = {
                            staff: staff,
                            hours: extraHours,
                            reason: `On Duty (OD): ${reason}`,
                            entryDate: new Date().toISOString(),
                            coffCalculated: false,
                            type: 'On Duty (Extra Hours)'
                        };
                    }

                    await saveAllData();

                    if (onDutyType === 'extra') {
                        calculateCOFFBalances();
                    }

                    const typeText = onDutyType === 'regular' ? 'On Duty (Regular Shift)' : `On Duty with ${extraHours} extra hours`;
                    alert(`${typeText} saved for ${abbrev} (${staff}) on ${date}\nReason: ${reason}`);
                    closeModal('onDutyModal');

                    renderWeekView();
                    renderMonthView();
                    renderTodayView();
                    updateStats();
                } catch (error) {
                    console.error("Error saving on-duty entry:", error);
                    alert("Error saving on-duty entry. Please try again.");
                }
            }

            // ==================== LATE ENTRY FUNCTIONS WITH FIREBASE ====================
            function updateRegularShiftTime() {
                const staff = document.getElementById('lateEntryStaff').value;
                const date = document.getElementById('lateEntryDate').value;
                const dateObj = new Date(date);
                const dayIndex = dateObj.getDay();
                const dayName = shiftData.days[dayIndex];
                const shift = shiftData.shifts[dayName][staff] || 'Not Scheduled';

                let startTime = '17:00';
                if (shift.includes('5pm-1:30am')) startTime = '17:00';
                if (shift.includes('4pm-12:30pm')) startTime = '16:00';
                if (shift.includes('7pm-3:30pm')) startTime = '19:00';
                if (shift.includes('7:00pm-3:30am')) startTime = '19:00';

                document.getElementById('regularShiftTime').value = `${startTime} (${shift})`;

                if (document.getElementById('actualTime').value) {
                    calculateDelay();
                }
            }

            function calculateDelay() {
                const regularShiftTime = document.getElementById('regularShiftTime').value;
                const actualTime = document.getElementById('actualTime').value;

                if (!regularShiftTime || !actualTime) return;

                const timeMatch = regularShiftTime.match(/(\d{1,2}):(\d{2})/);
                if (!timeMatch) {
                    alert('Could not parse regular shift time');
                    return;
                }

                const regularHour = parseInt(timeMatch[1]);
                const regularMinute = parseInt(timeMatch[2]);
                const [actualHour, actualMinute] = actualTime.split(':').map(Number);

                let adjustedRegularHour = regularHour;
                if (regularShiftTime.includes('pm') && regularHour < 12) {
                    adjustedRegularHour += 12;
                }

                const regularTotalMinutes = adjustedRegularHour * 60 + regularMinute;
                const actualTotalMinutes = actualHour * 60 + actualMinute;
                let delayMinutes = actualTotalMinutes - regularTotalMinutes;

                if (delayMinutes < -720) delayMinutes += 1440;

                document.getElementById('delayMinutes').value = delayMinutes > 0 ? `${delayMinutes} minutes` : 'On time or early';

                const delayMessage = document.getElementById('delayMessage');
                if (delayMinutes > 0) {
                    const coffHoursRequired = Math.ceil(delayMinutes / 60);
                    document.getElementById('coffHoursRequired').textContent = coffHoursRequired;
                    delayMessage.innerHTML = `
                <span style="color: #e74c3c;">
                    âš ï¸ ${delayMinutes} minutes late (${coffHoursRequired} hour${coffHoursRequired > 1 ? 's' : ''} COFF required)
                </span>
            `;
                } else {
                    document.getElementById('coffHoursRequired').textContent = '0';
                    delayMessage.innerHTML = '<span style="color: #27ae60;">âœ“ On time or early</span>';
                }
            }

            function toggleCOFFRequirement() {
                const regularizeType = document.querySelector('input[name="regularizeType"]:checked').value;
                document.getElementById('coffRequirement').style.display = regularizeType === 'coff' ? 'block' : 'none';
            }

            async function saveLateEntry() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save late entries.");
                    return;
                }

                const staff = document.getElementById('lateEntryStaff').value;
                const date = document.getElementById('lateEntryDate').value;
                const actualTime = document.getElementById('actualTime').value;
                const delayMinutes = parseInt(document.getElementById('delayMinutes').value) || 0;
                const regularizeType = document.querySelector('input[name="regularizeType"]:checked').value;
                const reason = document.getElementById('lateEntryReason').value;

                if (!staff || !date || !actualTime) {
                    alert('Please fill all required fields');
                    return;
                }

                if (delayMinutes <= 0) {
                    alert('Staff is on time or early. No late entry to record.');
                    return;
                }

                const dateObj = new Date(date);
                const dayIndex = dateObj.getDay();
                const dayName = shiftData.days[dayIndex];
                const regularShift = shiftData.shifts[dayName][staff] || 'Not Scheduled';
                const abbrev = staffAbbreviations[staff];

                const coffHoursRequired = Math.ceil(delayMinutes / 60);
                const regularizedFromCOFF = regularizeType === 'coff';

                if (regularizedFromCOFF) {
                    const coffBalance = coffData.balances[staff] || 0;
                    const coffBalanceHours = coffBalance * 8;

                    if (coffBalanceHours < coffHoursRequired) {
                        alert(`${abbrev} (${staff}) has insufficient COFF balance.\nRequired: ${coffHoursRequired} hours\nAvailable: ${coffBalanceHours} hours`);
                        return;
                    }
                }

                try {
                    const lateEntry = {
                        id: Date.now(),
                        staff: staff,
                        date: date,
                        actualTime: actualTime,
                        regularShift: regularShift,
                        delayMinutes: delayMinutes,
                        coffHoursRequired: coffHoursRequired,
                        regularizedFromCOFF: regularizedFromCOFF,
                        reason: reason,
                        entryDate: new Date().toISOString()
                    };

                    await saveLateEntry(lateEntry);
                    lateEntries.entries.push(lateEntry);

                    if (regularizedFromCOFF) {
                        coffData.balances[staff] = (coffData.balances[staff] || 0) - (coffHoursRequired / 8);

                        coffData.history.push({
                            id: Date.now(),
                            staff: staff,
                            date: date,
                            type: 'Late Entry Regularization',
                            hours: -coffHoursRequired,
                            coffUsed: coffHoursRequired / 8,
                            balanceAfter: coffData.balances[staff],
                            timestamp: new Date().toISOString(),
                            reason: `Late entry: ${reason} (${delayMinutes} minutes late)`
                        });
                    }

                    await saveAllData();
                    updateStats();

                    const regularizationText = regularizedFromCOFF ?
                        `Regularized using ${coffHoursRequired} hours (${(coffHoursRequired / 8).toFixed(1)} days) COFF` :
                        'Approved without COFF regularization';

                    alert(`Late entry recorded for ${abbrev} (${staff}) on ${date}\nDelay: ${delayMinutes} minutes\n${regularizationText}`);
                    closeModal('lateEntryModal');

                    renderWeekView();
                    renderMonthView();
                    renderTodayView();
                } catch (error) {
                    console.error("Error saving late entry:", error);
                    alert("Error saving late entry. Please try again.");
                }
            }

            // ==================== EXTRA HOURS FUNCTIONS WITH FIREBASE ====================
            async function saveExtraHours() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to save extra hours.");
                    return;
                }

                const staff = document.getElementById('extraHoursStaff').value;
                const date = document.getElementById('extraHoursDate').value;
                const hours = parseFloat(document.getElementById('extraHours').value);
                const reason = document.getElementById('extraHoursReason').value;
                const abbrev = staffAbbreviations[staff];

                if (!staff || !date || !hours || !reason) {
                    alert('Please fill all required fields');
                    return;
                }

                try {
                    const dateKey = date;
                    const existingEntry = extraHoursData[dateKey];

                    if (existingEntry && existingEntry.staff === staff) {
                        if (confirm(`${abbrev} already has ${existingEntry.hours} extra hours on ${date}. Add ${hours} more hours?`)) {
                            existingEntry.hours += hours;
                            existingEntry.reason += `; Additional: ${reason}`;
                            existingEntry.entryDate = new Date().toISOString();
                            existingEntry.coffCalculated = false;

                            await saveExtraHoursEntry(existingEntry);
                        } else {
                            return;
                        }
                    } else {
                        const entry = {
                            staff: staff,
                            date: date,
                            hours: hours,
                            reason: reason,
                            entryDate: new Date().toISOString(),
                            coffCalculated: false,
                            type: 'Extra Hours'
                        };

                        await saveExtraHoursEntry(entry);
                        extraHoursData[dateKey] = entry;
                    }

                    calculateCOFFBalances();
                    await saveAllData();
                    updateStats();

                    alert(`Extra hours saved for ${abbrev} (${staff}) on ${date}: ${hours} hours`);
                    closeModal('extraHoursModal');

                    renderWeekView();
                    renderMonthView();
                    renderTodayView();
                } catch (error) {
                    console.error("Error saving extra hours:", error);
                    alert("Error saving extra hours. Please try again.");
                }
            }

            // ==================== HOLIDAY FUNCTIONS WITH FIREBASE ====================
            function checkExistingHoliday() {
                const dateStr = document.getElementById('holidayDate').value;
                const infoDiv = document.getElementById('existingHolidayInfo');
                const actionBtn = document.getElementById('holidayActionBtn');

                if (!dateStr) {
                    infoDiv.style.display = 'none';
                    actionBtn.textContent = 'Add Holiday';
                    return;
                }

                const existingHoliday = holidays[dateStr];
                if (existingHoliday) {
                    infoDiv.style.display = 'block';
                    infoDiv.innerHTML = `
                <strong>Existing Holiday:</strong> ${existingHoliday.name}<br>
                <small>Click "Remove Holiday" to delete this holiday</small>
            `;
                    actionBtn.textContent = 'Remove Holiday';
                    actionBtn.className = 'btn-danger';
                    document.getElementById('holidayName').value = existingHoliday.name;
                } else {
                    infoDiv.style.display = 'none';
                    actionBtn.textContent = 'Add Holiday';
                    actionBtn.className = '';
                }
            }

            async function saveHoliday() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to manage holidays.");
                    return;
                }

                const date = document.getElementById('holidayDate').value;
                const name = document.getElementById('holidayName').value;
                const actionBtn = document.getElementById('holidayActionBtn');

                if (!date || !name) {
                    alert('Please fill all required fields');
                    return;
                }

                try {
                    if (actionBtn.textContent === 'Remove Holiday') {
                        if (confirm(`Remove holiday "${holidays[date].name}" on ${date}?`)) {
                            await deleteHoliday(date);
                            delete holidays[date];

                            await saveAllData();
                            alert(`Holiday removed from ${date}`);
                            closeModal('holidayModal');
                            renderWeekView();
                            renderMonthView();
                            renderTodayView();
                        }
                    } else {
                        const holiday = {
                            date: date,
                            name: name,
                            addedAt: new Date().toISOString()
                        };

                        await saveHoliday(holiday);
                        holidays[date] = holiday;

                        await saveAllData();
                        alert(`Holiday "${name}" added for ${date}`);
                        closeModal('holidayModal');
                        renderWeekView();
                        renderMonthView();
                        renderTodayView();
                    }
                } catch (error) {
                    console.error("Error managing holiday:", error);
                    alert("Error managing holiday. Please try again.");
                }
            }

            // ==================== SKELETON SHIFT FUNCTIONS WITH FIREBASE ====================
            function checkExistingSkeleton() {
                const dateStr = document.getElementById('skeletonDate').value;
                const infoDiv = document.getElementById('existingSkeletonInfo');
                const actionBtn = document.getElementById('skeletonActionBtn');

                if (!dateStr) {
                    infoDiv.style.display = 'none';
                    actionBtn.textContent = 'Add Skeleton Shift';
                    return;
                }

                const existingSkeleton = skeletonShifts[dateStr];
                if (existingSkeleton) {
                    infoDiv.style.display = 'block';
                    let excludedStr = existingSkeleton.excludedEmployees ? existingSkeleton.excludedEmployees.map(s => staffAbbreviations[s]).join(', ') : 'None';
                    infoDiv.innerHTML = `
                <strong>Existing Skeleton Shift:</strong> ${existingSkeleton.hours} hours<br>
                <strong>Excluded Employees:</strong> ${excludedStr}<br>
                <strong>Reason:</strong> ${existingSkeleton.reason}<br>
                <small>Click "Remove Skeleton Shift" to delete this entry</small>
            `;
                    actionBtn.textContent = 'Remove Skeleton Shift';
                    actionBtn.className = 'btn-danger';
                    document.getElementById('skeletonHours').value = existingSkeleton.hours;
                    document.getElementById('skeletonReason').value = existingSkeleton.reason;

                    if (existingSkeleton.excludedEmployees) {
                        existingSkeleton.excludedEmployees.forEach(staff => {
                            const checkbox = document.getElementById(`exclude_${staff}`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.dispatchEvent(new Event('change'));
                            }
                        });
                    }
                } else {
                    infoDiv.style.display = 'none';
                    actionBtn.textContent = 'Add Skeleton Shift';
                    actionBtn.className = '';
                }
            }

            async function saveSkeletonShift() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to manage skeleton shifts.");
                    return;
                }

                const date = document.getElementById('skeletonDate').value;
                const hours = parseInt(document.getElementById('skeletonHours').value);
                const reason = document.getElementById('skeletonReason').value;
                const actionBtn = document.getElementById('skeletonActionBtn');

                if (!date || !hours || !reason) {
                    alert('Please fill all required fields');
                    return;
                }

                const excludedEmployees = [];
                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                staffList.forEach(staff => {
                    const checkbox = document.getElementById(`exclude_${staff}`);
                    if (checkbox && checkbox.checked) excludedEmployees.push(staff);
                });

                try {
                    if (actionBtn.textContent === 'Remove Skeleton Shift') {
                        if (confirm(`Remove skeleton shift (${skeletonShifts[date].hours} hours) on ${date}?`)) {
                            await deleteSkeletonShift(date);
                            delete skeletonShifts[date];

                            await saveAllData();
                            calculateSkeletonOT();

                            alert(`Skeleton shift removed from ${date}`);
                            closeModal('skeletonModal');
                            renderWeekView();
                            renderMonthView();
                            renderTodayView();
                        }
                    } else {
                        const skeleton = {
                            date: date,
                            hours: hours,
                            reason: reason,
                            excludedEmployees: excludedEmployees
                        };

                        await saveSkeletonShift(skeleton);
                        skeletonShifts[date] = skeleton;

                        await saveAllData();
                        calculateSkeletonOT();

                        const excludedAbbrevs = excludedEmployees.map(s => staffAbbreviations[s]).join(', ');
                        alert(`Skeleton shift (${hours} hours) added for ${date}. Excluded employees: ${excludedEmployees.length > 0 ? excludedAbbrevs : 'None'}`);
                        closeModal('skeletonModal');
                        renderWeekView();
                        renderMonthView();
                        renderTodayView();
                    }
                } catch (error) {
                    console.error("Error managing skeleton shift:", error);
                    alert("Error managing skeleton shift. Please try again.");
                }
            }

            function calculateSkeletonOT() {
                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                otData.monthly = {};

                Object.entries(skeletonShifts).forEach(([dateStr, skeleton]) => {
                    const date = new Date(dateStr);
                    const year = date.getFullYear();
                    const month = date.getMonth() + 1;
                    const monthKey = `${year}-${month.toString().padStart(2, '0')}`;

                    if (!otData.monthly[monthKey]) {
                        otData.monthly[monthKey] = {};
                        staffList.forEach(staff => otData.monthly[monthKey][staff] = 0);
                    }

                    const dayIndex = date.getDay();
                    const dayName = shiftData.days[dayIndex];

                    staffList.forEach(staff => {
                        if (skeleton.excludedEmployees && skeleton.excludedEmployees.includes(staff)) return;

                        const shift = shiftData.shifts[dayName][staff];
                        const isOnLeave = checkIfOnLeave(staff, date);
                        const isOffDutyWorking = checkOffDutyWorking(staff, date);
                        const isOnDuty = checkOnDuty(staff, date);
                        const hasLateEntry = checkLateEntry(staff, date);

                        if (shift && !shift.includes('Off') && !isOnLeave && !isOffDutyWorking && !isOnDuty && !hasLateEntry) {
                            otData.monthly[monthKey][staff] += skeleton.hours;
                        }
                    });
                });

                saveAllData();
            }

            // ==================== COFF FUNCTIONS WITH FIREBASE ====================
            function updateCOFFBalanceDisplay() {
                const staff = document.getElementById('coffStaff').value;
                const balance = coffData.balances[staff] || 0;
                const abbrev = staffAbbreviations[staff];
                document.getElementById('coffBalanceDisplay').innerHTML = `
            <strong>${abbrev} (${staff}):</strong> ${balance.toFixed(1)} days available<br>
            <small>1 day = 8 hours of extra work</small>
        `;
            }

            function updateCoffToDate() {
                const fromDate = document.getElementById('coffFromDate').value;
                if (fromDate) {
                    document.getElementById('coffToDate').value = fromDate;
                    document.getElementById('coffToDate').min = fromDate;
                }
            }

            async function submitCOFF() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to submit COFF requests.");
                    return;
                }

                const staff = document.getElementById('coffStaff').value;
                const fromDate = new Date(document.getElementById('coffFromDate').value);
                const toDate = new Date(document.getElementById('coffToDate').value);
                const reason = document.getElementById('coffReason').value;
                const balance = coffData.balances[staff] || 0;
                const abbrev = staffAbbreviations[staff];

                if (fromDate > toDate) {
                    alert('To date must be after From date');
                    return;
                }

                const daysRequested = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;

                if (balance < daysRequested) {
                    alert(`${abbrev} (${staff}) has only ${balance.toFixed(1)} days COFF balance, but requested ${daysRequested} days.`);
                    return;
                }

                const dateRange = getDatesInRange(fromDate, toDate);

                try {
                    for (const date of dateRange) {
                        const dateKey = formatDateForInput(date);
                        const leaveRequest = {
                            id: Date.now() + Math.random(),
                            staff: staff,
                            date: dateKey,
                            type: 'Compensatory Off (COFF)',
                            reason: reason,
                            status: 'pending',
                            requestedAt: new Date().toISOString(),
                            isCOFF: true
                        };

                        await saveLeaveRequest(leaveRequest);
                        leaveRequests.push(leaveRequest);
                        coffData.pending.push(dateKey);
                    }

                    await saveAllData();
                    updateStats();

                    alert(`COFF request submitted for ${abbrev} (${staff}) from ${formatDateForInput(fromDate)} to ${formatDateForInput(toDate)}`);
                    closeModal('applyCOFFModal');

                    if (document.getElementById('approvals-tab').classList.contains('active')) {
                        renderApprovals();
                    }
                } catch (error) {
                    console.error("Error submitting COFF request:", error);
                    alert("Error submitting COFF request. Please try again.");
                }
            }

            function calculateCOFFBalances() {
                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                staffList.forEach(staff => coffData.balances[staff] = 0);

                coffData.history = [];

                Object.entries(extraHoursData).forEach(([dateKey, entry]) => {
                    if (!entry.coffCalculated) {
                        const staff = entry.staff;
                        const coffDays = entry.hours / 8;
                        coffData.balances[staff] = (coffData.balances[staff] || 0) + coffDays;

                        coffData.history.push({
                            id: Date.now(),
                            staff: staff,
                            date: dateKey,
                            type: entry.type || 'Extra Hours',
                            hours: entry.hours,
                            coffEarned: coffDays,
                            balanceAfter: coffData.balances[staff],
                            timestamp: new Date().toISOString(),
                            reason: entry.reason
                        });

                        entry.coffCalculated = true;
                    }
                });

                leaveRequests.forEach(request => {
                    if (request.isCOFF && request.status === 'approved') {
                        coffData.balances[request.staff] = (coffData.balances[request.staff] || 0) - 1;

                        coffData.history.push({
                            id: Date.now(),
                            staff: request.staff,
                            date: request.date,
                            type: 'COFF Used',
                            hours: -8,
                            coffUsed: 1,
                            balanceAfter: coffData.balances[request.staff],
                            timestamp: new Date().toISOString(),
                            reason: request.reason
                        });
                    }
                });

                if (lateEntries.entries) {
                    lateEntries.entries.forEach(entry => {
                        if (entry.regularizedFromCOFF) {
                            coffData.balances[entry.staff] = (coffData.balances[entry.staff] || 0) - (entry.coffHoursRequired / 8);

                            coffData.history.push({
                                id: Date.now(),
                                staff: entry.staff,
                                date: entry.date,
                                type: 'Late Entry Regularization',
                                hours: -entry.coffHoursRequired,
                                coffUsed: entry.coffHoursRequired / 8,
                                balanceAfter: coffData.balances[entry.staff],
                                timestamp: new Date().toISOString(),
                                reason: entry.reason
                            });
                        }
                    });
                }

                saveAllData();
                updateStats();
            }

            function renderCOFFSummary() {
                const container = document.getElementById('coff-summary-container');
                let html = '<div class="coff-summary"><h3>COFF Balances</h3>';

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                staffList.forEach(staff => {
                    const balance = coffData.balances[staff] || 0;
                    const abbrev = staffAbbreviations[staff];
                    const extraHoursEntries = Object.values(extraHoursData).filter(entry => entry.staff === staff);
                    const totalHours = extraHoursEntries.reduce((sum, entry) => sum + entry.hours, 0);

                    html += `
                <div style="margin-bottom: 10px; padding: 10px; background: #f0f7ff; border-radius: 5px;">
                    <strong>${abbrev} (${staff}):</strong> ${balance.toFixed(1)} days (${(balance * 8).toFixed(1)} hours)<br>
                    <small>Total extra hours: ${totalHours.toFixed(1)} hours from ${extraHoursEntries.length} entries</small>
                    ${balance >= 1 ? '<div style="color: #27ae60; margin-top: 5px;">âœ“ Eligible for COFF</div>' : ''}
                </div>
            `;
                });

                html += '</div>';
                container.innerHTML = html;
            }

            function renderCOFFHistory() {
                const container = document.getElementById('coff-history-container');

                if (coffData.history.length === 0) {
                    container.innerHTML = '<p>No COFF history available.</p>';
                    return;
                }

                let html = '<h3>COFF History</h3><table>';
                html += `
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Staff</th>
                    <th>Type</th>
                    <th>Hours</th>
                    <th>COFF Days</th>
                    <th>Balance After</th>
                    <th>Reason</th>
                </tr>
            </thead>
            <tbody>
        `;

                const recentHistory = [...coffData.history].reverse().slice(0, 20);
                recentHistory.forEach(entry => {
                    const abbrev = staffAbbreviations[entry.staff];
                    const hoursDisplay = entry.hours > 0 ? `+${entry.hours}` : entry.hours;
                    const coffDisplay = entry.coffEarned ? `+${entry.coffEarned.toFixed(2)}` :
                        entry.coffUsed ? `-${entry.coffUsed.toFixed(2)}` : 'N/A';

                    html += `
                <tr>
                    <td>${new Date(entry.timestamp).toLocaleDateString()}</td>
                    <td>${abbrev} (${entry.staff})</td>
                    <td>${entry.type}</td>
                    <td>${hoursDisplay}</td>
                    <td>${coffDisplay}</td>
                    <td>${entry.balanceAfter ? entry.balanceAfter.toFixed(2) + ' days' : 'N/A'}</td>
                    <td>${entry.reason || ''}</td>
                </tr>
            `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function viewCOFFSummary() {
                renderCOFFSummary();
                renderCOFFHistory();
            }

            // ==================== APPROVAL FUNCTIONS WITH FIREBASE ====================
            function showApprovalReasonModal(requestId, action) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to approve/reject leaves.");
                    return;
                }

                currentApprovalRequestId = requestId;
                currentApprovalAction = action;
                document.getElementById('approvalReason').value = '';

                if (action === 'approve') {
                    document.getElementById('approveWithReasonBtn').style.display = 'inline-block';
                    document.getElementById('rejectWithReasonBtn').style.display = 'none';
                } else {
                    document.getElementById('approveWithReasonBtn').style.display = 'none';
                    document.getElementById('rejectWithReasonBtn').style.display = 'inline-block';
                }

                openModal('approvalReasonModal');
            }

            async function approveLeaveWithReason() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to approve leaves.");
                    return;
                }

                const requestId = currentApprovalRequestId;
                const reason = document.getElementById('approvalReason').value;

                const requestIndex = leaveRequests.findIndex(req => req.id == requestId);
                if (requestIndex === -1) {
                    alert('Request not found');
                    closeModal('approvalReasonModal');
                    return;
                }

                const request = leaveRequests[requestIndex];
                const abbrev = staffAbbreviations[request.staff];

                if (request.isCOFF) {
                    const balance = coffData.balances[request.staff] || 0;
                    if (balance < 1) {
                        alert(`Cannot approve COFF request for ${abbrev} (${request.staff}). Insufficient balance: ${balance.toFixed(1)} days.`);
                        closeModal('approvalReasonModal');
                        return;
                    }
                }

                try {
                    await updateLeaveRequest(requestId, {
                        status: 'approved',
                        approvedAt: new Date().toISOString(),
                        approvalReason: reason
                    });

                    request.status = 'approved';
                    request.approvedAt = new Date().toISOString();
                    request.approvalReason = reason;

                    const dateKey = request.date;
                    if (!leaveData[dateKey]) leaveData[dateKey] = [];
                    if (!leaveData[dateKey].includes(request.staff)) leaveData[dateKey].push(request.staff);

                    if (request.isCOFF) {
                        coffData.balances[request.staff] = (coffData.balances[request.staff] || 0) - 1;

                        coffData.history.push({
                            id: Date.now(),
                            staff: request.staff,
                            date: request.date,
                            type: 'COFF Used',
                            status: 'approved',
                            balanceAfter: coffData.balances[request.staff],
                            timestamp: new Date().toISOString(),
                            reason: reason
                        });
                    }

                    await saveAllData();
                    updateStats();
                    renderApprovals();
                    renderWeekView();
                    renderMonthView();
                    renderTodayView();

                    closeModal('approvalReasonModal');
                    alert(`Leave approved for ${abbrev} (${request.staff}) on ${request.date}`);
                } catch (error) {
                    console.error("Error approving leave:", error);
                    alert("Error approving leave. Please try again.");
                }
            }

            async function rejectLeaveWithReason() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to reject leaves.");
                    return;
                }

                const requestId = currentApprovalRequestId;
                const reason = document.getElementById('approvalReason').value;

                const requestIndex = leaveRequests.findIndex(req => req.id == requestId);
                if (requestIndex === -1) {
                    alert('Request not found');
                    closeModal('approvalReasonModal');
                    return;
                }

                const request = leaveRequests[requestIndex];
                const abbrev = staffAbbreviations[request.staff];

                try {
                    await updateLeaveRequest(requestId, {
                        status: 'rejected',
                        rejectedAt: new Date().toISOString(),
                        approvalReason: reason
                    });

                    request.status = 'rejected';
                    request.rejectedAt = new Date().toISOString();
                    request.approvalReason = reason;

                    await saveAllData();
                    updateStats();
                    renderApprovals();

                    closeModal('approvalReasonModal');
                    alert(`Leave rejected for ${abbrev} (${request.staff}) on ${request.date}`);
                } catch (error) {
                    console.error("Error rejecting leave:", error);
                    alert("Error rejecting leave. Please try again.");
                }
            }

            function renderApprovals() {
                const approvalsTab = document.getElementById('approvals-tab');
                const existingSections = approvalsTab.querySelectorAll('h2, .approval-list, p');
                existingSections.forEach(section => section.remove());

                // Pending approvals
                const pendingContainer = document.getElementById('pending-approvals-container');
                const pendingRequests = leaveRequests.filter(req => req.status === 'pending');

                if (pendingRequests.length === 0) {
                    pendingContainer.innerHTML = '<p>No pending approvals</p>';
                } else {
                    pendingContainer.innerHTML = '<div class="approval-list">';
                    pendingRequests.forEach((request) => {
                        const abbrev = staffAbbreviations[request.staff];
                        const item = document.createElement('div');
                        item.className = 'approval-item';
                        item.innerHTML = `
                    <div class="approval-header">
                        <div>
                            <strong>${abbrev} (${request.staff})</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Date: ${request.date} | Type: ${request.type}
                            </div>
                            ${request.reason ? `<div style="margin-top: 5px;"><strong>Reason:</strong> ${request.reason}</div>` : ''}
                        </div>
                        <div style="font-size: 0.9em; color: #f39c12;">Pending</div>
                    </div>
                    <div class="approval-actions">
                        <button class="btn-success" onclick="showApprovalReasonModal('${request.id}', 'approve')">Approve</button>
                        <button class="btn-danger" onclick="showApprovalReasonModal('${request.id}', 'reject')">Reject</button>
                        ${request.isCOFF ? `<button class="btn-warning" onclick="checkCOFFEligibility('${request.staff}', '${request.id}')">Check COFF</button>` : ''}
                    </div>
                `;
                        pendingContainer.querySelector('.approval-list').appendChild(item);
                    });
                    pendingContainer.innerHTML += '</div>';
                }

                // Approved leaves
                const approvedContainer = document.getElementById('approved-leaves-container');
                const approvedRequests = leaveRequests.filter(req => req.status === 'approved');

                if (approvedRequests.length === 0) {
                    approvedContainer.innerHTML = '<p>No approved leaves</p>';
                } else {
                    approvedContainer.innerHTML = '<div class="approval-list">';
                    approvedRequests.slice(0, 20).forEach(request => {
                        const abbrev = staffAbbreviations[request.staff];
                        const item = document.createElement('div');
                        item.className = 'approval-item approved';
                        item.innerHTML = `
                    <div class="approval-header">
                        <div>
                            <strong>${abbrev} (${request.staff})</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Date: ${request.date} | Type: ${request.type}
                            </div>
                            ${request.reason ? `<div style="margin-top: 5px;"><strong>Reason:</strong> ${request.reason}</div>` : ''}
                            ${request.approvalReason ? `<div style="margin-top: 5px;"><strong>Approval Reason:</strong> ${request.approvalReason}</div>` : ''}
                        </div>
                        <div style="font-size: 0.9em; color: #27ae60;">Approved</div>
                    </div>
                    ${!request.isCOFF ? `<div class="approval-actions">
                        <button class="btn-danger" onclick="cancelSingleLeave('${request.id}')">Cancel Leave</button>
                    </div>` : ''}
                `;
                        approvedContainer.querySelector('.approval-list').appendChild(item);
                    });
                    approvedContainer.innerHTML += '</div>';
                }

                // Rejected leaves
                const rejectedContainer = document.getElementById('rejected-leaves-container');
                const rejectedRequests = leaveRequests.filter(req => req.status === 'rejected');

                if (rejectedRequests.length === 0) {
                    rejectedContainer.innerHTML = '<p>No rejected leaves</p>';
                } else {
                    rejectedContainer.innerHTML = '<div class="approval-list">';
                    rejectedRequests.slice(0, 20).forEach(request => {
                        const abbrev = staffAbbreviations[request.staff];
                        const item = document.createElement('div');
                        item.className = 'approval-item';
                        item.style.borderLeftColor = '#e74c3c';
                        item.innerHTML = `
                    <div class="approval-header">
                        <div>
                            <strong>${abbrev} (${request.staff})</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Date: ${request.date} | Type: ${request.type}
                            </div>
                            ${request.reason ? `<div style="margin-top: 5px;"><strong>Reason:</strong> ${request.reason}</div>` : ''}
                            ${request.approvalReason ? `<div style="margin-top: 5px;"><strong>Rejection Reason:</strong> ${request.approvalReason}</div>` : ''}
                        </div>
                        <div style="font-size: 0.9em; color: #e74c3c;">Rejected</div>
                    </div>
                `;
                        rejectedContainer.querySelector('.approval-list').appendChild(item);
                    });
                    rejectedContainer.innerHTML += '</div>';
                }

                // Cancelled leaves
                const cancelledContainer = document.getElementById('cancelled-leaves-container');
                const cancelledRequests = leaveRequests.filter(req => req.status === 'cancelled');

                if (cancelledRequests.length === 0) {
                    cancelledContainer.innerHTML = '<p>No cancelled leaves</p>';
                } else {
                    cancelledContainer.innerHTML = '<div class="approval-list">';
                    cancelledRequests.slice(0, 20).forEach(request => {
                        const abbrev = staffAbbreviations[request.staff];
                        const item = document.createElement('div');
                        item.className = 'approval-item';
                        item.style.borderLeftColor = '#95a5a6';
                        item.innerHTML = `
                    <div class="approval-header">
                        <div>
                            <strong>${abbrev} (${request.staff})</strong>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                Date: ${request.date} | Type: ${request.type}
                            </div>
                            ${request.reason ? `<div style="margin-top: 5px;"><strong>Reason:</strong> ${request.reason}</div>` : ''}
                        </div>
                        <div style="font-size: 0.9em; color: #95a5a6;">Cancelled</div>
                    </div>
                `;
                        cancelledContainer.querySelector('.approval-list').appendChild(item);
                    });
                    cancelledContainer.innerHTML += '</div>';
                }
            }

            // ==================== VIEW FUNCTIONS (REMAIN UNCHANGED) ====================
            function renderWeekView() {
                const calendar = document.getElementById('calendar');
                calendar.innerHTML = '';

                for (let i = 0; i < 7; i++) {
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + i);
                    const dayIndex = date.getDay();
                    const dayName = shiftData.days[dayIndex];
                    const dateStr = formatDateForDisplay(date);
                    const isToday = date.toDateString() === today.toDateString();
                    const dateKey = formatDateForInput(date);
                    const isHoliday = holidays[dateKey];
                    const isSkeleton = skeletonShifts[dateKey];

                    const operators = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                    let availableOperators = 0;
                    let leaveOperators = 0;
                    let offDutyOperators = 0;
                    let offDutyWorkingOperators = 0;
                    let onDutyOperators = 0;
                    let obituaryOperators = 0;
                    let extraHoursOperators = 0;
                    let lateEntryOperators = 0;

                    operators.forEach(op => {
                        const shift = shiftData.shifts[dayName][op];
                        const isOnLeave = checkIfOnLeave(op, date);
                        const isOffDutyWorking = checkOffDutyWorking(op, date);
                        const isOnDuty = checkOnDuty(op, date);
                        const hasExtraHours = checkExtraHours(op, date);
                        const hasLateEntry = checkLateEntry(op, date);

                        if (hasLateEntry) {
                            availableOperators++;
                            lateEntryOperators++;
                        } else if (isOffDutyWorking || isOnDuty) {
                            availableOperators++;
                            if (isOffDutyWorking) offDutyWorkingOperators++;
                            if (isOnDuty) onDutyOperators++;
                        } else if (shift && !shift.includes('Off') && !isOnLeave) {
                            availableOperators++;
                            if (shift.includes('Obituary')) obituaryOperators++;
                        }

                        if (isOnLeave) leaveOperators++;
                        if (shift && shift.includes('Off') && !isOffDutyWorking) offDutyOperators++;
                        if (hasExtraHours) extraHoursOperators++;
                    });

                    const dayCard = document.createElement('div');
                    let additionalClass = '';
                    if (isHoliday) additionalClass = 'holiday-cell';
                    if (isSkeleton) additionalClass = 'skeleton-cell';
                    dayCard.className = `day-card ${isToday ? 'today' : ''} ${additionalClass}`;
                    dayCard.onclick = () => showDayDetails(date);

                    if (isHoliday) {
                        const marker = document.createElement('div');
                        marker.className = 'holiday-marker';
                        marker.textContent = 'HOLIDAY';
                        dayCard.appendChild(marker);
                    } else if (isSkeleton) {
                        const marker = document.createElement('div');
                        marker.className = 'skeleton-marker';
                        marker.textContent = 'SKELETON';
                        dayCard.appendChild(marker);
                    }

                    const header = document.createElement('div');
                    header.className = 'day-header';
                    header.innerHTML = `
                <div class="day-name">${dayName}</div>
                <div class="date">${dateStr}</div>
            `;

                    const shiftList = document.createElement('div');
                    shiftList.className = 'shift-list';

                    const allStaff = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                    allStaff.forEach(staff => {
                        const shift = shiftData.shifts[dayName][staff];
                        if (shift || checkOffDutyWorking(staff, date) || checkOnDuty(staff, date) || checkExtraHours(staff, date) || checkIfOnLeave(staff, date) || checkLateEntry(staff, date)) {
                            const leaveStatus = getLeaveStatus(staff, date);
                            const isOffDutyWorking = checkOffDutyWorking(staff, date);
                            const isOnDuty = checkOnDuty(staff, date);
                            const hasExtraHours = checkExtraHours(staff, date);
                            const hasLateEntry = checkLateEntry(staff, date);
                            const abbrev = staffAbbreviations[staff];

                            const shiftItem = document.createElement('div');
                            let statusClass = '';

                            if (hasLateEntry) statusClass = 'late-entry';
                            else if (leaveStatus === 'pending') statusClass = 'leave-pending';
                            else if (leaveStatus === 'approved') statusClass = 'leave-approved';
                            else if (leaveStatus === 'rejected') statusClass = 'leave-rejected';
                            else if (isOffDutyWorking) statusClass = 'off-duty-working';
                            else if (isOnDuty) statusClass = 'on-duty';
                            else if (hasExtraHours) statusClass = 'extra-hours';
                            else if (shift && shift.includes('Obituary')) statusClass = 'obituary-duty';
                            else if (shift && shift.includes('Off')) statusClass = 'off-duty';

                            shiftItem.className = `shift-item ${statusClass}`;

                            let shiftDisplay = shift || '';
                            let badge = '';

                            if (hasLateEntry) {
                                const lateEntry = getLateEntry(staff, date);
                                shiftDisplay = lateEntry.actualTime || shiftDisplay;
                                badge = '<span class="badge late-entry-badge">LATE</span>';
                            } else if (isOffDutyWorking) {
                                const entry = offDutyEntries[dateKey];
                                if (entry && entry.staff === staff) {
                                    shiftDisplay = entry.shift;
                                    badge = '<span class="badge off-duty-working-badge">OFF-DUTY</span>';
                                }
                            }

                            if (isOnDuty) {
                                const entry = onDutyEntries[dateKey];
                                if (entry && entry.staff === staff) {
                                    badge = '<span class="badge on-duty-badge">OD</span>';
                                    if (entry.type === 'extra') {
                                        shiftDisplay = (shiftDisplay || 'Shift') + ` +${entry.hours}h extra`;
                                    }
                                }
                            }

                            if (hasExtraHours) {
                                const extra = extraHoursData[dateKey];
                                if (extra && extra.staff === staff) {
                                    shiftDisplay = (shiftDisplay || 'Shift') + ` +${extra.hours}h extra`;
                                    badge += '<span class="badge extra-hours-badge">+EXTRA</span>';
                                }
                            }

                            if (leaveStatus === 'pending') badge += '<span class="badge leave-pending-badge">PENDING</span>';
                            else if (leaveStatus === 'approved') badge += '<span class="badge leave-approved-badge">LEAVE</span>';
                            else if (leaveStatus === 'rejected') badge += '<span class="badge leave-rejected-badge">REJECTED</span>';

                            if (shift && shift.includes('Obituary')) badge += '<span class="badge obituary-badge">OBITUARY</span>';
                            if (isHoliday) badge += '<span class="badge holiday-badge">HOLIDAY</span>';
                            if (isSkeleton) badge += '<span class="badge skeleton-badge">SKELETON</span>';

                            shiftItem.innerHTML = `
                        <div class="operator-name">
                            <span class="status-indicator ${getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry)}"></span>
                            ${abbrev} (${staff}${staff === 'ANEESH' ? ' CTP' : ''})
                            ${badge}
                        </div>
                        <div class="shift-time">${shiftDisplay}</div>
                    `;
                            shiftList.appendChild(shiftItem);
                        }
                    });

                    const operatorCount = document.createElement('div');
                    operatorCount.className = 'operator-count-display';
                    operatorCount.innerHTML = `
                <div class="operator-count-item">
                    <span class="operator-dot available"></span>
                    <span>Available: ${availableOperators}</span>
                </div>
                <div class="operator-count-item">
                    <span class="operator-dot leave"></span>
                    <span>Leave: ${leaveOperators}</span>
                </div>
                <div class="operator-count-item">
                    <span class="operator-dot off-duty"></span>
                    <span>Off: ${offDutyOperators}</span>
                </div>
                <div class="operator-count-item">
                    <span class="operator-dot on-duty"></span>
                    <span>OD: ${onDutyOperators}</span>
                </div>
                <div class="operator-count-item">
                    <span class="operator-dot late-entry"></span>
                    <span>Late: ${lateEntryOperators}</span>
                </div>
            `;
                    shiftList.appendChild(operatorCount);

                    if (availableOperators <= 2) {
                        const warning = document.createElement('div');
                        warning.className = 'warning';
                        warning.textContent = `âš ï¸ Minimum operators only (${availableOperators} available)`;
                        shiftList.appendChild(warning);
                    } else if (availableOperators < 2) {
                        const warning = document.createElement('div');
                        warning.className = 'warning critical';
                        warning.textContent = 'âŒ CRITICAL: Less than 2 operators available!';
                        shiftList.appendChild(warning);
                    }

                    dayCard.appendChild(header);
                    dayCard.appendChild(shiftList);
                    calendar.appendChild(dayCard);
                }
            }

            // ==================== NAVIGATION FUNCTIONS (REMAIN UNCHANGED) ====================
            function switchTab(tabName) {
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach(tab => tab.classList.remove('active'));
                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => content.classList.remove('active'));

                document.getElementById(`${tabName}-tab`).classList.add('active');
                event.target.classList.add('active');

                if (tabName === 'approvals') renderApprovals();
                else if (tabName === 'coff') {
                    renderCOFFSummary();
                    renderCOFFHistory();
                } else if (tabName === 'reports') {
                    document.getElementById('report-container').innerHTML = '<p>Select a report to generate</p>';
                    document.getElementById('attendance-nav').style.display = 'none';
                }
            }

            function switchView(viewType) {
                document.getElementById('viewTodayBtn').classList.remove('active');
                document.getElementById('viewWeekBtn').classList.remove('active');
                document.getElementById('viewMonthBtn').classList.remove('active');

                document.getElementById('todayView').classList.remove('active');
                document.getElementById('calendarView').classList.remove('active');
                document.getElementById('monthView').classList.remove('active');

                if (viewType === 'today') {
                    document.getElementById('todayView').classList.add('active');
                    document.getElementById('viewTodayBtn').classList.add('active');
                } else if (viewType === 'week') {
                    document.getElementById('calendarView').classList.add('active');
                    document.getElementById('viewWeekBtn').classList.add('active');
                } else if (viewType === 'month') {
                    document.getElementById('monthView').classList.add('active');
                    document.getElementById('viewMonthBtn').classList.add('active');
                }
            }

            function previousWeek() {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderWeekView();
                updateWeekTitle();
            }

            function nextWeek() {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderWeekView();
                updateWeekTitle();
            }

            function goToTodayWeek() {
                currentWeekStart = new Date();
                currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
                renderWeekView();
                updateWeekTitle();
            }

            function previousMonth() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderMonthView();
                updateMonthTitle();
            }

            function nextMonth() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderMonthView();
                updateMonthTitle();
            }

            function goToTodayMonth() {
                currentMonth = today.getMonth();
                currentYear = today.getFullYear();
                renderMonthView();
                updateMonthTitle();
            }

            function previousDay() {
                currentDayView.setDate(currentDayView.getDate() - 1);
                renderTodayView();
                updateDayTitle();
            }

            function nextDay() {
                currentDayView.setDate(currentDayView.getDate() + 1);
                renderTodayView();
                updateDayTitle();
            }

            function goToToday() {
                currentDayView = new Date();
                renderTodayView();
                updateDayTitle();
            }

            function updateWeekTitle() {
                const endDate = new Date(currentWeekStart);
                endDate.setDate(currentWeekStart.getDate() + 6);
                const startStr = currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                document.getElementById('weekTitle').textContent = `Week: ${startStr} - ${endStr}`;
            }

            function updateMonthTitle() {
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                document.getElementById('monthTitle').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            }

            function updateDayTitle() {
                const dateStr = currentDayView.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('dayTitle').textContent = dateStr;
            }

        // Note: The remaining functions (renderMonthView, showDayDetails, loadShiftEditGrid,
        // loadCurrentObituaryDuty, transferObituaryDuty, saveShiftEdit, and all report functions)
        // should be included exactly as in your original code, with Firebase save calls added where needed.

        // The app will initialize automatically when Firebase auth state is determined
        // via the onAuthStateChanged listener at the top of the script
            // ==================== ATTENDANCE REPORT FUNCTIONS ====================
            function generateAttendancePeriodReport() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to generate reports.");
                    return;
                }

                document.getElementById('attendance-nav').style.display = 'block';
                generateAttendanceReportForPeriod(0);
            }

            function generateAttendanceReportForPeriod(periodOffset) {
                if (userRole !== 'admin') {
                    alert("You don't have permission to generate reports.");
                    return;
                }

                const container = document.getElementById('report-container');
                const periodTitle = document.getElementById('attendance-period-title');

                const today = new Date();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();
                const currentDay = today.getDate();

                let baseStartDate, baseEndDate;

                if (currentDay <= 20) {
                    baseStartDate = new Date(currentYear, currentMonth - 1, 21);
                    baseEndDate = new Date(currentYear, currentMonth, 20);
                } else {
                    baseStartDate = new Date(currentYear, currentMonth, 21);
                    baseEndDate = new Date(currentYear, currentMonth + 1, 20);
                }

                const monthsToAdjust = periodOffset;
                const reportStartDate = new Date(baseStartDate.getFullYear(), baseStartDate.getMonth() + monthsToAdjust, 21);
                const reportEndDate = new Date(reportStartDate.getFullYear(), reportStartDate.getMonth() + 1, 20);

                if (reportStartDate.getMonth() === 11 && reportStartDate.getDate() === 21) {
                    reportEndDate.setFullYear(reportStartDate.getFullYear() + 1);
                }

                currentAttendancePeriod = periodOffset;
                currentAttendanceStartDate = reportStartDate;
                currentAttendanceEndDate = reportEndDate;

                const reportPeriod = `${reportStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} to ${reportEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

                let periodLabel = "Current Period";
                if (periodOffset < 0) {
                    periodLabel = `${Math.abs(periodOffset)} Period${Math.abs(periodOffset) > 1 ? 's' : ''} Ago`;
                } else if (periodOffset > 0) {
                    periodLabel = `${periodOffset} Period${periodOffset > 1 ? 's' : ''} Ahead`;
                }
                periodTitle.textContent = `${periodLabel}: ${reportPeriod}`;

                let html = `<h3>Attendance Report</h3>`;

                html += `<div style="overflow-x: auto;">
        <table style="min-width: 1000px;">
            <thead>
                <tr>
                    <th style="min-width: 100px;">Operator</th>`;

                const tempDate = new Date(reportStartDate);
                while (tempDate <= reportEndDate) {
                    const dateStr = tempDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    const dayName = tempDate.toLocaleDateString('en-US', { weekday: 'short' }).substring(0, 2);
                    html += `<th style="min-width: 30px; text-align: center;" title="${tempDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}">
                    ${dateStr}<br>${dayName}
                 </th>`;
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                html += `<th>Total Days</th><th>Present</th><th>Leave</th><th>Off</th><th>% Present</th></tr></thead><tbody>`;

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];

                staffList.forEach(staff => {
                    const abbrev = staffAbbreviations[staff];
                    html += `<tr>
                    <td style="font-weight: bold;">${abbrev}<br>(${staff}${staff === 'ANEESH' ? ' CTP' : ''})</td>`;

                    let totalDays = 0;
                    let presentDays = 0;
                    let leaveDays = 0;
                    let offDays = 0;

                    tempDate.setTime(reportStartDate.getTime());

                    while (tempDate <= reportEndDate) {
                        const dateKey = formatDateForInput(tempDate);
                        const dayIndex = tempDate.getDay();
                        const dayName = shiftData.days[dayIndex];

                        const isHoliday = holidays[dateKey];
                        const isSkeleton = skeletonShifts[dateKey];
                        const shift = shiftData.shifts[dayName][staff];
                        const isOnLeave = checkIfOnLeave(staff, tempDate);
                        const isOffDutyWorking = checkOffDutyWorking(staff, tempDate);
                        const isOnDuty = checkOnDuty(staff, tempDate);
                        const hasLateEntry = checkLateEntry(staff, tempDate);
                        const leaveStatus = getLeaveStatus(staff, tempDate);
                        const isOffDuty = shift && (shift.includes('Off') || shift.includes('Off-operator'));

                        let attendanceMark = '';
                        let cellStyle = '';
                        let cellTitle = '';

                        if (isHoliday) {
                            attendanceMark = '<span style="color: #e74c3c; font-weight: bold;" title="Holiday">H</span>';
                            cellStyle = 'background-color: #ffebee;';
                            cellTitle = `Holiday: ${holidays[dateKey].name}`;
                        } else if (isSkeleton) {
                            attendanceMark = '<span style="color: #26a69a; font-weight: bold;" title="Skeleton Shift">S</span>';
                            cellStyle = 'background-color: #e8f6f3;';
                            cellTitle = `Skeleton Shift: ${skeletonShifts[dateKey].hours} hours`;
                        } else if (isOnLeave) {
                            attendanceMark = leaveStatus === 'pending' ?
                                '<span style="color: #f39c12; font-weight: bold; border: 1px dashed #f39c12; padding: 0 2px;" title="Pending Leave">L?</span>' :
                                '<span style="color: #e74c3c; font-weight: bold;" title="Leave">L</span>';
                            cellStyle = leaveStatus === 'pending' ? 'background-color: #fff9e6;' : 'background-color: #ffebee;';
                            leaveDays++;
                            totalDays++;
                            cellTitle = leaveStatus === 'pending' ? 'Pending Leave' : 'On Leave';
                        } else if (isOffDuty && !isOffDutyWorking) {
                            attendanceMark = '<span style="color: #95a5a6; font-weight: bold;" title="Off Duty">O</span>';
                            cellStyle = 'background-color: #f1f2f6;';
                            offDays++;
                            totalDays++;
                            cellTitle = 'Off Duty';
                        } else if (isOffDutyWorking || isOnDuty || hasLateEntry) {
                            attendanceMark = '<span style="color: #27ae60; font-weight: bold;" title="Present">âœ“</span>';
                            cellStyle = 'background-color: #e8f6ef;';
                            presentDays++;
                            totalDays++;
                            cellTitle = isOffDutyWorking ? 'Off-duty Working' :
                                isOnDuty ? 'On Duty (OD)' :
                                    hasLateEntry ? 'Present (Late Entry)' : 'Present';
                        } else if (shift && !shift.includes('Off')) {
                            attendanceMark = '<span style="color: #27ae60; font-weight: bold;" title="Present">âœ“</span>';
                            cellStyle = 'background-color: #e8f6ef;';
                            presentDays++;
                            totalDays++;
                            cellTitle = `Present: ${shift}`;
                        } else {
                            attendanceMark = '<span style="color: #95a5a6;">-</span>';
                            cellTitle = 'No Shift';
                        }

                        html += `<td style="text-align: center; ${cellStyle}" title="${cellTitle}">${attendanceMark}</td>`;

                        tempDate.setDate(tempDate.getDate() + 1);
                    }

                    const attendancePercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
                    let percentageColor = '#27ae60';
                    if (attendancePercentage < 80) percentageColor = '#f39c12';
                    if (attendancePercentage < 60) percentageColor = '#e74c3c';

                    html += `<td style="text-align: center; font-weight: bold;">${totalDays}</td>
                 <td style="text-align: center; color: #27ae60; font-weight: bold;">${presentDays}</td>
                 <td style="text-align: center; color: #e74c3c; font-weight: bold;">${leaveDays}</td>
                 <td style="text-align: center; color: #95a5a6; font-weight: bold;">${offDays}</td>
                 <td style="text-align: center; color: ${percentageColor}; font-weight: bold;">${attendancePercentage}%</td>
               </tr>`;
                });

                html += `<tr style="background-color: #f8f9fa; font-weight: bold;">
                <td>TOTAL</td>`;

                tempDate.setTime(reportStartDate.getTime());
                let dateCount = 0;
                while (tempDate <= reportEndDate) {
                    dateCount++;
                    html += `<td style="text-align: center;">${dateCount}</td>`;
                    tempDate.setDate(tempDate.getDate() + 1);
                }

                const totalStaff = staffList.length;
                const totalDaysInPeriod = Math.floor((reportEndDate - reportStartDate) / (1000 * 60 * 60 * 24)) + 1;

                html += `<td style="text-align: center;">${totalDaysInPeriod * totalStaff}</td>
             <td style="text-align: center;">-</td>
             <td style="text-align: center;">-</td>
             <td style="text-align: center;">-</td>
             <td style="text-align: center;">-</td>
           </tr>`;

                html += `</tbody></table></div>`;

                html += `
        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
            <h4>Legend:</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #27ae60; font-weight: bold;">âœ“</span> Present
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #e74c3c; font-weight: bold;">L</span> Leave
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #95a5a6; font-weight: bold;">O</span> Off Duty
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #f39c12; font-weight: bold; border: 1px dashed #f39c12; padding: 0 2px;">L?</span> Pending Leave
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #e74c3c; font-weight: bold;">H</span> Holiday
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #26a69a; font-weight: bold;">S</span> Skeleton Shift
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                <strong>Note:</strong> Holiday and Skeleton Shift days are not counted in Present/Leave/Off totals.
            </div>
        </div>
    `;

                container.innerHTML = html;
            }

            function previousAttendancePeriod() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to view reports.");
                    return;
                }
                generateAttendanceReportForPeriod(currentAttendancePeriod - 1);
            }

            function nextAttendancePeriod() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to view reports.");
                    return;
                }
                generateAttendanceReportForPeriod(currentAttendancePeriod + 1);
            }

            function goToCurrentAttendancePeriod() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to view reports.");
                    return;
                }
                generateAttendanceReportForPeriod(0);
            }

            // ==================== OTHER REPORT FUNCTIONS ====================
            function generateLeaveReport() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to generate reports.");
                    return;
                }

                document.getElementById('attendance-nav').style.display = 'none';

                const container = document.getElementById('report-container');
                const startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 3);

                const filteredLeaves = leaveRequests.filter(req => {
                    const reqDate = new Date(req.date);
                    return reqDate >= startDate && req.status === 'approved';
                });

                if (filteredLeaves.length === 0) {
                    container.innerHTML = '<h3>Leave Report</h3><p>No approved leaves in the last 3 months.</p>';
                    return;
                }

                let html = '<h3>Leave Report (Last 3 Months)</h3>';
                html += '<table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Reason</th></tr></thead><tbody>';

                filteredLeaves.forEach(leave => {
                    const abbrev = staffAbbreviations[leave.staff];
                    html += `
            <tr>
                <td>${leave.date}</td>
                <td>${abbrev} (${leave.staff})</td>
                <td>${leave.type}</td>
                <td>${leave.reason || ''}</td>
            </tr>
        `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            }

            function generateCOFFReport() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to generate reports.");
                    return;
                }

                document.getElementById('attendance-nav').style.display = 'none';

                const container = document.getElementById('report-container');
                let html = '<h3>COFF Report</h3>';
                html += '<table><thead><tr><th>Staff</th><th>Balance</th><th>Status</th><th>Details</th></tr></thead><tbody>';

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                staffList.forEach(staff => {
                    const balance = coffData.balances[staff] || 0;
                    const abbrev = staffAbbreviations[staff];
                    const status = balance >= 1 ? 'Eligible' : 'Not Eligible';
                    const statusClass = balance >= 1 ? 'style="color: #27ae60;"' : 'style="color: #e74c3c;"';

                    const extraHoursEntries = Object.values(extraHoursData).filter(entry => entry.staff === staff);
                    const totalHours = extraHoursEntries.reduce((sum, entry) => sum + entry.hours, 0);

                    html += `
            <tr>
                <td>${abbrev} (${staff})</td>
                <td>${balance.toFixed(1)} days (${(balance * 8).toFixed(1)} hours)</td>
                <td ${statusClass}>${status}</td>
                <td>${extraHoursEntries.length} extra duty entries (${totalHours} total hours)</td>
            </tr>
        `;
                });

                html += '</tbody></table>';

                if (coffData.history.length > 0) {
                    html += '<h4>Detailed COFF History</h4><table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Hours</th><th>COFF Days</th><th>Balance After</th><th>Reason</th></tr></thead><tbody>';

                    const recentHistory = [...coffData.history].reverse().slice(0, 20);
                    recentHistory.forEach(entry => {
                        const abbrev = staffAbbreviations[entry.staff];
                        const hoursDisplay = entry.hours > 0 ? `+${entry.hours}` : entry.hours;
                        const coffDisplay = entry.coffEarned ? `+${entry.coffEarned.toFixed(2)}` :
                            entry.coffUsed ? `-${entry.coffUsed.toFixed(2)}` : 'N/A';

                        html += `
                <tr>
                    <td>${entry.date}</td>
                    <td>${abbrev} (${entry.staff})</td>
                    <td>${entry.type}</td>
                    <td>${hoursDisplay}</td>
                    <td>${coffDisplay}</td>
                    <td>${entry.balanceAfter ? entry.balanceAfter.toFixed(2) + ' days' : 'N/A'}</td>
                    <td>${entry.reason || ''}</td>
                </tr>
            `;
                    });

                    html += '</tbody></table>';
                }

                container.innerHTML = html;
            }

            function generateOTReport() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to generate reports.");
                    return;
                }

                document.getElementById('attendance-nav').style.display = 'none';

                const container = document.getElementById('report-container');
                let html = '<h3>Overtime Report</h3>';

                const currentDate = new Date();
                const currentMonthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
                const currentMonthData = otData.monthly[currentMonthKey] || {};

                html += `<h4>Current Month (${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})</h4>`;
                html += '<table><thead><tr><th>Staff</th><th>OT Hours</th></tr></thead><tbody>';

                const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
                let totalHours = 0;

                staffList.forEach(staff => {
                    const hours = currentMonthData[staff] || 0;
                    const abbrev = staffAbbreviations[staff];
                    totalHours += hours;

                    html += `
            <tr>
                <td>${abbrev} (${staff})</td>
                <td>${hours} hours</td>
            </tr>
        `;
                });

                html += `<tr style="font-weight: bold; background: #f8f9fa;">
                <td>Total</td>
                <td>${totalHours} hours</td>
            </tr>`;
                html += '</tbody></table>';
                container.innerHTML = html;
            }

            async function exportAllData() {
                if (userRole !== 'admin') {
                    alert("You don't have permission to export data.");
                    return;
                }

                document.getElementById('attendance-nav').style.display = 'none';

                const allData = {
                    shiftData: shiftData,
                    leaveRequests: leaveRequests,
                    offDutyEntries: offDutyEntries,
                    onDutyEntries: onDutyEntries,
                    extraHoursData: extraHoursData,
                    coffData: coffData,
                    holidays: holidays,
                    skeletonShifts: skeletonShifts,
                    otData: otData,
                    lateEntries: lateEntries,
                    exportDate: new Date().toISOString()
                };

                const dataStr = JSON.stringify(allData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                const exportFileDefaultName = `shift-leave-data-${new Date().toISOString().split('T')[0]}.json`;

                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();

                alert('All data exported successfully!');
            }
    </script>
</body>
</html>
