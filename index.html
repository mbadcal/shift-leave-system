<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shift & Leave Management System</title>
    <!-- Add these BEFORE your existing styles -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f5f5f5;
            padding: 10px;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
            font-size: 1.4em;
        }
        
        h2 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 1.2em;
        }
        
        h3 {
            font-size: 1.1em;
            margin-bottom: 12px;
        }
        
        h4 {
            font-size: 1em;
            margin-bottom: 10px;
        }
        
        .stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            min-width: 120px;
            flex: 1;
            text-align: center;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }
        
        .stat-card.pending {
            border-left-color: #f39c12;
            background: #fff9e6;
        }
        
        .stat-card.approved {
            border-left-color: #27ae60;
            background: #eafaf1;
        }
        
        .today-highlight {
            background: #e8f4fc;
            border-left-color: #2980b9 !important;
        }
        
        .view-toggle {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 15px;
            gap: 8px;
        }
        
        .view-toggle button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: #ecf0f1;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            flex: 1;
            min-width: 100px;
        }
        
        .view-toggle button.active {
            background: #3498db;
            color: white;
        }
        
        .calendar-view, .month-view, .day-view {
            display: none;
        }
        
        .calendar-view.active, .month-view.active, .day-view.active {
            display: block;
        }
        
        .week-navigation, .month-navigation, .day-navigation {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            gap: 10px;
        }
        
        .nav-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .nav-buttons button {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            flex: 1;
            min-width: 80px;
        }
        
        .nav-buttons button:hover {
            background: #2980b9;
        }
        
        .nav-title {
            font-size: 1em;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            flex: 1;
            min-width: 100%;
            order: -1;
        }
        
        .calendar {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .day-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border: 2px solid #ecf0f1;
            transition: all 0.3s;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .day-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .day-card.today {
            border-color: #3498db;
            background-color: #e8f4fc;
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .day-name {
            font-weight: bold;
            font-size: 1em;
            color: #2c3e50;
        }
        
        .date {
            color: #7f8c8d;
            font-size: 0.85em;
        }
        
        .shift-list {
            margin-top: 8px;
        }
        
        .shift-item {
            padding: 6px 8px;
            margin-bottom: 6px;
            border-radius: 5px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        
        .operator-name {
            font-weight: 500;
            font-size: 0.9em;
        }
        
        .shift-time {
            color: #666;
            font-size: 0.8em;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
        }
        
        .obituary-duty {
            background-color: #e3f2fd !important;
            border-left: 3px solid #2196f3;
            color: #1976d2;
        }
        
        .leave {
            background-color: #ffeaa7 !important;
            border-left: 3px solid #fdcb6e;
        }
        
        .leave-pending {
            background-color: #fff9e6 !important;
            border-left: 3px solid #f39c12;
            border-style: dashed;
        }
        
        .leave-approved {
            background-color: #d5f4e6 !important;
            border-left: 3px solid #2ecc71;
        }
        
        .leave-rejected {
            background-color: #ffebee !important;
            border-left: 3px solid #e74c3c;
        }
        
        .off-duty {
            background-color: #dfe6e9 !important;
            color: #636e72;
        }
        
        .off-duty-working {
            background-color: #e8f4fc !important;
            border-left: 3px solid #3498db;
        }
        
        .extra-hours {
            background-color: #fff3e0 !important;
            border-left: 3px solid #ff9800;
        }
        
        .holiday {
            background-color: #ffebee !important;
            border-left: 3px solid #e74c3c;
            color: #c0392b;
        }
        
        .skeleton-shift {
            background-color: #e8f6f3 !important;
            border-left: 3px solid #26a69a;
            color: #00897b;
        }
        
        .warning {
            background-color: #ffeaa7 !important;
            border: 1px solid #fdcb6e;
            padding: 8px;
            border-radius: 5px;
            margin-top: 8px;
            font-size: 0.85em;
        }
        
        .critical {
            background-color: #ff7675 !important;
            color: white;
            border: 1px solid #d63031;
        }
        
        .operator-count-display {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            padding: 6px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.85em;
        }
        
        .operator-count-item {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            min-width: 80px;
        }
        
        .operator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .operator-dot.available {
            background-color: #2ecc71;
        }
        
        .operator-dot.leave {
            background-color: #fdcb6e;
        }
        
        .operator-dot.off-duty {
            background-color: #95a5a6;
        }
        
        .operator-dot.off-duty-working {
            background-color: #3498db;
        }
        
        .operator-dot.late-entry {
            background-color: #ff6b6b;
        }
        
        .operator-dot.on-duty {
            background-color: #6c5ce7;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            font-size: 0.9em;
        }
        
        select, input, button, textarea {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            -webkit-appearance: none;
            appearance: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 8px;
            padding: 10px 15px;
            font-size: 0.95em;
            min-height: 44px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-warning {
            background-color: #f39c12;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }
        
        .button-group button {
            flex: 1;
            min-width: 120px;
        }
        
        .badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-left: 4px;
            white-space: nowrap;
        }
        
        .leave-badge {
            background: #fdcb6e;
            color: #333;
        }
        
        .leave-pending-badge {
            background: #f39c12;
            color: white;
        }
        
        .leave-approved-badge {
            background: #2ecc71;
            color: white;
        }
        
        .leave-rejected-badge {
            background: #e74c3c;
            color: white;
        }
        
        .obituary-badge {
            background: #2196f3;
            color: white;
        }
        
        .off-duty-badge {
            background: #95a5a6;
            color: white;
        }
        
        .off-duty-working-badge {
            background: #3498db;
            color: white;
        }
        
        .extra-hours-badge {
            background: #ff9800;
            color: white;
        }
        
        .holiday-badge {
            background: #e74c3c;
            color: white;
        }
        
        .skeleton-badge {
            background: #26a69a;
            color: white;
        }
        
        .staff-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .staff-item {
            background: #ecf0f1;
            padding: 8px 12px;
            border-radius: 5px;
            flex: 1;
            min-width: 100px;
            text-align: center;
            font-size: 0.9em;
        }
        
        .ctp-operator {
            background: #d5f4e6;
            border-left: 3px solid #2ecc71;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .controls button {
            margin-top: 0;
            width: auto;
            min-width: 140px;
            flex: 1;
            padding: 8px 12px;
            font-size: 0.85em;
        }
        
        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }
        
        .day-header-cell {
            text-align: center;
            padding: 8px 5px;
            background: #ecf0f1;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.85em;
        }
        
        .day-cell {
            min-height: 100px;
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            overflow: hidden;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        
        .day-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: #3498db;
        }
        
        .day-cell.empty {
            background: #fafafa;
            cursor: default;
        }
        
        .day-cell.empty:hover {
            transform: none;
            box-shadow: none;
            border-color: #eee;
        }
        
        .day-cell.today {
            border-color: #3498db;
            background-color: #e8f4fc;
            border-width: 2px;
        }
        
        .day-cell .date-num {
            font-weight: bold;
            margin-bottom: 4px;
            color: #2c3e50;
            font-size: 1em;
        }
        
        .day-cell .day-name {
            font-size: 0.75em;
            color: #7f8c8d;
            margin-bottom: 6px;
        }
        
        .day-cell .operator-status {
            margin-top: 4px;
            font-size: 0.7em;
        }
        
        .day-cell .operator-status-item {
            margin-bottom: 2px;
            padding: 2px 4px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            gap: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .day-cell .operator-status-item.available {
            background: #e8f6ef;
            color: #27ae60;
        }
        
        .day-cell .operator-status-item.leave {
            background: #fff9e6;
            color: #e17055;
        }
        
        .day-cell .operator-status-item.off-duty {
            background: #f1f2f6;
            color: #636e72;
        }
        
        .day-cell .operator-status-item.off-duty-working {
            background: #e8f4fc;
            color: #2980b9;
        }
        
        .day-cell .operator-status-item.obituary {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .day-cell .operator-status-item.holiday {
            background: #ffebee;
            color: #c0392b;
        }
        
        .day-cell .operator-status-item.skeleton {
            background: #e8f6f3;
            color: #00897b;
        }
        
        .day-cell .operator-status-item.late-entry {
            background: #ffeaea;
            color: #d63031;
        }
        
        .day-cell .operator-status-item.on-duty {
            background: #e6e6fa;
            color: #483d8b;
        }
        
        .day-details-modal .detail-item {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }
        
        .day-details-modal .detail-item.leave {
            border-left-color: #fdcb6e;
        }
        
        .day-details-modal .detail-item.off-duty {
            border-left-color: #95a5a6;
        }
        
        .day-details-modal .detail-item.off-duty-working {
            border-left-color: #3498db;
        }
        
        .day-details-modal .detail-item.obituary {
            border-left-color: #2196f3;
        }
        
        .day-details-modal .detail-item.extra-hours {
            border-left-color: #ff9800;
        }
        
        .day-details-modal .detail-item.holiday {
            border-left-color: #e74c3c;
        }
        
        .day-details-modal .detail-item.skeleton {
            border-left-color: #26a69a;
        }
        
        .day-details-modal .detail-item.late-entry {
            border-left-color: #ff6b6b;
        }
        
        .day-details-modal .detail-item.on-duty {
            border-left-color: #6c5ce7;
        }
        
        .day-details-modal .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .day-details-modal .staff-name {
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .day-details-modal .shift-time {
            color: #666;
            font-size: 0.85em;
        }
        
        .tabs {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 2px solid #ecf0f1;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            flex: 1;
            text-align: center;
            font-size: 0.9em;
        }
        
        .tab.active {
            border-bottom-color: #3498db;
            color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .approval-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .approval-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }
        
        .approval-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .approval-item.approved {
            border-left-color: #2ecc71;
        }
        
        .approval-item.rejected {
            border-left-color: #e74c3c;
        }
        
        .approval-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .approval-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .approval-actions button {
            margin-top: 0;
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .coff-summary {
            background: #e8f4fc;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            border-left: 4px solid #3498db;
            font-size: 0.9em;
        }
        
        .coff-details {
            margin-top: 8px;
            font-size: 0.85em;
            color: #555;
        }
        
        .coff-details ul {
            margin-left: 15px;
            margin-top: 4px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 4px;
        }
        
        .status-available {
            background-color: #2ecc71;
        }
        
        .status-leave {
            background-color: #fdcb6e;
        }
        
        .status-leave-pending {
            background-color: #f39c12;
        }
        
        .status-leave-approved {
            background-color: #2ecc71;
        }
        
        .status-leave-rejected {
            background-color: #e74c3c;
        }
        
        .status-off {
            background-color: #95a5a6;
        }
        
        .status-off-duty-working {
            background-color: #3498db;
        }
        
        .status-obituary {
            background-color: #2196f3;
        }
        
        .status-extra-hours {
            background-color: #ff9800;
        }
        
        .status-holiday {
            background-color: #e74c3c;
        }
        
        .status-skeleton {
            background-color: #26a69a;
        }
        
        .status-late-entry {
            background-color: #ff6b6b;
        }
        
        .status-on-duty {
            background-color: #6c5ce7;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8em;
        }
        
        .day-details-container {
            margin: 15px 0;
        }
        
        .day-details-container h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1em;
        }
        
        .day-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .day-stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .day-stat-item .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .day-stat-item .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 0.85em;
            margin-top: 4px;
            display: none;
        }
        
        .date-range-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .date-range-group .form-group {
            flex: 1;
            margin-bottom: 0;
            min-width: 120px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 0.85em;
        }
        
        table th {
            background: #ecf0f1;
            padding: 8px;
            text-align: left;
            border: 1px solid #ddd;
            font-size: 0.9em;
        }
        
        table td {
            padding: 6px 8px;
            border: 1px solid #ddd;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        .holiday-marker {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #e74c3c;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6em;
            font-weight: bold;
        }
        
        .skeleton-marker {
            position: absolute;
            top: 4px;
            right: 4px;
            background: #26a69a;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 0.6em;
            font-weight: bold;
        }
        
        .day-cell.holiday-cell {
            background: #ffebee;
            border-color: #e74c3c;
        }
        
        .day-cell.skeleton-cell {
            background: #e8f6f3;
            border-color: #26a69a;
        }
        
        .day-view-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .staff-exclusion-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .staff-exclusion-item {
            background: #ecf0f1;
            padding: 6px 8px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em;
        }
        
        .staff-exclusion-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .edit-shift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 350px;
            overflow-y: auto;
            padding: 8px;
        }
        
        .edit-shift-day {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .edit-shift-day h4 {
            margin-bottom: 8px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 4px;
            font-size: 0.9em;
        }
        
        .edit-staff-shift {
            margin-bottom: 8px;
        }
        
        .edit-staff-shift label {
            font-size: 0.8em;
            color: #555;
            margin-bottom: 2px;
        }
        
        .late-entry-badge {
            background: #ff6b6b;
            color: white;
        }
        
        .late-entry {
            background-color: #ffeaea !important;
            border-left: 3px solid #ff6b6b;
            color: #d63031;
        }
        
        .on-duty-badge {
            background: #6c5ce7;
            color: white;
        }
        
        .on-duty {
            background-color: #e6e6fa !important;
            border-left: 3px solid #6c5ce7;
            color: #483d8b;
        }
        
        /* Attendance report navigation */
        #attendance-nav {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        #attendance-nav .nav-buttons {
            margin-bottom: 8px;
        }
        
        #attendance-period-title {
            color: #2c3e50;
            font-size: 1em;
            padding: 5px 0;
            text-align: center;
            font-weight: bold;
        }
        
        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            body {
                padding: 8px;
            }
            
            .container {
                padding: 12px;
            }
            
            h1 {
                font-size: 1.2em;
                margin-bottom: 12px;
            }
            
            .calendar {
                grid-template-columns: 1fr;
            }
            
            .month-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .day-cell {
                min-height: 80px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .controls button {
                width: 100%;
                min-width: auto;
                padding: 10px;
            }
            
            .nav-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .date-range-group {
                flex-direction: column;
            }
            
            .date-range-group .form-group {
                width: 100%;
            }
            
            .edit-shift-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
                text-align: left;
            }
            
            .stats-bar {
                gap: 8px;
            }
            
            .stat-card {
                min-width: 100px;
                padding: 8px;
                font-size: 0.85em;
            }
            
            .modal-content {
                padding: 15px;
                max-height: 85vh;
            }
            
            .button-group button {
                min-width: 100px;
            }
            
            table {
                font-size: 0.8em;
            }
            
            table th, table td {
                padding: 4px 6px;
            }
            
            .shift-time {
                max-width: 80px;
                font-size: 0.75em;
            }
            
            .legend-item {
                flex: 1 0 calc(50% - 10px);
                min-width: 120px;
            }
            
            .operator-name {
                font-size: 0.85em;
            }
            
            .badge {
                font-size: 0.7em;
                padding: 1px 4px;
            }
            
            .day-cell .operator-status-item {
                font-size: 0.65em;
            }
            
            #attendance-nav .nav-buttons {
                flex-direction: column;
            }
            
            #attendance-nav .nav-buttons button {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .month-grid {
                grid-template-columns: 1fr;
            }
            
            .day-cell {
                min-height: 70px;
            }
            
            .view-toggle button {
                min-width: 80px;
                font-size: 0.85em;
                padding: 6px 10px;
            }
            
            .staff-item {
                min-width: 80px;
                font-size: 0.85em;
                padding: 6px 8px;
            }
            
            .legend {
                gap: 8px;
                padding: 10px;
            }
            
            .legend-item {
                flex: 1 0 100%;
                font-size: 0.75em;
            }
            
            .stat-card {
                flex: 1 0 calc(50% - 8px);
                min-width: auto;
            }
        }
        
        /* Touch-friendly improvements */
        button, .tab, .day-cell, .shift-item {
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        select, input, textarea {
            font-size: 16px; /* Prevents iOS zoom on focus */
        }
        
        /* Ensure proper scrolling on mobile */
        .modal-content, .edit-shift-grid {
            -webkit-overflow-scrolling: touch;
        }
/* Update the tabs styling */
.tabs {
    display: flex;
    flex-wrap: wrap;
    border-bottom: 2px solid #ecf0f1;
    margin-bottom: 15px;
    background-color: #f8f9fa;
    border-radius: 8px 8px 0 0;
    padding: 5px 5px 0 5px;
}

.tab {
    padding: 10px 15px;
    cursor: pointer;
    font-weight: 600;
    border-bottom: 3px solid transparent;
    flex: 1;
    text-align: center;
    font-size: 0.9em;
    color: #555;
    background-color: #e9ecef;
    margin: 0 3px;
    border-radius: 5px 5px 0 0;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
    border-bottom: none;
}

.tab.active {
    border-bottom-color: #3498db;
    color: #3498db;
    background-color: white;
    border-color: #dee2e6 #dee2e6 white #dee2e6;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
}

.tab:hover:not(.active) {
    background-color: #f1f3f4;
    color: #2c3e50;
}

/* Improve day view contrast */
.day-view-container {
    background: white;
    border-radius: 8px;
    padding: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
}

.day-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #eee;
    background-color: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
}

.day-name {
    font-weight: bold;
    font-size: 1.1em;
    color: #2c3e50;
}

.day-header .date {
    color: #555;
    font-size: 0.9em;
    font-weight: 500;
}

/* Improve month view contrast */
.month-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 15px;
    background-color: white;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.day-header-cell {
    text-align: center;
    padding: 10px 5px;
    background: #f8f9fa;
    border-radius: 5px;
    font-weight: bold;
    font-size: 0.9em;
    color: #2c3e50;
    border: 1px solid #dee2e6;
}

.day-cell {
    min-height: 100px;
    background: #fefefe;
    border: 1px solid #e8e8e8;
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    transition: all 0.2s;
    overflow: hidden;
    position: relative;
    -webkit-tap-highlight-color: transparent;
}

.day-cell:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #3498db;
    background-color: #f8f9fa;
}

.day-cell.today {
    border-color: #3498db;
    background-color: #e8f4fc;
    border-width: 2px;
}

.day-cell .date-num {
    font-weight: bold;
    margin-bottom: 4px;
    color: #2c3e50;
    font-size: 1em;
}

.day-cell .day-name {
    font-size: 0.8em;
    color: #666;
    margin-bottom: 6px;
}

.day-cell .operator-status-item {
    margin-bottom: 2px;
    padding: 3px 5px;
    border-radius: 3px;
    display: flex;
    align-items: center;
    gap: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.75em;
    font-weight: 500;
}

/* Improve week view contrast */
.calendar {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

.day-card {
    background: white;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid #e0e0e0;
    transition: all 0.3s;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
}

.day-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-color: #3498db;
}

.day-card.today {
    border-color: #3498db;
    background-color: #e8f4fc;
    border-width: 2px;
}

/* Improve operator names visibility */
.operator-name {
    font-weight: 600;
    font-size: 0.9em;
    color: #2c3e50;
}

.shift-time {
    color: #444;
    font-size: 0.8em;
    background: #f0f0f0;
    padding: 3px 8px;
    border-radius: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px;
    font-weight: 500;
}

/* Improve badges visibility */
.badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 0.75em;
    margin-left: 4px;
    white-space: nowrap;
    font-weight: 600;
    color: white !important;
}

/* Improve stats bar visibility */
.stats-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 15px;
    justify-content: center;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    min-width: 120px;
    flex: 1;
    text-align: center;
    border-left: 4px solid #3498db;
    font-size: 0.9em;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid #e8e8e8;
}

.stat-card > div:first-child {
    color: #666;
    font-size: 0.85em;
    margin-bottom: 8px;
    font-weight: 500;
}

.stat-card > div:last-child {
    font-size: 1.2em;
    font-weight: bold;
    color: #2c3e50;
}

/* Improve controls visibility */
.controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    justify-content: center;
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e8e8e8;
}

.controls button {
    margin-top: 0;
    width: auto;
    min-width: 140px;
    flex: 1;
    padding: 10px 15px;
    font-size: 0.9em;
    font-weight: 600;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
}

.controls button:hover {
    background-color: #2980b9;
    transform: translateY(-1px);
    box-shadow: 0 3px 5px rgba(0,0,0,0.1);
}

/* Improve view toggle buttons */
.view-toggle {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    margin-bottom: 15px;
    gap: 10px;
}

.view-toggle button {
    padding: 10px 15px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: #f8f9fa;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    flex: 1;
    min-width: 100px;
    color: #555;
    transition: all 0.3s;
}

.view-toggle button.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.view-toggle button:hover:not(.active) {
    background: #e9ecef;
    border-color: #3498db;
}

/* Improve tab content background */
.tab-content {
    display: none;
    background-color: white;
    padding: 15px;
    border-radius: 0 0 8px 8px;
    border: 1px solid #dee2e6;
    border-top: none;
}

.tab-content.active {
    display: block;
}

/* Improve shift items contrast */
.shift-item {
    padding: 8px 10px;
    margin-bottom: 8px;
    border-radius: 6px;
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9em;
    border: 1px solid #e8e8e8;
}

/* Improve operator count display */
.operator-count-display {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 0.9em;
    border: 1px solid #e8e8e8;
}

.operator-count-item {
    display: flex;
    align-items: center;
    gap: 6px;
    flex: 1;
    min-width: 100px;
    color: #555;
    font-weight: 500;
}

/* Improve navigation bars */
.week-navigation, .month-navigation, .day-navigation {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 8px;
    gap: 10px;
    border: 1px solid #e8e8e8;
}

.nav-title {
    font-size: 1.1em;
    font-weight: bold;
    color: #2c3e50;
    text-align: center;
    flex: 1;
    min-width: 100%;
    order: -1;
}

.nav-buttons button {
    padding: 8px 15px;
    border: 1px solid #3498db;
    border-radius: 5px;
    background: white;
    color: #3498db;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9em;
    flex: 1;
    min-width: 100px;
    transition: all 0.3s;
}

.nav-buttons button:hover {
    background: #3498db;
    color: white;
}

/* Improve container contrast */
.container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    padding: 20px;
    margin-bottom: 15px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
}

/* Mobile responsiveness improvements */
@media (max-width: 768px) {
    .tab {
        padding: 8px 10px;
        font-size: 0.85em;
        margin: 0 2px;
    }
    
    .container {
        padding: 12px;
    }
    
    .controls button {
        min-width: 120px;
        padding: 8px 12px;
        font-size: 0.85em;
    }
    
    .view-toggle button {
        min-width: 80px;
        padding: 8px 10px;
        font-size: 0.85em;
    }
    
    .stat-card {
        padding: 10px;
        min-width: 90px;
    }
}

@media (max-width: 480px) {
    .tab {
        flex: 1 0 100%;
        margin-bottom: 5px;
        border-radius: 5px;
    }
    
    .tabs {
        padding: 5px;
    }
    
    .tab.active {
        border-radius: 5px;
        border: 1px solid #3498db;
    }
    
    .view-toggle button {
        flex: 1 0 100%;
        margin-bottom: 5px;
    }
}
/* Custom Radio Buttons */
.radio-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid #e0e0e0;
    transition: all 0.3s ease;
    flex: 1;
    min-width: 150px;
}

.radio-option:hover {
    background: #e9ecef;
    border-color: #3498db;
}

.radio-option input[type="radio"] {
    display: none;
}

.radio-custom {
    width: 18px;
    height: 18px;
    border: 2px solid #95a5a6;
    border-radius: 50%;
    display: inline-block;
    position: relative;
    transition: all 0.3s ease;
}

.radio-custom:after {
    content: '';
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #3498db;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    transition: all 0.3s ease;
}

.radio-option input[type="radio"]:checked + .radio-custom {
    border-color: #3498db;
    background-color: #e8f4fc;
}

.radio-option input[type="radio"]:checked + .radio-custom:after {
    transform: translate(-50%, -50%) scale(1);
}

.radio-label {
    font-weight: 500;
    color: #2c3e50;
}

.radio-option input[type="radio"]:checked ~ .radio-label {
    color: #3498db;
    font-weight: 600;
}

/* Custom Checkboxes */
.checkbox-item {
    flex: 1 0 45%;
    margin-bottom: 8px;
}

.checkbox-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f8f9fa;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid #e0e0e0;
    transition: all 0.3s ease;
}

.checkbox-option:hover {
    background: #e9ecef;
    border-color: #3498db;
}

.checkbox-option input[type="checkbox"] {
    display: none;
}

.checkbox-custom {
    width: 18px;
    height: 18px;
    border: 2px solid #95a5a6;
    border-radius: 4px;
    display: inline-block;
    position: relative;
    transition: all 0.3s ease;
    background-color: white;
}

.checkbox-custom:after {
    content: '✓';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    color: white;
    font-size: 12px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.checkbox-option input[type="checkbox"]:checked + .checkbox-custom {
    background-color: #3498db;
    border-color: #3498db;
}

.checkbox-option input[type="checkbox"]:checked + .checkbox-custom:after {
    transform: translate(-50%, -50%) scale(1);
}

.checkbox-label {
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.85em;
}

.checkbox-option input[type="checkbox"]:checked ~ .checkbox-label {
    color: #3498db;
    font-weight: 600;
}

/* Container for radio/checkbox groups */
#onDutyTypeSelector, #regularizeTypeSelector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

/* Staff exclusion list improvements */
.staff-exclusion-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .radio-option, .checkbox-option {
        flex: 1 0 100%;
        min-width: auto;
    }
    
    .checkbox-item {
        flex: 1 0 100%;
    }
    
    .staff-exclusion-list {
        flex-direction: column;
        gap: 8px;
    }

}
.leave-cancel-item {
    transition: all 0.3s ease;
    cursor: pointer;
}

.leave-cancel-checkbox {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border: 2px solid #95a5a6;
    border-radius: 4px;
    background-color: white;
    position: relative;
    cursor: pointer;
    margin: 0;
    flex-shrink: 0;
}

.leave-cancel-checkbox:checked {
    background-color: #e74c3c;
    border-color: #e74c3c;
}

.leave-cancel-checkbox:checked::after {
    content: '✓';
    position: absolute;
    color: white;
    font-size: 14px;
    font-weight: bold;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

.leave-cancel-checkbox:focus {
    outline: 2px solid #3498db;
    outline-offset: 2px;
}

/* ========== LOGIN & AUTH STYLES ========== */
.login-header {
    text-align: center;
    margin-bottom: 30px;
}

.login-header i {
    margin-bottom: 15px;
}

#loginModal .modal-content {
    animation: slideIn 0.3s ease;
    border-radius: 12px;
    padding: 30px;
}

.loading-spinner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.spinner {
    width: 60px;
    height: 60px;
    border: 5px solid #f3f3f3;
    border-top: 5px solid #3498db;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* User Profile Styles */
#userProfile {
    transition: all 0.3s;
}

#userProfile:hover {
    background: #e9ecef;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

#userProfileDropdown {
    animation: fadeIn 0.2s ease;
    border: 1px solid #e0e0e0;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Role-based styling */
.admin-badge {
    background: #e74c3c;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: bold;
}

.viewer-badge {
    background: #3498db;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7em;
    font-weight: bold;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    #userProfileSection {
        width: 100%;
        margin-top: 10px;
    }
    
    #userProfile {
        justify-content: center;
    }
    
    h1 {
        text-align: center;
        width: 100%;
    }
}

    </style>
</head>
<body>
<div class="container">
    <!-- NEW HEADER WITH USER PROFILE -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
        <h1 style="margin: 0; color: #2c3e50; flex: 1;">📅 Shift & Leave Management System</h1>
        
        <div id="userProfileSection" style="display: none;">
            <div id="userProfile" style="display: flex; align-items: center; gap: 10px; background: #f8f9fa; padding: 8px 15px; border-radius: 20px; cursor: pointer; border: 1px solid #e0e0e0; transition: all 0.3s;">
                <i class="fas fa-user-circle" style="font-size: 1.5em; color: #3498db;"></i>
                <div>
                    <div id="userName" style="font-weight: bold; font-size: 0.9em;"></div>
                    <div id="userRole" style="font-size: 0.75em; color: #666;"></div>
                </div>
                <i class="fas fa-chevron-down" style="font-size: 0.8em; color: #666;"></i>
            </div>
        </div>
    </div>
        
        <div class="stats-bar">
            <div class="stat-card today-highlight">
                <div>Today's Date</div>
                <div id="current-date" style="font-size: 1.1em; font-weight: bold;"></div>
            </div>
            <div class="stat-card">
                <div>Total Staff</div>
                <div style="font-size: 1.1em; font-weight: bold;">5</div>
            </div>
            <div class="stat-card pending">
                <div>Pending Approvals</div>
                <div id="pending-count" style="font-size: 1.1em; font-weight: bold;">0</div>
            </div>
            <div class="stat-card approved">
                <div>Comp-off Balance</div>
                <div id="coff-balance" style="font-size: 1.1em; font-weight: bold;">0 days</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="switchTab('approvals')">Approvals</div>
            <div class="tab" onclick="switchTab('coff')">Comp-off</div>
            <div class="tab" onclick="switchTab('reports')">Reports</div>
        </div>
        
        <!-- Dashboard Tab -->
<div id="dashboard-tab" class="tab-content active">
    <div class="view-toggle">
        <button id="viewTodayBtn" onclick="switchView('today')">📅 Today</button>
        <button id="viewWeekBtn" class="active" onclick="switchView('week')">📅 Week View (7 Days)</button>
        <button id="viewMonthBtn" onclick="switchView('month')">📆 Month View</button>
    </div>
    
    <!-- ADMIN CONTROLS (Only shown to admins) -->
    <div class="controls" id="adminControls" style="display: none;">
        <button onclick="openAddLeaveModal()">➕ Apply Leave</button>
        <button onclick="openCancelLeaveModal()">❌ Cancel Leave</button>
        <button onclick="openEditShiftModal()">✏️ Edit Shift</button>
        <button onclick="openEditObituaryModal()">📋 Edit Obituary Duty</button>
        <button onclick="openOffDutyModal()">📝 Off-Duty Working</button>
        <button onclick="openOnDutyModal()">🏢 On Duty (OD)</button>
        <button onclick="openLateEntryModal()">⏰ Late Entry</button>
        <button onclick="openExtraHoursModal()">⏰ Add Extra Hours</button>
        <button onclick="openCancelOffDutyModal()">🗑️ Cancel Off-Duty</button>
        <button onclick="openApplyCOFFModal()">🔄 Apply COFF</button>
        <button onclick="openHolidayModal()">🎉 Add/Remove Holiday</button>
        <button onclick="openSkeletonModal()">💀 Add/Remove Skeleton Shift</button>
    </div>
    
    <!-- VIEWER CONTROLS (Only shown to viewers) -->
    <div class="controls" id="viewerControls" style="display: none;">
        <button onclick="openAddLeaveModal()">➕ Apply Leave</button>
        <button onclick="openApplyCOFFModal()">🔄 Apply COFF</button>
        <button onclick="generateAttendancePeriodReport()">📋 Generate Report</button>
    </div>
    
    <div class="staff-list" id="staff-list">
        <!-- Staff list will be populated by JavaScript -->
    </div>
            
            <!-- Today View -->
            <div id="todayView" class="day-view">
                <div class="day-navigation">
                    <div class="nav-title" id="dayTitle"></div>
                    <div class="nav-buttons">
                        <button onclick="previousDay()">◀ Previous Day</button>
                        <button onclick="goToToday()">Today</button>
                        <button onclick="nextDay()">Next Day ▶</button>
                    </div>
                </div>
                <div class="day-view-container" id="todayViewContainer">
                    <!-- Today view will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Week View (7 Days) -->
            <div id="calendarView" class="calendar-view active">
                <div class="week-navigation">
                    <div class="nav-title" id="weekTitle"></div>
                    <div class="nav-buttons">
                        <button onclick="previousWeek()">◀ Previous Week</button>
                        <button onclick="goToTodayWeek()">Today</button>
                        <button onclick="nextWeek()">Next Week ▶</button>
                    </div>
                </div>
                
                <div class="calendar" id="calendar">
                    <!-- Calendar will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Month View -->
            <div id="monthView" class="month-view">
                <div class="month-navigation">
                    <div class="nav-title" id="monthTitle"></div>
                    <div class="nav-buttons">
                        <button onclick="previousMonth()">◀ Previous Month</button>
                        <button onclick="goToTodayMonth()">Today</button>
                        <button onclick="nextMonth()">Next Month ▶</button>
                    </div>
                </div>
                
                <div class="month-grid" id="monthGrid">
                    <!-- Month grid will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Approvals Tab -->
        <div id="approvals-tab" class="tab-content">
            <h2>📋 Pending Approvals</h2>
            <div id="pending-approvals-container">
                <!-- Pending approvals will be populated by JavaScript -->
            </div>
            
            <h2>✅ Approved Leaves</h2>
            <div id="approved-leaves-container">
                <!-- Approved leaves will be populated by JavaScript -->
            </div>
            
            <h2>❌ Rejected Leaves</h2>
            <div id="rejected-leaves-container">
                <!-- Rejected leaves will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Comp-off Tab -->
        <div id="coff-tab" class="tab-content">
            <h2>🔄 Comp-off Management</h2>
            <div class="controls">
                <button onclick="openApplyCOFFModal()">🔄 Apply for Comp-off</button>
                <button onclick="viewCOFFSummary()">📊 View COFF Summary</button>
            </div>
            <div id="coff-summary-container">
                <!-- COFF summary will be populated by JavaScript -->
            </div>
            <div id="coff-history-container">
                <!-- COFF history will be populated by JavaScript -->
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <h2>📊 Reports</h2>
            <div class="controls">
                <button onclick="generateAttendancePeriodReport()">📋 Attendance (21st-20th)</button>
                <button onclick="generateOnDutyReport()">📊 On Duty/Extra Hours</button>
                <button onclick="generateLeaveReport()">🏖️ Leave Report</button>
                <button onclick="generateCOFFReport()">🔄 COFF Report</button>
                <button onclick="generateOTReport()">💰 OT Report</button>
                <button onclick="exportAllData()">💾 Export All Data</button>
            </div>
            
            <!-- Navigation for attendance report -->
            <div id="attendance-nav">
                <div class="nav-buttons" style="justify-content: center;">
                    <button onclick="previousAttendancePeriod()">◀ Previous Period</button>
                    <button onclick="goToCurrentAttendancePeriod()">Current Period</button>
                    <button onclick="nextAttendancePeriod()">Next Period ▶</button>
                </div>
                <div id="attendance-period-title"></div>
            </div>
            
            <div id="report-container">
                <!-- Reports will be displayed here -->
            </div>
        </div>
    </div>
    
    <!-- All modals remain the same as original -->
    <!-- Modal for Day Details -->
    <div id="dayDetailsModal" class="modal day-details-modal">
        <div class="modal-content">
            <h3 id="dayDetailsTitle"></h3>
            <div class="day-stats" id="dayStats">
                <!-- Day statistics will be populated by JavaScript -->
            </div>
            <div class="day-details-container">
                <h4>Shift Details</h4>
                <div id="dayShiftDetails">
                    <!-- Shift details will be populated by JavaScript -->
                </div>
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('dayDetailsModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for adding leave with date range -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <h3>Apply for Leave</h3>
            <div class="form-group">
                <label for="leaveStaff">Staff Member:</label>
                <select id="leaveStaff" onchange="checkLeaveEligibility()">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Leave Period:</label>
                <div class="date-range-group">
                    <div class="form-group">
                        <label for="leaveFromDate">From Date:</label>
                        <input type="date" id="leaveFromDate" onchange="updateLeaveToDate(); checkLeaveEligibility()">
                    </div>
                    <div style="align-self: center;">to</div>
                    <div class="form-group">
                        <label for="leaveToDate">To Date:</label>
                        <input type="date" id="leaveToDate" onchange="checkLeaveEligibility()">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="leaveType">Leave Type:</label>
                <select id="leaveType">
                    <option value="full">Full Day</option>
                    <option value="half">Half Day</option>
                </select>
            </div>
            <div id="leaveEligibilityError" class="error-message">
                <!-- Error message will be populated by JavaScript -->
            </div>
            <div class="button-group">
                <button onclick="submitLeave()">Submit for Approval</button>
                <button class="btn-secondary" onclick="closeModal('leaveModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- [ALL OTHER MODALS REMAIN THE SAME AS ORIGINAL] -->
    <!-- Modal for editing obituary duty -->
    <div id="editObituaryModal" class="modal">
        <div class="modal-content">
            <h3>Edit Obituary Duty (Transfer)</h3>
            <div class="form-group">
                <label for="obituaryDate">Select Date:</label>
                <input type="date" id="obituaryDate" onchange="loadCurrentObituaryDuty()">
            </div>
            <div class="form-group">
                <label>Current Assignment:</label>
                <div id="currentObituaryInfo" style="padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                    Loading...
                </div>
            </div>
            <div class="form-group">
                <label>Transfer From:</label>
                <select id="transferFromStaff" onchange="updateAvailableStaff()">
                    <option value="">Select current obituary duty holder</option>
                </select>
            </div>
            <div class="form-group">
                <label>Transfer To:</label>
                <select id="transferToStaff">
                    <option value="">Select new staff for obituary duty</option>
                </select>
            </div>
            <div class="form-group">
                <label for="obituaryReason">Reason for Transfer (Optional):</label>
                <textarea id="obituaryReason" rows="2" placeholder="Reason for transferring obituary duty"></textarea>
            </div>
            <div class="button-group">
                <button onclick="transferObituaryDuty()">Transfer Obituary Duty</button>
                <button class="btn-secondary" onclick="closeModal('editObituaryModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for cancelling leave -->
    <div id="cancelLeaveModal" class="modal">
        <div class="modal-content">
            <h3>Cancel Leave</h3>
            <div class="form-group">
                <label for="cancelLeaveStaff">Select Staff Member:</label>
                <select id="cancelLeaveStaff" onchange="loadLeaveForStaff()">
                    <option value="">All Staff</option>
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Leave Period:</label>
                <div class="date-range-group">
                    <div class="form-group">
                        <label for="cancelFromDate">From Date:</label>
                        <input type="date" id="cancelFromDate" onchange="loadLeaveForStaff()">
                    </div>
                    <div style="align-self: center;">to</div>
                    <div class="form-group">
                        <label for="cancelToDate">To Date:</label>
                        <input type="date" id="cancelToDate" onchange="loadLeaveForStaff()">
                    </div>
                </div>
            </div>
            <div id="leaveListContainer">
                <!-- Leave list will be populated by JavaScript -->
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('cancelLeaveModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for editing shift -->
    <div id="editShiftModal" class="modal">
        <div class="modal-content">
            <h3>Edit Shift Schedule</h3>
            <div class="form-group">
                <label for="effectiveDate">Effective From Date:</label>
                <input type="date" id="effectiveDate">
            </div>
            
            <div class="edit-shift-grid" id="editShiftGrid">
                <!-- Shift grid will be populated by JavaScript -->
            </div>
            
            <div class="button-group">
                <button onclick="saveShiftEdit()">Save Changes</button>
                <button class="btn-secondary" onclick="closeModal('editShiftModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for off-duty working entry -->
    <div id="offDutyModal" class="modal">
        <div class="modal-content">
            <h3>Off-Duty Working Entry</h3>
            <div class="form-group">
                <label for="offDutyStaff">Staff Member (Off-duty):</label>
                <select id="offDutyStaff" onchange="updateOffDutyStaffOptions()">
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            <div class="form-group">
                <label for="offDutyDate">Date:</label>
                <input type="date" id="offDutyDate" onchange="updateOffDutyStaffOptions()">
            </div>
            <div class="form-group">
                <label for="offDutyShift">Actual Shift Worked:</label>
                <select id="offDutyShift">
                    <option value="5pm-1:30am">5pm-1:30am</option>
                    <option value="4pm-12:30pm">4pm-12:30pm</option>
                    <option value="7pm-3:30pm">7pm-3:30pm</option>
                    <option value="7:00pm-3:30am">7:00pm-3:30am</option>
                </select>
            </div>
            <div class="form-group">
                <label for="offDutyReason">Reason (Optional):</label>
                <input type="text" id="offDutyReason" placeholder="e.g., Emergency coverage, Project deadline">
            </div>
            <div class="button-group">
                <button onclick="saveOffDutyEntry()">Save Entry</button>
                <button class="btn-secondary" onclick="closeModal('offDutyModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for On Duty -->
    <div id="onDutyModal" class="modal">
        <div class="modal-content">
            <h3>On Duty (Outside Office Work)</h3>
            <div class="form-group">
                <label for="onDutyStaff">Staff Member:</label>
                <select id="onDutyStaff">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
             <div class="form-group">
                <label for="onDutyDate">Date:</label>
                <input type="date" id="onDutyDate">
            </div>
            <div class="form-group">
    <label>On Duty Type:</label>
    <div id="onDutyTypeSelector">
        <label class="radio-option">
            <input type="radio" name="onDutyType" value="regular" checked onclick="toggleExtraHours()">
            <span class="radio-custom"></span>
            <span class="radio-label">Regular Shift Time</span>
        </label>
        <label class="radio-option">
            <input type="radio" name="onDutyType" value="extra" onclick="toggleExtraHours()">
            <span class="radio-custom"></span>
            <span class="radio-label">Extra Hours</span>
        </label>
    </div>
</div>
            <div class="form-group" id="extraHoursSection" style="display: none;">
                <label for="onDutyExtraHours">Extra Hours:</label>
                <select id="onDutyExtraHours">
                    <option value="0.5">0.5 hour</option>
                    <option value="1">1 hour</option>
                    <option value="1.5">1.5 hours</option>
                    <option value="2">2 hours</option>
                    <option value="2.5">2.5 hours</option>
                    <option value="3">3 hours</option>
                    <option value="3.5">3.5 hours</option>
                    <option value="4">4 hours</option>
                    <option value="4.5">4.5 hours</option>
                    <option value="5">5 hours</option>
                    <option value="5.5">5.5 hours</option>
                    <option value="6">6 hours</option>
                    <option value="6.5">6.5 hours</option>
                    <option value="7">7 hours</option>
                    <option value="7.5">7.5 hours</option>
                    <option value="8">8 hours (Full day)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="onDutyReason">Reason/Location:</label>
                <textarea id="onDutyReason" rows="3" placeholder="e.g., Client site visit, Field work"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveOnDuty()">Save On Duty</button>
                <button class="btn-secondary" onclick="closeModal('onDutyModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Late Entry -->
    <div id="lateEntryModal" class="modal">
        <div class="modal-content">
            <h3>Late Entry Registration</h3>
            <div class="form-group">
                <label for="lateEntryStaff">Staff Member:</label>
                <select id="lateEntryStaff" onchange="updateRegularShiftTime()">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="lateEntryDate">Date:</label>
                <input type="date" id="lateEntryDate" onchange="updateRegularShiftTime()">
            </div>
            <div class="form-group">
                <label for="regularShiftTime">Regular Shift Time:</label>
                <input type="text" id="regularShiftTime" readonly style="background: #f5f5f5;">
            </div>
            <div class="form-group">
                <label for="actualTime">Actual Entry Time:</label>
                <input type="time" id="actualTime" onchange="calculateDelay()" required>
            </div>
            <div class="form-group">
                <label for="delayMinutes">Calculated Delay:</label>
                <input type="text" id="delayMinutes" readonly style="background: #f5f5f5;">
                <div id="delayMessage" style="font-size: 0.9em; margin-top: 5px; color: #666;"></div>
            </div>
<div class="form-group">
    <label>Regularization:</label>
    <div id="regularizeTypeSelector">
        <label class="radio-option">
            <input type="radio" name="regularizeType" value="coff" checked onclick="toggleCOFFRequirement()">
            <span class="radio-custom"></span>
            <span class="radio-label">Regularize from COFF</span>
        </label>
        <label class="radio-option">
            <input type="radio" name="regularizeType" value="skip" onclick="toggleCOFFRequirement()">
            <span class="radio-custom"></span>
            <span class="radio-label">Skip Regularization</span>
        </label>
    </div>
                <div id="coffRequirement" style="padding: 10px; background: #e8f4fc; border-radius: 5px; margin-top: 10px; display: block;">
                    <strong>COFF Required:</strong> <span id="coffHoursRequired">0</span> hours<br>
                    <small>Based on delay calculation</small>
                </div>
            </div>
            <div class="form-group">
                <label for="lateEntryReason">Reason for Late Entry:</label>
                <textarea id="lateEntryReason" rows="2" placeholder="e.g., Traffic, Personal emergency"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveLateEntry()">Save Late Entry</button>
                <button class="btn-secondary" onclick="closeModal('lateEntryModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for extra hours -->
    <div id="extraHoursModal" class="modal">
        <div class="modal-content">
            <h3>Add Extra Working Hours</h3>
            <div class="form-group">
                <label for="extraHoursStaff">Staff Member:</label>
                <select id="extraHoursStaff">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="extraHoursDate">Date:</label>
                <input type="date" id="extraHoursDate">
            </div>
            <div class="form-group">
                <label for="extraHours">Extra Hours:</label>
                <select id="extraHours">
                    <option value="0.5">0.5 hour</option>
                    <option value="1">1 hour</option>
                    <option value="1.5">1.5 hours</option>
                    <option value="2">2 hours</option>
                    <option value="2.5">2.5 hours</option>
                    <option value="3">3 hours</option>
                    <option value="3.5">3.5 hours</option>
                    <option value="4">4 hours</option>
                    <option value="4.5">4.5 hours</option>
                    <option value="5">5 hours</option>
                    <option value="5.5">5.5 hours</option>
                    <option value="6">6 hours</option>
                    <option value="6.5">6.5 hours</option>
                    <option value="7">7 hours</option>
                    <option value="7.5">7.5 hours</option>
                    <option value="8">8 hours (Full day)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="extraHoursReason">Reason:</label>
                <textarea id="extraHoursReason" rows="3" placeholder="Reason for extra hours"></textarea>
            </div>
            <div class="button-group">
                <button onclick="saveExtraHours()">Save Extra Hours</button>
                <button class="btn-secondary" onclick="closeModal('extraHoursModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for cancel off-duty working -->
    <div id="cancelOffDutyModal" class="modal">
        <div class="modal-content">
            <h3>Cancel Off-Duty Working Entry</h3>
            <div class="form-group">
                <label for="cancelOffDutyDate">Select Date:</label>
                <input type="date" id="cancelOffDutyDate" onchange="loadOffDutyForDate()">
            </div>
            <div id="offDutyListContainer">
                <!-- Off-duty list will be populated by JavaScript -->
            </div>
            <div class="button-group">
                <button class="btn-secondary" onclick="closeModal('cancelOffDutyModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for COFF application -->
    <div id="applyCOFFModal" class="modal">
        <div class="modal-content">
            <h3>Apply for Compensatory Off (COFF)</h3>
            <div class="form-group">
                <label for="coffStaff">Staff Member:</label>
                <select id="coffStaff" onchange="updateCOFFBalanceDisplay()">
                    <option value="Sreejith">Sreejith</option>
                    <option value="Sajeev">Sajeev</option>
                    <option value="Umesh">Umesh</option>
                    <option value="Rajesh">Rajesh</option>
                    <option value="ANEESH">ANEESH (CTP)</option>
                </select>
            </div>
            <div class="form-group">
                <label>COFF Period:</label>
                <div class="date-range-group">
                    <div class="form-group">
                        <label for="coffFromDate">From Date:</label>
                        <input type="date" id="coffFromDate" onchange="updateCoffToDate()">
                    </div>
                    <div style="align-self: center;">to</div>
                    <div class="form-group">
                        <label for="coffToDate">To Date:</label>
                        <input type="date" id="coffToDate">
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label for="coffReason">Reason:</label>
                <textarea id="coffReason" rows="3" placeholder="Reason for compensatory off"></textarea>
            </div>
            <div class="coff-summary">
                <h4>Your COFF Balance</h4>
                <div id="coffBalanceDisplay">Calculating...</div>
            </div>
            <div class="button-group">
                <button onclick="submitCOFF()">Submit COFF Request</button>
                <button class="btn-secondary" onclick="closeModal('applyCOFFModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for adding/removing holiday -->
    <div id="holidayModal" class="modal">
        <div class="modal-content">
            <h3>Add/Remove Holiday</h3>
            <div class="form-group">
                <label for="holidayName">Holiday Name:</label>
                <input type="text" id="holidayName" placeholder="e.g., New Year, Diwali, Christmas">
            </div>
            <div class="form-group">
                <label for="holidayDate">Date:</label>
                <input type="date" id="holidayDate" onchange="checkExistingHoliday()">
            </div>
            <div id="existingHolidayInfo" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                <!-- Existing holiday info will be shown here -->
            </div>
            <div class="button-group">
                <button id="holidayActionBtn" onclick="saveHoliday()">Add Holiday</button>
                <button class="btn-secondary" onclick="closeModal('holidayModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for adding/removing skeleton shift -->
    <div id="skeletonModal" class="modal">
        <div class="modal-content">
            <h3>Add/Remove Skeleton Shift</h3>
            <div class="form-group">
                <label for="skeletonDate">Date:</label>
                <input type="date" id="skeletonDate" onchange="checkExistingSkeleton()">
            </div>
            <div class="form-group">
                <label for="skeletonHours">Skeleton Hours:</label>
                <select id="skeletonHours">
                    <option value="4">4 hours (Half day)</option>
                    <option value="8">8 hours (Full day)</option>
                </select>
            </div>
<div class="form-group">
    <label>Exclude Employees from OT:</label>
    <div class="staff-exclusion-list" id="skeletonExcludeList">
        <!-- Staff exclusion checkboxes will be populated here -->
    </div>
</div>
            <div class="form-group">
                <label for="skeletonReason">Reason:</label>
                <textarea id="skeletonReason" rows="3" placeholder="Reason for skeleton shift"></textarea>
            </div>
            <div id="existingSkeletonInfo" style="display: none; padding: 10px; background: #f8f9fa; border-radius: 5px; margin-bottom: 15px;">
                <!-- Existing skeleton info will be shown here -->
            </div>
            <div class="button-group">
                <button id="skeletonActionBtn" onclick="saveSkeletonShift()">Add Skeleton Shift</button>
                <button class="btn-secondary" onclick="closeModal('skeletonModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Modal for approval with reason -->
    <div id="approvalReasonModal" class="modal">
        <div class="modal-content">
            <h3>Approve/Reject Leave</h3>
            <div class="form-group">
                <label for="approvalReason">Reason (Optional):</label>
                <textarea id="approvalReason" rows="3" placeholder="Enter reason for approval/rejection"></textarea>
            </div>
            <div class="button-group">
                <button id="approveWithReasonBtn" class="btn-success" onclick="approveLeaveWithReason()">Approve</button>
                <button id="rejectWithReasonBtn" class="btn-danger" onclick="rejectLeaveWithReason()">Reject</button>
                <button class="btn-secondary" onclick="closeModal('approvalReasonModal')">Cancel</button>
            </div>
        </div>
    </div>

   <script>
// ==================== FIREBASE CONFIGURATION ====================
// 🔴 REPLACE THESE WITH YOUR ACTUAL FIREBASE CONFIG VALUES
const firebaseConfig = {
    apiKey: "AIzaSyBsZb_05bhHF7Mu5qPlZMgl3Ekpi2Citiw",
    authDomain: "phc-shift.firebaseapp.com",
    projectId: "phc-shift",
    storageBucket: "phc-shift.firebasestorage.app",
    messagingSenderId: "426348959034",
    appId: "1:426348959034:web:2936bf71ff1aae92caac03"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();

// ==================== GLOBAL VARIABLES ====================
let currentUser = null;
let userRole = 'viewer'; // 'admin' or 'viewer'
let isLoading = false;

// Staff name abbreviations
const staffAbbreviations = {
    "Sreejith": "SKS",
    "Sajeev": "SJV", 
    "Umesh": "UMU",
    "Rajesh": "MR",
    "ANEESH": "AMR"
};

// Shift data structure
const shiftData = {
    days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
    shifts: {
        "Sunday": {
            "Sreejith": "Obituary duty 5pm-1:30am",
            "Sajeev": "5pm-1:30am",
            "Umesh": "5pm-1:30am",
            "Rajesh": "7pm-3:30pm",
            "ANEESH": "7:00pm-3:30am"
        },
        "Monday": {
            "Sreejith": "Obituary duty 5pm-1:30am",
            "Sajeev": "Off-operator",
            "Umesh": "5pm-1:30am",
            "Rajesh": "7pm-3:30pm",
            "ANEESH": "7:00pm-3:30am"
        },
        "Tuesday": {
            "Sreejith": "5pm-1:30am",
            "Sajeev": "Obituary duty 5pm-1:30am",
            "Umesh": "Off-operator",
            "Rajesh": "7pm-3:30pm",
            "ANEESH": "7:00pm-3:30am"
        },
        "Wednesday": {
            "Sreejith": "Off-operator",
            "Sajeev": "5pm-1:30am",
            "Umesh": "Obituary duty 5pm-1:30am",
            "Rajesh": "7pm-3:30pm",
            "ANEESH": "Off-operator"
        },
        "Thursday": {
            "Sreejith": "Obituary duty 5pm-1:30am",
            "Sajeev": "4pm-12:30pm",
            "Umesh": "5pm-1:30am",
            "Rajesh": "7pm-3:30pm",
            "ANEESH": "7:00pm-3:30am"
        },
        "Friday": {
            "Sreejith": "5pm-1:30am",
            "Sajeev": "Obituary duty 5pm-1:30am",
            "Umesh": "7pm-3:30pm",
            "Rajesh": "Off-operator",
            "ANEESH": "7:00pm-3:30am"
        },
        "Saturday": {
            "Sreejith": "4pm-12:30pm",
            "Sajeev": "5pm-1:30am",
            "Umesh": "Obituary duty 5pm-1:30am",
            "Rajesh": "7pm-3:30pm",
            "ANEESH": "7:00pm-3:30am"
        }
    }
};

// Data storage - Initialize empty (will load from Firestore)
let leaveRequests = [];
let offDutyEntries = {};
let onDutyEntries = {};
let extraHoursData = {};
let coffData = { balances: {}, history: [], pending: [] };
let holidays = {};
let skeletonShifts = {};
let otData = { monthly: {} };
let lateEntries = { entries: [] };

// Attendance report navigation state
let currentAttendancePeriod = 0;
let currentAttendanceStartDate = null;
let currentAttendanceEndDate = null;

// View state
let currentWeekStart = new Date();
currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let currentDayView = new Date();

// For approval modal
let currentApprovalRequestId = null;
let currentApprovalAction = null;

// Get current date
const today = new Date();
const currentDateStr = today.toLocaleDateString('en-US', { 
    weekday: 'long', 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
});

// ==================== AUTHENTICATION FUNCTIONS ====================
function showLoading(show) {
    isLoading = show;
    const spinner = document.getElementById('loadingSpinner');
    if (show) {
        document.body.style.cursor = 'wait';
        if (spinner) spinner.style.display = 'flex';
    } else {
        document.body.style.cursor = 'default';
        if (spinner) spinner.style.display = 'none';
    }
}

function showLoginScreen() {
    document.getElementById('loginModal').style.display = 'flex';
    document.getElementById('userProfileSection').style.display = 'none';
    document.querySelector('.container').style.display = 'none';
    document.getElementById('userProfileDropdown').style.display = 'none';
}

function showMainApp() {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('userProfileSection').style.display = 'flex';
    document.querySelector('.container').style.display = 'block';
    
    updateUserProfile();
    setupRoleBasedUI();
}

function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = 'Please enter email and password';
        errorDiv.style.display = 'block';
        return;
    }
    
    errorDiv.style.display = 'none';
    showLoading(true);
    
    const persistence = rememberMe ? 
        firebase.auth.Auth.Persistence.LOCAL : 
        firebase.auth.Auth.Persistence.SESSION;
    
    auth.setPersistence(persistence)
        .then(() => auth.signInWithEmailAndPassword(email, password))
        .then((userCredential) => {
            currentUser = userCredential.user;
            return getUserRole(currentUser.uid);
        })
        .then((role) => {
            userRole = role;
            initializeApp();
            showMainApp();
        })
        .catch((error) => {
            console.error('Login error:', error);
            errorDiv.textContent = getLoginErrorMessage(error.code);
            errorDiv.style.display = 'block';
            showLoading(false);
        });
}

function getLoginErrorMessage(errorCode) {
    const messages = {
        'auth/invalid-email': 'Invalid email address',
        'auth/user-disabled': 'Account is disabled',
        'auth/user-not-found': 'No account found with this email',
        'auth/wrong-password': 'Incorrect password',
        'auth/too-many-requests': 'Too many attempts. Try again later',
        'auth/network-request-failed': 'Network error. Check your connection'
    };
    return messages[errorCode] || 'Login failed. Please try again';
}

async function getUserRole(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        if (userDoc.exists) {
            return userDoc.data().role || 'viewer';
        } else {
            // Create user document if it doesn't exist
            await db.collection('users').doc(userId).set({
                email: currentUser.email,
                role: 'viewer',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                name: currentUser.email.split('@')[0]
            });
            return 'viewer';
        }
    } catch (error) {
        console.error('Error getting user role:', error);
        return 'viewer';
    }
}

function logoutUser() {
    showLoading(true);
    auth.signOut().then(() => {
        currentUser = null;
        userRole = 'viewer';
        showLoginScreen();
        showLoading(false);
    }).catch((error) => {
        console.error('Logout error:', error);
        showLoading(false);
    });
}

function updateUserProfile() {
    if (!currentUser) return;
    
    const userName = document.getElementById('userName');
    const userRoleElement = document.getElementById('userRole');
    
    // Extract name from email
    const emailName = currentUser.email.split('@')[0];
    const formattedName = emailName.charAt(0).toUpperCase() + emailName.slice(1);
    
    userName.textContent = formattedName;
    userRoleElement.textContent = userRole === 'admin' ? 'Administrator' : 'Viewer';
    userRoleElement.style.color = userRole === 'admin' ? '#e74c3c' : '#3498db';
    
    // Add click event for profile dropdown
    document.getElementById('userProfile').onclick = toggleUserDropdown;
}

function toggleUserDropdown() {
    const dropdown = document.getElementById('userProfileDropdown');
    if (dropdown.style.display === 'block') {
        dropdown.style.display = 'none';
    } else {
        updateUserDropdownContent();
        dropdown.style.display = 'block';
    }
}

function updateUserDropdownContent() {
    const content = document.getElementById('userProfileContent');
    const roleColor = userRole === 'admin' ? '#e74c3c' : '#3498db';
    
    content.innerHTML = `
        <div style="margin-bottom: 15px;">
            <div style="font-weight: bold; color: #2c3e50; font-size: 0.9em;">${currentUser.email}</div>
            <div style="margin-top: 5px;">
                <span style="background: ${roleColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7em; font-weight: bold;">
                    ${userRole.toUpperCase()}
                </span>
            </div>
        </div>
        <div style="border-top: 1px solid #eee; padding-top: 10px;">
            <button onclick="logoutUser()" style="width: 100%; background: #f8f9fa; border: 1px solid #ddd; padding: 8px; border-radius: 5px; cursor: pointer; color: #e74c3c; font-size: 0.9em;">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
        </div>
    `;
}

function setupRoleBasedUI() {
    const adminControls = document.getElementById('adminControls');
    const viewerControls = document.getElementById('viewerControls');
    
    if (userRole === 'admin') {
        if (adminControls) {
            adminControls.style.display = 'flex';
            adminControls.style.marginBottom = '20px';
        }
        if (viewerControls) viewerControls.style.display = 'none';
    } else {
        if (adminControls) adminControls.style.display = 'none';
        if (viewerControls) {
            viewerControls.style.display = 'flex';
            viewerControls.style.marginBottom = '20px';
        }
    }
}

// ==================== FIRESTORE DATA FUNCTIONS ====================
async function loadAllData() {
    try {
        showLoading(true);
        
        // Load all data in parallel
        await Promise.all([
            loadLeaveRequests(),
            loadOffDutyEntries(),
            loadOnDutyEntries(),
            loadExtraHours(),
            loadCOFFData(),
            loadHolidays(),
            loadSkeletonShifts(),
            loadLateEntries()
        ]);
        
        console.log('All data loaded from Firestore');
        showLoading(false);
        return true;
    } catch (error) {
        console.error('Error loading data:', error);
        showLoading(false);
        return false;
    }
}

async function loadLeaveRequests() {
    try {
        const snapshot = await db.collection('leaveRequests')
            .where('status', '!=', 'cancelled')
            .orderBy('date', 'desc')
            .limit(200)
            .get();
        
        leaveRequests = [];
        snapshot.forEach(doc => {
            leaveRequests.push({ id: doc.id, ...doc.data() });
        });
    } catch (error) {
        console.error('Error loading leave requests:', error);
    }
}

async function loadOffDutyEntries() {
    try {
        const snapshot = await db.collection('offDutyEntries').get();
        offDutyEntries = {};
        snapshot.forEach(doc => {
            offDutyEntries[doc.id] = doc.data();
        });
    } catch (error) {
        console.error('Error loading off-duty entries:', error);
    }
}

async function loadOnDutyEntries() {
    try {
        const snapshot = await db.collection('onDutyEntries').get();
        onDutyEntries = {};
        snapshot.forEach(doc => {
            onDutyEntries[doc.id] = doc.data();
        });
    } catch (error) {
        console.error('Error loading on-duty entries:', error);
    }
}

async function loadExtraHours() {
    try {
        const snapshot = await db.collection('extraHours').get();
        extraHoursData = {};
        snapshot.forEach(doc => {
            extraHoursData[doc.id] = doc.data();
        });
    } catch (error) {
        console.error('Error loading extra hours:', error);
    }
}

async function loadCOFFData() {
    try {
        // Load balances
        const balancesSnapshot = await db.collection('coffBalances').get();
        coffData.balances = {};
        balancesSnapshot.forEach(doc => {
            coffData.balances[doc.id] = doc.data().balance || 0;
        });
        
        // Load history
        const historySnapshot = await db.collection('coffHistory')
            .orderBy('timestamp', 'desc')
            .limit(100)
            .get();
        
        coffData.history = [];
        historySnapshot.forEach(doc => {
            coffData.history.push({ id: doc.id, ...doc.data() });
        });
    } catch (error) {
        console.error('Error loading COFF data:', error);
    }
}

async function loadHolidays() {
    try {
        const snapshot = await db.collection('holidays').get();
        holidays = {};
        snapshot.forEach(doc => {
            holidays[doc.id] = doc.data();
        });
    } catch (error) {
        console.error('Error loading holidays:', error);
    }
}

async function loadSkeletonShifts() {
    try {
        const snapshot = await db.collection('skeletonShifts').get();
        skeletonShifts = {};
        snapshot.forEach(doc => {
            skeletonShifts[doc.id] = doc.data();
        });
    } catch (error) {
        console.error('Error loading skeleton shifts:', error);
    }
}

async function loadLateEntries() {
    try {
        const snapshot = await db.collection('lateEntries')
            .orderBy('entryDate', 'desc')
            .limit(100)
            .get();
        
        lateEntries.entries = [];
        snapshot.forEach(doc => {
            lateEntries.entries.push({ id: doc.id, ...doc.data() });
        });
    } catch (error) {
        console.error('Error loading late entries:', error);
    }
}

async function saveData(collection, documentId, data) {
    if (!currentUser) {
        throw new Error('User must be logged in to save data');
    }
    
    try {
        const dataWithMetadata = {
            ...data,
            lastModified: firebase.firestore.FieldValue.serverTimestamp(),
            modifiedBy: currentUser.email,
            modifiedByUid: currentUser.uid,
            userRole: userRole
        };
        
        await db.collection(collection).doc(documentId).set(dataWithMetadata, { merge: true });
        return true;
    } catch (error) {
        console.error(`Error saving to ${collection}:`, error);
        throw error;
    }
}

async function deleteData(collection, documentId) {
    if (!currentUser || userRole !== 'admin') {
        throw new Error('Only administrators can delete data');
    }
    
    try {
        await db.collection(collection).doc(documentId).delete();
        return true;
    } catch (error) {
        console.error(`Error deleting from ${collection}:`, error);
        throw error;
    }
}

// ==================== YOUR EXISTING APPLICATION FUNCTIONS ====================
// Initialize the application
async function initializeApp() {
    if (!currentUser) {
        showLoginScreen();
        return;
    }
    
    document.getElementById('current-date').textContent = currentDateStr;
    
    // Load data from Firestore
    await loadAllData();
    
    updateStats();
    renderStaffList();
    renderWeekView();
    renderMonthView();
    renderTodayView();
    updateWeekTitle();
    updateMonthTitle();
    updateDayTitle();
    
    // Set default dates for modals
    const todayStr = formatDateForInput(today);
    const dateInputs = [
        'leaveFromDate', 'leaveToDate', 'obituaryDate', 'offDutyDate',
        'effectiveDate', 'cancelOffDutyDate', 'coffFromDate', 'coffToDate',
        'holidayDate', 'skeletonDate', 'cancelFromDate', 'cancelToDate',
        'extraHoursDate', 'onDutyDate', 'lateEntryDate'
    ];
    
    dateInputs.forEach(id => {
        const element = document.getElementById(id);
        if (element) element.value = todayStr;
    });
    
    // Initialize UI components
    updateOffDutyStaffOptions();
    renderCOFFSummary();
    renderCOFFHistory();
    renderApprovals();
    calculateSkeletonOT();
    calculateCOFFBalances();
    initTouchEvents();
}

function updateStats() {
    const pendingCount = leaveRequests.filter(req => req.status === 'pending').length;
    document.getElementById('pending-count').textContent = pendingCount;
    
    let totalCoffBalance = 0;
    Object.values(coffData.balances).forEach(balance => {
        totalCoffBalance += balance;
    });
    document.getElementById('coff-balance').textContent = totalCoffBalance.toFixed(1) + ' days';
}

function renderStaffList() {
    const staffList = document.getElementById('staff-list');
    const staff = [
        { name: "Sreejith", type: "Operator", abbrev: "SKS" },
        { name: "Sajeev", type: "Operator", abbrev: "SJV" },
        { name: "Umesh", type: "Operator", abbrev: "UMU" },
        { name: "Rajesh", type: "Operator", abbrev: "MR" },
        { name: "ANEESH", type: "CTP Operator", abbrev: "AMR" }
    ];
    
    staffList.innerHTML = '';
    staff.forEach(person => {
        const div = document.createElement('div');
        div.className = `staff-item ${person.type === 'CTP Operator' ? 'ctp-operator' : ''}`;
        div.innerHTML = `
            <div style="font-weight: bold; font-size: 0.9em;">${person.name}</div>
            <div style="font-size: 0.75em; color: #666;">${person.type} (${person.abbrev})</div>
        `;
        staffList.appendChild(div);
    });
}

function renderTodayView() {
    const container = document.getElementById('todayViewContainer');
    const date = currentDayView;
    const dayIndex = date.getDay();
    const dayName = shiftData.days[dayIndex];
    const dateStr = formatDateForDisplay(date);
    
    const isToday = date.toDateString() === today.toDateString();
    const dateKey = formatDateForInput(date);
    const isHoliday = holidays[dateKey];
    const isSkeleton = skeletonShifts[dateKey];
    
    let html = `
        <div class="day-header" style="margin-bottom: 15px;">
            <div class="day-name">${dayName}</div>
            <div class="date">${dateStr}</div>
        </div>
    `;
    
    // Add holiday/skeleton marker
    if (isHoliday) {
        html += `<div class="holiday-marker" style="position: static; margin-bottom: 10px; padding: 5px 8px; font-size: 0.8em;">HOLIDAY: ${holidays[dateKey].name}</div>`;
    } else if (isSkeleton) {
        html += `<div class="skeleton-marker" style="position: static; margin-bottom: 10px; padding: 5px 8px; font-size: 0.8em;">SKELETON SHIFT: ${skeletonShifts[dateKey].hours} hours</div>`;
    }
    
    // Get all staff for today - INCLUDING ANEESH
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    let availableOperators = 0;
    let hasCriticalWarning = false;
    
    staffList.forEach(staff => {
        const shift = shiftData.shifts[dayName][staff];
        const isOnLeave = checkIfOnLeave(staff, date);
        const isOffDutyWorking = checkOffDutyWorking(staff, date);
        const isOnDuty = checkOnDuty(staff, date);
        const hasExtraHours = checkExtraHours(staff, date);
        const leaveStatus = getLeaveStatus(staff, date);
        const hasLateEntry = checkLateEntry(staff, date);
        const abbrev = staffAbbreviations[staff];
        
        let statusClass = '';
        let statusText = '';
        let badge = '';
        let shiftDisplay = shift || 'Not Scheduled';
        
        if (hasLateEntry) {
            statusClass = 'late-entry';
            const lateEntry = getLateEntry(staff, date);
            statusText = `Late Entry: ${lateEntry.delayMinutes} min delay`;
            badge = '<span class="badge late-entry-badge">LATE</span>';
            shiftDisplay = lateEntry.actualTime || shiftDisplay;
            availableOperators++;
        } else if (leaveStatus === 'pending') {
            statusClass = 'leave-pending';
            statusText = 'Pending Leave';
            badge = '<span class="badge leave-pending-badge">PENDING</span>';
        } else if (leaveStatus === 'approved') {
            statusClass = 'leave-approved';
            statusText = 'On Leave';
            badge = '<span class="badge leave-approved-badge">LEAVE</span>';
        } else if (leaveStatus === 'rejected') {
            statusClass = 'leave-rejected';
            statusText = 'Leave Rejected';
            badge = '<span class="badge leave-rejected-badge">REJECTED</span>';
        } else if (isOffDutyWorking) {
            statusClass = 'off-duty-working';
            statusText = 'Off-duty Working';
            const entry = offDutyEntries[dateKey];
            shiftDisplay = entry ? entry.shift : shiftDisplay;
            badge = '<span class="badge off-duty-working-badge">OFF-DUTY</span>';
            availableOperators++;
        } else if (isOnDuty) {
            statusClass = 'on-duty';
            const entry = onDutyEntries[dateKey];
            statusText = entry && entry.type === 'extra' ? `On Duty (+${entry.hours}h extra)` : 'On Duty (OD)';
            badge = '<span class="badge on-duty-badge">OD</span>';
            availableOperators++;
        } else if (hasExtraHours) {
            statusClass = 'extra-hours';
            const extra = extraHoursData[dateKey];
            statusText = `+${extra.hours} extra hours`;
            badge = '<span class="badge extra-hours-badge">EXTRA</span>';
            availableOperators++;
        } else if (shift && shift.includes('Obituary')) {
            statusClass = 'obituary-duty';
            statusText = 'Obituary Duty';
            availableOperators++;
            badge = '<span class="badge obituary-badge">OBITUARY</span>';
        } else if (shift && shift.includes('Off')) {
            statusClass = 'off-duty';
            statusText = 'Off Duty';
        } else if (shift && !isOnLeave) {
            availableOperators++;
        }
        
        if (isHoliday) {
            badge += '<span class="badge holiday-badge">HOLIDAY</span>';
            statusText = 'Holiday';
        }
        
        if (isSkeleton) {
            badge += '<span class="badge skeleton-badge">SKELETON</span>';
            statusText = 'Skeleton Shift';
        }
        
        html += `
            <div class="shift-item ${statusClass}">
                <div class="operator-name">
                    <span class="status-indicator ${getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry)}"></span>
                    ${abbrev} (${staff})
                    ${badge}
                </div>
                <div class="shift-time">${shiftDisplay}</div>
            </div>
            ${statusText ? `<div style="font-size: 0.75em; color: #666; margin-left: 20px; margin-bottom: 5px;">${statusText}</div>` : ''}
        `;
    });
    
    // Add operator count - Now includes ANEESH in total
    html += `
        <div class="operator-count-display" style="margin-top: 15px;">
            <div class="operator-count-item">
                <span class="operator-dot available"></span>
                <span>Available Operators: ${availableOperators}/5</span>
            </div>
        </div>
    `;
    
    // Add warnings - Adjusted for 5 operators
    if (availableOperators <= 2) {
        html += `<div class="warning" style="margin-top: 12px;">⚠️ Minimum operators only (${availableOperators} available)</div>`;
    } else if (availableOperators < 2) {
        html += `<div class="warning critical" style="margin-top: 12px;">❌ CRITICAL: Less than 2 operators available!</div>`;
        hasCriticalWarning = true;
    }
    
    container.innerHTML = html;
}

function renderWeekView() {
    const calendar = document.getElementById('calendar');
    calendar.innerHTML = '';
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(currentWeekStart.getDate() + i);
        const dayIndex = date.getDay();
        const dayName = shiftData.days[dayIndex];
        const dateStr = formatDateForDisplay(date);
        
        const isToday = date.toDateString() === today.toDateString();
        
        // Check for holiday or skeleton shift
        const dateKey = formatDateForInput(date);
        const isHoliday = holidays[dateKey];
        const isSkeleton = skeletonShifts[dateKey];
        
        // Count operators by status - INCLUDING ANEESH
        const operators = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
        let availableOperators = 0;
        let leaveOperators = 0;
        let offDutyOperators = 0;
        let offDutyWorkingOperators = 0;
        let onDutyOperators = 0;
        let obituaryOperators = 0;
        let extraHoursOperators = 0;
        let lateEntryOperators = 0;
        
        operators.forEach(op => {
            const shift = shiftData.shifts[dayName][op];
            const isOnLeave = checkIfOnLeave(op, date);
            const isOffDutyWorking = checkOffDutyWorking(op, date);
            const isOnDuty = checkOnDuty(op, date);
            const hasExtraHours = checkExtraHours(op, date);
            const hasLateEntry = checkLateEntry(op, date);
            
            if (hasLateEntry) {
                availableOperators++;
                lateEntryOperators++;
            } else if (isOffDutyWorking || isOnDuty) {
                availableOperators++;
                if (isOffDutyWorking) offDutyWorkingOperators++;
                if (isOnDuty) onDutyOperators++;
            } else if (shift && !shift.includes('Off') && !isOnLeave) {
                availableOperators++;
                if (shift.includes('Obituary')) {
                    obituaryOperators++;
                }
            }
            
            if (isOnLeave) leaveOperators++;
            if (shift && shift.includes('Off') && !isOffDutyWorking) offDutyOperators++;
            if (hasExtraHours) extraHoursOperators++;
        });
        
        // Create day card
        const dayCard = document.createElement('div');
        let additionalClass = '';
        if (isHoliday) additionalClass = 'holiday-cell';
        if (isSkeleton) additionalClass = 'skeleton-cell';
        dayCard.className = `day-card ${isToday ? 'today' : ''} ${additionalClass}`;
        dayCard.onclick = () => showDayDetails(date);
        
        // Add holiday/skeleton marker
        if (isHoliday) {
            const marker = document.createElement('div');
            marker.className = 'holiday-marker';
            marker.textContent = 'HOLIDAY';
            dayCard.appendChild(marker);
        } else if (isSkeleton) {
            const marker = document.createElement('div');
            marker.className = 'skeleton-marker';
            marker.textContent = 'SKELETON';
            dayCard.appendChild(marker);
        }
        
        // Create header
        const header = document.createElement('div');
        header.className = 'day-header';
        header.innerHTML = `
            <div class="day-name">${dayName}</div>
            <div class="date">${dateStr}</div>
        `;
        
        // Create shift list
        const shiftList = document.createElement('div');
        shiftList.className = 'shift-list';
        
        // Add all staff shifts - INCLUDING ANEESH
        const allStaff = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
        allStaff.forEach(staff => {
            const shift = shiftData.shifts[dayName][staff];
            if (shift || checkOffDutyWorking(staff, date) || checkOnDuty(staff, date) || checkExtraHours(staff, date) || checkIfOnLeave(staff, date) || checkLateEntry(staff, date)) {
                const leaveStatus = getLeaveStatus(staff, date);
                const isOffDutyWorking = checkOffDutyWorking(staff, date);
                const isOnDuty = checkOnDuty(staff, date);
                const hasExtraHours = checkExtraHours(staff, date);
                const hasLateEntry = checkLateEntry(staff, date);
                const abbrev = staffAbbreviations[staff];
                
                const shiftItem = document.createElement('div');
                let statusClass = '';
                
                if (hasLateEntry) {
                    statusClass = 'late-entry';
                } else if (leaveStatus === 'pending') {
                    statusClass = 'leave-pending';
                } else if (leaveStatus === 'approved') {
                    statusClass = 'leave-approved';
                } else if (leaveStatus === 'rejected') {
                    statusClass = 'leave-rejected';
                } else if (isOffDutyWorking) {
                    statusClass = 'off-duty-working';
                } else if (isOnDuty) {
                    statusClass = 'on-duty';
                } else if (hasExtraHours) {
                    statusClass = 'extra-hours';
                } else if (shift && shift.includes('Obituary')) {
                    statusClass = 'obituary-duty';
                } else if (shift && shift.includes('Off')) {
                    statusClass = 'off-duty';
                }
                
                shiftItem.className = `shift-item ${statusClass}`;
                
                let shiftDisplay = shift || '';
                let badge = '';
                
                if (hasLateEntry) {
                    const lateEntry = getLateEntry(staff, date);
                    shiftDisplay = lateEntry.actualTime || shiftDisplay;
                    badge = '<span class="badge late-entry-badge">LATE</span>';
                } else if (isOffDutyWorking) {
                    const entry = offDutyEntries[dateKey];
                    if (entry && entry.staff === staff) {
                        shiftDisplay = entry.shift;
                        badge = '<span class="badge off-duty-working-badge">OFF-DUTY</span>';
                    }
                }
                
                if (isOnDuty) {
                    const entry = onDutyEntries[dateKey];
                    if (entry && entry.staff === staff) {
                        badge = '<span class="badge on-duty-badge">OD</span>';
                        if (entry.type === 'extra') {
                            shiftDisplay = (shiftDisplay || 'Shift') + ` +${entry.hours}h extra`;
                        }
                    }
                }
                
                if (hasExtraHours) {
                    const extra = extraHoursData[dateKey];
                    if (extra && extra.staff === staff) {
                        shiftDisplay = (shiftDisplay || 'Shift') + ` +${extra.hours}h extra`;
                        badge += '<span class="badge extra-hours-badge">+EXTRA</span>';
                    }
                }
                
                if (leaveStatus === 'pending') {
                    badge += '<span class="badge leave-pending-badge">PENDING</span>';
                } else if (leaveStatus === 'approved') {
                    badge += '<span class="badge leave-approved-badge">LEAVE</span>';
                } else if (leaveStatus === 'rejected') {
                    badge += '<span class="badge leave-rejected-badge">REJECTED</span>';
                }
                
                if (shift && shift.includes('Obituary')) {
                    badge += '<span class="badge obituary-badge">OBITUARY</span>';
                }
                
                if (isHoliday) {
                    badge += '<span class="badge holiday-badge">HOLIDAY</span>';
                }
                
                if (isSkeleton) {
                    badge += '<span class="badge skeleton-badge">SKELETON</span>';
                }
                
                shiftItem.innerHTML = `
                    <div class="operator-name">
                        <span class="status-indicator ${getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry)}"></span>
                        ${abbrev} (${staff}${staff === 'ANEESH' ? ' CTP' : ''})
                        ${badge}
                    </div>
                    <div class="shift-time">${shiftDisplay}</div>
                `;
                shiftList.appendChild(shiftItem);
            }
        });
        
        // Add operator count with color indicators
        const operatorCount = document.createElement('div');
        operatorCount.className = 'operator-count-display';
        operatorCount.innerHTML = `
            <div class="operator-count-item">
                <span class="operator-dot available"></span>
                <span>Available: ${availableOperators}</span>
            </div>
            <div class="operator-count-item">
                <span class="operator-dot leave"></span>
                <span>Leave: ${leaveOperators}</span>
            </div>
            <div class="operator-count-item">
                <span class="operator-dot off-duty"></span>
                <span>Off: ${offDutyOperators}</span>
            </div>
            <div class="operator-count-item">
                <span class="operator-dot on-duty"></span>
                <span>OD: ${onDutyOperators}</span>
            </div>
            <div class="operator-count-item">
                <span class="operator-dot late-entry"></span>
                <span>Late: ${lateEntryOperators}</span>
            </div>
        `;
        shiftList.appendChild(operatorCount);
        
        // Add warnings - Adjusted for 5 operators
        if (availableOperators <= 2) {
            const warning = document.createElement('div');
            warning.className = 'warning';
            warning.textContent = `⚠️ Minimum operators only (${availableOperators} available)`;
            shiftList.appendChild(warning);
        } else if (availableOperators < 2) {
            const warning = document.createElement('div');
            warning.className = 'warning critical';
            warning.textContent = '❌ CRITICAL: Less than 2 operators available!';
            shiftList.appendChild(warning);
        }
        
        // Assemble day card
        dayCard.appendChild(header);
        dayCard.appendChild(shiftList);
        calendar.appendChild(dayCard);
    }
}

function renderMonthView() {
    const monthGrid = document.getElementById('monthGrid');
    monthGrid.innerHTML = '';
    
    // Add day headers
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        const header = document.createElement('div');
        header.className = 'day-header-cell';
        header.textContent = day;
        monthGrid.appendChild(header);
    });
    
    // Get first day of month and total days
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const totalDays = lastDay.getDate();
    const firstDayIndex = firstDay.getDay();
    
    // Add empty cells for days before month start
    for (let i = 0; i < firstDayIndex; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'day-cell empty';
        monthGrid.appendChild(emptyCell);
    }
    
    // Add cells for each day of month
    for (let day = 1; day <= totalDays; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dayIndex = date.getDay();
        const dayName = shiftData.days[dayIndex];
        const isToday = date.toDateString() === today.toDateString();
        const dateKey = formatDateForInput(date);
        const isHoliday = holidays[dateKey];
        const isSkeleton = skeletonShifts[dateKey];
        
        const cell = document.createElement('div');
        let additionalClass = '';
        if (isHoliday) additionalClass = 'holiday-cell';
        if (isSkeleton) additionalClass = 'skeleton-cell';
        cell.className = `day-cell ${isToday ? 'today' : ''} ${additionalClass}`;
        cell.onclick = () => showDayDetails(date);
        
        // Add holiday/skeleton marker
        if (isHoliday) {
            const marker = document.createElement('div');
            marker.className = 'holiday-marker';
            marker.textContent = 'H';
            cell.appendChild(marker);
        } else if (isSkeleton) {
            const marker = document.createElement('div');
            marker.className = 'skeleton-marker';
            marker.textContent = 'S';
            cell.appendChild(marker);
        }
        
        // Get all staff data for this day - INCLUDING ANEESH
        const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
        let availableOperators = 0;
        let leaveList = [];
        let offDutyList = [];
        let offDutyWorkingList = [];
        let onDutyList = [];
        let obituaryList = [];
        let extraHoursList = [];
        let pendingLeaveList = [];
        let approvedLeaveList = [];
        let rejectedLeaveList = [];
        let lateEntryList = [];
        
        staffList.forEach(staff => {
            const shift = shiftData.shifts[dayName][staff];
            const isOnLeave = checkIfOnLeave(staff, date);
            const isOffDutyWorking = checkOffDutyWorking(staff, date);
            const isOnDuty = checkOnDuty(staff, date);
            const hasExtraHours = checkExtraHours(staff, date);
            const leaveStatus = getLeaveStatus(staff, date);
            const hasLateEntry = checkLateEntry(staff, date);
            
            // Count off-duty working and on-duty as available
            if (hasLateEntry) {
                availableOperators++;
                lateEntryList.push(staff);
            } else if (isOffDutyWorking || isOnDuty) {
                availableOperators++;
                if (isOffDutyWorking) offDutyWorkingList.push(staff);
                if (isOnDuty) onDutyList.push(staff);
            } else if (shift && !shift.includes('Off') && !isOnLeave) {
                availableOperators++;
                if (shift && shift.includes('Obituary')) {
                    obituaryList.push(staff);
                }
            }
            
            // Track leave status
            if (isOnLeave) {
                leaveList.push(staff);
                if (leaveStatus === 'pending') {
                    pendingLeaveList.push(staff);
                } else if (leaveStatus === 'approved') {
                    approvedLeaveList.push(staff);
                } else if (leaveStatus === 'rejected') {
                    rejectedLeaveList.push(staff);
                }
            }
            
            if (shift && shift.includes('Off') && !isOffDutyWorking) {
                offDutyList.push(staff);
            }
            
            if (hasExtraHours) {
                extraHoursList.push(staff);
            }
        });
        
        // Format date for display
        const dayStr = date.getDate();
        
        let cellContent = `
            <div class="date-num">${dayStr}</div>
            <div class="day-name">${dayName.substring(0, 3)}</div>
        `;
        
        // Show available operators count
        if (availableOperators > 0) {
            cellContent += `<div class="operator-status-item available">${availableOperators}/5</div>`;
        }
        
        // Show staff names with full status text - INCLUDING ANEESH
        const allStaffToday = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
        allStaffToday.forEach(staff => {
            const shift = shiftData.shifts[dayName][staff];
            const isOnLeave = checkIfOnLeave(staff, date);
            const isOffDutyWorking = checkOffDutyWorking(staff, date);
            const isOnDuty = checkOnDuty(staff, date);
            const hasExtraHours = checkExtraHours(staff, date);
            const leaveStatus = getLeaveStatus(staff, date);
            const hasLateEntry = checkLateEntry(staff, date);
            const abbrev = staffAbbreviations[staff];
            
            let statusClass = '';
            let statusText = abbrev;
            
            if (hasLateEntry) {
                statusClass = 'late-entry';
                const lateEntry = getLateEntry(staff, date);
                statusText += ` - Late: ${lateEntry.delayMinutes} min`;
            } else if (leaveStatus === 'pending') {
                statusClass = 'leave';
                statusText += ' - Pending Leave';
            } else if (leaveStatus === 'approved') {
                statusClass = 'leave';
                statusText += ' - Leave';
            } else if (isOffDutyWorking) {
                statusClass = 'off-duty-working';
                statusText += ' - Off-duty Working';
            } else if (isOnDuty) {
                statusClass = 'on-duty';
                const entry = onDutyEntries[dateKey];
                if (entry && entry.staff === staff) {
                    statusText += entry.type === 'extra' ? ` - OD (+${entry.hours}h)` : ' - OD';
                }
            } else if (hasExtraHours) {
                statusClass = 'extra-hours';
                const extra = extraHoursData[dateKey];
                if (extra && extra.staff === staff) {
                    statusText += ` - +${extra.hours}h extra`;
                }
            } else if (shift && shift.includes('Obituary')) {
                statusClass = 'obituary';
                statusText += ' - Obituary Duty';
            } else if (shift && shift.includes('Off')) {
                statusClass = 'off-duty';
                statusText += ' - OFF';
            } else if (shift) {
                statusText += ' - Duty';
            }
            
            if (isHoliday) {
                statusClass = 'holiday';
                statusText = abbrev + ' - Holiday';
            }
            
            if (isSkeleton) {
                statusClass = 'skeleton';
                statusText = abbrev + ' - Skeleton Shift';
            }
            
            cellContent += `<div class="operator-status-item ${statusClass}" title="${staff}">${statusText}</div>`;
        });
        
        // Show holiday
        if (isHoliday) {
            cellContent += `<div class="operator-status-item holiday" title="${holidays[dateKey].name}">🎉 ${holidays[dateKey].name.substring(0, 10)}</div>`;
        }
        
        // Show skeleton shift
        if (isSkeleton) {
            const skeleton = skeletonShifts[dateKey];
            cellContent += `<div class="operator-status-item skeleton" title="Skeleton Shift">💀 ${skeleton.hours}h</div>`;
        }
        
        // Add critical warning if less than 2 operators
        if (availableOperators < 2) {
            cellContent += `<div style="font-size: 0.65em; color: #e74c3c; background: #ffebee; padding: 2px; border-radius: 2px; margin-top: 3px; text-align: center;">CRITICAL</div>`;
        } else if (availableOperators <= 2) {
            cellContent += `<div style="font-size: 0.65em; color: #f39c12; background: #fff9e6; padding: 2px; border-radius: 2px; margin-top: 3px; text-align: center;">MIN</div>`;
        }
        
        cell.innerHTML = cellContent;
        monthGrid.appendChild(cell);
    }
}

function showDayDetails(date) {
    const dateKey = formatDateForInput(date);
    const dayIndex = date.getDay();
    const dayName = shiftData.days[dayIndex];
    const dateStr = formatDateForDisplay(date);
    const isHoliday = holidays[dateKey];
    const isSkeleton = skeletonShifts[dateKey];
    
    document.getElementById('dayDetailsTitle').textContent = `${dayName}, ${dateStr}`;
    
    // Calculate statistics - INCLUDING ANEESH
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    let availableOperators = 0;
    let leaveOperators = 0;
    let offDutyOperators = 0;
    let offDutyWorkingOperators = 0;
    let onDutyOperators = 0;
    let obituaryOperators = 0;
    let extraHoursOperators = 0;
    let pendingLeaveOperators = 0;
    let lateEntryOperators = 0;
    
    staffList.forEach(staff => {
        const shift = shiftData.shifts[dayName][staff];
        const isOnLeave = checkIfOnLeave(staff, date);
        const isOffDutyWorking = checkOffDutyWorking(staff, date);
        const isOnDuty = checkOnDuty(staff, date);
        const hasExtraHours = checkExtraHours(staff, date);
        const leaveStatus = getLeaveStatus(staff, date);
        const hasLateEntry = checkLateEntry(staff, date);
        
        if (hasLateEntry) {
            availableOperators++;
            lateEntryOperators++;
        } else if (isOffDutyWorking || isOnDuty) {
            availableOperators++;
            if (isOffDutyWorking) offDutyWorkingOperators++;
            if (isOnDuty) onDutyOperators++;
        } else if (shift && !shift.includes('Off') && !isOnLeave) {
            availableOperators++;
            if (shift.includes('Obituary')) {
                obituaryOperators++;
            }
        }
        
        if (leaveStatus === 'pending') {
            pendingLeaveOperators++;
            leaveOperators++;
        } else if (leaveStatus === 'approved') {
            leaveOperators++;
        }
        
        if (shift && shift.includes('Off') && !isOffDutyWorking) {
            offDutyOperators++;
        }
        
        if (hasExtraHours) {
            extraHoursOperators++;
        }
    });
    
    // Update day stats
    const dayStats = document.getElementById('dayStats');
    dayStats.innerHTML = `
        <div class="day-stat-item">
            <div class="stat-value">${availableOperators}/5</div>
            <div class="stat-label">Available</div>
        </div>
        <div class="day-stat-item">
            <div class="stat-value">${leaveOperators}</div>
            <div class="stat-label">On Leave</div>
        </div>
        <div class="day-stat-item">
            <div class="stat-value">${offDutyOperators}</div>
            <div class="stat-label">Off Duty</div>
        </div>
        <div class="day-stat-item">
            <div class="stat-value">${onDutyOperators}</div>
            <div class="stat-label">On Duty (OD)</div>
        </div>
        <div class="day-stat-item">
            <div class="stat-value">${lateEntryOperators}</div>
            <div class="stat-label">Late Entry</div>
        </div>
    `;
    
    // Update shift details
    const shiftDetails = document.getElementById('dayShiftDetails');
    let detailsHTML = '';
    
    const allStaff = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    allStaff.forEach(staff => {
        const shift = shiftData.shifts[dayName][staff];
        const isOnLeave = checkIfOnLeave(staff, date);
        const isOffDutyWorking = checkOffDutyWorking(staff, date);
        const isOnDuty = checkOnDuty(staff, date);
        const hasExtraHours = checkExtraHours(staff, date);
        const leaveStatus = getLeaveStatus(staff, date);
        const hasLateEntry = checkLateEntry(staff, date);
        const abbrev = staffAbbreviations[staff];
        
        let detailClass = '';
        let statusText = '';
        let shiftDisplay = shift || 'Not Scheduled';
        
        if (hasLateEntry) {
            detailClass = 'late-entry';
            const lateEntry = getLateEntry(staff, date);
            statusText = `Late Entry: ${lateEntry.delayMinutes} minutes delay`;
            if (lateEntry.regularizedFromCOFF) {
                statusText += ' (Regularized from COFF)';
            }
            shiftDisplay = lateEntry.actualTime || shiftDisplay;
        } else if (leaveStatus === 'pending') {
            detailClass = 'leave';
            statusText = 'Pending Leave';
        } else if (leaveStatus === 'approved') {
            detailClass = 'leave';
            statusText = 'On Leave';
        } else if (leaveStatus === 'rejected') {
            detailClass = 'leave';
            statusText = 'Leave Rejected';
        } else if (isOffDutyWorking) {
            detailClass = 'off-duty-working';
            statusText = 'Off-duty Working';
            const entry = offDutyEntries[dateKey];
            shiftDisplay = entry ? entry.shift : shiftDisplay;
        } else if (isOnDuty) {
            detailClass = 'on-duty';
            const entry = onDutyEntries[dateKey];
            statusText = entry.type === 'extra' ? `On Duty (+${entry.hours}h extra)` : 'On Duty (OD)';
        } else if (hasExtraHours) {
            detailClass = 'extra-hours';
            const extra = extraHoursData[dateKey];
            statusText = `+${extra.hours} extra hours`;
        } else if (shift && shift.includes('Obituary')) {
            detailClass = 'obituary';
            statusText = 'Obituary Duty';
        } else if (shift && shift.includes('Off')) {
            detailClass = 'off-duty';
            statusText = 'Off Duty';
        }
        
        if (isHoliday) {
            detailClass = 'holiday';
            statusText = 'Holiday';
        }
        
        if (isSkeleton) {
            detailClass = 'skeleton';
            statusText = 'Skeleton Shift';
        }
        
        detailsHTML += `
            <div class="detail-item ${detailClass}">
                <div class="detail-header">
                    <div class="staff-name">
                        ${abbrev} (${staff}${staff === 'ANEESH' ? ' CTP' : ''})
                    </div>
                    <div class="shift-time">${shiftDisplay}</div>
                </div>
                ${statusText ? `<div style="font-size: 0.85em; margin-top: 5px;">${statusText}</div>` : ''}
            </div>
        `;
    });
    
    shiftDetails.innerHTML = detailsHTML;
    document.getElementById('dayDetailsModal').style.display = 'flex';
}

function switchTab(tabName) {
    // Update tabs
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.classList.remove('active'));
    
    // Activate selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    event.target.classList.add('active');
    
    // Refresh content if needed
    if (tabName === 'approvals') {
        renderApprovals();
    } else if (tabName === 'coff') {
        renderCOFFSummary();
        renderCOFFHistory();
    } else if (tabName === 'reports') {
        // Clear reports container and hide attendance navigation
        document.getElementById('report-container').innerHTML = '<p>Select a report to generate</p>';
        document.getElementById('attendance-nav').style.display = 'none';
    }
}

function switchView(viewType) {
    // Update buttons
    document.getElementById('viewTodayBtn').classList.remove('active');
    document.getElementById('viewWeekBtn').classList.remove('active');
    document.getElementById('viewMonthBtn').classList.remove('active');
    
    // Hide all views
    document.getElementById('todayView').classList.remove('active');
    document.getElementById('calendarView').classList.remove('active');
    document.getElementById('monthView').classList.remove('active');
    
    // Show selected view and activate button
    if (viewType === 'today') {
        document.getElementById('todayView').classList.add('active');
        document.getElementById('viewTodayBtn').classList.add('active');
    } else if (viewType === 'week') {
        document.getElementById('calendarView').classList.add('active');
        document.getElementById('viewWeekBtn').classList.add('active');
    } else if (viewType === 'month') {
        document.getElementById('monthView').classList.add('active');
        document.getElementById('viewMonthBtn').classList.add('active');
    }
}

// Navigation functions
function previousWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    renderWeekView();
    updateWeekTitle();
}

function nextWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    renderWeekView();
    updateWeekTitle();
}

function goToTodayWeek() {
    currentWeekStart = new Date();
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
    renderWeekView();
    updateWeekTitle();
}

function previousMonth() {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderMonthView();
    updateMonthTitle();
}

function nextMonth() {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderMonthView();
    updateMonthTitle();
}

function goToTodayMonth() {
    currentMonth = today.getMonth();
    currentYear = today.getFullYear();
    renderMonthView();
    updateMonthTitle();
}

function previousDay() {
    currentDayView.setDate(currentDayView.getDate() - 1);
    renderTodayView();
    updateDayTitle();
}

function nextDay() {
    currentDayView.setDate(currentDayView.getDate() + 1);
    renderTodayView();
    updateDayTitle();
}

function goToToday() {
    currentDayView = new Date();
    renderTodayView();
    updateDayTitle();
}

function updateWeekTitle() {
    const endDate = new Date(currentWeekStart);
    endDate.setDate(currentWeekStart.getDate() + 6);
    const startStr = currentWeekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    const endStr = endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    document.getElementById('weekTitle').textContent = `Week: ${startStr} - ${endStr}`;
}

function updateMonthTitle() {
    const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
    document.getElementById('monthTitle').textContent = `${monthNames[currentMonth]} ${currentYear}`;
}

function updateDayTitle() {
    const dateStr = currentDayView.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    document.getElementById('dayTitle').textContent = dateStr;
}

// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
    // Prevent body scrolling when modal is open
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // Restore body scrolling
    document.body.style.overflow = 'auto';
}

// Specific modal open functions
function openAddLeaveModal() {
    openModal('leaveModal');
}

function openEditShiftModal() {
    openModal('editShiftModal');
    loadShiftEditGrid();
}

function openEditObituaryModal() {
    openModal('editObituaryModal');
    loadCurrentObituaryDuty();
}

function openOffDutyModal() {
    openModal('offDutyModal');
    updateOffDutyStaffOptions();
}

function openOnDutyModal() {
    openModal('onDutyModal');
    // Set default values
    document.getElementById('onDutyDate').value = formatDateForInput(new Date());
    document.getElementById('onDutyExtraHours').value = '0.5';
    document.getElementById('onDutyReason').value = '';
    document.querySelector('input[name="onDutyType"][value="regular"]').checked = true;
    document.getElementById('extraHoursSection').style.display = 'none';
}

function openLateEntryModal() {
    openModal('lateEntryModal');
    const todayStr = formatDateForInput(new Date());
    document.getElementById('lateEntryDate').value = todayStr;
    document.getElementById('actualTime').value = '';
    document.getElementById('lateEntryReason').value = '';
    document.querySelector('input[name="regularizeType"][value="coff"]').checked = true;
    document.getElementById('coffRequirement').style.display = 'block';
    
    // Set default actual time to current time
    const now = new Date();
    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
    document.getElementById('actualTime').value = currentTime;
    
    updateRegularShiftTime();
}

function openCancelOffDutyModal() {
    openModal('cancelOffDutyModal');
    loadOffDutyForDate();
}

function openApplyCOFFModal() {
    openModal('applyCOFFModal');
    updateCOFFBalanceDisplay();
}

function openHolidayModal() {
    openModal('holidayModal');
    checkExistingHoliday();
}

function openSkeletonModal() {
    openModal('skeletonModal');
    const todayStr = formatDateForInput(new Date());
    document.getElementById('skeletonDate').value = todayStr;
    document.getElementById('skeletonHours').value = '8';
    document.getElementById('skeletonReason').value = '';
    document.getElementById('existingSkeletonInfo').style.display = 'none';
    document.getElementById('skeletonActionBtn').textContent = 'Add Skeleton Shift';
    document.getElementById('skeletonActionBtn').className = '';
    
    // Populate staff exclusion list
    const excludeList = document.getElementById('skeletonExcludeList');
    excludeList.innerHTML = '';
    
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    staffList.forEach(staff => {
        const item = document.createElement('div');
        item.className = 'checkbox-item';
        item.innerHTML = `
            <label class="checkbox-option">
                <input type="checkbox" id="exclude_${staff}" value="${staff}">
                <span class="checkbox-custom"></span>
                <span class="checkbox-label">${staffAbbreviations[staff]} (${staff})</span>
            </label>
        `;
        excludeList.appendChild(item);
    });
    
    checkExistingSkeleton();
}

function openCancelLeaveModal() {
    openModal('cancelLeaveModal');
    loadLeaveForStaff();
}

function openExtraHoursModal() {
    openModal('extraHoursModal');
    const todayStr = formatDateForInput(new Date());
    document.getElementById('extraHoursDate').value = todayStr;
    document.getElementById('extraHours').value = '1';
    document.getElementById('extraHoursReason').value = '';
}

// ============== ATTENDANCE REPORT FUNCTIONS WITH NAVIGATION ==============
function generateAttendancePeriodReport() {
    // Show navigation
    document.getElementById('attendance-nav').style.display = 'block';
    
    // Generate report for current period (offset = 0)
    generateAttendanceReportForPeriod(0);
}

function generateAttendanceReportForPeriod(periodOffset) {
    const container = document.getElementById('report-container');
    const periodTitle = document.getElementById('attendance-period-title');
    
    // Calculate period based on offset
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const currentDay = today.getDate();
    
    // Determine base period (0 = current/next period based on today's date)
    let baseStartDate, baseEndDate;
    
    if (currentDay <= 20) {
        // If today is before the 21st, current period is previous month 21st to current month 20th
        baseStartDate = new Date(currentYear, currentMonth - 1, 21);
        baseEndDate = new Date(currentYear, currentMonth, 20);
    } else {
        // If today is after the 20th, current period is current month 21st to next month 20th
        baseStartDate = new Date(currentYear, currentMonth, 21);
        baseEndDate = new Date(currentYear, currentMonth + 1, 20);
    }
    
    // Apply offset (each offset is one month forward or backward)
    const monthsToAdjust = periodOffset;
    const reportStartDate = new Date(baseStartDate.getFullYear(), baseStartDate.getMonth() + monthsToAdjust, 21);
    const reportEndDate = new Date(reportStartDate.getFullYear(), reportStartDate.getMonth() + 1, 20);
    
    // Adjust year if crossing year boundary
    if (reportStartDate.getMonth() === 11 && reportStartDate.getDate() === 21) {
        reportEndDate.setFullYear(reportStartDate.getFullYear() + 1);
    }
    
    // Store current period for navigation
    currentAttendancePeriod = periodOffset;
    currentAttendanceStartDate = reportStartDate;
    currentAttendanceEndDate = reportEndDate;
    
    const reportPeriod = `${reportStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} to ${reportEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
    
    // Update period title
    let periodLabel = "Current Period";
    if (periodOffset < 0) {
        periodLabel = `${Math.abs(periodOffset)} Period${Math.abs(periodOffset) > 1 ? 's' : ''} Ago`;
    } else if (periodOffset > 0) {
        periodLabel = `${periodOffset} Period${periodOffset > 1 ? 's' : ''} Ahead`;
    }
    periodTitle.textContent = `${periodLabel}: ${reportPeriod}`;
    
    let html = `<h3>Attendance Report</h3>`;
    
    // Create table
    html += `<div style="overflow-x: auto;">
        <table style="min-width: 1000px;">
            <thead>
                <tr>
                    <th style="min-width: 100px;">Operator</th>`;
    
    // Generate date headers
    const tempDate = new Date(reportStartDate);
    while (tempDate <= reportEndDate) {
        const dateStr = tempDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const dayName = tempDate.toLocaleDateString('en-US', { weekday: 'short' }).substring(0, 2);
        html += `<th style="min-width: 30px; text-align: center;" title="${tempDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}">
                    ${dateStr}<br>${dayName}
                 </th>`;
        tempDate.setDate(tempDate.getDate() + 1);
    }
    
    html += `<th>Total Days</th><th>Present</th><th>Leave</th><th>Off</th><th>% Present</th></tr></thead><tbody>`;
    
    // Get all staff members
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    
    staffList.forEach(staff => {
        const abbrev = staffAbbreviations[staff];
        html += `<tr>
                    <td style="font-weight: bold;">${abbrev}<br>(${staff}${staff === 'ANEESH' ? ' CTP' : ''})</td>`;
        
        let totalDays = 0;
        let presentDays = 0;
        let leaveDays = 0;
        let offDays = 0;
        
        // Reset tempDate for this staff member
        tempDate.setTime(reportStartDate.getTime());
        
        while (tempDate <= reportEndDate) {
            const dateKey = formatDateForInput(tempDate);
            const dayIndex = tempDate.getDay();
            const dayName = shiftData.days[dayIndex];
            
            // Check various statuses
            const isHoliday = holidays[dateKey];
            const isSkeleton = skeletonShifts[dateKey];
            const shift = shiftData.shifts[dayName][staff];
            const isOnLeave = checkIfOnLeave(staff, tempDate);
            const isOffDutyWorking = checkOffDutyWorking(staff, tempDate);
            const isOnDuty = checkOnDuty(staff, tempDate);
            const hasLateEntry = checkLateEntry(staff, tempDate);
            const leaveStatus = getLeaveStatus(staff, tempDate);
            const isOffDuty = shift && (shift.includes('Off') || shift.includes('Off-operator'));
            
            let attendanceMark = '';
            let cellStyle = '';
            let cellTitle = '';
            
            if (isHoliday) {
                attendanceMark = '<span style="color: #e74c3c; font-weight: bold;" title="Holiday">H</span>';
                cellStyle = 'background-color: #ffebee;';
                cellTitle = `Holiday: ${holidays[dateKey].name}`;
                // Don't count holidays in totals
            } else if (isSkeleton) {
                attendanceMark = '<span style="color: #26a69a; font-weight: bold;" title="Skeleton Shift">S</span>';
                cellStyle = 'background-color: #e8f6f3;';
                cellTitle = `Skeleton Shift: ${skeletonShifts[dateKey].hours} hours`;
                // Don't count skeleton shifts in totals
            } else if (isOnLeave) {
                attendanceMark = leaveStatus === 'pending' ? 
                    '<span style="color: #f39c12; font-weight: bold; border: 1px dashed #f39c12; padding: 0 2px;" title="Pending Leave">L?</span>' :
                    '<span style="color: #e74c3c; font-weight: bold;" title="Leave">L</span>';
                cellStyle = leaveStatus === 'pending' ? 'background-color: #fff9e6;' : 'background-color: #ffebee;';
                leaveDays++;
                totalDays++;
                cellTitle = leaveStatus === 'pending' ? 'Pending Leave' : 'On Leave';
            } else if (isOffDuty && !isOffDutyWorking) {
                attendanceMark = '<span style="color: #95a5a6; font-weight: bold;" title="Off Duty">O</span>';
                cellStyle = 'background-color: #f1f2f6;';
                offDays++;
                totalDays++;
                cellTitle = 'Off Duty';
            } else if (isOffDutyWorking || isOnDuty || hasLateEntry) {
                attendanceMark = '<span style="color: #27ae60; font-weight: bold;" title="Present">✓</span>';
                cellStyle = 'background-color: #e8f6ef;';
                presentDays++;
                totalDays++;
                cellTitle = isOffDutyWorking ? 'Off-duty Working' : 
                           isOnDuty ? 'On Duty (OD)' : 
                           hasLateEntry ? 'Present (Late Entry)' : 'Present';
            } else if (shift && !shift.includes('Off')) {
                attendanceMark = '<span style="color: #27ae60; font-weight: bold;" title="Present">✓</span>';
                cellStyle = 'background-color: #e8f6ef;';
                presentDays++;
                totalDays++;
                cellTitle = `Present: ${shift}`;
            } else {
                attendanceMark = '<span style="color: #95a5a6;">-</span>';
                cellTitle = 'No Shift';
                // Don't count "no shift" days in totals
            }
            
            html += `<td style="text-align: center; ${cellStyle}" title="${cellTitle}">${attendanceMark}</td>`;
            
            tempDate.setDate(tempDate.getDate() + 1);
        }
        
        // Calculate attendance percentage
        const attendancePercentage = totalDays > 0 ? Math.round((presentDays / totalDays) * 100) : 0;
        let percentageColor = '#27ae60'; // Green for good attendance
        if (attendancePercentage < 80) percentageColor = '#f39c12'; // Orange for moderate
        if (attendancePercentage < 60) percentageColor = '#e74c3c'; // Red for poor
        
        // Add totals for this staff member
        html += `<td style="text-align: center; font-weight: bold;">${totalDays}</td>
                 <td style="text-align: center; color: #27ae60; font-weight: bold;">${presentDays}</td>
                 <td style="text-align: center; color: #e74c3c; font-weight: bold;">${leaveDays}</td>
                 <td style="text-align: center; color: #95a5a6; font-weight: bold;">${offDays}</td>
                 <td style="text-align: center; color: ${percentageColor}; font-weight: bold;">${attendancePercentage}%</td>
               </tr>`;
    });
    
    // Add summary row
    html += `<tr style="background-color: #f8f9fa; font-weight: bold;">
                <td>TOTAL</td>`;
    
    // Empty cells for each date
    tempDate.setTime(reportStartDate.getTime());
    let dateCount = 0;
    while (tempDate <= reportEndDate) {
        dateCount++;
        html += `<td style="text-align: center;">${dateCount}</td>`;
        tempDate.setDate(tempDate.getDate() + 1);
    }
    
    // Calculate overall totals
    const totalStaff = staffList.length;
    const totalDaysInPeriod = Math.floor((reportEndDate - reportStartDate) / (1000 * 60 * 60 * 24)) + 1;
    
    html += `<td style="text-align: center;">${totalDaysInPeriod * totalStaff}</td>
             <td style="text-align: center;">-</td>
             <td style="text-align: center;">-</td>
             <td style="text-align: center;">-</td>
             <td style="text-align: center;">-</td>
           </tr>`;
    
    html += `</tbody></table></div>`;
    
    // Add legend
    html += `
        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
            <h4>Legend:</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #27ae60; font-weight: bold;">✓</span> Present
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #e74c3c; font-weight: bold;">L</span> Leave
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #95a5a6; font-weight: bold;">O</span> Off Duty
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #f39c12; font-weight: bold; border: 1px dashed #f39c12; padding: 0 2px;">L?</span> Pending Leave
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #e74c3c; font-weight: bold;">H</span> Holiday
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #26a69a; font-weight: bold;">S</span> Skeleton Shift
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                <strong>Note:</strong> Holiday and Skeleton Shift days are not counted in Present/Leave/Off totals.
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

// Navigation functions for attendance report
function previousAttendancePeriod() {
    generateAttendanceReportForPeriod(currentAttendancePeriod - 1);
}

function nextAttendancePeriod() {
    generateAttendanceReportForPeriod(currentAttendancePeriod + 1);
}

function goToCurrentAttendancePeriod() {
    generateAttendanceReportForPeriod(0);
}

// Other report functions
function generateLeaveReport() {
    // Hide attendance navigation for leave report
    document.getElementById('attendance-nav').style.display = 'none';
    
    const container = document.getElementById('report-container');
    const startDate = new Date();
    startDate.setMonth(startDate.getMonth() - 3); // Last 3 months
    
    const filteredLeaves = leaveRequests.filter(req => {
        const reqDate = new Date(req.date);
        return reqDate >= startDate && req.status === 'approved';
    });
    
    if (filteredLeaves.length === 0) {
        container.innerHTML = '<h3>Leave Report</h3><p>No approved leaves in the last 3 months.</p>';
        return;
    }
    
    let html = '<h3>Leave Report (Last 3 Months)</h3>';
    html += '<table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Reason</th></tr></thead><tbody>';
    
    filteredLeaves.forEach(leave => {
        const abbrev = staffAbbreviations[leave.staff];
        html += `
            <tr>
                <td>${leave.date}</td>
                <td>${abbrev} (${leave.staff})</td>
                <td>${leave.type}</td>
                <td>${leave.reason || ''}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
}

function generateOnDutyReport() {
    // Hide attendance navigation for On Duty report
    document.getElementById('attendance-nav').style.display = 'none';
    
    const container = document.getElementById('report-container');
    let html = '<h3>On Duty & Extra Hours Report</h3>';
    
    // Get all On Duty entries (including extra hours)
    const allOnDutyEntries = Object.values(onDutyEntries);
    const allExtraHours = Object.values(extraHoursData);
    
    // Combine and sort by date
    const combinedEntries = [];
    
    // Add On Duty entries
    allOnDutyEntries.forEach(entry => {
        combinedEntries.push({
            type: 'On Duty',
            date: entry.date,
            staff: entry.staff,
            hours: entry.type === 'extra' ? entry.hours : 0,
            totalHours: entry.type === 'extra' ? (8 + entry.hours) : 8, // Regular shift (8h) + extra
            reason: entry.reason,
            entryDate: entry.entryDate,
            shiftType: entry.type === 'extra' ? 'Extra Hours' : 'Regular Shift',
            originalShift: entry.regularShift
        });
    });
    
    // Add standalone Extra Hours entries (not linked to On Duty)
    allExtraHours.forEach(entry => {
        // Check if this entry is already included as On Duty
        const isInOnDuty = allOnDutyEntries.some(od => 
            od.staff === entry.staff && od.date === entry.date && od.type === 'extra'
        );
        
        if (!isInOnDuty && entry.type !== 'Off-Duty Working') {
            combinedEntries.push({
                type: 'Extra Hours',
                date: entry.date,
                staff: entry.staff,
                hours: entry.hours,
                totalHours: entry.hours,
                reason: entry.reason,
                entryDate: entry.entryDate,
                shiftType: 'Standalone Extra',
                originalShift: 'Not specified'
            });
        }
    });
    
    // Sort by date (newest first)
    combinedEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (combinedEntries.length === 0) {
        html += '<p>No On Duty or Extra Hours entries found.</p>';
        container.innerHTML = html;
        return;
    }
    
    // Group by month for summary
    const monthlySummary = {};
    const staffSummary = {};
    
    // Initialize staff summary
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    staffList.forEach(staff => {
        staffSummary[staff] = {
            totalHours: 0,
            onDutyDays: 0,
            extraHours: 0,
            entries: []
        };
    });
    
    // Process all entries
    combinedEntries.forEach(entry => {
        const date = new Date(entry.date);
        const monthKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        // Initialize month in summary
        if (!monthlySummary[monthKey]) {
            monthlySummary[monthKey] = {
                month: monthName,
                totalHours: 0,
                totalDays: 0,
                entries: []
            };
        }
        
        // Update monthly summary
        monthlySummary[monthKey].totalHours += entry.totalHours;
        monthlySummary[monthKey].totalDays += (entry.type === 'On Duty' ? 1 : 0);
        monthlySummary[monthKey].entries.push(entry);
        
        // Update staff summary
        if (staffSummary[entry.staff]) {
            staffSummary[entry.staff].totalHours += entry.totalHours;
            if (entry.type === 'On Duty') {
                staffSummary[entry.staff].onDutyDays++;
            }
            staffSummary[entry.staff].extraHours += entry.hours;
            staffSummary[entry.staff].entries.push(entry);
        }
    });
    
    // Display Monthly Summary
    html += '<h4>Monthly Summary</h4>';
    html += '<div style="overflow-x: auto;">';
    html += '<table style="min-width: 800px;">';
    html += '<thead><tr><th>Month</th><th>On Duty Days</th><th>Total Hours</th><th>Details</th></tr></thead><tbody>';
    
    // Sort months chronologically
    const sortedMonths = Object.keys(monthlySummary).sort().reverse();
    
    sortedMonths.forEach(monthKey => {
        const monthData = monthlySummary[monthKey];
        html += `
            <tr>
                <td><strong>${monthData.month}</strong></td>
                <td>${monthData.totalDays} days</td>
                <td>${monthData.totalHours.toFixed(1)} hours</td>
                <td>
                    <button onclick="showMonthDetails('${monthKey}')" 
                            style="padding: 4px 8px; font-size: 0.8em;">
                        View Details
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    // Display Staff Summary
    html += '<h4 style="margin-top: 30px;">Staff Summary</h4>';
    html += '<div style="overflow-x: auto;">';
    html += '<table style="min-width: 800px;">';
    html += '<thead><tr><th>Staff</th><th>On Duty Days</th><th>Total Hours</th><th>Extra Hours</th><th>Average Hours/Day</th><th>Details</th></tr></thead><tbody>';
    
    staffList.forEach(staff => {
        const summary = staffSummary[staff];
        const abbrev = staffAbbreviations[staff];
        const avgHours = summary.onDutyDays > 0 ? (summary.totalHours / summary.onDutyDays).toFixed(1) : '0';
        
        html += `
            <tr>
                <td><strong>${abbrev} (${staff})</strong></td>
                <td>${summary.onDutyDays} days</td>
                <td>${summary.totalHours.toFixed(1)} hours</td>
                <td>${summary.extraHours.toFixed(1)} hours</td>
                <td>${avgHours} hours</td>
                <td>
                    <button onclick="showStaffOnDutyDetails('${staff}')" 
                            style="padding: 4px 8px; font-size: 0.8em;">
                        View Details
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    
    // Display Recent Entries (last 30 days)
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    
    const recentEntries = combinedEntries.filter(entry => 
        new Date(entry.date) >= thirtyDaysAgo
    );
    
    if (recentEntries.length > 0) {
        html += '<h4 style="margin-top: 30px;">Recent Entries (Last 30 Days)</h4>';
        html += '<div style="overflow-x: auto;">';
        html += '<table style="min-width: 1000px;">';
        html += '<thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Regular Shift</th><th>Extra Hours</th><th>Total Hours</th><th>Reason</th></tr></thead><tbody>';
        
        recentEntries.forEach(entry => {
            const abbrev = staffAbbreviations[entry.staff];
            const extraHoursDisplay = entry.hours > 0 ? `${entry.hours}h` : '-';
            const totalHoursDisplay = entry.totalHours > 8 ? `<strong>${entry.totalHours}h</strong>` : `${entry.totalHours}h`;
            
            html += `
                <tr>
                    <td>${entry.date}</td>
                    <td>${abbrev} (${entry.staff})</td>
                    <td>${entry.shiftType}</td>
                    <td>${entry.originalShift}</td>
                    <td>${extraHoursDisplay}</td>
                    <td>${totalHoursDisplay}</td>
                    <td>${entry.reason || '-'}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
    }
    
    // Add legend
    html += `
        <div style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
            <h4>Legend:</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #3498db; font-weight: bold;">On Duty</span>: Regular shift work outside office
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #e74c3c; font-weight: bold;">Extra Hours</span>: Additional hours beyond regular shift
                </div>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="color: #27ae60; font-weight: bold;">Standalone Extra</span>: Extra hours not linked to On Duty
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                <strong>Note:</strong> Regular shift is counted as 8 hours. Extra hours are additional to the regular shift.
            </div>
        </div>
    `;
    
    container.innerHTML = html;
}

function generateCOFFReport() {
    // Hide attendance navigation for COFF report
    document.getElementById('attendance-nav').style.display = 'none';
    
    const container = document.getElementById('report-container');
    let html = '<h3>COFF Report</h3>';
    html += '<table><thead><tr><th>Staff</th><th>Balance</th><th>Status</th><th>Details</th></tr></thead><tbody>';
    
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    staffList.forEach(staff => {
        const balance = coffData.balances[staff] || 0;
        const abbrev = staffAbbreviations[staff];
        const status = balance >= 1 ? 'Eligible' : 'Not Eligible';
        const statusClass = balance >= 1 ? 'style="color: #27ae60;"' : 'style="color: #e74c3c;"';
        
        // Calculate hours breakdown
        const extraHoursEntries = Object.values(extraHoursData).filter(entry => entry.staff === staff);
        const totalHours = extraHoursEntries.reduce((sum, entry) => sum + entry.hours, 0);
        
        html += `
            <tr>
                <td>${abbrev} (${staff})</td>
                <td>${balance.toFixed(1)} days (${(balance * 8).toFixed(1)} hours)</td>
                <td ${statusClass}>${status}</td>
                <td>${extraHoursEntries.length} extra duty entries (${totalHours} total hours)</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    
    // Add detailed COFF history
    if (coffData.history.length > 0) {
        html += '<h4>Detailed COFF History</h4><table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Hours</th><th>COFF Days</th><th>Balance After</th><th>Reason</th></tr></thead><tbody>';
        
        const recentHistory = [...coffData.history].reverse().slice(0, 20);
        recentHistory.forEach(entry => {
            const abbrev = staffAbbreviations[entry.staff];
            const hoursDisplay = entry.hours > 0 ? `+${entry.hours}` : entry.hours;
            const coffDisplay = entry.coffEarned ? `+${entry.coffEarned.toFixed(2)}` : 
                              entry.coffUsed ? `-${entry.coffUsed.toFixed(2)}` : 'N/A';
            
            html += `
                <tr>
                    <td>${entry.date}</td>
                    <td>${abbrev} (${entry.staff})</td>
                    <td>${entry.type}</td>
                    <td>${hoursDisplay}</td>
                    <td>${coffDisplay}</td>
                    <td>${entry.balanceAfter ? entry.balanceAfter.toFixed(2) + ' days' : 'N/A'}</td>
                    <td>${entry.reason || ''}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
    }
    
    container.innerHTML = html;
}

function generateOTReport() {
    // Hide attendance navigation for OT report
    document.getElementById('attendance-nav').style.display = 'none';
    
    const container = document.getElementById('report-container');
    let html = '<h3>Overtime Report</h3>';
    
    // Get current month
    const currentDate = new Date();
    const currentMonthKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}`;
    const currentMonthData = otData.monthly[currentMonthKey] || {};
    
    html += `<h4>Current Month (${currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})</h4>`;
    html += '<table><thead><tr><th>Staff</th><th>OT Hours</th></tr></thead><tbody>';
    
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    let totalHours = 0;
    
    staffList.forEach(staff => {
        const hours = currentMonthData[staff] || 0;
        const abbrev = staffAbbreviations[staff];
        totalHours += hours;
        
        html += `
            <tr>
                <td>${abbrev} (${staff})</td>
                <td>${hours} hours</td>
            </tr>
        `;
    });
    
    html += `<tr style="font-weight: bold; background: #f8f9fa;">
                <td>Total</td>
                <td>${totalHours} hours</td>
            </tr>`;
    html += '</tbody></table>';
    
    container.innerHTML = html;
}

function exportAllData() {
    // Hide attendance navigation for export
    document.getElementById('attendance-nav').style.display = 'none';
    
    const allData = {
        shiftData: shiftData,
        leaveRequests: leaveRequests,
        offDutyEntries: offDutyEntries,
        onDutyEntries: onDutyEntries,
        extraHoursData: extraHoursData,
        coffData: coffData,
        holidays: holidays,
        skeletonShifts: skeletonShifts,
        otData: otData,
        lateEntries: lateEntries,
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `shift-leave-data-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    alert('All data exported successfully!');
}

// Leave functions
function checkLeaveEligibility() {
    const staff = document.getElementById('leaveStaff').value;
    const fromDate = new Date(document.getElementById('leaveFromDate').value);
    const toDate = new Date(document.getElementById('leaveToDate').value);
    const errorDiv = document.getElementById('leaveEligibilityError');
    
    // Check date range
    if (fromDate > toDate) {
        errorDiv.textContent = 'To date must be after From date';
        errorDiv.style.display = 'block';
        return false;
    }
    
    // Check for overlapping leaves
    const dateRange = getDatesInRange(fromDate, toDate);
    for (const date of dateRange) {
        const dateKey = formatDateForInput(date);
        if (checkIfOnLeave(staff, date)) {
            errorDiv.textContent = `${staff} already has leave on ${dateKey}`;
            errorDiv.style.display = 'block';
            return false;
        }
    }
    
    errorDiv.style.display = 'none';
    return true;
}

function updateLeaveToDate() {
    const fromDate = document.getElementById('leaveFromDate').value;
    if (fromDate) {
        document.getElementById('leaveToDate').value = fromDate;
        document.getElementById('leaveToDate').min = fromDate;
    }
}

// Load shift edit grid
function loadShiftEditGrid() {
    const grid = document.getElementById('editShiftGrid');
    grid.innerHTML = '';
    
    const days = shiftData.days;
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    
    days.forEach(dayName => {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'edit-shift-day';
        dayDiv.innerHTML = `<h4>${dayName}</h4>`;
        
        staffList.forEach(staff => {
            const currentShift = shiftData.shifts[dayName][staff] || '5pm-1:30am';
            const abbrev = staffAbbreviations[staff];
            
            const staffDiv = document.createElement('div');
            staffDiv.className = 'edit-staff-shift';
            staffDiv.innerHTML = `
                <label for="shift_${dayName}_${staff}">${abbrev} (${staff}${staff === 'ANEESH' ? ' CTP' : ''})</label>
                <select id="shift_${dayName}_${staff}">
                    <option value="5pm-1:30am" ${currentShift === '5pm-1:30am' ? 'selected' : ''}>5pm-1:30am</option>
                    <option value="4pm-12:30pm" ${currentShift === '4pm-12:30pm' ? 'selected' : ''}>4pm-12:30pm</option>
                    <option value="7pm-3:30pm" ${currentShift === '7pm-3:30pm' ? 'selected' : ''}>7pm-3:30pm</option>
                    <option value="7:00pm-3:30am" ${currentShift === '7:00pm-3:30am' ? 'selected' : ''}>7:00pm-3:30am</option>
                    <option value="Off" ${currentShift === 'Off' ? 'selected' : ''}>Off</option>
                    <option value="Off-operator" ${currentShift === 'Off-operator' ? 'selected' : ''}>Off-operator</option>
                    <option value="Obituary duty 5pm-1:30am" ${currentShift === 'Obituary duty 5pm-1:30am' ? 'selected' : ''}>Obituary duty 5pm-1:30am</option>
                </select>
            `;
            
            dayDiv.appendChild(staffDiv);
        });
        
        grid.appendChild(dayDiv);
    });
}

// Edit Obituary Duty Functions
function loadCurrentObituaryDuty() {
    const date = document.getElementById('obituaryDate').value;
    const dateObj = new Date(date);
    const dayIndex = dateObj.getDay();
    const dayName = shiftData.days[dayIndex];
    const currentInfo = document.getElementById('currentObituaryInfo');
    
    // Find who currently has obituary duty
    let currentHolder = null;
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh"];
    
    staffList.forEach(staff => {
        const shift = shiftData.shifts[dayName][staff];
        if (shift && shift.includes('Obituary')) {
            currentHolder = staff;
        }
    });
    
    if (currentHolder) {
        const abbrev = staffAbbreviations[currentHolder];
        currentInfo.innerHTML = `
            <strong>Current Obituary Duty Holder:</strong><br>
            ${abbrev} (${currentHolder}) - ${shiftData.shifts[dayName][currentHolder]}
        `;
    } else {
        currentInfo.innerHTML = `
            <strong>No obituary duty assigned for ${dayName}, ${date}</strong><br>
            You can assign obituary duty to any staff.
        `;
    }
    
    // Populate transfer from dropdown
    const transferFrom = document.getElementById('transferFromStaff');
    transferFrom.innerHTML = '<option value="">Select current obituary duty holder</option>';
    
    staffList.forEach(staff => {
        const shift = shiftData.shifts[dayName][staff];
        const abbrev = staffAbbreviations[staff];
        const option = document.createElement('option');
        option.value = staff;
        
        if (shift && shift.includes('Obituary')) {
            option.textContent = `${abbrev} (${staff}) - CURRENT HOLDER`;
            option.selected = true;
        } else {
            option.textContent = `${abbrev} (${staff})`;
        }
        
        transferFrom.appendChild(option);
    });
    
    updateAvailableStaff();
}

function updateAvailableStaff() {
    const transferFrom = document.getElementById('transferFromStaff').value;
    const transferTo = document.getElementById('transferToStaff');
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh"];
    
    transferTo.innerHTML = '<option value="">Select new staff for obituary duty</option>';
    
    staffList.forEach(staff => {
        if (staff !== transferFrom) {
            const abbrev = staffAbbreviations[staff];
            const option = document.createElement('option');
            option.value = staff;
            option.textContent = `${abbrev} (${staff})`;
            transferTo.appendChild(option);
        }
    });
}

async function transferObituaryDuty() {
    const date = document.getElementById('obituaryDate').value;
    const transferFrom = document.getElementById('transferFromStaff').value;
    const transferTo = document.getElementById('transferToStaff').value;
    const reason = document.getElementById('obituaryReason').value;
    
    if (!transferFrom || !transferTo) {
        alert('Please select both "Transfer From" and "Transfer To" staff members.');
        return;
    }
    
    if (transferFrom === transferTo) {
        alert('Cannot transfer obituary duty to the same staff member.');
        return;
    }
    
    const dateObj = new Date(date);
    const dayIndex = dateObj.getDay();
    const dayName = shiftData.days[dayIndex];
    const fromAbbrev = staffAbbreviations[transferFrom];
    const toAbbrev = staffAbbreviations[transferTo];
    
    // Get current shifts
    const fromCurrentShift = shiftData.shifts[dayName][transferFrom];
    const toCurrentShift = shiftData.shifts[dayName][transferTo];
    
    // Update shifts
    shiftData.shifts[dayName][transferFrom] = toCurrentShift; // Give transferFrom the shift of transferTo
    shiftData.shifts[dayName][transferTo] = "Obituary duty 5pm-1:30am"; // Give transferTo obituary duty
    
    // Save to Firestore
    try {
        await saveData('system', 'shiftSchedule', {
            shifts: shiftData.shifts,
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser.email,
            change: `Obituary duty transfer from ${fromAbbrev} to ${toAbbrev} on ${date}`
        });
        
        alert(`Obituary duty transferred from ${fromAbbrev} (${transferFrom}) to ${toAbbrev} (${transferTo}) on ${date}${reason ? `\nReason: ${reason}` : ''}`);
        closeModal('editObituaryModal');
        
        // Refresh views
        renderWeekView();
        renderMonthView();
        renderTodayView();
    } catch (error) {
        console.error('Error transferring obituary duty:', error);
        alert('Error transferring duty: ' + error.message);
    }
}

// On Duty Functions
function toggleExtraHours() {
    const extraHoursSection = document.getElementById('extraHoursSection');
    const onDutyType = document.querySelector('input[name="onDutyType"]:checked').value;
    
    if (onDutyType === 'extra') {
        extraHoursSection.style.display = 'block';
    } else {
        extraHoursSection.style.display = 'none';
    }
}

// Late Entry Functions
function updateRegularShiftTime() {
    const staff = document.getElementById('lateEntryStaff').value;
    const date = document.getElementById('lateEntryDate').value;
    const dateObj = new Date(date);
    const dayIndex = dateObj.getDay();
    const dayName = shiftData.days[dayIndex];
    const shift = shiftData.shifts[dayName][staff] || 'Not Scheduled';
    
    // Extract start time from shift string
    let startTime = '17:00'; // Default 5:00 PM
    
    if (shift.includes('5pm-1:30am')) startTime = '17:00';
    if (shift.includes('4pm-12:30pm')) startTime = '16:00';
    if (shift.includes('7pm-3:30pm')) startTime = '19:00';
    if (shift.includes('7:00pm-3:30am')) startTime = '19:00';
    
    document.getElementById('regularShiftTime').value = `${startTime} (${shift})`;
    
    // Recalculate delay if actual time is set
    if (document.getElementById('actualTime').value) {
        calculateDelay();
    }
}

function calculateDelay() {
    const regularShiftTime = document.getElementById('regularShiftTime').value;
    const actualTime = document.getElementById('actualTime').value;
    
    if (!regularShiftTime || !actualTime) {
        return;
    }
    
    // Extract start time from regular shift
    const timeMatch = regularShiftTime.match(/(\d{1,2}):(\d{2})/);
    if (!timeMatch) {
        alert('Could not parse regular shift time');
        return;
    }
    
    const regularHour = parseInt(timeMatch[1]);
    const regularMinute = parseInt(timeMatch[2]);
    
    // Parse actual time
    const [actualHour, actualMinute] = actualTime.split(':').map(Number);
    
    // Convert to 24-hour format if needed (handle PM times)
    let adjustedRegularHour = regularHour;
    if (regularShiftTime.includes('pm') && regularHour < 12) {
        adjustedRegularHour += 12;
    }
    
    // Calculate delay in minutes
    const regularTotalMinutes = adjustedRegularHour * 60 + regularMinute;
    const actualTotalMinutes = actualHour * 60 + actualMinute;
    
    let delayMinutes = actualTotalMinutes - regularTotalMinutes;
    
    // Handle overnight shifts
    if (delayMinutes < -720) { // If more than 12 hours difference, assume actual is next day
        delayMinutes += 1440; // Add 24 hours
    }
    
    document.getElementById('delayMinutes').value = delayMinutes > 0 ? `${delayMinutes} minutes` : 'On time or early';
    
    const delayMessage = document.getElementById('delayMessage');
    if (delayMinutes > 0) {
        const coffHoursRequired = Math.ceil(delayMinutes / 60); // Round up to nearest hour
        document.getElementById('coffHoursRequired').textContent = coffHoursRequired;
        
        delayMessage.innerHTML = `
            <span style="color: #e74c3c;">
                ⚠️ ${delayMinutes} minutes late (${coffHoursRequired} hour${coffHoursRequired > 1 ? 's' : ''} COFF required)
            </span>
        `;
    } else {
        document.getElementById('coffHoursRequired').textContent = '0';
        delayMessage.innerHTML = '<span style="color: #27ae60;">✓ On time or early</span>';
    }
}

function toggleCOFFRequirement() {
    const regularizeType = document.querySelector('input[name="regularizeType"]:checked').value;
    const coffRequirement = document.getElementById('coffRequirement');
    
    if (regularizeType === 'coff') {
        coffRequirement.style.display = 'block';
    } else {
        coffRequirement.style.display = 'none';
    }
}

async function saveLateEntry() {
    const staff = document.getElementById('lateEntryStaff').value;
    const date = document.getElementById('lateEntryDate').value;
    const actualTime = document.getElementById('actualTime').value;
    const delayMinutes = parseInt(document.getElementById('delayMinutes').value) || 0;
    const regularizeType = document.querySelector('input[name="regularizeType"]:checked').value;
    const reason = document.getElementById('lateEntryReason').value;
    
    if (!staff || !date || !actualTime) {
        alert('Please fill all required fields');
        return;
    }
    
    if (delayMinutes <= 0) {
        alert('Staff is on time or early. No late entry to record.');
        return;
    }
    
    const dateObj = new Date(date);
    const dayIndex = dateObj.getDay();
    const dayName = shiftData.days[dayIndex];
    const regularShift = shiftData.shifts[dayName][staff] || 'Not Scheduled';
    const abbrev = staffAbbreviations[staff];
    
    const coffHoursRequired = Math.ceil(delayMinutes / 60);
    const regularizedFromCOFF = regularizeType === 'coff';
    
    // Check COFF balance if regularization is required
    if (regularizedFromCOFF) {
        const coffBalance = coffData.balances[staff] || 0;
        const coffBalanceHours = coffBalance * 8;
        
        if (coffBalanceHours < coffHoursRequired) {
            alert(`${abbrev} (${staff}) has insufficient COFF balance.\nRequired: ${coffHoursRequired} hours\nAvailable: ${coffBalanceHours} hours`);
            return;
        }
    }
    
    // Create late entry record
    const lateEntry = {
        id: `late_${date}_${staff}_${Date.now()}`,
        staff: staff,
        date: date,
        actualTime: actualTime,
        regularShift: regularShift,
        delayMinutes: delayMinutes,
        coffHoursRequired: coffHoursRequired,
        regularizedFromCOFF: regularizedFromCOFF,
        reason: reason,
        entryDate: new Date().toISOString(),
        enteredBy: currentUser.email
    };
    
    try {
        // Save late entry
        await saveData('lateEntries', lateEntry.id, lateEntry);
        lateEntries.entries.push(lateEntry);
        
        // Deduct COFF if regularization is required
        if (regularizedFromCOFF) {
            coffData.balances[staff] = (coffData.balances[staff] || 0) - (coffHoursRequired / 8);
            
            // Add to COFF history
            const historyId = `coff_late_${date}_${staff}_${Date.now()}`;
            await saveData('coffHistory', historyId, {
                staff: staff,
                date: date,
                type: 'Late Entry Regularization',
                hours: -coffHoursRequired,
                coffUsed: coffHoursRequired / 8,
                balanceAfter: coffData.balances[staff],
                timestamp: new Date().toISOString(),
                reason: `Late entry: ${reason} (${delayMinutes} minutes late)`,
                processedBy: currentUser.email
            });
            
            // Update COFF balance in Firestore
            await saveData('coffBalances', staff, {
                balance: coffData.balances[staff],
                lastUpdated: new Date().toISOString(),
                updatedBy: currentUser.email
            });
        }
        
        const regularizationText = regularizedFromCOFF ? 
            `Regularized using ${coffHoursRequired} hours (${(coffHoursRequired/8).toFixed(1)} days) COFF` : 
            'Approved without COFF regularization';
        
        alert(`Late entry recorded for ${abbrev} (${staff}) on ${date}\nDelay: ${delayMinutes} minutes\n${regularizationText}`);
        closeModal('lateEntryModal');
        
        // Refresh views
        renderWeekView();
        renderMonthView();
        renderTodayView();
        updateStats();
        
    } catch (error) {
        console.error('Error saving late entry:', error);
        alert('Error saving late entry: ' + error.message);
    }
}

// Off-duty staff options
function updateOffDutyStaffOptions() {
    const date = document.getElementById('offDutyDate').value;
    const staffSelect = document.getElementById('offDutyStaff');
    const dateObj = new Date(date);
    const dayIndex = dateObj.getDay();
    const dayName = shiftData.days[dayIndex];
    
    // Save current selection before rebuilding
    const currentSelected = staffSelect.value;
    
    // Clear and rebuild the dropdown
    staffSelect.innerHTML = '';
    
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    
    // Check which staff are available for off-duty working
    let availableStaff = [];
    
    staffList.forEach(staff => {
        const shift = shiftData.shifts[dayName][staff];
        const abbrev = staffAbbreviations[staff];
        
        // Check if staff already has off-duty working entry for this date
        const dateKey = formatDateForInput(dateObj);
        const hasOffDutyWorking = offDutyEntries[dateKey] && offDutyEntries[dateKey].staff === staff;
        const isOnLeave = checkIfOnLeave(staff, dateObj);
        
        // Only show staff who are scheduled as "Off" or "Off-operator" and not already working off-duty
        if (shift && (shift.includes('Off') || shift.includes('Off-operator')) && !hasOffDutyWorking) {
            availableStaff.push({
                name: staff,
                abbrev: abbrev,
                shift: shift,
                isOnLeave: isOnLeave
            });
        }
    });
    
    if (availableStaff.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'No off-duty staff available on this date';
        staffSelect.appendChild(option);
        staffSelect.disabled = true;
        return;
    }
    
    // Sort available staff alphabetically
    availableStaff.sort((a, b) => a.name.localeCompare(b.name));
    
    // Add "Select staff" option first
    const selectOption = document.createElement('option');
    selectOption.value = '';
    selectOption.textContent = '-- Select Staff --';
    staffSelect.appendChild(selectOption);
    
    // Add each available staff as an option
    availableStaff.forEach(staff => {
        const option = document.createElement('option');
        option.value = staff.name;
        
        // Show additional info in the dropdown
        let statusInfo = '';
        if (staff.isOnLeave) {
            statusInfo = ' (On Leave - covering)';
        }
        
        option.textContent = `${staff.abbrev} (${staff.name}) - ${staff.shift}${statusInfo}`;
        staffSelect.appendChild(option);
    });
    
    // Restore previous selection if it's still valid
    if (currentSelected && availableStaff.some(staff => staff.name === currentSelected)) {
        staffSelect.value = currentSelected;
    } else {
        staffSelect.value = '';
    }
    
    staffSelect.disabled = false;
}

// Load leaves for staff in cancel modal
function loadLeaveForStaff() {
    const staff = document.getElementById('cancelLeaveStaff').value;
    const fromDate = document.getElementById('cancelFromDate').value;
    const toDate = document.getElementById('cancelToDate').value;
    const container = document.getElementById('leaveListContainer');
    
    let filteredRequests = leaveRequests.filter(req => {
        const matchesStaff = staff === '' || req.staff === staff;
        const matchesDate = (!fromDate || req.date >= fromDate) && (!toDate || req.date <= toDate);
        return matchesStaff && matchesDate && req.status !== 'cancelled';
    });
    
    if (filteredRequests.length === 0) {
        container.innerHTML = '<p>No leaves found for the selected criteria.</p>';
        return;
    }
    
    let html = '<h4>Select Leaves to Cancel:</h4>';
    filteredRequests.forEach(request => {
        const abbrev = staffAbbreviations[request.staff];
        
        // Determine badge class based on status
        let badgeClass = '';
        let badgeText = '';
        
        if (request.status === 'pending') {
            badgeClass = 'leave-pending-badge';
            badgeText = 'PENDING';
        } else if (request.status === 'approved') {
            badgeClass = request.isCOFF ? 'obituary-badge' : 'leave-approved-badge';
            badgeText = request.isCOFF ? 'COFF' : 'APPROVED';
        } else if (request.status === 'rejected') {
            badgeClass = 'leave-rejected-badge';
            badgeText = 'REJECTED';
        }
        
        html += `
            <div class="leave-cancel-item" style="margin-bottom: 15px; padding: 15px; background: ${request.status === 'approved' ? '#e8f6ef' : '#f8f9fa'}; border-radius: 8px; border-left: 4px solid ${request.status === 'approved' ? '#27ae60' : request.status === 'pending' ? '#f39c12' : '#e74c3c'}">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <input type="checkbox" value="${request.id}" 
                           class="leave-cancel-checkbox" 
                           style="width: 20px; height: 20px; margin: 0; cursor: pointer; flex-shrink: 0;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <strong style="font-size: 1em;">${abbrev} (${request.staff})</strong>
                            <span class="badge ${badgeClass}" style="font-size: 0.8em;">
                                ${badgeText}${request.isCOFF ? ' (COFF)' : ''}
                            </span>
                        </div>
                        <div style="font-size: 0.9em; color: #555;">
                            <strong>Date:</strong> ${request.date} | <strong>Type:</strong> ${request.type}
                        </div>
                        ${request.reason ? `<div style="font-size: 0.85em; color: #666; margin-top: 5px; padding: 5px 10px; background: rgba(255,255,255,0.7); border-radius: 4px;"><strong>Reason:</strong> ${request.reason}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += `
        <div class="button-group" style="margin-top: 20px;">
            <button onclick="cancelSelectedLeaves()" class="btn-danger" style="padding: 12px 24px; font-size: 1em; font-weight: bold;">Cancel Selected Leaves</button>
        </div>
    `;
    
    container.innerHTML = html;
}

function cancelSingleLeave(requestId) {
    if (confirm('Cancel this approved leave?')) {
        const requestIndex = leaveRequests.findIndex(req => req.id == requestId);
        if (requestIndex !== -1) {
            leaveRequests[requestIndex].status = 'cancelled';
            leaveRequests[requestIndex].cancelledAt = new Date().toISOString();
            
            // Update in Firestore
            saveData('leaveRequests', requestId, leaveRequests[requestIndex]);
            
            alert('Leave cancelled successfully!');
            
            // Refresh views
            renderApprovals();
            renderWeekView();
            renderMonthView();
            renderTodayView();
            updateStats();
        }
    }
}

// Edit shift functions
async function saveShiftEdit() {
    const effectiveDate = document.getElementById('effectiveDate').value;
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    const days = shiftData.days;
    
    // Update shift data for all days
    days.forEach(dayName => {
        staffList.forEach(staff => {
            const selectId = `shift_${dayName}_${staff}`;
            const newShift = document.getElementById(selectId).value;
            shiftData.shifts[dayName][staff] = newShift;
        });
    });
    
    try {
        // Save to Firestore
        await saveData('system', 'shiftSchedule', {
            shifts: shiftData.shifts,
            effectiveDate: effectiveDate,
            updatedAt: new Date().toISOString(),
            updatedBy: currentUser.email
        });
        
        alert(`Shift schedule updated effective from ${effectiveDate}`);
        closeModal('editShiftModal');
        
        // Refresh views
        renderWeekView();
        renderMonthView();
        renderTodayView();
    } catch (error) {
        console.error('Error saving shift edit:', error);
        alert('Error saving shift changes: ' + error.message);
    }
}

function loadOffDutyForDate() {
    const date = document.getElementById('cancelOffDutyDate').value;
    const container = document.getElementById('offDutyListContainer');
    const dateKey = date;
    const entry = offDutyEntries[dateKey];
    
    if (!entry) {
        container.innerHTML = '<p>No off-duty working entries found for this date.</p>';
        return;
    }
    
    const abbrev = staffAbbreviations[entry.staff];
    container.innerHTML = `
        <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <strong>Off-duty Working Entry:</strong><br>
            <strong>Staff:</strong> ${abbrev} (${entry.staff})<br>
            <strong>Date:</strong> ${date}<br>
            <strong>Shift Worked:</strong> ${entry.shift}<br>
            <strong>Reason:</strong> ${entry.reason || 'Not specified'}<br>
            <strong>Entry Date:</strong> ${new Date(entry.entryDate).toLocaleDateString()}
        </div>
        <div class="button-group">
            <button onclick="cancelOffDutyEntry('${dateKey}')" class="btn-danger">Cancel This Entry</button>
        </div>
    `;
}

async function cancelOffDutyEntry(dateKey) {
    if (confirm('Cancel this off-duty working entry?')) {
        try {
            // Delete from Firestore
            await deleteData('offDutyEntries', dateKey);
            
            // Also remove from extraHoursData if it exists
            const extraHoursId = `${dateKey}_${offDutyEntries[dateKey].staff}_offduty`;
            if (extraHoursData[extraHoursId]) {
                await deleteData('extraHours', extraHoursId);
                delete extraHoursData[extraHoursId];
            }
            
            // Delete from local data
            delete offDutyEntries[dateKey];
            
            // Recalculate COFF balances
            await calculateCOFFBalances();
            
            alert('Off-duty working entry cancelled.');
            closeModal('cancelOffDutyModal');
            
            // Refresh views
            renderWeekView();
            renderMonthView();
            renderTodayView();
        } catch (error) {
            console.error('Error cancelling off-duty entry:', error);
            alert('Error: ' + error.message);
        }
    }
}

// COFF functions
function updateCOFFBalanceDisplay() {
    const staff = document.getElementById('coffStaff').value;
    const balance = coffData.balances[staff] || 0;
    const abbrev = staffAbbreviations[staff];
    document.getElementById('coffBalanceDisplay').innerHTML = `
        <strong>${abbrev} (${staff}):</strong> ${balance.toFixed(1)} days available<br>
        <small>1 day = 8 hours of extra work</small>
    `;
}

function updateCoffToDate() {
    const fromDate = document.getElementById('coffFromDate').value;
    if (fromDate) {
        document.getElementById('coffToDate').value = fromDate;
        document.getElementById('coffToDate').min = fromDate;
    }
}

async function submitCOFF() {
    const staff = document.getElementById('coffStaff').value;
    const fromDate = new Date(document.getElementById('coffFromDate').value);
    const toDate = new Date(document.getElementById('coffToDate').value);
    const reason = document.getElementById('coffReason').value;
    const balance = coffData.balances[staff] || 0;
    const abbrev = staffAbbreviations[staff];
    
    // Check if date range is valid
    if (fromDate > toDate) {
        alert('To date must be after From date');
        return;
    }
    
    // Calculate number of days requested
    const daysRequested = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24)) + 1;
    
    // Check balance
    if (balance < daysRequested) {
        alert(`${abbrev} (${staff}) has only ${balance.toFixed(1)} days COFF balance, but requested ${daysRequested} days.`);
        return;
    }
    
    // Create COFF request
    const dateRange = getDatesInRange(fromDate, toDate);
    
    try {
        const batch = db.batch();
        const newRequests = [];
        
        dateRange.forEach(date => {
            const dateKey = formatDateForInput(date);
            const leaveId = `coff_${dateKey}_${staff}_${Date.now()}`;
            
            const leaveRequest = {
                id: leaveId,
                staff: staff,
                date: dateKey,
                type: 'Compensatory Off (COFF)',
                reason: reason,
                status: 'pending',
                requestedAt: new Date().toISOString(),
                isCOFF: true,
                requestedBy: currentUser.email,
                requestedByUid: currentUser.uid
            };
            
            const leaveRef = db.collection('leaveRequests').doc(leaveId);
            batch.set(leaveRef, leaveRequest);
            newRequests.push(leaveRequest);
        });
        
        await batch.commit();
        
        // Update local array
        leaveRequests.push(...newRequests);
        
        alert(`COFF request submitted for ${abbrev} (${staff}) from ${formatDateForInput(fromDate)} to ${formatDateForInput(toDate)}`);
        closeModal('applyCOFFModal');
        
        // Refresh approvals tab
        if (document.getElementById('approvals-tab').classList.contains('active')) {
            renderApprovals();
        }
        
        updateStats();
        
    } catch (error) {
        console.error('Error submitting COFF:', error);
        alert('Error submitting COFF request: ' + error.message);
    }
}

function checkExistingHoliday() {
    const date = document.getElementById('holidayDate').value;
    const existingInfo = document.getElementById('existingHolidayInfo');
    const actionBtn = document.getElementById('holidayActionBtn');
    
    if (holidays[date]) {
        existingInfo.innerHTML = `
            <strong>Existing Holiday:</strong> ${holidays[date].name}<br>
            <small>Added on: ${new Date(holidays[date].addedDate || holidays[date].entryDate).toLocaleDateString()}</small>
        `;
        existingInfo.style.display = 'block';
        actionBtn.textContent = 'Update Holiday';
        actionBtn.className = 'btn-warning';
    } else {
        existingInfo.style.display = 'none';
        actionBtn.textContent = 'Add Holiday';
        actionBtn.className = '';
    }
}

async function saveHoliday() {
    const name = document.getElementById('holidayName').value;
    const date = document.getElementById('holidayDate').value;
    
    if (!name || !date) {
        alert('Please enter holiday name and date');
        return;
    }
    
    try {
        await saveData('holidays', date, {
            name: name,
            date: date,
            addedDate: new Date().toISOString(),
            addedBy: currentUser.email,
            addedByUid: currentUser.uid
        });
        
        holidays[date] = {
            name: name,
            date: date,
            addedDate: new Date().toISOString()
        };
        
        alert(`Holiday "${name}" saved for ${date}`);
        closeModal('holidayModal');
        
        // Refresh views
        renderWeekView();
        renderMonthView();
        renderTodayView();
        
    } catch (error) {
        console.error('Error saving holiday:', error);
        alert('Error saving holiday: ' + error.message);
    }
}

function checkExistingSkeleton() {
    const date = document.getElementById('skeletonDate').value;
    const existingInfo = document.getElementById('existingSkeletonInfo');
    const actionBtn = document.getElementById('skeletonActionBtn');
    
    if (skeletonShifts[date]) {
        existingInfo.innerHTML = `
            <strong>Existing Skeleton Shift:</strong> ${skeletonShifts[date].hours} hours<br>
            <small>Reason: ${skeletonShifts[date].reason || 'No reason provided'}</small><br>
            <small>Added on: ${new Date(skeletonShifts[date].entryDate).toLocaleDateString()}</small>
        `;
        existingInfo.style.display = 'block';
        actionBtn.textContent = 'Update Skeleton Shift';
        actionBtn.className = 'btn-warning';
    } else {
        existingInfo.style.display = 'none';
        actionBtn.textContent = 'Add Skeleton Shift';
        actionBtn.className = '';
    }
}

async function saveSkeletonShift() {
    const date = document.getElementById('skeletonDate').value;
    const hours = document.getElementById('skeletonHours').value;
    const reason = document.getElementById('skeletonReason').value;
    
    if (!date || !hours) {
        alert('Please select date and hours');
        return;
    }
    
    // Get excluded staff
    const excludedStaff = [];
    const checkboxes = document.querySelectorAll('#skeletonExcludeList input[type="checkbox"]:checked');
    checkboxes.forEach(checkbox => {
        excludedStaff.push(checkbox.value);
    });
    
    try {
        await saveData('skeletonShifts', date, {
            hours: hours,
            reason: reason,
            excludedStaff: excludedStaff,
            entryDate: new Date().toISOString(),
            addedBy: currentUser.email,
            addedByUid: currentUser.uid
        });
        
        skeletonShifts[date] = {
            hours: hours,
            reason: reason,
            excludedStaff: excludedStaff,
            entryDate: new Date().toISOString()
        };
        
        alert(`Skeleton shift of ${hours} hours saved for ${date}`);
        closeModal('skeletonModal');
        
        // Refresh views
        renderWeekView();
        renderMonthView();
        renderTodayView();
        
    } catch (error) {
        console.error('Error saving skeleton shift:', error);
        alert('Error saving skeleton shift: ' + error.message);
    }
}

// Helper functions
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDateForDisplay(date) {
    return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        year: 'numeric',
        weekday: 'short'
    });
}

function getDatesInRange(startDate, endDate) {
    const dates = [];
    const currentDate = new Date(startDate);
    
    while (currentDate <= endDate) {
        dates.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }
    
    return dates;
}

function checkIfOnLeave(staff, date) {
    const dateKey = formatDateForInput(date);
    return leaveRequests.some(request => 
        request.staff === staff && 
        request.date === dateKey && 
        (request.status === 'approved' || request.status === 'pending')
    );
}

function checkOffDutyWorking(staff, date) {
    const dateKey = formatDateForInput(date);
    return offDutyEntries[dateKey] && offDutyEntries[dateKey].staff === staff;
}

function checkOnDuty(staff, date) {
    const dateKey = formatDateForInput(date);
    return onDutyEntries[dateKey] && onDutyEntries[dateKey].staff === staff;
}

function checkExtraHours(staff, date) {
    const dateKey = formatDateForInput(date);
    // Check all extra hours entries for this staff on this date
    return Object.values(extraHoursData).some(entry => 
        entry.staff === staff && 
        entry.date === dateKey
    );
}

function getLeaveStatus(staff, date) {
    const dateKey = formatDateForInput(date);
    const request = leaveRequests.find(req => 
        req.staff === staff && 
        req.date === dateKey
    );
    return request ? request.status : null;
}

function checkLateEntry(staff, date) {
    const dateKey = formatDateForInput(date);
    return lateEntries.entries.some(entry => 
        entry.staff === staff && 
        entry.date === dateKey
    );
}

function getLateEntry(staff, date) {
    const dateKey = formatDateForInput(date);
    return lateEntries.entries.find(entry => 
        entry.staff === staff && 
        entry.date === dateKey
    );
}

function getStatusIndicatorClass(leaveStatus, isOffDutyWorking, isOnDuty, hasExtraHours, shift, hasLateEntry) {
    if (hasLateEntry) return 'status-late-entry';
    if (leaveStatus === 'pending') return 'status-leave-pending';
    if (leaveStatus === 'approved') return 'status-leave-approved';
    if (leaveStatus === 'rejected') return 'status-leave-rejected';
    if (isOffDutyWorking) return 'status-off-duty-working';
    if (isOnDuty) return 'status-on-duty';
    if (hasExtraHours) return 'status-extra-hours';
    if (shift && shift.includes('Obituary')) return 'status-obituary';
    if (shift && shift.includes('Off')) return 'status-off';
    return 'status-available';
}

function calculateSkeletonOT() {
    // Calculate OT for skeleton shifts
    // This is a placeholder - implement your skeleton OT calculation logic
    console.log('Calculating skeleton OT...');
}

function renderCOFFSummary() {
    const container = document.getElementById('coff-summary-container');
    let html = '<div class="coff-summary">';
    
    const staffList = ["Sreejith", "Sajeev", "Umesh", "Rajesh", "ANEESH"];
    staffList.forEach(staff => {
        const balance = coffData.balances[staff] || 0;
        const abbrev = staffAbbreviations[staff];
        const status = balance >= 1 ? 'Eligible for COFF' : 'Not eligible';
        const statusColor = balance >= 1 ? '#27ae60' : '#e74c3c';
        
        html += `
            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                <strong>${abbrev} (${staff}):</strong> ${balance.toFixed(1)} days
                <span style="color: ${statusColor}; font-size: 0.9em; margin-left: 10px;">${status}</span>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function renderCOFFHistory() {
    const container = document.getElementById('coff-history-container');
    
    if (coffData.history.length === 0) {
        container.innerHTML = '<p>No COFF history available.</p>';
        return;
    }
    
    let html = '<h4>Recent COFF History</h4>';
    html += '<div style="overflow-x: auto;">';
    html += '<table><thead><tr><th>Date</th><th>Staff</th><th>Type</th><th>Hours</th><th>COFF Days</th><th>Balance After</th><th>Reason</th></tr></thead><tbody>';
    
    // Show last 20 entries
    const recentHistory = [...coffData.history].slice(0, 20);
    
    recentHistory.forEach(entry => {
        const abbrev = staffAbbreviations[entry.staff];
        const hoursDisplay = entry.hours > 0 ? `+${entry.hours}` : entry.hours;
        const coffDisplay = entry.coffEarned ? `+${entry.coffEarned.toFixed(2)}` : 
                          entry.coffUsed ? `-${entry.coffUsed.toFixed(2)}` : 'N/A';
        
        html += `
            <tr>
                <td>${new Date(entry.timestamp).toLocaleDateString()}</td>
                <td>${abbrev} (${entry.staff})</td>
                <td>${entry.type}</td>
                <td>${hoursDisplay}</td>
                <td>${coffDisplay}</td>
                <td>${entry.balanceAfter ? entry.balanceAfter.toFixed(2) + ' days' : 'N/A'}</td>
                <td>${entry.reason || ''}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function renderApprovals() {
    const pendingContainer = document.getElementById('pending-approvals-container');
    const approvedContainer = document.getElementById('approved-leaves-container');
    const rejectedContainer = document.getElementById('rejected-leaves-container');
    
    // Pending approvals
    const pendingRequests = leaveRequests.filter(req => req.status === 'pending');
    if (pendingRequests.length === 0) {
        pendingContainer.innerHTML = '<p>No pending approvals.</p>';
    } else {
        let html = '<div class="approval-list">';
        pendingRequests.forEach(request => {
            const abbrev = staffAbbreviations[request.staff];
            html += `
                <div class="approval-item">
                    <div class="approval-header">
                        <div>
                            <strong>${abbrev} (${request.staff})</strong><br>
                            <small>${request.date} - ${request.type}</small>
                        </div>
                        <div>
                            ${request.isCOFF ? '<span class="badge obituary-badge">COFF</span>' : ''}
                        </div>
                    </div>
                    ${request.reason ? `<p>${request.reason}</p>` : ''}
                    <div class="approval-actions">
                        <button class="btn-success" onclick="approveLeave('${request.id}')">Approve</button>
                        <button class="btn-danger" onclick="rejectLeave('${request.id}')">Reject</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        pendingContainer.innerHTML = html;
    }
    
    // Approved leaves
    const approvedRequests = leaveRequests.filter(req => req.status === 'approved');
    if (approvedRequests.length === 0) {
        approvedContainer.innerHTML = '<p>No approved leaves.</p>';
    } else {
        let html = '<div class="approval-list">';
        approvedRequests.slice(0, 10).forEach(request => {
            const abbrev = staffAbbreviations[request.staff];
            html += `
                <div class="approval-item approved">
                    <div class="approval-header">
                        <div>
                            <strong>${abbrev} (${request.staff})</strong><br>
                            <small>${request.date} - ${request.type}</small>
                        </div>
                        <div>
                            ${request.isCOFF ? '<span class="badge obituary-badge">COFF</span>' : ''}
                            <button class="btn-danger" onclick="cancelSingleLeave('${request.id}')" style="padding: 4px 8px; font-size: 0.8em;">Cancel</button>
                        </div>
                    </div>
                    ${request.reason ? `<p>${request.reason}</p>` : ''}
                </div>
            `;
        });
        html += '</div>';
        approvedContainer.innerHTML = html;
    }
    
    // Rejected leaves
    const rejectedRequests = leaveRequests.filter(req => req.status === 'rejected');
    if (rejectedRequests.length === 0) {
        rejectedContainer.innerHTML = '<p>No rejected leaves.</p>';
    } else {
        let html = '<div class="approval-list">';
        rejectedRequests.slice(0, 10).forEach(request => {
            const abbrev = staffAbbreviations[request.staff];
            html += `
                <div class="approval-item rejected">
                    <div class="approval-header">
                        <div>
                            <strong>${abbrev} (${request.staff})</strong><br>
                            <small>${request.date} - ${request.type}</small>
                        </div>
                    </div>
                    ${request.reason ? `<p>${request.reason}</p>` : ''}
                </div>
            `;
        });
        html += '</div>';
        rejectedContainer.innerHTML = html;
    }
}

async function approveLeave(leaveId) {
    if (!confirm('Approve this leave request?')) return;
    
    try {
        await saveData('leaveRequests', leaveId, {
            status: 'approved',
            approvedAt: new Date().toISOString(),
            approvedBy: currentUser.email,
            approvedByUid: currentUser.uid
        });
        
        // Update local copy
        const requestIndex = leaveRequests.findIndex(req => req.id === leaveId);
        if (requestIndex !== -1) {
            leaveRequests[requestIndex].status = 'approved';
            leaveRequests[requestIndex].approvedAt = new Date().toISOString();
            leaveRequests[requestIndex].approvedBy = currentUser.email;
        }
        
        alert('Leave approved successfully!');
        renderApprovals();
        renderWeekView();
        renderMonthView();
        renderTodayView();
        updateStats();
        
    } catch (error) {
        console.error('Error approving leave:', error);
        alert('Error approving leave: ' + error.message);
    }
}

async function rejectLeave(leaveId) {
    if (!confirm('Reject this leave request?')) return;
    
    try {
        await saveData('leaveRequests', leaveId, {
            status: 'rejected',
            rejectedAt: new Date().toISOString(),
            rejectedBy: currentUser.email,
            rejectedByUid: currentUser.uid
        });
        
        // Update local copy
        const requestIndex = leaveRequests.findIndex(req => req.id === leaveId);
        if (requestIndex !== -1) {
            leaveRequests[requestIndex].status = 'rejected';
            leaveRequests[requestIndex].rejectedAt = new Date().toISOString();
            leaveRequests[requestIndex].rejectedBy = currentUser.email;
        }
        
        alert('Leave rejected.');
        renderApprovals();
        renderWeekView();
        renderMonthView();
        renderTodayView();
        updateStats();
        
    } catch (error) {
        console.error('Error rejecting leave:', error);
        alert('Error rejecting leave: ' + error.message);
    }
}

function approveLeaveWithReason() {
    // Placeholder - implement if needed
    console.log('Approve with reason');
}

function rejectLeaveWithReason() {
    // Placeholder - implement if needed
    console.log('Reject with reason');
}

function initTouchEvents() {
    // Make buttons more touch-friendly
    const buttons = document.querySelectorAll('button, .tab, .day-cell');
    buttons.forEach(button => {
        button.addEventListener('touchstart', function() {
            this.style.transform = 'scale(0.98)';
        });
        button.addEventListener('touchend', function() {
            this.style.transform = '';
        });
    });
    
    // Prevent zoom on input focus for mobile
    document.addEventListener('touchstart', function(event) {
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') {
            event.target.style.fontSize = '16px';
        }
    });
}

// ==================== AUTH STATE LISTENER ====================
// This runs automatically when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if user is already logged in
    auth.onAuthStateChanged((user) => {
        if (user) {
            currentUser = user;
            getUserRole(user.uid).then((role) => {
                userRole = role;
                initializeApp();
                showMainApp();
            });
        } else {
            showLoginScreen();
        }
    });
    
    // Close user dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userProfileDropdown');
        const profile = document.getElementById('userProfile');
        
        if (dropdown && dropdown.style.display === 'block' && 
            !dropdown.contains(event.target) && 
            !profile.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });
});
</script>
<!-- ========== LOGIN MODAL ========== -->
<div id="loginModal" class="modal" style="display: flex;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div class="login-header" style="margin-bottom: 20px;">
            <i class="fas fa-user-shield" style="font-size: 3em; color: #3498db; margin-bottom: 15px;"></i>
            <h2 style="color: #2c3e50; margin-bottom: 5px;">Shift & Leave Management</h2>
            <p style="color: #7f8c8d; font-size: 0.9em;">Secure Access Portal</p>
        </div>
        
        <div class="form-group">
            <label for="loginEmail"><i class="fas fa-envelope"></i> Email Address</label>
            <input type="email" id="loginEmail" placeholder="admin@company.com" autocomplete="email">
        </div>
        
        <div class="form-group">
            <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
            <input type="password" id="loginPassword" placeholder="Enter password" autocomplete="current-password">
        </div>
        
        <div class="form-group" style="text-align: left;">
            <label>
                <input type="checkbox" id="rememberMe">
                <span style="font-size: 0.9em;">Remember me</span>
            </label>
        </div>
        
        <button onclick="loginUser()" style="width: 100%; padding: 12px; font-size: 1em; margin-top: 10px;">
            <i class="fas fa-sign-in-alt"></i> Sign In
        </button>
        
        <div id="loginError" class="error-message" style="margin-top: 10px; display: none;"></div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            <p style="font-size: 0.85em; color: #7f8c8d;">
                <i class="fas fa-info-circle"></i> Contact administrator for account access
            </p>
        </div>
    </div>
</div>

<!-- User Profile Dropdown -->
<div id="userProfileDropdown" style="display: none; position: fixed; top: 70px; right: 20px; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); padding: 15px; z-index: 1001; min-width: 200px; border: 1px solid #e0e0e0;">
    <div id="userProfileContent"></div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="loading-spinner" style="display: none;">
    <div class="spinner"></div>
    <div style="margin-top: 15px; color: #3498db; font-weight: bold;">Loading...</div>
</div>
</body>
</html>
